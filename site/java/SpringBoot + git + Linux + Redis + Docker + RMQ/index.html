
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://liutianba7.github.io/java/SpringBoot%20%2B%20git%20%2B%20Linux%20%2B%20Redis%20%2B%20Docker%20%2B%20RMQ/">
      
      
      
      
        
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.1">
    
    
      
        <title>SpringBoot + git + Linux + Redis + Docker + RMQ - LiuTianBa7 's Blog</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#springboot" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="LiuTianBa7 &#39;s Blog" class="md-header__button md-logo" aria-label="LiuTianBa7 's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12 8-1.33.09C9.81 7.07 7.4 4.5 5 4.5c0 0-1.97 2.96-.04 6.91-.55.83-.89 1.26-.96 2.25l-1.93.29.21.98 1.76-.26.14.71-1.57.94.47.89 1.45-.89C5.68 18.76 8.59 20 12 20s6.32-1.24 7.47-3.68l1.45.89.47-.89-1.57-.94.14-.71 1.76.26.21-.98-1.93-.29c-.07-.99-.41-1.42-.96-2.25C20.97 7.46 19 4.5 19 4.5c-2.4 0-4.81 2.57-5.67 3.59zm-3 3a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m6 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m-4 3h2l-.7 1.39c.2.64.76 1.11 1.45 1.11a1.5 1.5 0 0 0 1.5-1.5h.5a2 2 0 0 1-2 2c-.75 0-1.4-.41-1.75-1-.35.59-1 1-1.75 1a2 2 0 0 1-2-2h.5a1.5 1.5 0 0 0 1.5 1.5c.69 0 1.25-.47 1.45-1.11z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            LiuTianBa7 's Blog
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              SpringBoot + git + Linux + Redis + Docker + RMQ
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="indigo"  aria-label="切换至深色模式"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="切换至深色模式" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="切换至浅色模式"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="切换至浅色模式" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/liutianba7/liutianba7.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    blog
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="标签" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href="../.." class="md-tabs__link">
        
  
  
    
  
  Welcome

      </a>
    </li>
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../ssm/" class="md-tabs__link">
          
  
  
  Java

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../middleware/minio/" class="md-tabs__link">
          
  
  
  Middleware

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="LiuTianBa7 &#39;s Blog" class="md-nav__button md-logo" aria-label="LiuTianBa7 's Blog" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m12 8-1.33.09C9.81 7.07 7.4 4.5 5 4.5c0 0-1.97 2.96-.04 6.91-.55.83-.89 1.26-.96 2.25l-1.93.29.21.98 1.76-.26.14.71-1.57.94.47.89 1.45-.89C5.68 18.76 8.59 20 12 20s6.32-1.24 7.47-3.68l1.45.89.47-.89-1.57-.94.14-.71 1.76.26.21-.98-1.93-.29c-.07-.99-.41-1.42-.96-2.25C20.97 7.46 19 4.5 19 4.5c-2.4 0-4.81 2.57-5.67 3.59zm-3 3a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m6 0a1 1 0 0 1 1 1 1 1 0 0 1-1 1 1 1 0 0 1-1-1 1 1 0 0 1 1-1m-4 3h2l-.7 1.39c.2.64.76 1.11 1.45 1.11a1.5 1.5 0 0 0 1.5-1.5h.5a2 2 0 0 1-2 2c-.75 0-1.4-.41-1.75-1-.35.59-1 1-1.75 1a2 2 0 0 1-2-2h.5a1.5 1.5 0 0 0 1.5 1.5c.69 0 1.25-.47 1.45-1.11z"/></svg>

    </a>
    LiuTianBa7 's Blog
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/liutianba7/liutianba7.github.io" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    blog
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Welcome
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Java
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Java
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../ssm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    ssm
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Middleware
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Middleware
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../middleware/minio/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    minio
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#springboot" class="md-nav__link">
    <span class="md-ellipsis">
      
        一 Springboot
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="一 Springboot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-spring-boot" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Spring Boot的概念、功能
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 场景启动器
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 自动配置
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 自动配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 概念
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 核心流程
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-datasourceautoconfiguration" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 DataSourceAutoConfiguration 的导入流程
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 常用基本功能
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. 常用基本功能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-configurationproperties" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 属性绑定 @ConfigurationProperties
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-yaml" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. yaml语法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-banner" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 自定义banner
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-springapplication" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 启动 SpringApplication 的其他方法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 日志
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. 日志">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 日志的级别
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 日志的使用方式
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.3 日志分组
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.4 日志输出到文件
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.5 日志归档与滚动切割
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#56" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.6 引入日志框架自己的配置文件
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 单元测试
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 单元测试">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 一些常用的方法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 断言机制
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.2 断言机制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-orgjunitjupiterapiassertions" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 常用断言方法（org.junit.jupiter.api.Assertions）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 高级特性
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-actuator" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Actuator
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Actuator">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 功能
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 使用步骤
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 生命周期 -- 监听器感知生命周期
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. 生命周期 -- 监听器感知生命周期">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 生命周期-事件
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        三 总结以及扩展
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="三 总结以及扩展">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 总结
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 自定义场景启动器
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 重点源码
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3.3 重点源码">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-springboot" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. SpringBoot 自动配置
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-springmvc-dispatcherservlet" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. SpringMvc DispatcherServlet 流程
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-spring-ioc" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Spring Ioc（三级缓存）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-spring-transactionmanager-transactioninterceptor" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Spring 事务原理 （TransactionManager + TransactionInterceptor)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#git" class="md-nav__link">
    <span class="md-ellipsis">
      
        四 Git
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="四 Git">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-git" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Git 的概念和作用
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-git" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. git 工作流程
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-git" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. git 的常用命令
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-git" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. git 分支
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-git" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. git 冲突
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-git" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. git 远程仓库
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. git 远程仓库">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-ssh" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 Ssh配置
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-git" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 git 远程相关命令
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3 配置推送忽略文件
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#linux" class="md-nav__link">
    <span class="md-ellipsis">
      
        五 Linux
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="五 Linux">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-linux" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Linux 的文件目录
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-vim" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Vim 编辑文件
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. Vim 编辑文件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-vim" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 vim 的三重模式
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-vim" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 vim相关命令
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 命令模式下的一些指令
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-linux" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Linux 核心命令
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Linux 核心命令">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 开启、关闭服务器
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 服务管理命令
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 文件相关命令
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 文件相关命令">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-pwd-lp" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. pwd -[LP]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-ls-a-l-s-s-t-ll" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. ls[-a -l -s -S -t ...] // ll
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-cd-pl" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. cd -[PL]
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-mkdir-mpvz" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. mkdir -[mpvz] 目录名
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-rmdir" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. rmdir
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-touch" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. touch
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-cp" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. cp
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-rm" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. rm
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-mv" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. mv
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. 查看文件内容
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 用户以及权限命令
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 文件权限命令
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. 查询文件
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. 查询文件">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61-find" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 find
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-grep" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 grep
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. 文件解压缩
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. 文件解压缩">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-gzip" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 gzip
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-zip" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 zip
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-tar" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3 tar
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-linux-docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Linux 下一些应用的安装（非 docker)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Linux 下一些应用的安装（非 docker)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-jdk-tomcat" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 安装 JDK 与 Tomcat
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 安装 JDK 与 Tomcat">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11-jdk" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 JDK
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#java_home" class="md-nav__link">
    <span class="md-ellipsis">
      
        JAVA_HOME
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="JAVA_HOME">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#12-tomcat" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 Tomcat
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-mysql" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 安装mysql
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 安装mysql">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-mysql" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 与 mysql 服务相关的命令
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-nginx" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 安装 nginx
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. 安装 nginx">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        1 安装过程
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        2 核心目录以及文件
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        3 虚拟主机的配置
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        4 反向代理
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        5 安全模式
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-minio" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 安装 minio
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#x1" class="md-nav__link">
    <span class="md-ellipsis">
      
        x1. 软件包管理
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#x2" class="md-nav__link">
    <span class="md-ellipsis">
      
        x2. 切换第三方源
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 其他命令总结
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. 其他命令总结">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 查看端口号是否被占用
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 查看端口具体应用信息
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#redis" class="md-nav__link">
    <span class="md-ellipsis">
      
        六 Redis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="六 Redis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#60-no-sql-redis" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.0 No Sql 以及 Redis 的一些特性
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#61-redis" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 安装 redis
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-redis" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 Redis 配置、启动
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63-redis" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3 Redis 常见数据类型和操作命令
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.3 Redis 常见数据类型和操作命令">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 常见数据类型
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-key" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. key 相关指令
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-string" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. String 相关指令
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-list" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. List 相关指令
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-set" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Set 相关指令
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-zset" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. Zset 相关指令
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-hash" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. Hash 相关指令
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-redis-hash" class="md-nav__link">
    <span class="md-ellipsis">
      
        8 Redis hash 的底层
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64-jedis" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4. Jedis
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.4. Jedis">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 使用方法
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65-spring-data-redis" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.5 Spring data redis
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#jedis" class="md-nav__link">
    <span class="md-ellipsis">
      
        jedis:
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#pool" class="md-nav__link">
    <span class="md-ellipsis">
      
        pool:
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#enabled-true" class="md-nav__link">
    <span class="md-ellipsis">
      
        enabled: true
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#max-active-8" class="md-nav__link">
    <span class="md-ellipsis">
      
        max-active: 8
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#max-idle-5" class="md-nav__link">
    <span class="md-ellipsis">
      
        max-idle: 5
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#max-wait-100" class="md-nav__link">
    <span class="md-ellipsis">
      
        max-wait: 100
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#client-type-jedis" class="md-nav__link">
    <span class="md-ellipsis">
      
        client-type: jedis
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#redis_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        # redis连接池配置
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="# redis连接池配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#lettuce" class="md-nav__link">
    <span class="md-ellipsis">
      
        含义：这个属性指定是否启用 Lettuce 连接池。
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#springdataredislettucepoolenabledtrue" class="md-nav__link">
    <span class="md-ellipsis">
      
        spring.data.redis.lettuce.pool.enabled=true
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        # 含义：这个属性定义了连接池中允许的最大活动连接数。
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#springdataredislettucepoolmax-active8" class="md-nav__link">
    <span class="md-ellipsis">
      
        spring.data.redis.lettuce.pool.max-active=8
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        # 含义：这个属性定义了连接池中允许的最大空闲连接数。
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#springdataredislettucepoolmax-idle5" class="md-nav__link">
    <span class="md-ellipsis">
      
        spring.data.redis.lettuce.pool.max-idle=5
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        # 含义：这个属性定义了在获取连接时最长的等待时间（以毫秒为单位）。
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#springdataredislettucepoolmax-wait100" class="md-nav__link">
    <span class="md-ellipsis">
      
        spring.data.redis.lettuce.pool.max-wait=100
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="spring.data.redis.lettuce.pool.max-wait=100">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#66" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.6 事务和锁
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.6 事务和锁">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 概念
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 代码实现
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 悲观锁和乐观锁
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#67-lua" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.7 Lua 脚本
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#68-redis" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.8 Redis 的持久化策略
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.8 Redis 的持久化策略">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-rdb" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. RDB
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-aof" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. AOF
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#69-redis" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.9 Redis 主从
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.9 Redis 主从">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 主从实现方法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 主从实现原理
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 哨兵机制
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#610-redis" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.10 redis 集群
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.10 redis 集群">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        集群相关命令
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-2375" class="md-nav__link">
    <span class="md-ellipsis">
      
        七 Docker 2375
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="七 Docker 2375">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71-docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 什么是docker
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72-docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 docker 架构
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#73-docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.3 安装docker
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#74-docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.4 docker的配置
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#74-docker_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.4 docker常用命令
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.4 docker常用命令">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 镜像相关
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 容器相关
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 其他命令
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#75-docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.5 docker 数据卷
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.5 docker 数据卷">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 概念
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 数据卷相关命令
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#76" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.6 项目部署
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7.6 项目部署">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-dockerfile" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. dockerfile
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 构建过程
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#78-docker-compose" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.8 docker compose
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rabbitmq-5672" class="md-nav__link">
    <span class="md-ellipsis">
      
        八 RabbitMQ (5672)
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="八 RabbitMQ (5672)">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-rabbitmq" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.1 RabbitMQ 介绍
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.2 消息队列的功能
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.2 消息队列的功能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.解耦服务
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 异步处理
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 流量削峰
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#83-amqp-jms" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.3 AMQP 以及 JMS
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.3 AMQP 以及 JMS">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-amqp" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. AMQP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-jms" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. JMS
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-amqp-jms" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. AMQP 与 JMS 区别
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#84-docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.4 docker 镜像下载
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#85-springboot-rabbitmq" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.5 springboot 集成 rabbitMQ
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#86" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.6 不同工作模式案例
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.6 不同工作模式案例">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 简单模式
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 工人模式
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 发布-订阅模式(广播模式)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 发布-订阅模式（转发模式）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 主题模式
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#87-rabbitlistener" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.7 @RabbitListener
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#88" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.8 消息的可靠性投递
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#89" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.9 消息幂等性
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#810" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.10 消费端限流（存在默认限流）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#811" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.11 消息超时
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#812" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.12 死信队列
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.12 死信队列">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 消息成为死信的三种情况
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 死信处理的方式
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 实现方式
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#813" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.13 延迟队列
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8.13 延迟队列">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 实现方式
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_14" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 安装方式
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_8" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 使用方式
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#springcloud-2022" class="md-nav__link">
    <span class="md-ellipsis">
      
        九 SpringCloud 2022年版本
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="九 SpringCloud 2022年版本">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 什么是微服务
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_15" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 概念汇总
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-springcloud" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. SpringCloud 的介绍
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 远程调用
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-nacos" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Nacos
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. Nacos">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-nacos" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Nacos的介绍
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-nacos-docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Nacos 的安装与启动（docker）
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-nacos" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 微服务集成 nacos
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-discoveryclient" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. DiscoveryClient
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5_5" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 高级特性
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. 高级特性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 就近机房访问
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 权重配置
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.3 环境隔离
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.4 临时实例与永久实例
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-loadbalancer" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. LoadBalancer
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. LoadBalancer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_14" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 使用方式
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-loadbalancer" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. LoadBalancer 的原理
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_9" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 更改负载均衡算法
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-openfeign" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. OpenFeign
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. OpenFeign">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_15" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 使用方法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-openfeign" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. OpenFeign 的自定义配置
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. OpenFeign 的自定义配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 日志配置
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 超时配置
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 重试配置
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-nacos" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. Nacos 配置中心
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. Nacos 配置中心">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_16" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 使用方法
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-gateway" class="md-nav__link">
    <span class="md-ellipsis">
      
        9. Gateway
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="9. Gateway">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-gateway" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Gateway简介
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_16" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 核心概念
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-gateway" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Gateway 使用方法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-predicate" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Predicate 的使用
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-fliter" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. Fliter 的使用
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#x" class="md-nav__link">
    <span class="md-ellipsis">
      
        x. 过滤器执行顺序
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10-sentinel" class="md-nav__link">
    <span class="md-ellipsis">
      
        10. Sentinel
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="10. Sentinel">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_17" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 雪崩效应
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_17" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 解决方案
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. 解决方案">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 超时处理
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 隔离处理
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 熔断处理
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4 流量控制
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-sentinel" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Sentinel 的安装与整合
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Sentinel 的安装与整合">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 安装
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-sentinel" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 整合 sentinel
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 流量控制
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. 流量控制">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 相关概念
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 流控效果
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4 热点资源限流
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#langchain4j" class="md-nav__link">
    <span class="md-ellipsis">
      
        十 LangChain4j
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="十 LangChain4j">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#x-pinecone" class="md-nav__link">
    <span class="md-ellipsis">
      
        x. Pinecone 的集成
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#11-elasticsearch" class="md-nav__link">
    <span class="md-ellipsis">
      
        11 ElasticSearch
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="11 ElasticSearch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_18" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 概述
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 概述">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 简介
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 特性
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 应用场景
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#14" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.4 全文搜索引擎
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#15-lucene" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.5 lucene 介绍
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#16" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.6 倒排索引
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#17-es-solr" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.7 Es 和 Solr 的对比
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-elk-docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. ELK 的安装（docker）
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. ELK 的安装（docker）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-elasticsearch" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 ElasticSearch 的安装
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-logstach" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 LogStach 的安装
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-kibana" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 kibana的安装
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-es" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. es 核心概念
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. es 核心概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-es" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 es 与 关系型数据库的对比
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-index" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 index
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-type" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 type
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35-field" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5 field
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#37-mapping" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.7 mapping
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-es" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Es 的基础功能
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Es 的基础功能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 分词器
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 索引操作
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 文档操作
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4 映射
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.4 映射">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#441" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4.1 动态映射
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#442" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4.2 静态映射
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45-nested" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5 nested
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-dsl" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. DSL 高级查询功能
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. DSL 高级查询功能">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 模糊查询
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 精确查询
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.3 多条件查询
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.4 聚合查询
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#55_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.5 分页查询
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#57" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.7 高亮显示
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#61-elasticsearch-java-api-client" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 ElasticSearch Java API Client
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62-spring-data-elasticsearch" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 Spring Data Elasticsearch
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.2 Spring Data Elasticsearch">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        使用方法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#es" class="md-nav__link">
    <span class="md-ellipsis">
      
        映射以及通过实现接口来使用es
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. 提示词的实现
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="7. 提示词的实现">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#71" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.1 基础语法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#72" class="md-nav__link">
    <span class="md-ellipsis">
      
        7.2 实现方式
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-elk" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. ELK 日志解决方法
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="8. ELK 日志解决方法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#81-elk" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.1 ELK的安装
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#82-elk" class="md-nav__link">
    <span class="md-ellipsis">
      
        8.2 ELK的使用
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12-mongodb" class="md-nav__link">
    <span class="md-ellipsis">
      
        12 MongoDB
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="12 MongoDB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_19" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 基础概念
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1. 基础概念">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#11_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.1 介绍
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#12_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.2 适用场景
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-mdb" class="md-nav__link">
    <span class="md-ellipsis">
      
        1.3 Mdb 的安装
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="1.3 Mdb 的安装">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        docker 版本
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#windows" class="md-nav__link">
    <span class="md-ellipsis">
      
        windows 版本
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-mongodb" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. MongoDB 用法
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2. MongoDB 用法">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.1 基本命令
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.2 数据库操作
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.3 集合的操作
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        2.4 文档的操作
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="2.4 文档的操作">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_20" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 文档的增删改查
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_18" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 文档的索引操作
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-spring-data-mongodb" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Spring Data MongoDB
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="3. Spring Data MongoDB">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31_4" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.1 版本需求
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-mongodb" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.2 连接到 mongoDb
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#33-mongotemplate" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.3 mongoTemplate 的配置
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#34" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.4 使用方法
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#35" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.5 持久层接口代码演示
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#36" class="md-nav__link">
    <span class="md-ellipsis">
      
        3.6 模板类代码演示
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#13-zipkin" class="md-nav__link">
    <span class="md-ellipsis">
      
        13 zipkin
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="13 zipkin">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_21" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 为什么要有链路追踪
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-zipkin" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. zipkin 主要功能
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_10" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 使用方式
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-openfeign-zipkin" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 解决异步 openfeign 无法被 zipkin 完整追踪的问题
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#14-redisson" class="md-nav__link">
    <span class="md-ellipsis">
      
        14 Redisson
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="14 Redisson">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_22" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 介绍
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-redission" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. redission 的使用
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_19" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 分布式锁的使用：缓存击穿
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_11" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 获取锁的不同方式
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-day10" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. 源码分析 day10
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. 源码分析 day10">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_23" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 加锁
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_20" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 看门狗机制
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_12" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 解锁
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5_6" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 布隆过滤器
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="5. 布隆过滤器">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#51_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.1 原理
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#52_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.2 优缺点
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#53_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.3 使用方式
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#54_3" class="md-nav__link">
    <span class="md-ellipsis">
      
        5.4 布隆过滤器的重建与扩容
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. 缓存数据一致性
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6. 缓存数据一致性">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.1 双写策略
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#62" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.2 先删除缓存再更新数据库
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#63_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.3 延迟双删
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#64" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.4 分布式读写锁
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#65-binlog" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.5 Binlog 方案
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="6.5 Binlog 方案">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#canal" class="md-nav__link">
    <span class="md-ellipsis">
      
        Canal 服务端
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#canal_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        Canal 客户端
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#66_1" class="md-nav__link">
    <span class="md-ellipsis">
      
        6.6 内网穿透
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#15-seata" class="md-nav__link">
    <span class="md-ellipsis">
      
        15. seata
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="15. seata">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-cap" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. CAP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-base" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Base 定理
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_13" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 分布式事务的解决方案
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-seata" class="md-nav__link">
    <span class="md-ellipsis">
      
        4. Seata简介
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4. Seata简介">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.1 架构
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-xa-cp" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.2 XA 模式 CP
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-at-ap" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.3 AT 模式 AP
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="4.3 AT 模式 AP">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_24" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 概述
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_21" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 具体过程
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3_14" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. 优缺点
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-seata-docker" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.4 Seata 部署（docker)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45-seata-windows" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.5 Seata 部署（windows)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46-seata" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.6 集成 Seata
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#47" class="md-nav__link">
    <span class="md-ellipsis">
      
        4.7 总结
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5_7" class="md-nav__link">
    <span class="md-ellipsis">
      
        5. 全局锁
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        6. 全局事务的边界选择
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7_2" class="md-nav__link">
    <span class="md-ellipsis">
      
        7. 本地事务失效的常见场景
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8" class="md-nav__link">
    <span class="md-ellipsis">
      
        8. 分布式事务失效问题
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#16-xxj-job" class="md-nav__link">
    <span class="md-ellipsis">
      
        16. Xxj-Job
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="16. Xxj-Job">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1_25" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. 概述
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2_22" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. 使用
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h2 id="springboot">一 Springboot</h2>
<h3 id="1-spring-boot">1. Spring Boot的概念、功能</h3>
<pre><code>简单来说，Spring Boot 能让你**快速创建、配置和运行 Spring 应用**，无需手动添加大量 XML 配置或繁琐的依赖管理。以前用 Spring 写 Web 项目，要配 `web.xml`、Dispatcher Serverlet、Spring 容器……一大堆配置。

现在用 Spring Boot，你只需要：

1. 加个 `spring-boot-starter-web` 依赖，
2. 写个 `@SpringBootApplication` 注解的主类，
3. 运行 `main` 方法 —— 项目就跑起来了！
</code></pre>
<h3 id="2">2. 场景启动器</h3>
<pre><code>Starters are a set of convenient dependency descriptors that you can include in your application. You get a one-stop shop for all the Spring and related technologies that you need without having to hunt through sample code and copy-paste loads of dependency descriptors. For example, if you want to get started using Spring and JPA for database access, include the `spring-boot-starter-data-jpa` dependency in your project.

启动器是一组方便的依赖项描述符，您可以将其包含在应用程序中。您可以在一个地方获取所有需要的 Spring 及相关技术，而无需在示例代码中搜寻并复制粘贴大量的依赖项描述符。例如，如果您想开始使用 Spring 和 JPA 进行数据库访问，请在项目中包含 `spring-boot-starter-data-jpa` 依赖项。

The starters contain a lot of the dependencies that you need to get a project up and running quickly and with a consistent, supported set of managed transitive dependencies.

这些启动器包含大量您需要的依赖项，能让您快速启动项目，并且拥有一套一致且受支持的受管传递依赖项。
</code></pre>
<h3 id="3">3.  自动配置</h3>
<h4 id="31">3.1 概念</h4>
<h4 id="32">3.2 核心流程</h4>
<pre><code>1. 创建项目
2. 选择场景启动器
3. 场景启动器一导入，就从META-INF/spring.org.springframework.boot.autoconfigure .AutoConfiguration.imports下面导入一堆自动配置类到spring容器中。
4. 这些 xxxAutoConfiguration 基于 @Conditional 注解有导入了一堆的组件
5. 之后业务就可以使用这些组件了
</code></pre>
<h4 id="33-datasourceautoconfiguration">3.3 DataSourceAutoConfiguration 的导入流程</h4>
<pre><code>6. 在使用之前，自动配置类把组件配置到容器中，要做两件事

    6.1把属性类和配置文件进行绑定
    6.2：把组件要用到的所有属性，也就是这个属性类放到容器中
</code></pre>
<h3 id="4">4. 常用基本功能</h3>
<h4 id="1-configurationproperties">1. 属性绑定 @ConfigurationProperties</h4>
<div class="highlight"><pre><span></span><code><span class="nd">@Data</span>
<span class="nd">@Component</span>
<span class="nd">@ConfigurationProperties</span><span class="p">(</span><span class="n">prefix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;dog&quot;</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DogProperties</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">age</span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">sex</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 配置文件</span>
<span class="nl">dog</span><span class="p">:</span>
<span class="w">  </span><span class="n">age</span><span class="p">:</span><span class="w"> </span><span class="mi">18</span>
<span class="w">  </span><span class="n">name</span><span class="p">:</span><span class="w"> </span><span class="n">旺财</span>
<span class="w">  </span><span class="n">sex</span><span class="p">:</span><span class="w"> </span><span class="n">雄性</span>
</code></pre></div>
<h4 id="2-yaml">2. yaml语法</h4>
<pre><code>1.  yaml语法都是 key : value
2.  一个对象就是多个 key : value, 也可以用: {name: 小咪, age: 18}  表示
3.  数据可以用[i1, i2, i3]表示,也可以用 - i1, -i2 表示

注:如果同时存在.properties与.yaml,优先使用.properties下的配置
</code></pre>
<div class="highlight"><pre><span></span><code><span class="nt">person</span><span class="p">:</span><span class="w">  </span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">李四</span><span class="w">  </span>
<span class="w">  </span><span class="nt">age</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">18</span><span class="w">  </span>
<span class="w">  </span><span class="nt">birthday</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2019/01/01 00:00:00</span><span class="w">  </span>
<span class="w">  </span><span class="nt">like</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span>
<span class="w">  </span><span class="nt">child</span><span class="p">:</span><span class="w">  </span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">张三</span><span class="w">  </span>
<span class="w">    </span><span class="nt">age</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10</span><span class="w">  </span>
<span class="w">    </span><span class="nt">birthday</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2018/01/01 00:00:00</span><span class="w">  </span>
<span class="w">  </span><span class="nt">dogs</span><span class="p">:</span><span class="w">  </span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">旺财</span><span class="w">  </span>
<span class="w">      </span><span class="nt">age</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">18</span><span class="w">  </span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">旺财2</span><span class="w">  </span>
<span class="w">      </span><span class="nt">age</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">18</span><span class="w">  </span>
<span class="w">  </span><span class="nt">cats</span><span class="p">:</span><span class="w">  </span>
<span class="w">    </span><span class="nt">cat1</span><span class="p">:</span><span class="w">  </span>
<span class="w">      </span><span class="p p-Indicator">{</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="nv">小咪</span><span class="p p-Indicator">,</span><span class="nt"> age</span><span class="p">:</span><span class="w"> </span><span class="nv">18</span><span class="p p-Indicator">}</span><span class="w">  </span>
<span class="w">    </span><span class="nt">cat2</span><span class="p">:</span><span class="w">  </span>
<span class="w">      </span><span class="p p-Indicator">{</span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="nv">小咪2</span><span class="p p-Indicator">,</span><span class="nt"> age</span><span class="p">:</span><span class="w"> </span><span class="nv">18</span><span class="p p-Indicator">}</span>
</code></pre></div>
<h4 id="3-banner">3. 自定义banner</h4>
<pre><code>通过修改 spring.banner.location=classpath:banner.txt 去自定义bannner
</code></pre>
<h4 id="4-springapplication">4. 启动 SpringApplication 的其他方法</h4>
<pre><code>第一种就是先把 SpringApplication 对象实例化出来,然后调用它的run方法,这样的好处是可以做一些配置.
</code></pre>
<p><code>java
public static void main(String[] args) {  

       // 1. 创建SpringApplication对象  
       SpringApplication app = new SpringApplication(SpringbootDemoApplication.class);  

       // 2. 配置  
       app.setBannerMode(Banner.Mode.OFF);  

       // 3. 启动SpringApplication对象  
       app.run(args);  
   }</code></p>
<pre><code>第二种方法就是通过 SpringApplicationBuilder 来链式启动 Spring 应用.
</code></pre>
<p><code>java
builder.sources(SpringbootDemoApplication.class)  
        .bannerMode(Banner.Mode.OFF)  
        .run(args);</code></p>
<h4 id="5">5. 日志</h4>
<pre><code>日志系统描述:
</code></pre>
<p>![[Pasted image 20251102093346.png]]</p>
<h5 id="51">5.1 日志的级别</h5>
<pre><code>All --&gt; Trace --&gt; DEBUG --&gt; INFO --&gt; WARN --&gt; ERROR --&gt; OFF
从低到高,越打印,越粗糙.日志的默认级别(info),只会打印日志级别及其以上的日志.
</code></pre>
<p><code>logging.level.root=debug
logging.level.xx包的全类名=xx级别</code></p>
<h5 id="52">5.2 日志的使用方式</h5>
<pre><code>首先，先导入日志的场景启动器
</code></pre>
<p><code>java
&lt;dependency&gt;  
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;  
    &lt;artifactId&gt;spring-boot-starter-logging&lt;/artifactId&gt;  
&lt;/dependency&gt;</code></p>
<pre><code>方法1:直接通过日志工厂获得一个工厂类
</code></pre>
<p><code>java
@SpringBootTest  
public class LoggingTest {  

    // 获得一个日志  
    Logger logger = LoggerFactory.getLogger(LoggingTest.class);  

    @Test  
    public void test01(){  
        logger.trace("trace...");  
        logger.debug("debug...");  
        logger.info("info...");  
        logger.warn("warn...");  
        logger.error("error...");  
    }  
}</code></p>
<pre><code>方法2:lombok的 @Slf4j 注解会自动注册并注入一个日志类,名字为log,我们直接调log就可以.
</code></pre>
<p><code>java
@Slf4j  
@SpringBootTest  
public class LoggingTest {  

    @Test  
    public void test01(){  
        log.trace("trace...");  
        log.debug("debug...");  
        log.info("info...");  
        log.warn("warn...");  
        log.error("error...");  
    }  
}</code></p>
<h5 id="53">5.3 日志分组</h5>
<pre><code>日志分组能够更加细粒度的控制不同包,不同类的日志级别,也就是对每一组统一来控制级别
</code></pre>
<p><code>java
logging.group.group1=全类名1,全类名2,...</code></p>
<h5 id="54">5.4 日志输出到文件</h5>
<p>![[Pasted image 20251102100745.png]]</p>
<h5 id="55">5.5 日志归档与滚动切割</h5>
<pre><code>Spring Boot 项目中通过 `application.yml` 或 `application.properties` 配置 Logback 的日志滚动策略，实现日志文件的自动切割与归档。
</code></pre>
<table>
<thead>
<tr>
<th>配置项</th>
<th>说明</th>
<th>推荐值/示例</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>logging.logback.rollingpolicy.clean-history-on-start</code></td>
<td>是否在应用启动时清理旧的日志归档文件</td>
<td><code>false</code>（建议设为 <code>false</code>，避免误删历史日志）</td>
</tr>
<tr>
<td><code>logging.logback.rollingpolicy.file-name-pattern</code></td>
<td>归档日志文件的命名格式</td>
<td><code>app-%d{yyyy-MM-dd}.log</code>（按天切割）</td>
</tr>
<tr>
<td><code>logging.logback.rollingpolicy.max-file-size</code></td>
<td>单个日志文件的最大大小，超过则触发滚动</td>
<td><code>2MB</code>（可根据项目日志量调整）</td>
</tr>
<tr>
<td><code>logging.logback.rollingpolicy.max-history</code></td>
<td>保留归档日志文件的最大天数（或数量）</td>
<td><code>7</code>（保留最近7天的日志）</td>
</tr>
</tbody>
</table>
<pre><code>配置演示:
</code></pre>
<p>```yaml
logging:
  logback:
    rollingpolicy:
      # 是否在应用启动时删除旧的归档日志
      clean-history-on-start: false

      # 归档日志文件名格式：按日期切割
      file-name-pattern: app-%d{yyyy-MM-dd}.log

      # 每个日志文件最大 2MB，超过则创建新文件
      max-file-size: 2MB

      # 最多保留 7 天的历史日志文件
      max-history: 7
````

</p>
<h5 id="56">5.6 引入日志框架自己的配置文件</h5>
<p>``` </p>
<?xml version="1.0" encoding="UTF-8"?>
<p><configuration>  </p>
<pre><code>&lt;contextName&gt;logback&lt;/contextName&gt;

&lt;!-- 日志的输出目录 --&gt;  
&lt;property name="log.path" value="D://work//tingshu_work//logs" /&gt;

&lt;!--控制台日志格式：彩色日志--&gt;  
&lt;!-- magenta:洋红 --&gt;  
&lt;!-- boldMagenta:粗红--&gt;  
&lt;!-- cyan:青色 --&gt;  
&lt;!-- white:白色 --&gt;  
&lt;!-- magenta:洋红 --&gt;  
&lt;property name="CONSOLE_LOG_PATTERN"  
          value="%yellow(%date{yyyy-MM-dd HH:mm:ss}) %highlight([%-5level]) %green(%logger) %msg%n"/&gt;

&lt;!--文件日志格式--&gt;  
&lt;property name="FILE_LOG_PATTERN"  
          value="%date{yyyy-MM-dd HH:mm:ss} [%-5level] %thread %file:%line %logger %msg%n" /&gt;

&lt;!--编码--&gt;  
&lt;property name="ENCODING" value="UTF-8" /&gt;

&lt;!-- 控制台日志 --&gt;  
&lt;appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender"&gt;  
    &lt;!-- 临界值过滤器 --&gt;  
    &lt;filter class="ch.qos.logback.classic.filter.ThresholdFilter"&gt;  
        &lt;level&gt;INFO&lt;/level&gt;  
    &lt;/filter&gt;        &lt;encoder&gt;            &lt;pattern&gt;${CONSOLE_LOG_PATTERN}&lt;/pattern&gt;  
        &lt;charset&gt;${ENCODING}&lt;/charset&gt;  
    &lt;/encoder&gt;    &lt;/appender&gt;  
&lt;!-- 文件日志 --&gt;  
&lt;appender name="FILE" class="ch.qos.logback.core.FileAppender"&gt;  
    &lt;file&gt;${log.path}//log.log&lt;/file&gt;  
    &lt;append&gt;true&lt;/append&gt;  
    &lt;encoder&gt;            &lt;pattern&gt;%date{yyyy-MM-dd HH:mm:ss} %msg%n&lt;/pattern&gt;  
        &lt;charset&gt;${ENCODING}&lt;/charset&gt;  
    &lt;/encoder&gt;    &lt;/appender&gt;  
&lt;!-- logstash日志 --&gt;
</code></pre>
<!--    <appender name="LOGSTASH" class="net.logstash.logback.appender.LogstashTcpSocketAppender">-->
<!--        &lt;!&ndash; logstash ip和暴露的端口，logback就是通过这个地址把日志发送给logstash &ndash;&gt;-->
<!--        <destination>139.198.127.41:8044</destination>-->
<!--        <encoder charset="UTF-8" class="net.logstash.logback.encoder.LogstashEncoder" />-->
<!--    </appender>-->

<pre><code>&lt;!-- 开发环境 --&gt;  
&lt;springProfile name="dev"&gt;  
    &lt;!-- com.atguigu日志记录器：业务程序INFO级别  --&gt;  
    &lt;logger name="com.atguigu" level="INFO" /&gt;  
    &lt;!-- 根日志记录器：INFO级别  --&gt;  
    &lt;root level="INFO"&gt;  
        &lt;appender-ref ref="CONSOLE" /&gt;
</code></pre>
<!--            <appender-ref ref="FILE" />-->
<p></root><br />
    </springProfile><br />
</configuration>
<div class="highlight"><pre><span></span><code>##### 5.7 总结

    在我们使用日志时,步骤可以总结为下:
        1. 如果不需要切换底层日志框架logback,就可以直接去写配置文件了,包括日志级别 
        2. 记录日志:(在合适的时间,合适的级别记录日志就可以了)log.xxx


## 二 Spring Boot 的进阶使用

### 1. Profiles 环境隔离

      为项目设立多个环境（如开发 `dev`、测试 `test`、生产 `prod`），实现不同环境下配置的快速切换。

    实现流程:
      1. 定义不同环境：
    创建特定于环境的配置文件，命名格式为 application-{profile}.properties 或 application-{profile}.yml。
     示例：
       application-dev.yml(开发环境)
       application-test.yml(测试环境)
       application-prod.yml(生产环境)

      2. 指定环境特定的配置：
     在 application-{profile}.yml 文件中，配置该环境下特有的属性（如数据库连接、日志级别、服务地址等）。
     可以在这些文件中定义或覆盖在主配置文件中声明的Bean。

      3. 激活指定环境：
     在主配置文件 application.yml (或 application.properties) 中，通过 spring.profiles.active 属性来激活某个环境。
     示例 (在 application.yml 中)：
```yaml
spring:
    profiles:
        active: dev # 激活开发环境配置
</code></pre></div>
     也可以通过命令行参数、环境变量等方式激活，例如：
       命令行：java -jar myapp.jar --spring.profiles.active=prod
       环境变量：SPRING_PROFILES_ACTIVE=prod</p>
<h3 id="2_1">2. 单元测试</h3>
<h4 id="21">2.1 一些常用的方法</h4>
<pre><code>✅ 提示：优先使用 `@DisplayName` 提升测试可读性；合理使用 `@Tag` 实现测试分组。
</code></pre>
<table>
<thead>
<tr>
<th>注解</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>@Test</code></td>
<td>标记为测试方法</td>
</tr>
<tr>
<td><code>@ParameterizedTest</code></td>
<td>支持参数化测试</td>
</tr>
<tr>
<td><code>@RepeatedTest</code></td>
<td>方法可重复执行指定次数</td>
</tr>
<tr>
<td><code>@DisplayName</code></td>
<td>设置测试类或方法的展示名称</td>
</tr>
<tr>
<td><code>@BeforeEach</code></td>
<td>每个测试前执行（如初始化）</td>
</tr>
<tr>
<td><code>@AfterEach</code></td>
<td>每个测试后执行（如清理资源）</td>
</tr>
<tr>
<td><code>@BeforeAll</code></td>
<td>所有测试前执行一次（需 static）</td>
</tr>
<tr>
<td><code>@AfterAll</code></td>
<td>所有测试后执行一次（需 static）</td>
</tr>
<tr>
<td><code>@Tag</code></td>
<td>为测试打标签，用于分类筛选</td>
</tr>
<tr>
<td><code>@Disabled</code></td>
<td>跳过该测试（类似 @Ignore）</td>
</tr>
<tr>
<td><code>@Timeout</code></td>
<td>设置超时时间，超过则失败</td>
</tr>
<tr>
<td><code>@ExtendWith</code></td>
<td>引入扩展类，支持自定义行为</td>
</tr>
</tbody>
</table>
<h4 id="22">2.2 断言机制</h4>
<pre><code>断言用于验证测试结果是否符合预期，是单元测试的核心。
</code></pre>
<h5 id="1-orgjunitjupiterapiassertions">1. 常用断言方法（<code>org.junit.jupiter.api.Assertions</code>）</h5>
<table>
<thead>
<tr>
<th>方法</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>assertEquals(expected, actual)</code></td>
<td>检查两值是否相等</td>
</tr>
<tr>
<td><code>assertNotEquals(unexpected, actual)</code></td>
<td>检查两值是否不相等</td>
</tr>
<tr>
<td><code>assertTrue(condition)</code></td>
<td>检查条件是否为真</td>
</tr>
<tr>
<td><code>assertFalse(condition)</code></td>
<td>检查条件是否为假</td>
</tr>
<tr>
<td><code>assertNull(object)</code></td>
<td>检查对象是否为 null</td>
</tr>
<tr>
<td><code>assertNotNull(object)</code></td>
<td>检查对象是否不为 null</td>
</tr>
<tr>
<td><code>assertArrayEquals(expectedArray, actualArray)</code></td>
<td>检查数组是否相等</td>
</tr>
<tr>
<td><code>assertThrows(Exception.class, () -&gt; { ... })</code></td>
<td>验证是否抛出指定异常</td>
</tr>
<tr>
<td><code>assertTimeout(Duration.ofSeconds(1), () -&gt; { ... })</code></td>
<td>验证代码块是否在规定时间内执行</td>
</tr>
<tr>
<td><code>assertAll("group", () -&gt; { ... })</code></td>
<td>分组断言，可执行多个断言并收集所有失败信息</td>
</tr>
</tbody>
</table>
<h5 id="2_2">2. 高级特性</h5>
<ul>
<li>
<p><strong>消息延迟加载</strong>：<br />
<code>assertEquals(expected, actual, () -&gt; "自定义错误信息")</code><br />
  只有断言失败时才会生成消息，提升性能。</p>
</li>
<li>
<p><strong>分组断言（Grouped Assertions）</strong>：<br />
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="n">assertAll</span><span class="p">(</span><span class="s">&quot;用户信息校验&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">assertEquals</span><span class="p">(</span><span class="s">&quot;Tom&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getName</span><span class="p">()),</span>
<span class="w">      </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">assertEquals</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="n">user</span><span class="p">.</span><span class="na">getAge</span><span class="p">()),</span>
<span class="w">      </span><span class="p">()</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">assertNotNull</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span>
</code></pre></div></p>
</li>
</ul>
<h3 id="3-actuator">3. Actuator</h3>
<pre><code>通过导入 `spring-boot-starter-actuator` 场景启动器，可以轻松监控和管理 Spring Boot 应用的运行状态。
</code></pre>
<h4 id="31_1">3.1 功能</h4>
<ul>
<li>提供生产级的<strong>监控端点</strong>（endpoints），用于观测应用健康、指标、环境等信息。</li>
<li>支持与外部系统集成（如 Prometheus、Grafana、Zipkin 等）。</li>
</ul>
<h4 id="32_1">3.2 使用步骤</h4>
<ol>
<li><strong>添加依赖</strong>（Maven）
<div class="highlight"><pre><span></span><code><span class="w">   </span><span class="nt">&lt;dependency&gt;</span>
<span class="w">       </span><span class="nt">&lt;groupId&gt;</span>org.springframework.boot<span class="nt">&lt;/groupId&gt;</span>
<span class="w">       </span><span class="nt">&lt;artifactId&gt;</span>spring-boot-starter-actuator<span class="nt">&lt;/artifactId&gt;</span>
<span class="w">   </span><span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></li>
<li><strong>访问内置端点</strong>：http://localhost:8080/actuator/{endpoint}</li>
<li>
<p><strong>启用与暴露端点</strong>
<div class="highlight"><pre><span></span><code><span class="nt">management</span><span class="p">:</span>
<span class="w">  </span><span class="nt">endpoints</span><span class="p">:</span>
<span class="w">    </span><span class="nt">web</span><span class="p">:</span>
<span class="w">      </span><span class="nt">exposure</span><span class="p">:</span>
<span class="w">        </span><span class="nt">include</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;*&#39;</span><span class="w">  </span><span class="c1"># 暴露所有端点（生产慎用）</span>
<span class="w">        </span><span class="c1"># include: health,info  # 推荐：仅暴露必要端点</span>
<span class="w">  </span><span class="nt">endpoint</span><span class="p">:</span>
<span class="w">    </span><span class="nt">health</span><span class="p">:</span>
<span class="w">      </span><span class="nt">show-details</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">always</span><span class="w">  </span><span class="c1"># 显示健康详情</span>
</code></pre></div></p>
</li>
<li>
<p><strong>自定义 <code>info</code> 端点</strong>
<div class="highlight"><pre><span></span><code><span class="nt">info</span><span class="p">:</span>
<span class="w">  </span><span class="nt">app</span><span class="p">:</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">MyApp</span>
<span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0.0</span>
<span class="w">    </span><span class="nt">author</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Alice</span>
</code></pre></div></p>
</li>
</ol>
<h3 id="4-">4. 生命周期 -- 监听器感知生命周期</h3>
<p>![[Pasted image 20251102152652.png]]</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Slf4j</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyListener</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">SpringApplicationRunListener</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">starting</span><span class="p">(</span><span class="n">ConfigurableBootstrapContext</span><span class="w"> </span><span class="n">bootstrapContext</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;starting&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">environmentPrepared</span><span class="p">(</span><span class="n">ConfigurableBootstrapContext</span><span class="w"> </span><span class="n">bootstrapContext</span><span class="p">,</span><span class="w"> </span><span class="n">ConfigurableEnvironment</span><span class="w"> </span><span class="n">environment</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;environmentPrepared&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">contextPrepared</span><span class="p">(</span><span class="n">ConfigurableApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;contextPrepared&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">contextLoaded</span><span class="p">(</span><span class="n">ConfigurableApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;contextLoaded&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">started</span><span class="p">(</span><span class="n">ConfigurableApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="w"> </span><span class="n">timeTaken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;started&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">ready</span><span class="p">(</span><span class="n">ConfigurableApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Duration</span><span class="w"> </span><span class="n">timeTaken</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;ready&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">failed</span><span class="p">(</span><span class="n">ConfigurableApplicationContext</span><span class="w"> </span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="n">Throwable</span><span class="w"> </span><span class="n">exception</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;failed&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div>
<h4 id="41-">4.1 生命周期-事件</h4>
<pre><code>Spring Boot 提供了完整的生命周期管理机制，通过监听器（Listener）可以感知应用启动和关闭的关键阶段。
如果项目启动前做事： BootstrapRegistryInitializer和ApplicationContextInitializer
如果想要在项目启动完成后做事：ApplicationRunner和CommandLineRunner
如果要干涉生命周期做事：SpringApplicationRunListener
如果想要用事件机制：ApplicationListener
</code></pre>
<p>![[Pasted image 20251102160053.png]]</p>
<pre><code>什么是基于事件驱动开发：事件驱动开发（Event-Driven Development） 是一种编程范式，其核心思想是：系统的行为由事件的产生和响应来驱动。当某个特定事件发生时，系统会自动触发预先注册的监听器或处理器进行处理。

事件驱动开发的流程：
1. 自定义事件：继承 ApplicationEvent，携带响应得业务数据
2. 根据特定业务发布事件 publisher.publishEvent()
3. 系统中预先定义的事件监听器(@EventListener)就会监听事件，然后对这个事件做出响应 
4. 之后，就可以自己设定是同步还是异步处理（@Async,同时记得开启异步处理)
</code></pre>
<p>实现方式：注解形式</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Component</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyEventMonitor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@EventListener</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleReady</span><span class="p">(</span><span class="n">ApplicationReadyEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;✅ 应用启动完成！&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@EventListener</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">handleStart</span><span class="p">(</span><span class="n">ApplicationStartedEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;🚀 应用已启动，正在执行 Runner...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>实现方式：接口形式
<div class="highlight"><pre><span></span><code><span class="nd">@Component</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyEventListener</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">ApplicationListener</span><span class="o">&lt;</span><span class="n">ApplicationReadyEvent</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">onApplicationEvent</span><span class="p">(</span><span class="n">ApplicationReadyEvent</span><span class="w"> </span><span class="n">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;应用已就绪，开始处理请求...&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>代码演示：传统开发方式--同步阻塞开发</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Slf4j</span><span class="w">  </span>
<span class="nd">@RestController</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserController</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="c1">// 传统开发方式  </span>
<span class="w">    </span><span class="c1">// 注入一堆service,然后去调方法  </span>
<span class="w">    </span><span class="nd">@Autowired</span><span class="w">  </span>
<span class="w">    </span><span class="n">UserPointsService</span><span class="w"> </span><span class="n">userPointsService</span><span class="p">;</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@Autowired</span><span class="w">  </span>
<span class="w">    </span><span class="n">CouponService</span><span class="w"> </span><span class="n">couponService</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterLogin</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">){</span><span class="w">  </span>
<span class="w">        </span><span class="c1">//1. 登录成功  </span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;登录成功&quot;</span><span class="p">);</span><span class="w">  </span>

<span class="w">        </span><span class="c1">//2. 给用户发送优惠券  </span>
<span class="w">        </span><span class="n">couponService</span><span class="p">.</span><span class="na">sendCoupon</span><span class="p">(</span><span class="n">username</span><span class="p">);</span><span class="w">  </span>

<span class="w">        </span><span class="c1">//3. 给用户发积分  </span>
<span class="w">        </span><span class="n">userPointsService</span><span class="p">.</span><span class="na">addUserPoints</span><span class="p">(</span><span class="n">username</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div>
<p>代码演示：事件驱动开发方式
<div class="highlight"><pre><span></span><code><span class="c1">// 事件驱动开发方式</span>
<span class="o">----------------------------------</span><span class="n">userController</span><span class="o">--------------------------------</span>
<span class="nd">@Autowired</span><span class="w">  </span>
<span class="n">ApplicationEventPublisher</span><span class="w"> </span><span class="n">applicationEventPublisher</span><span class="p">;</span><span class="w">  </span>

<span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/login&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">afterLogin</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">){</span><span class="w">  </span>
<span class="w">    </span><span class="c1">// 1. 登录成功  </span>
<span class="w">    </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;登录成功&quot;</span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 2. 发送登录成功事件  </span>
<span class="w">    </span><span class="n">applicationEventPublisher</span><span class="p">.</span><span class="na">publishEvent</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">UserLoginSuccessEvent</span><span class="p">(</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">));</span><span class="w">  </span>
<span class="p">}</span>


<span class="o">---------------------------------</span><span class="n">CouponService</span><span class="o">--------------------------------</span>
<span class="nd">@Slf4j</span><span class="w">  </span>
<span class="nd">@Service</span><span class="w">  </span>
<span class="nd">@EnableAsync</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CouponService</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@Async</span><span class="w">  </span>
<span class="w">    </span><span class="nd">@EventListener</span><span class="p">(</span><span class="n">UserLoginSuccessEvent</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">listener</span><span class="p">(</span><span class="n">UserLoginSuccessEvent</span><span class="w"> </span><span class="n">event</span><span class="p">){</span><span class="w">  </span>
<span class="w">        </span><span class="n">sendCoupon</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getUsername</span><span class="p">());</span><span class="w">  </span>

<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendCoupon</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">userName</span><span class="p">){</span><span class="w">  </span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;给用户{}发送优惠券&quot;</span><span class="p">,</span><span class="n">userName</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>

<span class="w"> </span><span class="o">-----------------------------------</span><span class="n">UserPointsService</span><span class="o">------------------------------</span>
<span class="nd">@Slf4j</span><span class="w">  </span>
<span class="nd">@Service</span><span class="w">  </span>
<span class="nd">@EnableAsync</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserPointsService</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@Async</span><span class="w">  </span>
<span class="w">    </span><span class="nd">@EventListener</span><span class="p">(</span><span class="n">UserLoginSuccessEvent</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">  </span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">listener</span><span class="p">(</span><span class="n">UserLoginSuccessEvent</span><span class="w"> </span><span class="n">event</span><span class="p">){</span><span class="w">  </span>
<span class="w">        </span><span class="n">addUserPoints</span><span class="p">(</span><span class="n">event</span><span class="p">.</span><span class="na">getUsername</span><span class="p">());</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 添加积分  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">addUserPoints</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="p">){</span><span class="w">  </span>
<span class="w">      </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;用户：{} 添加积分&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">username</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div></p>
<h2 id="_1">三 总结以及扩展</h2>
<h3 id="31_2">3.1 总结</h3>
<p>![[Pasted image 20251102174854.png]]</p>
<h3 id="32_2">3.2 自定义场景启动器</h3>
<pre><code>该功能的目的是把我们得一些功能抽取出来，写成一个xxx-spring-boot-starter(官方规定得第三方启动器名称)
1.所有自定义得starter都需要依赖公共得spring-boot-starter
2.第一层抽取：编写一个自动配置类,别人导入我的 starter 无需关系需要给容器中导入那些组件，只需要导入自动配置类。该类自动的注册该场景所用到的所有组件。
3.第二层抽取：别人不需要用 @Import 导入配置类，只需要标注功能开关注解 @Enablexxx 就能使用。
4.第三层抽取：只需要导入 starter，然后所有功能就会就绪
</code></pre>
<h3 id="33">3.3 重点源码</h3>
<h4 id="1-springboot">1. SpringBoot 自动配置</h4>
<h4 id="2-springmvc-dispatcherservlet">2. SpringMvc DispatcherServlet 流程</h4>
<h4 id="3-spring-ioc">3. Spring Ioc（三级缓存）</h4>
<h4 id="4-spring-transactionmanager-transactioninterceptor">4. Spring 事务原理 （TransactionManager + TransactionInterceptor)</h4>
<p>​   </p>
<h2 id="git">四 Git</h2>
<pre><code>日期：2025年11月3日
</code></pre>
<h4 id="1-git">1. Git 的概念和作用</h4>
<pre><code>Git 是一个分布式版本控制系统，用于跟踪文件的变更历史，支持多人协作开发。
</code></pre>
<h4 id="2-git">2. git 工作流程</h4>
<pre><code>工作区 → 暂存区 → 本地仓库
工作区：正在编辑的文件所在目录。
暂存区：使用 git add 命令将修改加入暂存区，准备提交。
本地仓库：使用 git commit 将暂存区内容提交到本地版本库。
</code></pre>
<p>![[Pasted image 20251103095619.png]]</p>
<h4 id="3-git">3. git 的常用命令</h4>
<ol>
<li>
<p>配置 git 的账户与邮箱
<div class="highlight"><pre><span></span><code>git config -- user.name liutianba
git config -- user.email liutianba7@163.com
</code></pre></div></p>
</li>
<li>
<p>初始化仓库
<div class="highlight"><pre><span></span><code>git init
</code></pre></div></p>
</li>
<li>
<p>将工作区的文件加入到暂存区
<div class="highlight"><pre><span></span><code>git add filename
git add . # 将工作区不再暂存区的文件全部加入到暂存区
git status # 查看文件状态（在不在缓存区）
</code></pre></div></p>
</li>
<li>
<p>查看本地仓库信息
<div class="highlight"><pre><span></span><code>git log # 查看提交记录
git reflog # 查看提交记录（精简版，可选项 -n x)
</code></pre></div></p>
</li>
<li>
<p>版本回滚
<div class="highlight"><pre><span></span><code>git reset -- hard 版本号
细节：git 回滚的头指针不会直接移回去，还是往前走，新结点是之前回滚版本的一个复制
</code></pre></div></p>
</li>
</ol>
<h4 id="4-git">4. git 分支</h4>
<pre><code>Git 分支管理是 Git 强大功能之一，能够让多个开发人员并行工作，开发新功能、修复 bug 或进行实验，而不会影响主代码库。几乎每一种版本控制系统都以某种形式支持分支，一个分支代表一条独立的开发线。
使用分支意味着你可以从开发主线上分离开来，然后在不影响主线的同时继续工作。
</code></pre>
<p>![[Pasted image 20251103104230.png]]</p>
<p>![[Pasted image 20251103104921.png]]</p>
<ol>
<li>
<p>创建分支
<div class="highlight"><pre><span></span><code>git branch 分支名
git branch -v // 查看分支
</code></pre></div></p>
</li>
<li>
<p>切换分支
<div class="highlight"><pre><span></span><code>git checkout 分支名
git checkout -b 分支名 // 切换并创建分支
</code></pre></div></p>
</li>
<li>
<p>合并分支</p>
<pre><code>一旦某分支有了独立内容，你终究会希望将它合并回到你的主分支。 你可以使用以下命令将任何分支合并到当前分支中去：
</code></pre>
<p><code>git merge 分支名 //把指定的分支合并到当前分支</code></p>
</li>
<li>
<p>删除分支
<div class="highlight"><pre><span></span><code>git branch -d 分支名
</code></pre></div></p>
</li>
</ol>
<h4 id="5-git">5. git 冲突</h4>
<pre><code> 当在合并分支时，出现同名文件同行内容不同的话，就会出现合并冲突，而解决方式就是去手动的选择要哪个分支上的内容，然后再去将当前工作区提交到本地仓库即可。
</code></pre>
<div class="highlight"><pre><span></span><code>git merge xxx
git add .
git commit -m &quot;解决合并冲突&quot;
</code></pre></div>
<h4 id="6-git">6. git 远程仓库</h4>
<pre><code>在远程仓库中，推送和拉去是以分支为单位的
</code></pre>
<h5 id="61-ssh">6.1 Ssh配置</h5>
<pre><code>使用 SSH 协议连接 Git 远程仓库，可实现免密推送/拉取代码，并提升安全性。流程：每次去访问远程仓库时，git 都会从指定位置带着密钥过去，而这个位置可以自己制定，在.ssh的配置文件下，这样就可以完成：不同远程仓库指定的密钥是不同的。
</code></pre>
<ol>
<li>
<p>生成 SSH 密钥对
<div class="highlight"><pre><span></span><code>ssh-keygen -t ed25519 -C &quot;your_email@example.com
</code></pre></div></p>
</li>
<li>
<p>启动 SSH 代理并添加私钥
<div class="highlight"><pre><span></span><code># 启动 ssh-agent
eval &quot;$(ssh-agent -s)&quot; 
# 将私钥添加到 
ssh-agent ssh-add ~/.ssh/id_ed25519
</code></pre></div></p>
</li>
<li>
<p>然后就可以把公钥放到远程仓库了</p>
</li>
</ol>
<h5 id="62-git">6.2 git 远程相关命令</h5>
<ol>
<li>
<p>关联和断开远程仓库
<div class="highlight"><pre><span></span><code>git remote add 别名 远程仓库的 ssh | https 地址
git remote -v # 查看远程仓库信息
git remote remove 别名 # 删除远程仓库
</code></pre></div></p>
</li>
<li>
<p>推送数据到远程仓库
<div class="highlight"><pre><span></span><code>git push 别名 本地分支名:远程分支名 # 没写远程分支名则在远程仓库建立一个同名的分支    
</code></pre></div></p>
</li>
<li>
<p>克隆远程仓库内容
<div class="highlight"><pre><span></span><code>git clone 远程仓库地址（1.创建远程仓库同名的一个文件夹 2.初始化仓库 3.关联远程仓库，默认名字为 origin，4.拉取现有远程仓库内容）
</code></pre></div></p>
</li>
<li>
<p>拉去远程仓库内容
<div class="highlight"><pre><span></span><code>git pull 别名 远程仓库中的分支名
</code></pre></div></p>
</li>
</ol>
<h5 id="63">6.3 配置推送忽略文件</h5>
<pre><code>java日常项目模板：
</code></pre>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">Compiled</span><span class="w"> </span><span class="kd">class</span> <span class="nc">file</span>
<span class="o">*</span><span class="p">.</span><span class="na">class</span>

<span class="err">#</span><span class="w"> </span><span class="n">Log</span><span class="w"> </span><span class="n">file</span>
<span class="o">*</span><span class="p">.</span><span class="na">log</span>

<span class="err">#</span><span class="w"> </span><span class="n">BlueJ</span><span class="w"> </span><span class="n">files</span>
<span class="o">*</span><span class="p">.</span><span class="na">ctxt</span>

<span class="err">#</span><span class="w"> </span><span class="n">Mobile</span><span class="w"> </span><span class="n">Tools</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="nf">Java</span><span class="w"> </span><span class="p">(</span><span class="n">J2ME</span><span class="p">)</span>
<span class="p">.</span><span class="na">mtj</span><span class="p">.</span><span class="na">tmp</span><span class="o">/</span>

<span class="err">#</span><span class="w"> </span><span class="n">Package</span><span class="w"> </span><span class="n">Files</span><span class="w"> </span><span class="err">#</span>
<span class="o">*</span><span class="p">.</span><span class="na">jar</span>
<span class="o">*</span><span class="p">.</span><span class="na">war</span>
<span class="o">*</span><span class="p">.</span><span class="na">nar</span>
<span class="o">*</span><span class="p">.</span><span class="na">ear</span>
<span class="o">*</span><span class="p">.</span><span class="na">zip</span>
<span class="o">*</span><span class="p">.</span><span class="na">tar</span><span class="p">.</span><span class="na">gz</span>
<span class="o">*</span><span class="p">.</span><span class="na">rar</span>

<span class="err">#</span><span class="w"> </span><span class="n">virtual</span><span class="w"> </span><span class="n">machine</span><span class="w"> </span><span class="n">crash</span><span class="w"> </span><span class="n">logs</span><span class="p">,</span><span class="w"> </span><span class="n">see</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//www.java.com/en/download/help/error_hotspot.xml</span>
<span class="n">hs_err_pid</span><span class="o">*</span>

<span class="err">#</span><span class="w"> </span><span class="n">IDE</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">Build</span><span class="w"> </span><span class="n">Files</span>
<span class="p">.</span><span class="na">classpath</span>
<span class="p">.</span><span class="na">project</span>
<span class="p">.</span><span class="na">settings</span>
<span class="n">target</span>
<span class="p">.</span><span class="na">idea</span>
<span class="o">*</span><span class="p">.</span><span class="na">iml</span>
</code></pre></div>
<pre><code>全局配置：首先，在任意位置写一个xxx.ignore，然后，在git的配置文件中应用该文件即可
</code></pre>
<div class="highlight"><pre><span></span><code>[core]
    excludesfile = **/xxx.ignore
</code></pre></div>
<h2 id="linux">五 Linux</h2>
<h3 id="1-linux">1. Linux 的文件目录</h3>
<p>![[Pasted image 20251103174627.png]]</p>
<div class="highlight"><pre><span></span><code><span class="n">a</span><span class="p">.</span><span class="w">  </span><span class="n">bin可执行系统命令文件夹</span>

<span class="n">b</span><span class="p">.</span><span class="w">  </span><span class="n">sbin</span><span class="w"> </span><span class="nf">超级用户</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="n">可执行命令文件夹</span>

<span class="n">c</span><span class="p">.</span><span class="w">  </span><span class="n">etc</span><span class="w"> </span><span class="n">系统配置文件夹位置</span><span class="p">,</span><span class="n">网络配置</span><span class="p">,</span><span class="n">用户配置等等</span>

<span class="n">d</span><span class="p">.</span><span class="w">  </span><span class="n">home</span><span class="w"> </span><span class="n">存放用户的主目录</span><span class="p">,</span><span class="n">每个用户都有一个对应的文件夹</span>

<span class="n">e</span><span class="p">.</span><span class="w">  </span><span class="n">root</span><span class="w"> </span><span class="nf">是超级用户</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="n">的主目录</span>

<span class="n">f</span><span class="p">.</span><span class="w">  </span><span class="kd">var</span><span class="w"> </span><span class="n">存放可变文件夹</span><span class="p">,</span><span class="n">例如</span><span class="p">:</span><span class="n">日志文件</span><span class="p">,</span><span class="n">数据库文件等</span>

<span class="n">g</span><span class="p">.</span><span class="w">  </span><span class="n">tmp</span><span class="w"> </span><span class="n">存放临时文件位置</span><span class="p">,</span><span class="n">可以清理</span>

<span class="n">h</span><span class="p">.</span><span class="w">  </span><span class="n">dev</span><span class="w"> </span><span class="n">存放设备文件</span><span class="p">,</span><span class="n">用户系统访问设备文件</span><span class="p">,</span><span class="n">例如</span><span class="p">:</span><span class="w"> </span><span class="n">键盘</span><span class="p">,</span><span class="n">打印机等等</span>

<span class="n">i</span><span class="p">.</span><span class="w">  </span><span class="n">boot</span><span class="w"> </span><span class="n">启动系统所需要的文件</span>

<span class="n">j</span><span class="p">.</span><span class="w">  </span><span class="n">opt</span><span class="w"> </span><span class="n">用于存放第三方引用</span><span class="p">,</span><span class="n">例如mysql和tomcat服务器软件等等</span>

<span class="n">k</span><span class="p">.</span><span class="w">  </span><span class="n">usr</span><span class="w"> </span><span class="n">存放系统可共享的资源</span><span class="p">,</span><span class="n">文档</span><span class="p">,</span><span class="n">软件等等</span>

<span class="n">l</span><span class="p">.</span><span class="w">  </span><span class="n">lib</span><span class="w"> </span><span class="n">系统启动需要的运行库文件</span>

<span class="n">m</span><span class="p">.</span><span class="w">  </span><span class="n">mnt</span><span class="w"> </span><span class="n">用于临时加载</span><span class="o">/</span><span class="n">挂载外部设备和系统文件</span><span class="w"> </span><span class="n">例如</span><span class="p">:</span><span class="w"> </span><span class="n">光盘</span><span class="p">,</span><span class="n">usb驱动等</span>
</code></pre></div>
<h3 id="2-vim">2. Vim 编辑文件</h3>
<h5 id="21-vim">2.1 vim 的三重模式</h5>
<pre><code>首先，用 vim 命令打开一个文件，它的模式默认是一般模式，通过 i / a / o 可以进入到编辑模式，当编辑完毕后，按 esc 可以返回一般模式，然后，再通过 : / / 从一般模式到了命令模式，来进行退出（:q)，退出并保存（:wq)，强制推出（:q!)等操作。
</code></pre>
<p>![[Pasted image 20251103180120.png]]</p>
<h4 id="22-vim">2.2 vim相关命令</h4>
<ol>
<li>
<p>查看当前目录文件
<div class="highlight"><pre><span></span><code>ls
ls<span class="w"> </span>-a<span class="w"> </span>
</code></pre></div></p>
</li>
<li>
<p>光标移动
<div class="highlight"><pre><span></span><code>n<span class="w"> </span>+<span class="w"> </span>G<span class="w"> </span>//<span class="w"> </span>移动到<span class="w"> </span>n<span class="w"> </span>行
G<span class="w"> </span>//<span class="w"> </span>移动到最后一行
gg<span class="w"> </span>//<span class="w"> </span>移动到页头
</code></pre></div></p>
</li>
<li>
<p>删除一行、word、字母
<div class="highlight"><pre><span></span><code>dd<span class="w"> </span>//<span class="w"> </span>删除一行<span class="w"> </span>
dnd<span class="w"> </span>//删除n行
dw<span class="w"> </span>//<span class="w"> </span>删除一个word
x<span class="w"> </span>/<span class="w"> </span>X<span class="w"> </span>//<span class="w"> </span>方向不同的删除字母
</code></pre></div></p>
</li>
<li>
<p>复制与粘贴
<div class="highlight"><pre><span></span><code>yy
yny
yw
p
</code></pre></div></p>
</li>
<li>
<p>进入编辑模式的方式</p>
</li>
</ol>
<p>![[Pasted image 20251103183536.png]]</p>
<div class="highlight"><pre><span></span><code>i 当前光标前
a 当前光标后
o 当前光标行的下一行
I 当前行最前
A 当前行最后
o 当前光标行的上一行
</code></pre></div>
<h4 id="23">2.3 命令模式下的一些指令</h4>
<ol>
<li>
<p>进入命令模式 
<div class="highlight"><pre><span></span><code>:
/
</code></pre></div></p>
</li>
<li>
<p>一些退出操作
<div class="highlight"><pre><span></span><code>q
wq
q!
</code></pre></div></p>
</li>
<li>
<p>查找
<div class="highlight"><pre><span></span><code>/word
</code></pre></div></p>
</li>
<li>
<p>显示行号
<div class="highlight"><pre><span></span><code>set nu
set nonu
</code></pre></div></p>
</li>
<li>
<p>全局替换！
<div class="highlight"><pre><span></span><code>%s/old/new/g
</code></pre></div></p>
</li>
</ol>
<h3 id="3-linux">3. Linux 核心命令</h3>
<h4 id="1">1. 开启、关闭服务器</h4>
<div class="highlight"><pre><span></span><code>roboot<span class="w"> </span>-h<span class="w"> </span>now
shutdown<span class="w"> </span>-h<span class="w"> </span>now
</code></pre></div>
<h4 id="2_3">2. 服务管理命令</h4>
<div class="highlight"><pre><span></span><code>//<span class="w"> </span>临时设置
systemctl<span class="w"> </span>start<span class="w"> </span>xxx
systemctl<span class="w"> </span>restart<span class="w"> </span>xxx
systemctl<span class="w"> </span>stop<span class="w">  </span>xxx
systemclt<span class="w"> </span>status<span class="w"> </span>xxx

//<span class="w"> </span>永久设置
systemctl<span class="w"> </span><span class="nb">enable</span><span class="w"> </span>xxx
systemctl<span class="w"> </span>disable<span class="w"> </span>xxx
systemctl<span class="w"> </span>is-enabled<span class="w"> </span>xxx
systemctl<span class="w"> </span>list-unit-files
</code></pre></div>
<h4 id="3_1">3. 文件相关命令</h4>
<h5 id="1-pwd-lp">1. pwd -[LP]</h5>
<pre><code>pwd：打印当前所在的工作完整路径 print working directory
</code></pre>
<div class="highlight"><pre><span></span><code><span class="nb">pwd</span><span class="w"> </span>//<span class="w"> </span>显示当前逻辑地址
<span class="nb">pwd</span><span class="w"> </span>-L<span class="w"> </span>//<span class="w"> </span>逻辑地址
<span class="nb">pwd</span><span class="w"> </span>-P<span class="w"> </span>//<span class="w"> </span>物理地址
</code></pre></div>
<pre><code>ls：ls命令来自英文单词list的缩写，中文译为“列出”，其功能是显示目录中的文件及其属性信息，是最常使用的Linux命令之‍一。 默认不添加任何参数的情况下，ls命令会列出当前工作目录中的文件信息，常与cd或pwd命令搭配使用，十分方便。带上参数后，我们可以做更多的事情。作为最基础、最频繁使用的命令，有必要仔细了解其常用功‍能。
</code></pre>
<h5 id="2-ls-a-l-s-s-t-ll">2. ls[-a -l -s -S -t ...] // ll</h5>
<div class="highlight"><pre><span></span><code>ls [-a -l] [值：文件夹名]
参数：-a 显示所有文件，包含隐藏文件 -l 详细罗列信息 -t 按创建时间排序 -S 按文件大小排序
</code></pre></div>
<h5 id="3-cd-pl">3. cd -[PL]</h5>
<pre><code>cd命令来自英文词组change directory的缩写，其功能是更改当前所处的工作目录，路径可以是绝对路径，也可以是相对路径，若省略不写则会跳转至当前使用者的家目‍录。
</code></pre>
<div class="highlight"><pre><span></span><code><span class="nb">cd</span><span class="w"> </span>参数<span class="w"> </span>目录名<span class="w">  </span>
—L<span class="w"> </span>:<span class="w"> </span>切换到软连接的位置
-P<span class="w"> </span>：切换到真正所在的位置
~<span class="w">  </span>：切换到当前用户的家目录<span class="w"> </span>等于<span class="w"> </span><span class="nb">cd</span>
-<span class="w"> </span>：切换到上一次所在目录
..<span class="w"> </span>：切换到上一级目录
</code></pre></div>
<h5 id="4-mkdir-mpvz">4. mkdir -[mpvz] 目录名</h5>
<pre><code>mkdir命令来自英文词组make directories的缩写，其功能是创建目录文件。该命令的使用简单，但需要注意，若要创建的目标目录已经存在，则会提示已存在而不继续创建，不覆盖已有文件。若目录不存在，但具有嵌套的依赖关系时，例如/Dir1/Dir2/Dir3/Dir4/Dir5，要想一次性创建则需要加入-p参数，进行递归操‍作。
</code></pre>
<p><code>shell
-m 创建目录的同时设置权限   
-v 显示执行过程详细信息 
-p 递归创建多级目录 
-z 设置目录安全上下文</code></p>
<h5 id="5-rmdir">5. rmdir</h5>
<pre><code>了解：只能删除空文件夹，所以了解即可，参数与mkdir差不多，  -v -p...
</code></pre>
<h5 id="6-touch">6. touch</h5>
<pre><code>touch命令的功能是创建空文件与修改时间戳。如果文件不存在，则会创建一个空内容的文本文件；如果文件已经存在，则会对文件的Atime（访问时间）和Ctime（修改时间）进行修改操作，管理员可以完成此项工作，而普通用户只能管理主机的文‍件。
</code></pre>
<div class="highlight"><pre><span></span><code>touch<span class="w"> </span>参数<span class="w"> </span>文件名<span class="w">  </span>
vim<span class="w"> </span>test.txt<span class="w"> </span>//<span class="w"> </span>vim会自动创建文件，编辑完:wq就可以保存
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;xxxxxx&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>xxx<span class="w"> </span>//<span class="w"> </span>回直接创建一个文件并写入<span class="s2">&quot;xxxxxx&quot;</span>
//<span class="w"> </span>todo
</code></pre></div>
<h5 id="7-cp">7. cp</h5>
<pre><code>cp命令来自英文单词copy的缩写，中文译为“复制”，其功能是复制文件或目录。cp命令能够将一个或多个文件或目录复制到指定位置，亦常用于文件的备份工作。-r参数用于递归操作，复制目录时若忘记添加则会直接报错；-f参数则用于当目标文件已存在时会直接覆盖而不再询问。这两个参数尤为常用。
</code></pre>
<p><div class="highlight"><pre><span></span><code>cp 参数 源文件名 目标文件名
</code></pre></div>
![[Pasted image 20251104105622.png]]</p>
<h5 id="8-rm">8. rm</h5>
<pre><code>rm命令来自英文单词remove的缩写，中文译为“消除”，其功能是删除文件或目录，一次可以删除多个文件，或递归删除目录及其内的所有子文件。 rm也是一个很危险的命令，使用的时候要特别当心，尤其对于新手更要格外注意。例如，执行rm -rf /*命令会清空系统中所有的文件，甚至无法恢复回来。所以我们在执行之前一定要再次确认在在哪个目录中、到底要删除什么文件，考虑好后再敲击Enter键，要时刻保持清醒的头‍脑。
</code></pre>
<p>![[Pasted image 20251104105727.png]]</p>
<h5 id="9-mv">9. mv</h5>
<pre><code>mv命令来自英文单词move的缩写，中文译为“移动”，其功能与英文含义相同，能够对文件进行剪切和重命名操作。这是一个被高频使用的文件管理命令，我们需要留意它与复制命令的区别。cp命令是用于文件的复制操作，文件个数是增加的，而mv则为剪切操作，也就是对文件进行移动（搬家）操作，文件位置发生变化，但总个数并无增‍加。 在同一个目录内对文件进行剪切的操作，实际上应理解成重命名操作，例如下面的第一个示例所‍示。
</code></pre>
<p><div class="highlight"><pre><span></span><code>语法格式：mv 参数 源文件名 目标文件名  
</code></pre></div>
![[Pasted image 20251104110617.png]]</p>
<h5 id="10">10. 查看文件内容</h5>
<ol>
<li>cat<pre><code>cat命令来自英文词组concatenate files and print的缩写，其功能是在终端设备上显示文件内容。在Linux系统中有很多用于查看文件内容的命令，例如more、tail、head等，每个命令都有各自的特点。cat命令适合查看内容较少的纯文本文件。 对于内容较多的文件，使用cat命令查看后会在屏幕上快速滚屏，用户往往看不清所显示的具体内容，只好按Ctrl+C组合键中断命令执行，所以对于大文件，干脆用more命令‍显示吧。
</code></pre>
</li>
</ol>
<div class="highlight"><pre><span></span><code>cat 参数 文件名 查看一屏幕显示的非动态文本（小文本）
-n 显示行号
</code></pre></div>
<ol>
<li>more<pre><code>more命令的功能是分页显示文本文件的内容。如果文本文件中的内容较多较长，使用cat命令读取后则很难看清，这时使用more命令进行分页查看就比较合适了，该命令可以把文本内容一页一页地显示在终端界面上，用户每按一次Enter键即向下一行，每按一次空格键即向下一页，直至看完为止。
</code></pre>
</li>
</ol>
<p><div class="highlight"><pre><span></span><code>more 参数 文件名
一些命令:
= 输出当前行数
:f 输出文件名以及行数
</code></pre></div>
![[Pasted image 20251104142054.png]]</p>
<ol>
<li>less<pre><code>less命令的功能是分页显示文件内容。Less命令分页显示的功能与more命令很相像，但more命令只能从前向后浏览文件内容，而less命令不仅能从前向后浏览（按PageDown键），还可以从后向前浏览（按PageUp键），更加灵‍活。
</code></pre>
</li>
</ol>
<p><div class="highlight"><pre><span></span><code>less 参数 文件
空格翻页 上 下 进行翻页 q退出 /查找关键字
</code></pre></div>
![[Pasted image 20251104143220.png]]</p>
<ol>
<li>head
        head命令的功能是显示文件开头的内容，默认为前10行。  </li>
</ol>
<div class="highlight"><pre><span></span><code>head 参数 文件名  
-c 设置显示头部内容的字符数   
-v 显示文件名的头信息 
-n 设置显示行数 
--help 显示帮助信息 
-q 不显示文件名的头信息   
</code></pre></div>
<ol>
<li>tail<pre><code>tail命令的功能是查看文件尾部内容，例如默认会在终端界面上显示指定文件的末尾10行，如果指定了多个文件，则会在显示的每个文件内容前面加上文件名来加以区分。高阶玩法的-f参数的作用是持续显示文件的尾部最新内容，类似于机场候机厅的大屏幕，总会把最新的消息显示出来
注:只有 echo 追加的参会被识别
</code></pre>
</li>
</ol>
<div class="highlight"><pre><span></span><code>tail 参数 文件名
-c 设置显示文件尾部的字符数   
--pid 当指定PID进程结束时，自动退出命令 
-f 持续显示文件尾部最新内容 
--retry 当文件无权限访问时，依然尝试打开 
-n 设置显示文件尾部的行数 
</code></pre></div>
<ol>
<li>echo<pre><code>echo命令的功能是在终端设备上输出指定字符串或变量提取后的值，能够给用户一些简单的提醒信息，亦可以将输出的指定字符串内容同管道符一起传递给后续命令作为标准输入信息进行二次处理，还可以同输出重定向符一起操作，将信息直接写入文件。如需提取变量值，需在变量名称前加入$符号，变量名称一般均为大写形‍式。
</code></pre>
</li>
</ol>
<div class="highlight"><pre><span></span><code>echo 参数 字符串或$变量名  

配合重定向符
&gt; 覆写
&gt;&gt; 追加
</code></pre></div>
<ol>
<li>ln<pre><code>ln命令来自英文单词link的缩写，中文译为“链接”，其功能是为某个文件在另外一个位置建立同步的链接。Linux系统中的链接文件有两种形式，一种是硬链接，另一种是软链接。软链接相当于Windows系统中的快捷方式文件，原始文件被移动或删除后，软链接文件也将无法使用；硬链接则是将文件的inode属性块进行了复制，因此把原始文件移动或删除后，硬链接文件依然可以使用。
</code></pre>
</li>
</ol>
<div class="highlight"><pre><span></span><code>创建软连接（快捷方式）
ln -s 原文件或者文件夹 软连接名
对软连接的所有操作，相当于源文件的动作，软连接名要和源文件一致
</code></pre></div>
<h4 id="4_1">4. 用户以及权限命令</h4>
<ol>
<li>
<p>添加一个用户
<div class="highlight"><pre><span></span><code>useradd 用户名
-g 指定组(改组必须存在)

userdel username
-f 强制删除
-r 连相关数据也删除
</code></pre></div></p>
</li>
<li>
<p>为用户设置密码
<div class="highlight"><pre><span></span><code>passwd 用户名
</code></pre></div></p>
</li>
<li>
<p>修改用户一些属性
<div class="highlight"><pre><span></span><code>usermod 参数 用户名
-g 修改用户所在组
// 修改用户所属组
usermod -g 组名 用户名
</code></pre></div></p>
</li>
<li>
<p>查看用户是否存在以及相关信息
<div class="highlight"><pre><span></span><code>id username
cat /etc/passwd
cat /etc/group
cat /etc/sudoers
</code></pre></div></p>
</li>
<li>
<p>组相关命令
<div class="highlight"><pre><span></span><code>// 添加一个组
groupadd 组名
// 删除组
groupdel 组名
//查看组
cat /etc/group
</code></pre></div></p>
</li>
<li>
<p>赋予权限
<div class="highlight"><pre><span></span><code>1. 去 /etc/sudoers 配置文件中配置权限 账号 ALL=(ALL) NOPASSWD:ALL
2. 之后对应用户使用命令时前面 + sudo
</code></pre></div></p>
</li>
<li>
<p>用户的切换
<div class="highlight"><pre><span></span><code>su username
exit
logout 
</code></pre></div></p>
</li>
</ol>
<h4 id="5_1">5. 文件权限命令</h4>
<pre><code>文件权限通过10位来表示,第一位是类型(-, l, d),后9位分为三组,分别代表 所有者, 所在组, 其他人的权限, 如图所示. 后面分别是文件所有者和所在组.
</code></pre>
<p>![[Pasted image 20251104170916.png]]</p>
<ol>
<li>权限修改命令<pre><code>chmod命令来自英文词组change mode的缩写，其功能是改变文件或目录权限的命令。默认只有文件的所有者和管理员可以设置文件权限，普通用户只能管理自己文件的权限属性。 设置权限时可以使用数字法，亦可使用字母表达式，对于目录文件，建议加入-R参数进行递归操作，这意味着不仅对于目录本身，而且也对目录内的子文件/目录进行新权限的设定。
</code></pre>
</li>
</ol>
<div class="highlight"><pre><span></span><code>chmod 参数值 [u+r, g+w, o+x] 文件/目录名
身份表示: u g o a
数字法 r 4 w 2 x 1
-R 递归处理
-v 显示执行过程
-f 修改失败后不提示信息
</code></pre></div>
<ol>
<li>修改所有者/组<pre><code>chown命令来自英文词组change owner的缩写，其功能是改变文件或目录的用户和用户组信息。管理员可以改变一切文件的所属信息，而普通用户只能改变自己文件的所属信息.
</code></pre>
<p><code>chown 参数 所属主:所属组 文件名</code></p>
</li>
</ol>
<h4 id="6">6. 查询文件</h4>
<h5 id="61-find">6.1 find</h5>
<pre><code>find命令的功能是根据给定的路径和条件查找相关文件或目录，其参数灵活方便，且支持正则表达式，结合管道符后能够实现更加复杂的功能，是Linux系统运维人员必须掌握的命令之一。 
find命令通常进行的是从根目录（/）开始的全盘搜索，有别于whereis、which、locate等有条件或部分文件的搜索。对于服务器负载较高的情况，建议不要在高峰时期使用find命令的模糊搜索，这会相对消耗较多的系统资源。
</code></pre>
<div class="highlight"><pre><span></span><code>find 路径 条件 文件名  
-name 匹配文件名   
-nouser 匹配无所属主的文件 
-perm 匹配文件权限 
-nogroup 匹配无所属组的文件 
-user 匹配文件所属主 
-newer 匹配比指定文件更新的文件 
-group 匹配文件所属组 
-type 匹配文件类型 
-mtime 匹配最后修改文件内容时间 
-size 匹配文件大小 
-atime 匹配最后读取文件内容时间 
-prune 不搜索指定目录 
-ctime 匹配最后修改文件属性时间 
-exec…… {}\; 进一步处理搜索结果  
</code></pre></div>
<h5 id="62-grep">6.2 grep</h5>
<pre><code>grep命令来自英文词组global search regular expression and print out the line的缩写，意思是用于全面搜索的正则表达式，并将结果输出。人们通常会将grep命令与正则表达式搭配使用，参数作为搜索过程中的补充或对输出结果的筛选，命令模式十分灵‍活。
</code></pre>
<p><div class="highlight"><pre><span></span><code>grep 参数(可以是一个字符串) 文件名
</code></pre></div>
![[Pasted image 20251104171842.png]]</p>
<h4 id="7">7. 文件解压缩</h4>
<h5 id="71-gzip">7.1 gzip</h5>
<pre><code>只能压缩文件，压缩文件的后缀名 原名.gz   压缩以后原文件消失，解压以后gz压缩包也消失
</code></pre>
<div class="highlight"><pre><span></span><code>压缩文件：<span class="w"> </span>gzip<span class="w"> </span>文件名
解压文件：<span class="w"> </span>gunzip<span class="w"> </span>文件名.gz
</code></pre></div>
<h5 id="72-zip">7.2 zip</h5>
<div class="highlight"><pre><span></span><code>压缩文件: zip 压缩文件名.zip 文件名
压缩文件夹: zip -r 压缩文件夹名.zip 文件夹
解压文件/文件贾 unzip 压缩文件名.zip -d /解压的位置
</code></pre></div>
<h5 id="73-tar">7.3 tar</h5>
<pre><code>tar命令的功能是压缩和解压缩文件，能够制作出Linux系统中常见的tar、tar.gz、tar.bz2等格式的压缩包文件。对于RHEL 7、CentOS 7版本及以后的系统，解压缩时不添加格式参数（如z或j），系统也能自动进行分析并解压。把要传输的文件先压缩再传输，能够很好地提高工作效率，方便分享。
</code></pre>
<div class="highlight"><pre><span></span><code>归纳文件
tar -cvf xxx.tar 要归纳的文件或者文件夹
-f 指定操作的文件
-z 解压缩
-c 归纳
-x 解纳
打包： tar -cvf xxx.tar 文件或者文件夹
打包+压缩：tar -czvf xxx.tar.gz 文件或者文件夹
解包： tar -xvf xxx.tar -C /解到指定的文件夹
解压+解包：tar -zxvf xxx.tar.gz -C /解到指定的文件夹
</code></pre></div>
<h3 id="4-linux-docker">4. Linux 下一些应用的安装（非 docker)</h3>
<h4 id="1-jdk-tomcat">1. 安装 JDK 与 Tomcat</h4>
<pre><code>注：所有端口都注意一下买没开放（云服务器），然后防火墙要记得关
</code></pre>
<h5 id="11-jdk">1.1 JDK</h5>
<p>``` java
1、先去官网下一个 jdk 的tar.gz 版本

2、上传到服务器，然后 tar -zxvf 就可以解压 + 解纳（opt）

3、配环境变量：vim /etc/profile.d/my_env.sh（在profile.d下面新建你的环境变量文件.sh）</p>
<h1 id="java_home">JAVA_HOME</h1>
<p>JAVA_HOME=/opt/jdk-17.0.12
PATH=$PATH:$JAVA_HOME/bin
export PATH JAVA_HOME

4、source /etc/profile.d/my_env.sh

java -version
```</p>
<h5 id="12-tomcat">1.2 Tomcat</h5>
<p><code>直接去官网找到对应版本：tomcat 10.x 然后下载解压即可</code></p>
<h4 id="2-mysql">2. 安装mysql</h4>
<div class="highlight"><pre><span></span><code>1. 先去官网上下载和你的 linux 匹配的版本，最好是xxx.tar，RPM Bundle 是一个打包好的 .tar.gz 文件，包含了所有必要的 RPM 包（服务器、客户端、库等）。
通过命令：cat /etc/redhat-release 查看版本
2. 然后，把 .tar 解纳了，就到的若干个.rpm
3. 之后，按顺序通过 rpm -ivh xxx.rpm 来安装，顺序为：
   1）mysql-community-common-8.0.30-1.el7.x86_64.rpm
   2）mysql-community-client-plugins-8.0.30-1.el7.x86_64.rpm
   3）mysql-community-libs-8.0.30-1.el7.x86_64.rpm
   4）mysql-community-icu-data-files-8.0.30-1.el7.x86_64.rpm
   5）mysql-community-icu-data-files-8.0.30-1.el7.x86_64.rpm
   6）mysql-community-server-8.0.30-1.el7.x86_64.rpm

4. 安装完毕后，就可以通过 mysqladmin --version 检查是否安装成功
</code></pre></div>
<h5 id="21-mysql">2.1 与 mysql 服务相关的命令</h5>
<ol>
<li>
<p>启动服务
<div class="highlight"><pre><span></span><code>#初始化服务
mysqld --initialize --user=root

# 启动服务
systemclt start mysqld

# 遇到的错误（权限不足，创建不了文件）
解决：
chown -R mysql:mysql /var/lib/mysql
chmod -R 777 /var/lib/mysql
</code></pre></div></p>
</li>
<li>
<p>找初始化密码以及重置密码
<div class="highlight"><pre><span></span><code>cat /var/log/mysqld.log
grep &quot;temporary password&quot; \var\log\mysqld.log
ALTER USER &#39;root&#39;@&#39;localhost&#39; IDENTIFIED BY &#39;liuqiang&#39;;


# 找回密码
</code></pre></div></p>
</li>
<li>
<p>去配置那些主机可以连接当前mysql
<div class="highlight"><pre><span></span><code># 修改表
update user set host=&#39;%&#39; where user=&#39;root&#39;;
# 修改完mysql底层表，记得更新 
FLUSH PRIVILEGES;
</code></pre></div></p>
</li>
</ol>
<h4 id="3-nginx">3. 安装 nginx</h4>
<h5 id="1_1">1 安装过程</h5>
<ol>
<li>
<p>配置Nginx yum存储库
<div class="highlight"><pre><span></span><code><span class="n">创建</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="p">.</span><span class="na">repos</span><span class="p">.</span><span class="na">d</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="na">repo文件</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">vim</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="p">.</span><span class="na">repos</span><span class="p">.</span><span class="na">d</span><span class="o">/</span><span class="n">nginx</span><span class="p">.</span><span class="na">repo</span>

<span class="n">增加以下内容</span><span class="err">：</span>

<span class="o">[</span><span class="n">nginx</span><span class="o">-</span><span class="n">stable</span><span class="o">]</span>
<span class="n">name</span><span class="o">=</span><span class="n">nginx</span><span class="w"> </span><span class="n">stable</span><span class="w"> </span><span class="n">repo</span>
<span class="n">baseurl</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="c1">//nginx.org/packages/centos/$releasever/$basearch/</span>
<span class="n">gpgcheck</span><span class="o">=</span><span class="mi">1</span>
<span class="n">enabled</span><span class="o">=</span><span class="mi">1</span>
<span class="n">gpgkey</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="c1">//nginx.org/keys/nginx_signing.key</span>
<span class="n">module_hotfixes</span><span class="o">=</span><span class="kc">true</span>

<span class="o">[</span><span class="n">nginx</span><span class="o">-</span><span class="n">mainline</span><span class="o">]</span>
<span class="n">name</span><span class="o">=</span><span class="n">nginx</span><span class="w"> </span><span class="n">mainline</span><span class="w"> </span><span class="n">repo</span>
<span class="n">baseurl</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="c1">//nginx.org/packages/mainline/centos/$releasever/$basearch/</span>
<span class="n">gpgcheck</span><span class="o">=</span><span class="mi">1</span>
<span class="n">enabled</span><span class="o">=</span><span class="mi">0</span>
<span class="n">gpgkey</span><span class="o">=</span><span class="n">https</span><span class="p">:</span><span class="c1">//nginx.org/keys/nginx_signing.key</span>
<span class="n">module_hotfixes</span><span class="o">=</span><span class="kc">true</span>
</code></pre></div></p>
</li>
<li>
<p>在线安装Nginx
<div class="highlight"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">nginx</span>
</code></pre></div></p>
</li>
<li>
<p>启动Nginx
<div class="highlight"><pre><span></span><code><span class="n">执行以下命令启动Nginx</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">nginx</span>

<span class="n">执行以下命令查看Nginx运行状态</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="n">nginx</span>

<span class="n">执行以下命令设置开机自启</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">nginx</span>
</code></pre></div></p>
</li>
<li>
<p>访问Nginx服务默认首页
    访问<code>http://192.168.10.101</code>，能访问到如下页面，则证明Nginx运行正常。</p>
</li>
</ol>
<h5 id="2_4">2 核心目录以及文件</h5>
<ol>
<li>
<p><strong>配置文件相关</strong></p>
<ul>
<li><code>/etc/nginx/</code>：主要的Nginx配置文件目录。</li>
<li><code>/etc/nginx/nginx.conf</code>：Nginx的主配置文件，包含全局配置信息。</li>
<li><code>/etc/nginx/conf.d/</code>：这个目录通常包含一些附加的配置文件，默认情况下主配置文件<code>/etc/nginx/nginx.conf</code>会引入该目录的所有文件。</li>
</ul>
</li>
<li>
<p><strong>日志相关</strong></p>
<ul>
<li><code>/var/log/nginx/</code>：Nginx的日志文件目录，包括访问日志和错误日志。</li>
<li><code>/var/log/nginx/access.log</code>：访问日志，记录所有进入服务器的请求。</li>
<li><code>/var/log/nginx/error.log</code>：错误日志，记录服务器处理过程中的错误信息。</li>
</ul>
</li>
<li>
<p>静态资源</p>
<ul>
<li>/usr/share/nginx/html -&gt;静态资源</li>
</ul>
</li>
</ol>
<h5 id="3_2">3 虚拟主机的配置</h5>
<p>由于Nginx中可存在多个虚拟主机的配置，故接收到一个请求后，Nginx首先要确定请求交给哪个虚拟主机进行处理。这很显然是根据<code>server_name</code>和<code>listen</code>进行判断的。例如上述的请求路径<a href="http://115.190.231.171:8080/hello-nginx">http://115.190.231.171/hello-nginx</a>，就会匹配到以下的虚拟主机</p>
<div class="highlight"><pre><span></span><code><span class="n">server</span><span class="p">{</span>
<span class="w">    </span><span class="n">listen</span><span class="w"> </span><span class="mi">8080</span><span class="p">;</span>
<span class="w">    </span><span class="n">server_name</span><span class="w"> </span><span class="mf">115.190.231.171</span><span class="p">;</span>
<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="n">hello</span><span class="o">-</span><span class="n">nginx</span><span class="p">{</span>
<span class="w">        </span><span class="n">root</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">html</span><span class="o">/</span><span class="p">;</span>
<span class="w">        </span><span class="n">index</span><span class="w"> </span><span class="n">index</span><span class="p">.</span><span class="na">html</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="err">#</span><span class="n">其他命令</span>
<span class="n">nginx</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span>
<span class="n">nginx</span><span class="w"> </span><span class="o">-</span><span class="n">s</span><span class="w"> </span><span class="n">reload</span>
</code></pre></div>
<h5 id="4_2">4 反向代理</h5>
<div class="highlight"><pre><span></span><code><span class="n">server</span><span class="p">{</span>
<span class="w">    </span><span class="n">listen</span><span class="w"> </span><span class="mi">8080</span><span class="p">;</span>
<span class="w">    </span><span class="n">server_name</span><span class="w"> </span><span class="mf">115.190.231.171</span><span class="p">;</span>
<span class="w">    </span><span class="n">location</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">{</span>
<span class="w">         </span><span class="n">proxy_pass</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//www.atguigu.com;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>
<h5 id="5_2">5 安全模式</h5>
<div class="highlight"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">setenforce</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">是一个用于管理</span><span class="w"> </span><span class="n">SELinux</span><span class="err">（</span><span class="n">Security</span><span class="o">-</span><span class="n">Enhanced</span><span class="w"> </span><span class="n">Linux</span><span class="err">）</span><span class="n">策略的命令</span><span class="err">。</span>

<span class="n">解释</span><span class="err">：</span>
<span class="nl">sudo</span><span class="p">:</span><span class="w"> </span><span class="n">这个命令用于以超级用户权限</span><span class="err">（</span><span class="n">root</span><span class="w"> </span><span class="n">权限</span><span class="err">）</span><span class="n">执行后续的命令</span><span class="err">。</span><span class="n">它要求用户输入密码</span><span class="err">，</span><span class="n">以确认有权限执行高权限的操作</span><span class="err">。</span>

<span class="nl">setenforce</span><span class="p">:</span><span class="w"> </span><span class="n">这是一个用于动态设置</span><span class="w"> </span><span class="n">SELinux</span><span class="w"> </span><span class="n">模式的命令</span><span class="err">。</span><span class="n">SELinux</span><span class="w"> </span><span class="n">有三种工作模式</span><span class="err">：</span><span class="n">Enforcing</span><span class="err">（</span><span class="n">强制</span><span class="err">）、</span><span class="n">Permissive</span><span class="err">（</span><span class="n">宽容</span><span class="err">）、</span><span class="n">Disabled</span><span class="err">（</span><span class="n">禁用</span><span class="err">）。</span><span class="n">setenforce</span><span class="w"> </span><span class="n">命令允许你切换</span><span class="w"> </span><span class="n">Enforcing</span><span class="w"> </span><span class="n">和</span><span class="w"> </span><span class="n">Permissive</span><span class="w"> </span><span class="n">模式</span><span class="err">。</span>

<span class="n">Enforcing</span><span class="w"> </span><span class="n">模式</span><span class="err">：</span><span class="n">SELinux</span><span class="w"> </span><span class="n">会强制执行所有的安全策略</span><span class="err">，</span><span class="n">对不符合策略的操作进行阻止</span><span class="err">，</span><span class="n">并记录事件</span><span class="err">。</span>
<span class="n">Permissive</span><span class="w"> </span><span class="n">模式</span><span class="err">：</span><span class="n">SELinux</span><span class="w"> </span><span class="n">会允许所有操作</span><span class="err">，</span><span class="n">但会记录违反安全策略的事件</span><span class="err">，</span><span class="n">不会阻止任何操作</span><span class="err">。</span>
<span class="mi">0</span><span class="p">:</span><span class="w"> </span><span class="n">这个数字表示将</span><span class="w"> </span><span class="n">SELinux</span><span class="w"> </span><span class="n">切换到</span><span class="w"> </span><span class="n">Permissive</span><span class="w"> </span><span class="n">模式</span><span class="err">。</span><span class="n">在这个模式下</span><span class="err">，</span><span class="n">SELinux</span><span class="w"> </span><span class="n">不会阻止任何操作</span><span class="err">，</span><span class="n">只会记录潜在的违规行为</span><span class="err">。</span>

<span class="n">综上</span><span class="err">：</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">setenforce</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">命令的作用是将</span><span class="w"> </span><span class="n">SELinux</span><span class="w"> </span><span class="n">的模式设置为</span><span class="w"> </span><span class="n">Permissive</span><span class="err">。</span><span class="n">这意味着</span><span class="w"> </span><span class="n">SELinux</span><span class="w"> </span><span class="n">会停止强制执行安全策略</span><span class="err">，</span><span class="n">只会记录任何违反策略的操作</span><span class="err">，</span><span class="n">而不会真正阻止它们</span><span class="err">。</span><span class="n">通常</span><span class="err">，</span><span class="n">管理员会在排查</span><span class="w"> </span><span class="n">SELinux</span><span class="w"> </span><span class="n">相关问题时使用这个命令</span><span class="err">，</span><span class="n">以便不被策略限制影响系统的正常操作</span><span class="err">。</span>

<span class="n">注意</span><span class="err">：</span>
<span class="n">这个命令仅会在当前会话中生效</span><span class="err">。</span><span class="n">如果需要永久禁用</span><span class="w"> </span><span class="n">SELinux</span><span class="w"> </span><span class="n">或更改配置</span><span class="err">，</span><span class="n">需要修改</span><span class="w"> </span><span class="n">SELinux</span><span class="w"> </span><span class="n">配置文件</span><span class="err">（</span><span class="n">通常是</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">selinux</span><span class="o">/</span><span class="n">config</span><span class="err">）。</span>
<span class="n">在某些生产环境中</span><span class="err">，</span><span class="n">将</span><span class="w"> </span><span class="n">SELinux</span><span class="w"> </span><span class="n">设置为</span><span class="w"> </span><span class="n">Permissive</span><span class="w"> </span><span class="n">可能会带来安全隐患</span><span class="err">，</span><span class="n">因为它不再强制执行安全策略</span><span class="err">。</span>
</code></pre></div>
<h4 id="4-minio">4. 安装 minio</h4>
<p><a href="https://min.io/docs/minio/linux/developers/java/API.html">minio官方文档</a></p>
<ol>
<li>还是去官网下载 minio 的 rpm 包</li>
</ol>
<div class="highlight"><pre><span></span><code>wget https://dl.min.io/server/minio/release/linux-amd64/archive/minio-20241029160148.0.0-1.x86_64.rpm -O minio.rpm
</code></pre></div>
<ol>
<li>
<p>然后直接安装
<div class="highlight"><pre><span></span><code>dnf|yum install minio.rpm

rpm -ivh xxx.rpm
</code></pre></div></p>
</li>
<li>
<p>之后就可以启动 minio 服务器了
<div class="highlight"><pre><span></span><code>mkdir ~/minio
minio server ~/minio --console-address :9001

// 后台启动
nohup minio server ./minioPath/data &gt; ./minioPath/minio.log 2&gt;&amp;1 &amp;
RootUser: minioadmin
RootPass: minioadmin
</code></pre></div></p>
</li>
<li>
<p>配置 minio 的数据存放位置以及后台启动
<div class="highlight"><pre><span></span><code>// 1. 编写MinIO服务配置文件
vim /etc/systemd/system/minio.service

// 2. 内容如下，具体可参考MinIO[官方文档](https://min.io/docs/minio/linux/operations/install-deploy-manage/deploy-minio-single-node-single-drive.html#create-the-systemd-service-file)。


[Unit]
Description=MinIO
Documentation=https://min.io/docs/minio/linux/index.html
Wants=network-online.target
After=network-online.target
AssertFileIsExecutable=/usr/local/bin/minio

[Service]
WorkingDirectory=/usr/local
ProtectProc=invisible
EnvironmentFile=-/etc/default/minio
ExecStartPre=/bin/bash -c &quot;if [ -z \&quot;${MINIO_VOLUMES}\&quot; ]; then echo \&quot;Variable MINIO_VOLUMES not set in /etc/default/minio\&quot;; exit 1; fi&quot;
ExecStart=/usr/local/bin/minio server $MINIO_OPTS $MINIO_VOLUMES
Restart=always
LimitNOFILE=65536
TasksMax=infinity
TimeoutStopSec=infinity
SendSIGKILL=no

[Install]
WantedBy=multi-user.target

// 3. 编写 EnvironmentFile 文件
vim /etc/default/minio

MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=minioadmin
MINIO_VOLUMES=/root/minio/data
MINIO_OPTS=&quot;--console-address :9001&quot;


mkdir /data
chmod -R 777 /root/minio/data
</code></pre></div></p>
</li>
<li>
<p><code>EnvironmentFile</code>，该文件中可配置MinIO服务所需的各项参数</p>
</li>
<li>
<p><code>ExecStart</code>，该参数用于配置MinIO服务的启动命令，其中<code>$MINIO_OPTS</code>、<code>$MINIO_VOLUMES</code>，均引用于<code>EnvironmentFile</code>中的变量。</p>
<ul>
<li><code>MINIO_OPTS</code>用于配置MinIO服务的启动选项，可省略不配置。</li>
<li><code>MINIO_VOLUMES</code>用于配置MinIO服务的数据存储路径。</li>
</ul>
</li>
<li>
<p><code>Restart</code>，表示自动重启</p>
</li>
<li>
<p>自定义桶规则
<div class="highlight"><pre><span></span><code>{
  &quot;Statement&quot; : [ {
    &quot;Action&quot; : &quot;s3:GetObject&quot;,
    &quot;Effect&quot; : &quot;Allow&quot;,
    &quot;Principal&quot; : &quot;*&quot;,
    &quot;Resource&quot; : &quot;arn:aws:s3:::test/*&quot;
  } ],
  &quot;Version&quot; : &quot;2012-10-17&quot;
}
</code></pre></div></p>
</li>
<li>
<p>minio通用模板
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span><span class="w">  </span>
<span class="kt">void</span><span class="w"> </span><span class="nf">testMinioClient</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">Exception</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="c1">// 检查并创建桶  </span>
<span class="w">    </span><span class="kt">boolean</span><span class="w"> </span><span class="n">exists</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">minioClient</span><span class="p">.</span><span class="na">bucketExists</span><span class="p">(</span><span class="w">  </span>
<span class="w">            </span><span class="n">BucketExistsArgs</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">bucket</span><span class="p">(</span><span class="n">BUCKET_NAME</span><span class="p">).</span><span class="na">build</span><span class="p">()</span><span class="w">  </span>
<span class="w">    </span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">exists</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">minioClient</span><span class="p">.</span><span class="na">makeBucket</span><span class="p">(</span><span class="w">  </span>
<span class="w">                </span><span class="n">MakeBucketArgs</span><span class="p">.</span><span class="na">builder</span><span class="p">().</span><span class="na">bucket</span><span class="p">(</span><span class="n">BUCKET_NAME</span><span class="p">).</span><span class="na">build</span><span class="p">()</span><span class="w">  </span>
<span class="w">        </span><span class="p">);</span><span class="w">  </span>

<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">policy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;&quot;  </span>
<span class="s">            {              &quot;</span><span class="n">Statement</span><span class="s">&quot;: [{                &quot;</span><span class="n">Action</span><span class="s">&quot;: &quot;</span><span class="n">s3</span><span class="p">:</span><span class="n">GetObject</span><span class="s">&quot;,                &quot;</span><span class="n">Effect</span><span class="s">&quot;: &quot;</span><span class="n">Allow</span><span class="s">&quot;,                &quot;</span><span class="n">Principal</span><span class="s">&quot;: &quot;</span><span class="o">*</span><span class="s">&quot;,                &quot;</span><span class="n">Resource</span><span class="s">&quot;: &quot;</span><span class="n">arn</span><span class="p">:</span><span class="n">aws</span><span class="p">:</span><span class="n">s3</span><span class="p">:::</span><span class="o">%</span><span class="n">s</span><span class="o">/*</span><span class="s">&quot;              }],              &quot;</span><span class="n">Version</span><span class="s">&quot;: &quot;</span><span class="mi">2012</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">17</span><span class="s">&quot;            }            &quot;&quot;&quot;</span><span class="p">.</span><span class="na">formatted</span><span class="p">(</span><span class="n">BUCKET_NAME</span><span class="p">);</span><span class="w">  </span>

<span class="w">        </span><span class="n">minioClient</span><span class="p">.</span><span class="na">setBucketPolicy</span><span class="p">(</span><span class="w">  </span>
<span class="w">                </span><span class="n">SetBucketPolicyArgs</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">  </span>
<span class="w">                        </span><span class="p">.</span><span class="na">bucket</span><span class="p">(</span><span class="n">BUCKET_NAME</span><span class="p">)</span><span class="w">  </span>
<span class="w">                        </span><span class="p">.</span><span class="na">config</span><span class="p">(</span><span class="n">policy</span><span class="p">)</span><span class="w">  </span>
<span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">()</span><span class="w">  </span>
<span class="w">        </span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 上传文件（从测试资源目录）  </span>
<span class="w">    </span><span class="n">URL</span><span class="w"> </span><span class="n">resource</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getClass</span><span class="p">().</span><span class="na">getClassLoader</span><span class="p">().</span><span class="na">getResource</span><span class="p">(</span><span class="s">&quot;test-file.txt&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">resource</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Test file &#39;test-file.txt&#39; not found in resources!&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="w">    </span><span class="n">Path</span><span class="w"> </span><span class="n">filePath</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Paths</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">resource</span><span class="p">.</span><span class="na">toURI</span><span class="p">());</span><span class="w">  </span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">fileSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Files</span><span class="p">.</span><span class="na">size</span><span class="p">(</span><span class="n">filePath</span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="k">try</span><span class="w"> </span><span class="p">(</span><span class="n">InputStream</span><span class="w"> </span><span class="n">inputStream</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Files</span><span class="p">.</span><span class="na">newInputStream</span><span class="p">(</span><span class="n">filePath</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">minioClient</span><span class="p">.</span><span class="na">putObject</span><span class="p">(</span><span class="w">  </span>
<span class="w">                </span><span class="n">PutObjectArgs</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">  </span>
<span class="w">                        </span><span class="p">.</span><span class="na">bucket</span><span class="p">(</span><span class="n">BUCKET_NAME</span><span class="p">)</span><span class="w">  </span>
<span class="w">                        </span><span class="p">.</span><span class="na">object</span><span class="p">(</span><span class="s">&quot;remote-file.txt&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="w">                        </span><span class="c1">// 输入流、文件大小、分片大小，默认分片大小（5MB) </span>
<span class="w">                        </span><span class="p">.</span><span class="na">stream</span><span class="p">(</span><span class="n">inputStream</span><span class="p">,</span><span class="w"> </span><span class="n">fileSize</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="w">  </span>
<span class="w">                        </span><span class="p">.</span><span class="na">contentType</span><span class="p">(</span><span class="s">&quot;text/plain&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="w">                        </span><span class="p">.</span><span class="na">build</span><span class="p">()</span><span class="w">  </span>
<span class="w">        </span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<h4 id="x1">x1. 软件包管理</h4>
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">查询</span>
<span class="n">rpm</span><span class="w"> </span><span class="o">-</span><span class="n">qa</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">关键字</span><span class="w"> </span><span class="n">查看安装了某个软件</span><span class="w"> </span><span class="o">[</span><span class="n">查询安装了哪些软件</span><span class="w"> </span><span class="n">grep</span><span class="w"> </span><span class="n">筛选</span><span class="o">]</span>
<span class="n">rpm</span><span class="w"> </span><span class="o">-</span><span class="n">ql</span><span class="w"> </span><span class="n">软件名</span><span class="w"> </span><span class="n">查看软件安装的文件夹</span><span class="w"> </span><span class="o">[</span><span class="n">软件安装的位置</span><span class="o">]</span>

<span class="mf">2.</span><span class="w"> </span><span class="n">卸载</span>
<span class="n">rpm</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">软件名</span><span class="w"> </span><span class="n">卸载软件</span><span class="p">,</span><span class="n">如果要卸载的软件其他软件依赖</span><span class="p">,</span><span class="n">卸载失败</span><span class="w"> </span><span class="o">[</span><span class="n">如果有别的软件依赖我</span><span class="p">,</span><span class="n">我就卸载失败</span><span class="o">]</span>
<span class="n">rpm</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="o">--</span><span class="n">nodeps</span><span class="w"> </span><span class="n">软件名</span><span class="w"> </span><span class="n">强制卸载</span><span class="w"> </span><span class="o">[</span><span class="n">不关别的软件是否依赖我</span><span class="p">,</span><span class="n">我都强制卸载</span><span class="o">]</span>

<span class="mf">3.</span><span class="w"> </span><span class="n">安装</span><span class="err">（</span><span class="n">yum</span><span class="err">）</span>
<span class="n">rpm</span><span class="w"> </span><span class="o">-</span><span class="n">ivh</span><span class="w"> </span><span class="o">--</span><span class="n">nodeps</span><span class="w"> </span><span class="n">软件包</span><span class="p">.</span><span class="na">rpm</span><span class="w"> </span><span class="o">[--</span><span class="n">nodeps</span><span class="w"> </span><span class="n">强制安装</span><span class="p">,</span><span class="n">就算环境不足安装成功</span><span class="p">,</span><span class="n">运行不起来</span><span class="o">!</span><span class="w"> </span><span class="o">]</span>
</code></pre></div>
<h4 id="x2">x2. 切换第三方源</h4>
<div class="highlight"><pre><span></span><code><span class="n">centos7停止官方维护</span><span class="p">,</span><span class="n">切换数据源为阿里源方可使用</span>
<span class="n">wget</span><span class="w"> </span><span class="o">-</span><span class="n">O</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">yum</span><span class="p">.</span><span class="na">repos</span><span class="p">.</span><span class="na">d</span><span class="o">/</span><span class="n">CentOS</span><span class="o">-</span><span class="n">Base</span><span class="p">.</span><span class="na">repo</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//mirrors.aliyun.com/repo/Centos-7.repo</span>
<span class="n">yum</span><span class="w"> </span><span class="o">-</span><span class="n">y</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">软件名</span>
</code></pre></div>
<h3 id="5_3">5. 其他命令总结</h3>
<h5 id="1_2">1. 查看端口号是否被占用</h5>
<div class="highlight"><pre><span></span><code>ss -tuln | grep &quot;port&quot;
</code></pre></div>
<h4 id="2_5">2. 查看端口具体应用信息</h4>
<div class="highlight"><pre><span></span><code>lsof -i:port;
</code></pre></div>
<h2 id="redis">六 Redis</h2>
<h5 id="60-no-sql-redis">6.0 No Sql 以及 Redis 的一些特性</h5>
<pre><code>NoSQL（Not Only SQL） 是一类非关系型数据库的统称，旨在解决传统关系型数据库在高并发、大数据量、灵活数据模型等场景下的瓶颈。
Redis 是一个开源的内存型键值数据库，属于 NoSQL 中的键值存储类型。
</code></pre>
<h5 id="61-redis">6.1 安装 redis</h5>
<ol>
<li>
<p>去 redis 官网下载 redis，默认就是 .tar.gz，然后解压</p>
</li>
<li>
<p>redis 需要 c 环境
<div class="highlight"><pre><span></span><code>yum -y install gcc
gcc --version
</code></pre></div></p>
</li>
<li>
<p>进入 redis 目录，然后编译 redis
<div class="highlight"><pre><span></span><code>make 编译
make install 安装

# 安装失败
make disclean 
</code></pre></div></p>
</li>
<li>
<p>默认安装到了 usr 里面，不需要自己配环境变量了（命令所在位置：/usr/local/bin）</p>
</li>
</ol>
<h4 id="62-redis">6.2 Redis 配置、启动</h4>
<div class="highlight"><pre><span></span><code>1、将前台启动改为后台启动
309 行附近：daemonize no

2、将 bind ip 注解掉，这样其他 host 才能连接
87 行附近：bind 127.0.0.1 -::1
3、取消密码保护
111 行附近：protected-mode yes --&gt; no
</code></pre></div>
<h4 id="63-redis">6.3 Redis 常见数据类型和操作命令</h4>
<h5 id="1_3">1. 常见数据类型</h5>
<pre><code>redis的存储时 key-value形式的,这里的五大类型指的是 value的五种数据类型!
1）String
2) List
3) Set
4) Hash
5) Zset
</code></pre>
<h5 id="2-key">2. key 相关指令</h5>
<p>![[Pasted image 20251105162931.png]]</p>
<h5 id="3-string">3. String 相关指令</h5>
<pre><code>String是Redis最基本的类型，你可以理解成与Memcached一模一样的类型，一个key对应一个value。

String类型是二进制安全的。意味着Redis的string可以包含任何数据。比如jpg图片或者序列化的对象。

String类型是Redis最基本的数据类型，一个Redis中字符串value最多可以是512M
</code></pre>
<p>![[Pasted image 20251105163018.png]]</p>
<h5 id="4-list">4. List 相关指令</h5>
<pre><code>redis 现在的 list 底层结构就是 Quicklist
Quicklist 就是 Redis 用来实现 List 的底层数据结构 —— 说白了，它是一个「用双向链表串起来的多个小压缩列表」。
</code></pre>
<p>![[Pasted image 20251105163041.png]]</p>
<h5 id="5-set">5. Set 相关指令</h5>
<pre><code>Redis 的 Set 类型是一个不允许重复元素的集合，元素存储的顺序不按照插入的顺序，因此属于无序集合。一个 Set 最多可以存储 2^32 - 1 个元素，这与数学中的集合概念类似。Set 类型不仅支持增、删、改、查等操作，还支持多个Set之间的交集、并集和差集运算。
</code></pre>
<p>内部实现：</p>
<pre><code>如果集合中的所有元素都是整数，并且元素个数小于 512（默认值，可通过属性 set-maxintset-entries 配置），Redis 会使用intset作为 Set 类型的底层数据结构。
IntSet 内部其实是一个数组（int8_t coentents[] 数组），而且存储数据的时候是有序的，因为在查找数据的时候是通过二分查找来实现的。
当我们使用 sadd nunbers 1 3 5,该集合对象在内存的结构如下：
</code></pre>
<p>![[Pasted image 20251105170459.png]]</p>
<pre><code>如果集合中的元素不符合上述条件，Redis 会使用哈希表作为 Set 类型的底层数据结构。
Redis 中的 key-value 是通过 dictEntry 对象来实现的，而哈希表就是将 dictEntry 进行了再一次的包装得到的，这就是哈希表对象 dictht：
</code></pre>
<p><code>js
typedef struct dictht { 
dictEntry **table;//哈希表数组 
unsigned long size;//哈希表大小 
unsigned long sizemask;//掩码大小，用于计算索引值，总是等于size-1 
unsigned long used;//哈希表中的已有节点数 
} dictht;</code>
![[Pasted image 20251105170734.png]]</p>
<p>![[Pasted image 20251105163131.png]]</p>
<h5 id="6-zset">6. Zset 相关指令</h5>
<pre><code>ZSet 底层是 跳表（skiplist） + 哈希表（hash table）：
</code></pre>
<p>![[Pasted image 20251105171705.png]]</p>
<h5 id="7-hash">7. Hash 相关指令</h5>
<pre><code>在redis存放关联数据，有三种解决方式，如图：
</code></pre>
<p>![[Pasted image 20251105173701.png]]</p>
<p>![[Pasted image 20251105174257.png]]</p>
<div class="highlight"><pre><span></span><code>其他常用命令
hgetall key
hlen key
hkeys key
kvals key
hincrby key field increment
hsetnx key field vaule
</code></pre></div>
<h5 id="8-redis-hash">8 Redis hash 的底层</h5>
<pre><code>首先，hash 就是用来存放 key - value 键值对的，它的底层可以看作是数组，只不过对应的 value 所存放的位置都是通过 Hash(key) 来计算出来的，具体实现就是两种：拉链法 | 蹲坑法
</code></pre>
<p>![[Pasted image 20251105180733.png]]</p>
<pre><code>那么 Redis 采用的是哪一种做法呢？答案是「分离链接法」，在不扩容哈希表的前提下，将具有相同哈希值的数据串起来，形成链表，以便这些数据在表中仍然可以被查询到。好了，那么接下来就看看 Redis 哈希表的结构设计。
</code></pre>
<p>![[Pasted image 20251105180917.png]]</p>
<h4 id="64-jedis">6.4. Jedis</h4>
<h5 id="1_4">1. 使用方法</h5>
<ol>
<li>
<p>导入依赖
<div class="highlight"><pre><span></span><code><span class="nt">&lt;dependency&gt;</span><span class="w">  </span>
<span class="w">    </span><span class="nt">&lt;groupId&gt;</span>redis.clients<span class="nt">&lt;/groupId&gt;</span><span class="w">  </span>
<span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>jedis<span class="nt">&lt;/artifactId&gt;</span><span class="w">  </span>
<span class="w">    </span><span class="nt">&lt;version&gt;</span>2.9.0<span class="nt">&lt;/version&gt;</span><span class="w">  </span>
<span class="nt">&lt;/dependency&gt;</span><span class="w">  </span>
<span class="cm">&lt;!-- https://mvnrepository.com/artifact/org.junit.jupiter/junit-jupiter-api --&gt;</span><span class="w">  </span>
<span class="nt">&lt;dependency&gt;</span><span class="w">  </span>
<span class="w">    </span><span class="nt">&lt;groupId&gt;</span>org.junit.jupiter<span class="nt">&lt;/groupId&gt;</span><span class="w">  </span>
<span class="w">    </span><span class="nt">&lt;artifactId&gt;</span>junit-jupiter-api<span class="nt">&lt;/artifactId&gt;</span><span class="w">  </span>
<span class="w">    </span><span class="nt">&lt;version&gt;</span>5.8.1<span class="nt">&lt;/version&gt;</span><span class="w">  </span>
<span class="w">    </span><span class="nt">&lt;scope&gt;</span>test<span class="nt">&lt;/scope&gt;</span><span class="w">  </span>
<span class="nt">&lt;/dependency&gt;</span>
</code></pre></div></p>
</li>
<li>
<p>然后就可以获取连接，执行方法了
<div class="highlight"><pre><span></span><code><span class="n">Jedis</span><span class="w"> </span><span class="n">jedis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Jedis</span><span class="p">(</span><span class="s">&quot;192.168.6.101&quot;</span><span class="p">,</span><span class="mi">6379</span><span class="p">);</span>
<span class="n">jedis</span><span class="p">.</span><span class="na">xxx</span><span class="w"> </span><span class="p">(</span><span class="n">这里的方法名就是</span><span class="w"> </span><span class="n">redis</span><span class="w"> </span><span class="n">的命令名</span><span class="p">)</span>
</code></pre></div></p>
</li>
</ol>
<h4 id="65-spring-data-redis">6.5 Spring data redis</h4>
<pre><code>使用步骤：
1）导入相关场景启动器以及依赖（spring-boot-starter-data-redis， spring-boot-starter-web：要的是json以及连接池依赖 commons-pool2）
</code></pre>
<p><code>xml
&lt;parent&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-parent&lt;/artifactId&gt;
    &lt;version&gt;3.0.5&lt;/version&gt;
&lt;/parent&gt;

&lt;dependencies&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
        &lt;artifactId&gt;spring-boot-starter-data-redis&lt;/artifactId&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
        &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;
        &lt;artifactId&gt;lombok&lt;/artifactId&gt;
    &lt;/dependency&gt;

&lt;/dependencies&gt;</code>
    2）在配置文件中配置信息，最重要的：spring.data.redis.host | port
``` yaml
spring:<br />
  data:<br />
    redis:<br />
      host: 47.94.86.115<br />
      port: 6379  </p>
<h1 id="jedis">jedis:</h1>
<h1 id="pool">pool:</h1>
<h1 id="enabled-true">enabled: true</h1>
<h1 id="max-active-8">max-active: 8</h1>
<h1 id="max-idle-5">max-idle: 5</h1>
<h1 id="max-wait-100">max-wait: 100</h1>
<h1 id="client-type-jedis">client-type: jedis</h1>
<h1 id="redis_1"># redis连接池配置</h1>
<h2 id="lettuce">含义：这个属性指定是否启用 Lettuce 连接池。</h2>
<h1 id="springdataredislettucepoolenabledtrue">spring.data.redis.lettuce.pool.enabled=true</h1>
<h1 id="_2"># 含义：这个属性定义了连接池中允许的最大活动连接数。</h1>
<h1 id="springdataredislettucepoolmax-active8">spring.data.redis.lettuce.pool.max-active=8</h1>
<h1 id="_3"># 含义：这个属性定义了连接池中允许的最大空闲连接数。</h1>
<h1 id="springdataredislettucepoolmax-idle5">spring.data.redis.lettuce.pool.max-idle=5</h1>
<h1 id="_4"># 含义：这个属性定义了在获取连接时最长的等待时间（以毫秒为单位）。</h1>
<h1 id="springdataredislettucepoolmax-wait100">spring.data.redis.lettuce.pool.max-wait=100</h1>
<p><code>3) 自定义序列化器（手动注册一个redistemplate)</code>java
@Configuration<br />
public class RedisTemplateConfig {<br />

    @Bean<br />
    public RedisTemplate<String, Object> redisTemplate(RedisConnectionFactory connectionFactory){<br />
        // 创建RedisTemplate对象<br />
        RedisTemplate<String, Object> template = new RedisTemplate&lt;&gt;();<br />
        // 设置连接工厂<br />
        template.setConnectionFactory(connectionFactory);<br />
        // 创建JSON序列化工具<br />
        GenericJackson2JsonRedisSerializer jsonRedisSerializer =<br />
                new GenericJackson2JsonRedisSerializer();<br />
        // 设置Key的序列化<br />
        template.setKeySerializer(RedisSerializer.string());<br />
        template.setHashKeySerializer(RedisSerializer.string());<br />
        // 设置Value的序列化<br />
        template.setValueSerializer(jsonRedisSerializer);<br />
        template.setHashValueSerializer(jsonRedisSerializer);<br />
        // 返回修改的模板对象<br />
        return template;<br />
    }<br />
}
```</p>
<h4 id="66">6.6 事务和锁</h4>
<h5 id="1_5">1. 概念</h5>
<pre><code>在redis中，事务就是一系列命令组个队（QUEUE），但是不像 mysql，redis 的事务是没有 ACID 的。
而锁是因为在事务还没执行之前，也就是组队期间，当前事务要访问的数据可能被其他命令所修改，从而导致脏读。
</code></pre>
<h5 id="2_6">2. 代码实现</h5>
<div class="highlight"><pre><span></span><code>// 事务
multi  开启事务
exec 执行事务
discard 取消事务


// 锁
watch key1 key2 ... 
</code></pre></div>
<h5 id="3_3">3. 悲观锁和乐观锁</h5>
<pre><code>悲观锁的意思就是悲观的认为事务要访问的数据会被其他命令或者事务所修改，所以我直接给数据上锁，让别人在我所执行过程中不能使用这个数据，因此，悲观锁性能会差点。
而乐观锁就是认为本次要访问的数据不会被其他命令或者事务所修改，就算其他事务或命令要修改，也让他们去修改，我在重新开一次事务就行了。
java用的是悲观锁机制，而redis是乐观锁机制。
</code></pre>
<h4 id="67-lua">6.7 Lua 脚本</h4>
<pre><code>Lua 是一门轻量级、可嵌入的脚本语言，设计目标是高效、简洁、可扩展，常用于游戏开发、嵌入式系统和高性能服务中（如 Redis）。
在 redis 中，lua可以一次执行多条redis命令，从而减少与redis的连接次数，提升性能。同时，这些 redis 命令是原子的，复合的。也就是要么全部执行，要么全部不执行。
</code></pre>
<p>使用方法：</p>
<pre><code>1. 编写 lua 脚本，将 lua 脚本存到 resources 下
2. 我们需要将 lua 脚本转为 resource 对象，然后再转为 RedisScript 对象并注册到 ioc 容器中。
3. 然后，通过 script.execute() 方法就可以调用这个 lua 脚本。
</code></pre>
<p><code>java
@Bean
public RedisScript&lt;Boolean&gt; booleanRedisScript(){
    //加载脚本文件
    Resource resource = new ClassPathResource("lua/change.lua");

    //参数1： 加载脚本的资源对象 参数2： 返回值类型
    RedisScript&lt;Boolean&gt; booleanRedisScript = RedisScript.of(resource, Boolean.class);

    return booleanRedisScript;
}</code></p>
<h4 id="68-redis">6.8 Redis 的持久化策略</h4>
<h5 id="1-rdb">1. RDB</h5>
<pre><code>在指定时间间隔内，将内存中的数据集快照写入磁盘，生成一个 dump.rdb 文件
</code></pre>
<div class="highlight"><pre><span></span><code>// 持久化文件名字配置
dbfilename dump.rdb （481行）

// dump.rdb 存放的位置
dir ./ （默认配置）
</code></pre></div>
<p>触发持久化的方法：
<div class="highlight"><pre><span></span><code>save 在主进程去进行持久化
bgsave
shutdown
flushall


// 官方提供的配置
save 900 1 # 在900秒（15分钟）内，如果至少有1个键发生改变，则执行RDB持久化
save 300 10 # 在300秒（5分钟）内，如果至少有10个键发生改变，则执行RDB持久化
save 60 10000 # 在60秒内，如果至少有10,000个键发生改变，则执行RDB持久化
注意: 周期一定执行完毕才会触发持久化!不会中途触发! 所以rdb自动备份可能会丢失数据
</code></pre></div></p>
<h5 id="2-aof">2. AOF</h5>
<pre><code>记录服务器接收到的每一个写命令，以协议格式追加到 appendonly.aof 文件末尾。重启时通过重放命令恢复数据
</code></pre>
<div class="highlight"><pre><span></span><code>// 持久化的文件名配置 
appendfilename &quot;appendonly.aof&quot;

// &quot;appendonly.aof 存放的位置
dir ./

// 写的频率
appendfsync always
appendfsync everysec 默认用这个
appendfsync no

// 是否开启
appendonly no --&gt; yes
</code></pre></div>
<p>重写压缩机制：
 1.  aof 才有重写机制
 2.  aof 存储写命令的文本文件
 3.  重写会减少 aof 文件的大小， aof 重写保证存的是能够恢复数据的最小指令集
 4. aof 可以自动触发重写，也可以手动触发：bgrewriteaof
<div class="highlight"><pre><span></span><code><span class="n">auto</span><span class="o">-</span><span class="n">aof</span><span class="o">-</span><span class="n">rewrite</span><span class="o">-</span><span class="n">percentage</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">150</span><span class="o">%</span><span class="w"> </span><span class="err">#</span><span class="n">增量百分比</span>
<span class="n">auto</span><span class="o">-</span><span class="n">aof</span><span class="o">-</span><span class="n">rewrite</span><span class="o">-</span><span class="n">min</span><span class="o">-</span><span class="n">size</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="n">MB</span><span class="w"> </span><span class="err">#</span><span class="n">设置第一次压缩的基准值</span>
<span class="nl">第一次</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="o">+</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="mi">150</span><span class="o">%</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">250</span><span class="n">MB</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="mi">80</span><span class="n">MB</span>
<span class="nl">第二次</span><span class="p">:</span><span class="w"> </span><span class="mi">80</span><span class="o">+</span><span class="mi">80</span><span class="o">*</span><span class="mi">150</span><span class="o">%</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">200</span><span class="n">MB</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">.....</span>
</code></pre></div></p>
<p>选择建议：
    a.  官网推荐两个都开启，开启的AOF优先生效
    b.  非敏感数据，建议RDB
    c.  单纯的缓存，建议都不开启
    d.  敏感数据，建议都开启</p>
<h4 id="69-redis">6.9 Redis 主从</h4>
<pre><code>主从是来实现读写分离的，主负责写入数据并负责将数据写入从，从负责读取数据，并且接受主发来的同步数据。
</code></pre>
<h5 id="1_6">1. 主从实现方法</h5>
<ol>
<li>准备多份配置文件
<div class="highlight"><pre><span></span><code><span class="n">include</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">myredis</span><span class="o">/</span><span class="n">redis</span><span class="p">.</span><span class="na">conf</span>
<span class="n">pidfile</span><span class="w"> </span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">redis_6379</span><span class="p">.</span><span class="na">pid</span>
<span class="n">port</span><span class="w"> </span><span class="mi">6379</span>
<span class="n">dbfilename</span><span class="w"> </span><span class="n">dump6379</span><span class="p">.</span><span class="na">rdb</span>
</code></pre></div></li>
<li>
<p>启动这三台 redis 服务
<div class="highlight"><pre><span></span><code>redis-server xxx.conf
</code></pre></div></p>
</li>
<li>
<p>构建主从模式
<div class="highlight"><pre><span></span><code>slave of ip port --&gt; replicaof ip port
info replication（查看角色）
</code></pre></div></p>
</li>
</ol>
<h5 id="2_7">2. 主从实现原理</h5>
<pre><code>a.  全量复制: 小弟连接到主机，主机第一次会将所有数据都传递给小弟！（全量）
b.  增量复制：后续的主机数据更新，都属于增量复制，得到的新数据会立即同步给小弟（增强）
c.  主从模式通过全量+增量提高了性能的同时，也能保证任意时刻加入的小弟都有主机的全部数据
d.  我们必须知道，主从模式数据是有延迟性的！（主机-》写入数据-》从机没有读到）
</code></pre>
<h5 id="3_4">3. 哨兵机制</h5>
<pre><code>哨兵的存在就是当主机出现故障时，自动的选择一个从机当作主机，然后让其他从机都执行 replicaof ip host，从而实现换主，当曾经的主机回来后，也会变成当前主机的从机。

a.  编写哨兵配置
</code></pre>
<p><code>sentinel monitor mymaster 127.0.0.1 6379 1</code></p>
<pre><code>b.  启动哨兵模式
</code></pre>
<p><code>redis-sentinel sentinel.conf</code></p>
<h4 id="610-redis">6.10 redis 集群</h4>
<pre><code>Redis 集群（Redis Cluster）是 Redis 官方提供的分布式解决方案，用于实现数据分片（sharding）、高可用和水平扩展。
</code></pre>
<p>核心特性：</p>
<pre><code>自动分片：将数据分散到多个节点（最多 16384 个哈希槽）
高可用：每个主节点可配置从节点，主节点故障时自动故障转移
去中心化：无中心代理，客户端直连任意节点，集群内部自动重定向
写能力扩展：多主架构，突破单机写性能瓶颈
</code></pre>
<p>核心原理：</p>
<ul>
<li>Redis 集群将整个键空间划分为 <strong>16384 个哈希槽（hash slots）</strong></li>
<li>每个 key 通过 <code>CRC16(key) % 16384</code> 计算出所属槽位</li>
<li>每个主节点负责一部分槽位（例如 3 主节点：0-5460, 5461-10922, 10923-16383）</li>
</ul>
<h5 id="_5">集群相关命令</h5>
<ol>
<li>
<p>每个节点的配置文件
<div class="highlight"><pre><span></span><code>include /root/myredis/redis.conf
port 6379
pidfile &quot;/var/run/redis_6379.pid&quot;
dbfilename &quot;dump6379.rdb&quot;
cluster-enabled yes
cluster-config-file nodes-6379.conf
cluster-node-timeout 15000
</code></pre></div></p>
</li>
<li>
<p>将多个 redis 组成集群
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">每个服务都要清空</span>
<span class="n">redis</span><span class="o">-</span><span class="n">cli</span><span class="w"> </span><span class="o">--</span><span class="n">cluster</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="o">--</span><span class="n">cluster</span><span class="o">-</span><span class="n">replicas</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="mf">172.17.14.36</span><span class="p">:</span><span class="mi">6379</span><span class="w"> </span><span class="mf">172.17.14.36</span><span class="p">:</span><span class="mi">6380</span><span class="w"> </span><span class="mf">172.17.14.36</span><span class="p">:</span><span class="mi">6381</span><span class="w"> </span><span class="mf">172.17.14.36</span><span class="p">:</span><span class="mi">6382</span><span class="w"> </span><span class="mf">172.17.14.36</span><span class="p">:</span><span class="mi">6383</span><span class="w"> </span><span class="mf">172.17.14.36</span><span class="p">:</span><span class="mi">6384</span>
</code></pre></div></p>
</li>
<li>
<p>连接集群
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">登录必须是</span><span class="o">-</span><span class="n">c链接的集群不是每个节点</span>
<span class="n">redis</span><span class="o">-</span><span class="n">cli</span><span class="w"> </span><span class="o">-</span><span class="n">c</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">6383</span>

<span class="err">#</span><span class="w"> </span><span class="n">查看集群中节点</span>
<span class="n">cluster</span><span class="w"> </span><span class="n">nodes</span><span class="w"> </span><span class="n">查看节点关系</span>

<span class="err">#</span><span class="w"> </span><span class="n">redis集群的数据存储</span><span class="err">（</span><span class="n">集群</span><span class="err">，</span><span class="n">真正的能解决数据的并发写问题</span><span class="err">！）</span>
<span class="n">存储过程</span><span class="err">：</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">CRC16</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="err">》</span><span class="w"> </span><span class="n">整数</span><span class="w"> </span><span class="o">=</span><span class="err">》</span><span class="w"> </span><span class="o">%</span><span class="mi">16384</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">index</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">存储到对应的slot</span>
<span class="n">节点</span><span class="w"> </span><span class="n">A</span><span class="w"> </span><span class="n">负责处理</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="n">号至</span><span class="w"> </span><span class="mi">5460</span><span class="w"> </span><span class="n">号插槽</span><span class="err">。</span>
<span class="n">节点</span><span class="w"> </span><span class="n">B</span><span class="w"> </span><span class="n">负责处理</span><span class="w"> </span><span class="mi">5461</span><span class="w"> </span><span class="n">号至</span><span class="w"> </span><span class="mi">10922</span><span class="w"> </span><span class="n">号插槽</span><span class="err">。</span>
<span class="n">节点</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">负责处理</span><span class="w"> </span><span class="mi">10923</span><span class="w"> </span><span class="n">号至</span><span class="w"> </span><span class="mi">16383</span><span class="w"> </span><span class="n">号插槽</span><span class="err">。</span>

<span class="n">set</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="n">xx</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">redirect</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">master节点</span><span class="w"> </span><span class="o">-</span><span class="err">》</span><span class="w"> </span><span class="n">存储数据</span>

<span class="err">#</span><span class="n">一次设置多对键值对</span>
<span class="n">mset</span><span class="w"> </span><span class="n">key</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="n">key</span><span class="p">{</span><span class="mi">1</span><span class="p">}</span><span class="w"> </span><span class="p">....{</span><span class="mi">1</span><span class="p">}</span><span class="n">slot值进行存储</span>
</code></pre></div></p>
</li>
<li>
<p>计算 key 的slot
<div class="highlight"><pre><span></span><code><span class="o">-</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="n">keyslot</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="n">计算key应该保存在那个插槽</span>
<span class="o">-</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="n">countkeysinslot</span><span class="w"> </span><span class="n">slot的值</span><span class="w"> </span><span class="n">计算某个插槽中保存的key的数量</span>
<span class="o">-</span><span class="w"> </span><span class="n">CLUSTER</span><span class="w"> </span><span class="n">GETKEYSINSLOT</span><span class="w"> </span><span class="err">\</span><span class="o">&lt;</span><span class="n">slot</span><span class="o">&gt;</span><span class="err">\</span><span class="o">&lt;</span><span class="n">count</span><span class="o">&gt;</span><span class="w"> </span><span class="n">返回</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="n">个</span><span class="w"> </span><span class="n">slot</span><span class="w"> </span><span class="n">槽中的键</span><span class="err">。</span>
</code></pre></div></p>
</li>
<li>
<p>集群故障恢复
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">单个分区的master挂了</span>
<span class="n">集群内部自带哨兵</span>
<span class="n">主节点挂了以后</span><span class="err">，</span><span class="n">自动选举丛节点当选主节点</span>

<span class="mf">2.</span><span class="w"> </span><span class="n">单个分区都挂了</span>
<span class="o">-</span><span class="w"> </span><span class="n">redis</span><span class="p">.</span><span class="na">conf中cluster</span><span class="o">-</span><span class="n">require</span><span class="o">-</span><span class="n">full</span><span class="o">-</span><span class="n">coverage</span><span class="w"> </span><span class="n">为yes</span><span class="w"> </span><span class="n">那么</span><span class="err">，</span><span class="n">整个集群都挂掉</span>
<span class="o">-</span><span class="w"> </span><span class="n">redis</span><span class="p">.</span><span class="na">conf中cluster</span><span class="o">-</span><span class="n">require</span><span class="o">-</span><span class="n">full</span><span class="o">-</span><span class="n">coverage</span><span class="w"> </span><span class="n">为no</span><span class="w"> </span><span class="n">那么</span><span class="err">，</span><span class="n">只有该插槽数据全都不能使用</span><span class="err">。</span>
</code></pre></div></p>
</li>
</ol>
<h2 id="docker-2375">七 Docker 2375</h2>
<h4 id="71-docker">7.1 什么是docker</h4>
<pre><code>Docker 是一个开源的容器化平台，用于将应用及其依赖打包到轻量、可移植的容器中。
</code></pre>
<h4 id="72-docker">7.2 docker 架构</h4>
<p>![[Pasted image 20251118081318.png]]
- <strong>镜像（Image）</strong>：只读模板，用于创建容器。
- <strong>容器（Container）</strong>：镜像的运行实例。
- <strong>Docker Hub</strong>：官方镜像仓库，可拉取/推送镜像。</p>
<h4 id="73-docker">7.3 安装docker</h4>
<ol>
<li>
<p>先去安装c,c++环境
<div class="highlight"><pre><span></span><code><span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">gcc</span>
<span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">gcc</span><span class="o">-</span><span class="n">c</span><span class="o">++</span>
</code></pre></div></p>
</li>
<li>
<p>再去安装一些docker的依赖
<div class="highlight"><pre><span></span><code><span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">-</span><span class="n">y</span><span class="w"> </span><span class="n">yum</span><span class="o">-</span><span class="n">utils</span><span class="w"> </span><span class="err">\</span>
<span class="w">  </span><span class="n">device</span><span class="o">-</span><span class="n">mapper</span><span class="o">-</span><span class="n">persistent</span><span class="o">-</span><span class="n">data</span><span class="w"> </span><span class="err">\</span>
<span class="w">  </span><span class="n">lvm2</span>
</code></pre></div></p>
</li>
<li>
<p>添加镜像源
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="mi">12</span><span class="n">月1日</span><span class="err">，</span><span class="n">发现这个源有问题</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">yum</span><span class="o">-</span><span class="n">config</span><span class="o">-</span><span class="n">manager</span><span class="w"> </span><span class="err">\</span>
<span class="w">    </span><span class="o">--</span><span class="n">add</span><span class="o">-</span><span class="n">repo</span><span class="w"> </span><span class="err">\</span>
<span class="w">    </span><span class="n">https</span><span class="p">:</span><span class="c1">//download.docker.com/linux/centos/docker-ce.repo</span>

<span class="err">#</span><span class="w"> </span><span class="n">清华源</span>
<span class="n">sed</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="err">&#39;</span><span class="n">s</span><span class="o">+</span><span class="n">https</span><span class="p">:</span><span class="c1">//download.docker.com+https://mirrors.tuna.tsinghua.edu.cn/docker-ce+&#39; /etc/yum.repos.d/docker-ce.repo</span>
</code></pre></div></p>
</li>
<li>
<p>安装docker
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">一个一个安装</span><span class="err">，</span><span class="n">不然有问题</span>
<span class="n">sudo</span><span class="w"> </span><span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">-</span><span class="n">y</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">ce</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">ce</span><span class="o">-</span><span class="n">cli</span><span class="w"> </span><span class="n">containerd</span><span class="p">.</span><span class="na">io</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">buildx</span><span class="o">-</span><span class="n">plugin</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="o">-</span><span class="n">plugin</span>
<span class="err">#</span><span class="w"> </span><span class="n">一键安装</span>
<span class="n">curl</span><span class="w"> </span><span class="o">-</span><span class="n">fsSL</span><span class="w"> </span><span class="n">https</span><span class="p">:</span><span class="c1">//github.com/tech-shrimp/docker_installer/releases/download/latest/linux.sh| bash -s docker --mirror Aliyun</span>
</code></pre></div></p>
</li>
<li>
<p>删除 docker
<div class="highlight"><pre><span></span><code>yum remove docker \  
                  docker-client \  
                  docker-client-latest \  
                  docker-common \  
                  docker-latest \  
                  docker-latest-logrotate \  
                  docker-logrotate \  
                  docker-engine
</code></pre></div></p>
</li>
</ol>
<h4 id="74-docker">7.4 docker的配置</h4>
<ol>
<li>
<p>配置仓库
<div class="highlight"><pre><span></span><code><span class="n">sudo</span><span class="w"> </span><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">docker</span><span class="w"> </span>
<span class="n">sudo</span><span class="w"> </span><span class="n">tee</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">docker</span><span class="o">/</span><span class="n">daemon</span><span class="p">.</span><span class="na">json</span><span class="w"> </span><span class="o">&lt;&lt;-</span><span class="err">&#39;</span><span class="n">EOF</span><span class="err">&#39;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;registry-mirrors&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s">&quot;https://kf7vf3vo.mirror.aliyuncs.com&quot;</span><span class="o">]</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="n">EOF</span><span class="w"> </span>
<span class="n">sudo</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">daemon</span><span class="o">-</span><span class="n">reload</span><span class="w"> </span>
<span class="n">sudo</span><span class="w"> </span><span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">docker</span>
</code></pre></div></p>
</li>
<li>
<p>完整配置如下（现在阿里的仓库不对外开放了，只能阿里云的云服务器才能用）
<div class="highlight"><pre><span></span><code><span class="n">坑</span><span class="err">：</span><span class="n">最后不要有逗号</span><span class="err">！！</span>
<span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;registry-mirrors&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="s">&quot;https://docker.m.daocloud.io&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;https://docker.1panel.live&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;https://docker.xuanyuan.me&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;https://registry.dockermirror.com&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;https://hub-mirror.c.163.com&quot;</span>
<span class="w">        </span><span class="o">]</span>
<span class="p">}</span>

<span class="c1">// 腾讯云服务器的配置</span>
<span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="s">&quot;registry-mirrors&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="s">&quot;https://docker.m.daocloud.io&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;https://docker.1panel.live&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;https://docker.xuanyuan.me&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;https://registry.dockermirror.com&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;https://hub-mirror.c.163.com&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;https://mirror.ccs.tencentyun.com&quot;</span>
<span class="w">        </span><span class="o">]</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>配置允许远程连接（为了后续把springboot项目打包成镜像，上传到docker）</p>
</li>
<li></li>
<li><code>-H tcp://0.0.0.0:2375</code>：开启 TCP 端口监听，允许所有 IP 访问（生产环境建议限制 IP）。</li>
<li><code>-H fd://</code>：保留默认 Unix socket 方式（本地通信仍可用）。</li>
<li><code>2375</code> 是 Docker 默认的远程 API 端口。
<div class="highlight"><pre><span></span><code><span class="c1">// 1. 编辑配置文件</span>
<span class="n">vim</span><span class="w"> </span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="na">service</span>

<span class="c1">// 2. 修改配置</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dockerd</span><span class="w"> </span><span class="o">-</span><span class="n">H</span><span class="w"> </span><span class="n">fd</span><span class="p">:</span><span class="c1">// --containerd=/run/containerd/containerd.sock</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">dockerd</span><span class="w"> </span><span class="o">-</span><span class="n">H</span><span class="w"> </span><span class="n">tcp</span><span class="p">:</span><span class="c1">//0.0.0.0:2375 -H fd:// --containerd=/run/containerd/containerd.sock</span>

<span class="c1">// 3. 重启服务</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">daemon</span><span class="o">-</span><span class="n">reload</span><span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="n">重载</span><span class="w"> </span><span class="n">systemd</span><span class="w"> </span><span class="n">配置</span>
<span class="n">systemctl</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">docker</span><span class="w">       </span><span class="err">#</span><span class="w"> </span><span class="n">重启</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">服务</span>
</code></pre></div></li>
</ol>
<h4 id="74-docker_1">7.4 docker常用命令</h4>
<pre><code>镜像是由很多层组成的，这样的好处是层是公用的，这样下载其他镜像时可以复用之前下载过的层。
</code></pre>
<h5 id="1_7">1. 镜像相关</h5>
<div class="highlight"><pre><span></span><code><span class="c1">//  查看中央仓库</span>
<span class="n">docker</span><span class="w"> </span><span class="n">search</span><span class="w"> </span><span class="n">镜像关键字</span><span class="p">:</span><span class="n">版本</span><span class="w">  </span>

<span class="c1">// 查看本地镜像</span>
<span class="n">docker</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="o">-</span><span class="n">a</span><span class="w"> </span>

<span class="c1">// 拉取镜像</span>
<span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">镜像名称</span><span class="p">:</span><span class="n">版本号</span><span class="w"> </span>

<span class="c1">//删除镜像</span>
<span class="n">docker</span><span class="w"> </span><span class="n">rmi</span><span class="w"> </span><span class="o">--</span><span class="n">force</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">id</span><span class="o">/</span><span class="n">镜像名称</span><span class="p">:</span><span class="n">版本号</span><span class="w"> </span>

<span class="c1">// 删除所有</span>
<span class="n">ddocker</span><span class="w"> </span><span class="n">rmi</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="nf">$</span><span class="p">(</span><span class="n">docker</span><span class="w"> </span><span class="n">images</span><span class="w"> </span><span class="o">-</span><span class="n">aq</span><span class="p">)</span>

<span class="c1">// 从本地加载镜像（也就是把tar --&gt; 镜像）</span>
<span class="n">docker</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">xxx</span><span class="p">.</span><span class="na">tar</span><span class="w">  </span>
</code></pre></div>
<h5 id="2_8">2. 容器相关</h5>
<div class="highlight"><pre><span></span><code><span class="c1">// 查看容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="o">-</span><span class="n">aq</span>
<span class="o">-</span><span class="n">a</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">所有</span><span class="w">  </span><span class="n">不加</span><span class="o">-</span><span class="n">a就是只看正在运行时的</span>
<span class="o">-</span><span class="n">q</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">查id</span>

<span class="c1">// 创建容器</span>
<span class="o">-</span><span class="n">i</span><span class="err">：</span><span class="n">表示运行容器</span>
<span class="o">-</span><span class="n">t</span><span class="err">：</span><span class="n">表示容器启动后会进入其命令行</span><span class="err">。</span><span class="n">加入这两个参数后</span><span class="err">，</span><span class="n">容器创建就能登录进去</span><span class="err">。</span><span class="n">即分配一个伪终端</span><span class="err">。</span>
<span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="p">:</span><span class="n">为创建的容器命名</span><span class="err">。</span>
<span class="o">-</span><span class="n">v</span><span class="err">：</span><span class="n">表示目录映射关系</span><span class="err">（</span><span class="n">前者是宿主机目录</span><span class="err">，</span><span class="n">后者是映射到宿主机上的目录</span><span class="err">），</span><span class="n">可以使用多个</span><span class="err">－</span><span class="n">v做多个目录或文件映射</span><span class="err">。</span><span class="n">注意</span><span class="err">：</span><span class="n">最好做目录映射</span><span class="err">，</span><span class="n">在宿主机上做修改</span><span class="err">，</span><span class="n">然后共享到容器上</span><span class="err">。</span>
<span class="o">-</span><span class="n">d</span><span class="err">：</span><span class="n">在run后面加上</span><span class="o">-</span><span class="n">d参数</span><span class="p">,</span><span class="n">则会创建一个守护式容器在后台运行</span><span class="err">（</span><span class="n">这样创建容器后不会自动登录容器</span><span class="err">，</span><span class="n">如果只加</span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="n">t两个参数</span><span class="err">，</span><span class="n">创建后就会自动进去容器</span><span class="err">）。</span>
<span class="o">-</span><span class="n">p</span><span class="err">：</span><span class="n">表示端口映射</span><span class="err">，</span><span class="n">前者是宿主机端口</span><span class="err">，</span><span class="n">后者是容器内的映射端口</span><span class="err">。</span><span class="n">可以使用多个</span><span class="o">-</span><span class="n">p做多个端口映射</span>


<span class="n">交互型容器</span><span class="err">：</span><span class="n">具有和用户交互的输入和输出终端</span><span class="err">，</span><span class="n">容器创建后自动进入容器</span><span class="err">，</span><span class="n">首次退出exit容器后</span><span class="err">，</span><span class="n">容器自动关闭</span><span class="err">。</span>
<span class="n">容器启动了</span><span class="err">，</span><span class="n">但容器里面的程序没自己启动</span>
<span class="c1">// 创建容器并进入它、同时用终端于它交互</span>
<span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">容器名</span><span class="w"> </span><span class="n">镜像名</span><span class="p">:</span><span class="n">版本号</span>
<span class="nl">eg</span><span class="p">:</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">8888</span><span class="p">:</span><span class="mi">8080</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">tomcat</span><span class="w"> </span><span class="n">tomcat</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>

<span class="c1">// 进入交互式容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="n">容器名</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>

<span class="c1">// 创建守护型容器</span>
<span class="n">守护型容器</span><span class="err">：</span><span class="n">没有和用户交互终端</span><span class="err">，</span><span class="n">需要使用docker</span><span class="w"> </span><span class="n">exec进入容器</span><span class="err">，</span><span class="n">退出后</span><span class="err">，</span><span class="n">容器不会关闭</span><span class="err">。</span>
<span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">id</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">xxxx</span><span class="p">:</span><span class="n">xxxx</span><span class="w"> </span><span class="n">镜像名</span><span class="err">：</span><span class="n">版本号</span>


<span class="c1">// 运行容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="n">xxx</span>

<span class="c1">// 停止容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">stop</span><span class="w"> </span><span class="n">xxx</span>

<span class="c1">// 重启容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">xxx</span>

<span class="c1">// 删除容器     </span>
<span class="n">docker</span><span class="w"> </span><span class="n">rm</span><span class="w"> </span><span class="n">xxx</span>

<span class="c1">// 删除所有容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">rm</span><span class="w"> </span><span class="nf">$</span><span class="p">(</span><span class="n">docker</span><span class="w"> </span><span class="n">ps</span><span class="w"> </span><span class="o">-</span><span class="n">aq</span><span class="p">)</span>

<span class="c1">// 进入容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="n">xxx</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span><span class="w"> </span>

<span class="c1">// 修改容器的一些属性</span>
<span class="n">docker</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">容器名</span><span class="w"> </span><span class="n">参数</span><span class="w"> </span><span class="n">参数值</span>
<span class="nl">eg</span><span class="p">:</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="n">xxx</span><span class="w"> </span><span class="o">--</span><span class="n">restart</span><span class="w"> </span><span class="n">alaways</span>
<span class="c1">// 退出容器         </span>
<span class="n">exit</span>
</code></pre></div>
<h5 id="3_5">3. 其他命令</h5>
<ol>
<li>
<p>日志相关
<div class="highlight"><pre><span></span><code><span class="c1">// 查看容器内进程的日志</span>
<span class="n">docker</span><span class="w"> </span><span class="n">logs</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">容器名</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">id</span>

<span class="c1">// 查看容器详情信息</span>
<span class="n">docker</span><span class="w"> </span><span class="n">inspect</span><span class="w"> </span><span class="n">容器名</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">id</span>
</code></pre></div></p>
</li>
<li>
<p>宿主机与docker容器的文件传递
<div class="highlight"><pre><span></span><code><span class="c1">// 宿主机的文件与容器进行交互</span>
<span class="n">docker</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="n">宿主机的文件路径</span><span class="w"> </span><span class="n">容器名</span><span class="p">:</span><span class="n">要拷贝到该容器的路径</span>

<span class="n">docker</span><span class="w"> </span><span class="n">容器名</span><span class="p">:</span><span class="n">要拷贝到该容器的路径</span><span class="w"> </span><span class="n">cp</span><span class="w"> </span><span class="n">宿主机的文件路径</span>
</code></pre></div></p>
</li>
<li>
<p>备份与迁移
![[Pasted image 20251118111513.png]]</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1">// 1. 先通过容器去创建一个镜像</span>
<span class="n">docker</span><span class="w"> </span><span class="n">commit</span><span class="w"> </span><span class="n">容器名</span><span class="o">/</span><span class="n">id</span><span class="w"> </span><span class="n">镜像名</span>
<span class="nl">eg</span><span class="p">:</span><span class="n">docker</span><span class="w"> </span><span class="n">commit</span><span class="w"> </span><span class="n">redis01</span><span class="w"> </span><span class="n">myredis_image</span>
<span class="c1">// 2. 把镜像归纳成tar包</span>
<span class="n">docker</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="n">tar包的文件名</span><span class="w"> </span><span class="n">镜像名称</span><span class="o">/</span><span class="n">id</span>
<span class="nl">eg</span><span class="p">:</span><span class="n">docker</span><span class="w"> </span><span class="n">save</span><span class="w"> </span><span class="o">-</span><span class="n">o</span><span class="w"> </span><span class="p">.</span><span class="o">/</span><span class="n">images</span><span class="o">/</span><span class="n">redis_image</span><span class="p">.</span><span class="na">tar</span><span class="w"> </span><span class="n">myredis_image</span>

<span class="c1">// 3. 把tar包重写加载为镜像</span>
<span class="n">docker</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">镜像tar文件名称</span>
<span class="nl">eg</span><span class="p">:</span><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">load</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">images</span><span class="o">/</span>
</code></pre></div>
<h4 id="75-docker">7.5 docker 数据卷</h4>
<h6 id="1_8">1. 概念</h6>
<h6 id="2_9">2. 数据卷相关命令</h6>
<ol>
<li>
<p>查看数据卷
<div class="highlight"><pre><span></span><code><span class="n">docker</span><span class="w"> </span><span class="n">volume</span><span class="w"> </span><span class="n">ls</span>
<span class="n">docker</span><span class="w"> </span><span class="n">volume</span><span class="w"> </span><span class="n">inspect</span><span class="w"> </span><span class="n">数据卷名称</span>
</code></pre></div></p>
</li>
<li>
<p>创建数据卷
<div class="highlight"><pre><span></span><code><span class="n">docker</span><span class="w"> </span><span class="n">volume</span><span class="w"> </span><span class="n">create</span><span class="w"> </span><span class="n">数据卷名称</span>
</code></pre></div></p>
</li>
<li>
<p>删除数据卷
<div class="highlight"><pre><span></span><code><span class="n">docker</span><span class="w"> </span><span class="n">volume</span><span class="w"> </span><span class="n">rm</span><span class="w"> </span><span class="n">数据卷名称</span>
</code></pre></div></p>
</li>
<li>
<p>数据卷的挂载（也就是和哪个容器绑定）</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">id</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">xxx</span><span class="p">:</span><span class="w"> </span><span class="n">xxx</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">xxx</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">数据卷名字</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="w"> </span><span class="n">redis</span><span class="p">:</span><span class="mf">7.0.15</span>
<span class="w"> </span><span class="n">解释</span><span class="err">：</span><span class="n">数据卷名字</span><span class="p">:</span><span class="o">/</span><span class="n">data</span>
<span class="w"> </span><span class="o">/</span><span class="n">data</span><span class="w"> </span><span class="n">是容器内部的数据</span>

<span class="w"> </span><span class="n">注</span><span class="err">：</span><span class="n">卷名前面不能有</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="err">，</span><span class="n">如果有</span><span class="o">/</span><span class="err">，</span><span class="n">就是目录挂载</span><span class="err">，</span><span class="n">这样的挂载方式都不需要创建卷了</span>

<span class="w"> </span><span class="n">Docker挂载主机目录Docker访问出现cannot</span><span class="w"> </span><span class="n">open</span><span class="w"> </span><span class="n">directory</span><span class="w"> </span><span class="p">.:</span><span class="w"> </span><span class="n">Permission</span><span class="w"> </span><span class="n">denied</span>
<span class="n">解决办法</span><span class="err">：</span><span class="n">在挂载目录后多加一个</span><span class="o">--</span><span class="n">privileged</span><span class="o">=</span><span class="n">true参数即可</span>
</code></pre></div>
<p>注意事项：</p>
<pre><code>1、如果数据卷没有提前创建好，那么在创建容器的时候会自动创建对应的数据卷

2、数据卷挂载的时候数据卷名称前面没有/*

3、容器目录不存在会自动创建

4、数据卷目录如果不为空，此时会使用数据卷目录内容覆盖容器目录内容

5、数据卷目录如果为空，容器目录不为空，此时就会使用容器目录内容覆盖数据卷目录
</code></pre>
<ol>
<li>目录挂载
<div class="highlight"><pre><span></span><code><span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="o">=</span><span class="n">redis02</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">6380</span><span class="p">:</span><span class="mi">6379</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="n">redis</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="w"> </span><span class="n">redis</span><span class="p">:</span><span class="mf">7.0.10</span>
</code></pre></div></li>
</ol>
<p>注意事项：</p>
<pre><code>1、如果宿主机目录没有提前创建好，那么在创建容器的时候会自动创建对应的宿主机目录

2、宿主机目录挂载的时候宿主机目录名称前面有/

3、容器目录不存在会自动创建

4、宿主机目录如果不为空，此时会使用宿主机目录内容覆盖容器目录内容

5、宿主机目录如果为空，容器目录不为空，此时就会将容器目录内容清空掉 注意!!!!!
</code></pre>
<h4 id="76">7.6 项目部署</h4>
<h6 id="1-dockerfile">1. dockerfile</h6>
<pre><code>Dockerfile 是一个文本文件，包含一系列指令（instructions），用于自动构建 Docker 镜像。Docker 引擎会按顺序执行这些指令，最终生成一个可运行的镜像。
</code></pre>
<p>（1）FROM —— 指定基础镜像</p>
<ul>
<li>作用：定义构建新镜像所基于的父镜像（基础镜像）。</li>
<li>所有 Dockerfile 必须以 FROM 开头（注释和空行除外）。</li>
<li>centos:7 表示使用官方仓库中的 CentOS 7 镜像作为起点。</li>
<li>如果你不需要操作系统层，也可以用 scratch`（空镜像），但一般用于极简场景。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">FROM</span><span class="w"> </span><span class="n">centos</span><span class="p">:</span><span class="mi">7</span>
</code></pre></div>
<p>（2）<code>MAINTAINER</code>（已弃用，建议用 <code>LABEL</code>）</p>
<div class="highlight"><pre><span></span><code><span class="n">LABEL</span><span class="w"> </span><span class="n">maintainer</span><span class="o">=</span><span class="s">&quot;atguigu@example.com&quot;</span>
</code></pre></div>
<p>（3）<code>RUN</code> —— 在镜像中执行命令</p>
<ul>
<li><strong>作用</strong>：在构建过程中<strong>创建新的镜像层</strong>，并执行 shell 命令。</li>
<li>每个 <code>RUN</code> 会生成一层（layer），建议合并多个命令以减少层数（用 <code>&amp;&amp;</code> 连接）：
<div class="highlight"><pre><span></span><code><span class="n">RUN</span><span class="w"> </span><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">java</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">yum</span><span class="w"> </span><span class="n">update</span><span class="w"> </span><span class="o">-</span><span class="n">y</span>
</code></pre></div></li>
</ul>
<p>（4）ADD ——  复制文件/解压/下载</p>
<ul>
<li>将本地文件（如 <code>.tar.gz</code>）复制到镜像中。</li>
<li><strong>自动解压</strong> <code>.tar</code>, <code>.tar.gz</code>, <code>.zip</code> 等压缩包（仅限本地路径）。</li>
<li>也支持从 URL 下载文件（但不推荐，建议用 <code>curl</code> + <code>RUN</code> 更可控）。</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">ADD</span><span class="w"> </span><span class="n">jdk</span><span class="o">-</span><span class="mi">17_l</span><span class="n">inux</span><span class="o">-</span><span class="n">x64_bin</span><span class="p">.</span><span class="na">tar</span><span class="p">.</span><span class="na">gz</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">java</span><span class="o">/</span>
</code></pre></div>
<p>（5） ENV —— 设置环境变量</p>
<p>设置环境变量，后续的 <code>RUN</code>、容器启动时都可用。
<div class="highlight"><pre><span></span><code><span class="n">ENV</span><span class="w"> </span><span class="n">JAVA_HOME</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">jdk</span><span class="o">-</span><span class="mf">17.0.7</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">PATH</span><span class="o">=</span><span class="n">$PATH</span><span class="p">:</span><span class="n">$JAVA_HOME</span><span class="o">/</span><span class="n">bin</span>

<span class="c1">// 可以写成一行</span>
<span class="n">ENV</span><span class="w"> </span><span class="n">JAVA_HOME</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">jdk</span><span class="o">-</span><span class="mf">17.0.7</span><span class="w"> </span><span class="err">\</span>
<span class="w">    </span><span class="n">PATH</span><span class="o">=</span><span class="n">$PATH</span><span class="p">:</span><span class="n">$JAVA_HOME</span><span class="o">/</span><span class="n">bin</span>
</code></pre></div></p>
<p>（6） 其他指令：</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>WORKDIR</code></td>
<td>设置工作目录（类似 <code>cd</code>），后续 <code>RUN</code>/<code>CMD</code> 在此目录执行</td>
</tr>
<tr>
<td><code>COPY</code></td>
<td>仅复制文件（不解压），比 <code>ADD</code> 更明确</td>
</tr>
<tr>
<td><code>EXPOSE</code></td>
<td>声明容器运行时监听的端口（如 <code>8080</code>），仅为文档用途，需配合 <code>-p</code> 映射</td>
</tr>
<tr>
<td><code>CMD</code></td>
<td>容器启动时默认执行的命令（可被 <code>docker run</code> 后参数覆盖）</td>
</tr>
<tr>
<td><code>ENTRYPOINT</code></td>
<td>容器主命令，与 <code>CMD</code> 配合使用，不易被覆盖</td>
</tr>
</tbody>
</table>
<h6 id="2_10">2. 构建过程</h6>
<ol>
<li>
<p>编写dockerfile
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">使用</span><span class="w"> </span><span class="n">CentOS</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="n">作为基础镜像</span><span class="w"> </span>
<span class="n">FROM</span><span class="w"> </span><span class="n">centos</span><span class="p">:</span><span class="mi">7</span><span class="w"> </span>

<span class="err">#</span><span class="w"> </span><span class="n">标注维护者</span><span class="err">（</span><span class="n">推荐用</span><span class="w"> </span><span class="n">LABEL</span><span class="err">）</span><span class="w"> </span>
<span class="n">LABEL</span><span class="w"> </span><span class="n">maintainer</span><span class="o">=</span><span class="s">&quot;atguigu&quot;</span><span class="w"> </span>

<span class="err">#</span><span class="w"> </span><span class="n">创建</span><span class="w"> </span><span class="n">Java</span><span class="w"> </span><span class="n">安装目录</span><span class="w"> </span>
<span class="n">RUN</span><span class="w"> </span><span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">java</span><span class="w"> </span>

<span class="err">#</span><span class="w"> </span><span class="n">将本地</span><span class="w"> </span><span class="n">JDK</span><span class="w"> </span><span class="n">压缩包添加并自动解压到指定目录</span><span class="w"> </span><span class="n">ADD</span><span class="w"> </span><span class="n">jdk</span><span class="o">-</span><span class="mi">17_l</span><span class="n">inux</span><span class="o">-</span><span class="n">x64_bin</span><span class="p">.</span><span class="na">tar</span><span class="p">.</span><span class="na">gz</span><span class="w"> </span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="w"> </span>

<span class="err">#</span><span class="w"> </span><span class="n">设置环境变量</span><span class="w"> </span>
<span class="n">ENV</span><span class="w"> </span><span class="n">JAVA_HOME</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">java</span><span class="o">/</span><span class="n">jdk</span><span class="o">-</span><span class="mf">17.0.7</span><span class="w"> </span>
<span class="n">ENV</span><span class="w"> </span><span class="n">PATH</span><span class="o">=</span><span class="n">$PATH</span><span class="p">:</span><span class="n">$JAVA_HOME</span><span class="o">/</span><span class="n">bin</span><span class="w"> </span><span class="err">#</span><span class="w"> </span>

<span class="err">（</span><span class="n">可选</span><span class="err">）</span><span class="n">验证</span><span class="w"> </span><span class="n">Java</span><span class="w"> </span><span class="n">安装</span><span class="w"> </span>
<span class="n">RUN</span><span class="w"> </span><span class="n">java</span><span class="w"> </span><span class="o">-</span><span class="n">version</span>
</code></pre></div></p>
</li>
<li>
<p>构建镜像
<div class="highlight"><pre><span></span><code><span class="n">docker</span><span class="w"> </span><span class="n">build</span><span class="w"> </span><span class="o">-</span><span class="n">t</span><span class="w"> </span><span class="n">centos7</span><span class="o">-</span><span class="n">jdk17</span><span class="w"> </span><span class="p">.</span>
</code></pre></div></p>
</li>
<li>
<p><code>-t</code>：指定镜像名称和标签</p>
</li>
<li><code>.</code>：表示当前目录为构建上下文（Dockerfile 和 JDK 包必须在此）</li>
</ol>
<p>#### 7.7 一些常用容器的下载与启动</p>
<p>1）mysql</p>
<div class="highlight"><pre><span></span><code><span class="c1">// 创建一个容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">di</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="o">=</span><span class="n">mysql</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">3306</span><span class="p">:</span><span class="mi">3306</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">mysql_data</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">mysql_conf</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">MYSQL_ROOT_PASSWORD</span><span class="o">=</span><span class="n">liuqiang</span><span class="w"> </span><span class="n">mysql</span><span class="p">:</span><span class="mf">8.0.30</span>


<span class="c1">// 之后，进入该容器，记得设置编码格式，否则中文可能乱码</span>
<span class="n">docker</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">LANG</span><span class="o">=</span><span class="n">C</span><span class="p">.</span><span class="na">UTF</span><span class="o">-</span><span class="mi">8</span><span class="w"> </span><span class="n">mysql</span><span class="w"> </span><span class="n">bash</span>
</code></pre></div>
<p>2）rabbitmq
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">参数</span><span class="err">：</span><span class="n">后台运行</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">容器</span>
<span class="err">#</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">参数</span><span class="err">：</span><span class="n">设置容器名称</span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">参数</span><span class="err">：</span><span class="n">映射端口号</span><span class="err">，</span><span class="n">格式是</span><span class="err">“</span><span class="n">宿主机端口号</span><span class="p">:</span><span class="n">容器内端口号</span><span class="err">”。</span><span class="mi">5672</span><span class="n">供客户端程序访问</span><span class="err">，</span><span class="mi">15672</span><span class="n">供后台管理界面访问</span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">参数</span><span class="err">：</span><span class="n">卷映射目录</span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">参数</span><span class="err">：</span><span class="n">设置容器内的环境变量</span><span class="err">，</span><span class="n">这里我们设置了登录RabbitMQ管理后台的默认用户和密码</span>
<span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="err">\</span>
<span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">rabbitmq</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">5672</span><span class="p">:</span><span class="mi">5672</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">15672</span><span class="p">:</span><span class="mi">15672</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">plugin</span><span class="p">:</span><span class="o">/</span><span class="n">plugins</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">RABBITMQ_DEFAULT_USER</span><span class="o">=</span><span class="n">root</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">RABBITMQ_DEFAULT_PASS</span><span class="o">=</span><span class="n">liuqiang</span><span class="w"> </span><span class="err">\</span>
<span class="nl">rabbitmq</span><span class="p">:</span><span class="mf">3.12.0</span><span class="o">-</span><span class="n">management</span>


<span class="c1">// 然后，把插件上传到数据卷后，启动插件即可</span>
<span class="n">rabbitmq</span><span class="o">-</span><span class="n">plugins</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">rabbitmq_delayed_message_exchange</span>
</code></pre></div></p>
<p>3）nacos
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">拉取镜像</span>
<span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">nacos</span><span class="o">/</span><span class="n">nacos</span><span class="o">-</span><span class="n">server</span><span class="p">:</span><span class="n">v2</span><span class="mf">.1.1</span>

<span class="err">#</span><span class="w"> </span><span class="n">创建容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">nacos</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">MODE</span><span class="o">=</span><span class="n">standalone</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">8848</span><span class="p">:</span><span class="mi">8848</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">9848</span><span class="p">:</span><span class="mi">9848</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">nacos</span><span class="o">/</span><span class="n">nacos</span><span class="o">-</span><span class="n">server</span><span class="p">:</span><span class="n">v2</span><span class="mf">.1.1</span>

<span class="err">#</span><span class="w"> </span><span class="n">nacos2</span><span class="p">.</span><span class="na">x的版本新增了一个客户端与服务端的gRpc的通讯端口号9848</span>
</code></pre></div></p>
<p>4）redis
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">创建redis数据存放以及配置文件</span>

<span class="n">mkdir</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="o">/</span><span class="n">mydata</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">conf</span><span class="w"> </span><span class="o">/</span><span class="n">mydata</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">data</span>
<span class="n">touch</span><span class="w"> </span><span class="o">/</span><span class="n">mydata</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">redis</span><span class="p">.</span><span class="na">conf</span>

<span class="mf">2.</span><span class="w"> </span><span class="n">运行redis</span>
<span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="err">\</span>
<span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">redis</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">6379</span><span class="p">:</span><span class="mi">6379</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">mydata</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">data</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="n">mydata</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">conf</span><span class="o">/</span><span class="n">redis</span><span class="p">.</span><span class="na">conf</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="p">.</span><span class="na">conf</span><span class="w"> </span><span class="err">\</span>
<span class="nl">redis</span><span class="p">:</span><span class="mf">7.0.15</span><span class="w"> </span><span class="n">redis</span><span class="o">-</span><span class="n">server</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">redis</span><span class="o">/</span><span class="n">redis</span><span class="p">.</span><span class="na">conf</span>

<span class="mf">3.</span><span class="w"> </span><span class="n">进入redis</span><span class="o">-</span><span class="n">cli测试</span>
<span class="n">docker</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="n">redis</span><span class="w"> </span><span class="n">redis</span><span class="o">-</span><span class="n">cli</span>
</code></pre></div></p>
<p>5）minio
<div class="highlight"><pre><span></span><code><span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">minio</span><span class="o">/</span><span class="n">minio</span>


<span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">9000</span><span class="p">:</span><span class="mi">9000</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">9001</span><span class="p">:</span><span class="mi">9001</span><span class="w"> </span><span class="err">\</span>
<span class="o">--</span><span class="n">name</span><span class="o">=</span><span class="n">spzx_minio</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="o">--</span><span class="n">restart</span><span class="o">=</span><span class="n">always</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="s">&quot;MINIO_ROOT_USER=minioadmin&quot;</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="s">&quot;MINIO_ROOT_PASSWORD=minioadmin&quot;</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">spzx_minio</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">spzx_minio</span><span class="o">-</span><span class="n">config</span><span class="p">:</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="na">minio</span><span class="w"> </span><span class="err">\</span>
<span class="n">minio</span><span class="o">/</span><span class="n">minio</span><span class="w"> </span><span class="n">server</span><span class="w"> </span><span class="o">/</span><span class="n">data</span><span class="w"> </span><span class="o">--</span><span class="n">console</span><span class="o">-</span><span class="n">address</span><span class="w"> </span><span class="s">&quot;:9001&quot;</span>
</code></pre></div></p>
<p>6）nginx
<div class="highlight"><pre><span></span><code><span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">nginx</span>

<span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="o">=</span><span class="n">spzx_nginx</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">80</span><span class="p">:</span><span class="mi">80</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">nginx_conf</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">nginx_html</span><span class="p">:</span><span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">html</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">nginx_logs</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">nginx</span><span class="w"> </span><span class="n">nginx</span>
</code></pre></div></p>
<p>7）sentinel 默认8080
<div class="highlight"><pre><span></span><code><span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">bladex</span><span class="o">/</span><span class="n">sentinel</span><span class="o">-</span><span class="n">dashboard</span><span class="p">:</span><span class="n">latest</span>

<span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="o">=</span><span class="n">sentinel</span><span class="o">-</span><span class="n">dashboard</span><span class="w"> </span><span class="o">--</span><span class="n">restart</span><span class="o">=</span><span class="n">always</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">8858</span><span class="p">:</span><span class="mi">8858</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">bladex</span><span class="o">/</span><span class="n">sentinel</span><span class="o">-</span><span class="n">dashboard</span><span class="p">:</span><span class="n">latest</span>
</code></pre></div></p>
<p>8）elasticsearch</p>
<p>[[#11 ElasticSearch#2.1 ElasticSearch 的安装]]</p>
<p>9）portainer
<div class="highlight"><pre><span></span><code><span class="n">步骤</span><span class="w"> </span><span class="mi">1</span><span class="err">：</span><span class="n">拉取</span><span class="w"> </span><span class="n">Portainer</span><span class="w"> </span><span class="n">英文版</span>
<span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">portainer</span><span class="o">/</span><span class="n">portainer</span><span class="o">-</span><span class="n">ce</span><span class="p">:</span><span class="n">latest</span>

<span class="n">步骤</span><span class="w"> </span><span class="mi">2</span><span class="err">：</span><span class="n">启动</span><span class="w"> </span><span class="n">Portainer</span>
<span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">portainer</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">19000</span><span class="p">:</span><span class="mi">9000</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="na">sock</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">run</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="na">sock</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="n">app</span><span class="o">/</span><span class="n">portainer_data</span><span class="p">:</span><span class="o">/</span><span class="n">data</span><span class="w"> </span><span class="o">--</span><span class="n">restart</span><span class="w"> </span><span class="n">always</span><span class="w"> </span><span class="o">--</span><span class="n">privileged</span><span class="o">=</span><span class="kc">true</span><span class="w"> </span><span class="n">portainer</span><span class="o">/</span><span class="n">portainer</span><span class="o">-</span><span class="n">ce</span><span class="p">:</span><span class="n">latest</span>

<span class="n">步骤</span><span class="w"> </span><span class="mi">3</span><span class="err">：</span><span class="n">访问</span><span class="w"> </span><span class="n">Portainer</span><span class="w"> </span><span class="n">Web</span><span class="w"> </span><span class="n">界面</span>
<span class="nl">http</span><span class="p">:</span><span class="c1">//115.190.231.171:19000/</span>
</code></pre></div></p>
<p>10）zipkin
<div class="highlight"><pre><span></span><code>docker pull openzipkin/zipkin

docker run --name zipkin --restart=always -d -p 9411:9411 openzipkin/zipkin
</code></pre></div></p>
<p>11）canal
<div class="highlight"><pre><span></span><code>
</code></pre></div></p>
<p>12）mdb
[[#12 MongoDB]]</p>
<h4 id="78-docker-compose">7.8 docker compose</h4>
<p>批量管理容器  是docker内置的插件</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">启动容器</span><span class="p">(</span><span class="n">如果不存在容器就创建</span><span class="err">、</span><span class="n">存在则修改</span><span class="p">)</span>
<span class="n">docker</span><span class="w"> </span><span class="n">compose</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="p">.</span><span class="na">yml</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="o">-</span><span class="n">d</span>

<span class="err">#</span><span class="w"> </span><span class="n">删除所有容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">compose</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="p">.</span><span class="na">yml</span><span class="w"> </span><span class="n">down</span>

<span class="err">#</span><span class="w"> </span><span class="n">停止所有容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">compose</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="p">.</span><span class="na">yml</span><span class="w"> </span><span class="n">stop</span>

<span class="err">#</span><span class="w"> </span><span class="n">启动所有容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">compose</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="p">.</span><span class="na">yml</span><span class="w"> </span><span class="n">start</span>

<span class="err">#</span><span class="w"> </span><span class="n">重启所有容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">compose</span><span class="w"> </span><span class="o">-</span><span class="n">f</span><span class="w"> </span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="p">.</span><span class="na">yml</span><span class="w"> </span><span class="n">restart</span>
</code></pre></div>
<p>compose 管理多个容器的 yml 配置
<div class="highlight"><pre><span></span><code><span class="n">容器编排</span><span class="err">：</span><span class="n">docker</span><span class="o">-</span><span class="n">compose</span><span class="p">.</span><span class="na">yml</span>
<span class="o">---------------------------------------------</span>
<span class="nl">services</span><span class="p">:</span>
<span class="w">  </span><span class="n">redis</span><span class="p">:</span>
<span class="w">    </span><span class="n">image</span><span class="p">:</span><span class="w"> </span><span class="n">redis</span><span class="p">:</span><span class="mf">7.0.10</span>
<span class="w">    </span><span class="n">container_name</span><span class="p">:</span><span class="w"> </span><span class="n">redis001</span>
<span class="w">    </span><span class="n">ports</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="s">&quot;6399:6379&quot;</span>
<span class="w">    </span><span class="n">volumes</span><span class="p">:</span><span class="w"> </span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">redis</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="o">/</span><span class="n">data</span>
<span class="w">  </span><span class="n">mysql</span><span class="p">:</span>
<span class="w">    </span><span class="n">container_name</span><span class="p">:</span><span class="w"> </span><span class="n">mysql001</span>
<span class="w">    </span><span class="n">image</span><span class="p">:</span><span class="w"> </span><span class="n">mysql</span><span class="p">:</span><span class="mf">8.0.30</span>
<span class="w">    </span><span class="n">ports</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="s">&quot;3399:3306&quot;</span>
<span class="w">    </span><span class="n">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">mysql_data</span><span class="p">:</span><span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">mysql</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="n">mysql_conf</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">mysql</span>
<span class="w">    </span><span class="n">privileged</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">    </span><span class="n">environment</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="s">&quot;MYSQL_ROOT_PASSWORD=1234&quot;</span>
<span class="w">  </span><span class="n">ebuy</span><span class="p">:</span>
<span class="w">    </span><span class="n">container_name</span><span class="p">:</span><span class="w"> </span><span class="n">ebuy001</span>
<span class="w">    </span><span class="n">image</span><span class="p">:</span><span class="w"> </span><span class="n">ebuy</span><span class="o">-</span><span class="n">docker</span><span class="p">:</span><span class="n">v2</span><span class="mf">.0</span>
<span class="w">    </span><span class="n">ports</span><span class="p">:</span>
<span class="w">      </span><span class="o">-</span><span class="w"> </span><span class="s">&quot;8099:8081&quot;</span>
<span class="nl">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="n">redis</span><span class="o">-</span><span class="n">data</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="n">mysql_data</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="n">mysql_conf</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="o">---------------------------------------------</span>
</code></pre></div></p>
<h2 id="rabbitmq-5672">八 RabbitMQ  (5672)</h2>
<h4 id="81-rabbitmq">8.1 RabbitMQ 介绍</h4>
<p>![[Pasted image 20251118154521.png]]</p>
<p>RabbitMQ是由erlang语言开发，基于AMQP（Advanced Message Queue 高级消息队列协议）协议实现的消息队列，它是一种应用程序之间的通信方法，消息队列在分布式系统开发中应用非常广泛。</p>
<p>AMQP，即 Advanced Message Queuing Protocol（高级消息队列协议），是一个网络协议，是应用层协议的一个开放标准，为面向消息的中间件设计。基于此协议的客户端与消息中间件可传递消息，并不受客户端/中间件不同产品，不同的开发语言等条件的限制。2006年，AMQP 规范发布。类比HTTP。</p>
<p>2007年，Rabbit 技术公司基于 AMQP 标准开发的 RabbitMQ 1.0 发布。RabbitMQ 采用 Erlang 语言开发。Erlang 语言由 Ericson 设计，专门为开发高并发和分布式系统的一种语言，在电信领域使用广泛。</p>
<p>RabbitMQ官方地址：<a href="http://www.rabbitmq.com/">http://www.rabbitmq.com/</a></p>
<p>RabbitMQ提供了<strong>多种工作模式</strong>：简单模式，work模式 ，Publish/Subscribe发布与订阅模式，Routing路由模式，Topics主题模式等</p>
<p>![[Pasted image 20251118154557.png]]</p>
<p>官网对应模式介绍：<a href="https://www.rabbitmq.com/getstarted.html">https://www.rabbitmq.com/getstarted.html</a></p>
<h4 id="82">8.2 消息队列的功能</h4>
<h5 id="1_9">1.解耦服务</h5>
<ul>
<li>以下单功能为例，如下图，存在功能耦合度高的问题。</li>
<li>用户下单，需要保存订单，更新购物车，更新库存，还要更新积分，如果在操作过程中，有任何一个环节失败了，最终会导致操作失败，返回错误信息
![[Pasted image 20251118151250.png]]</li>
<li>而采用消息队列方式，可以很好的解决耦合度过高问题
![[Pasted image 20251118151309.png]]</li>
</ul>
<h5 id="2_11">2. 异步处理</h5>
<p>场景说明：用户注册后，需要发注册邮件和注册短信，传统的做法有两种
- 串行的方式
- 并行的方式</p>
<p><strong>(1)</strong> <strong>串行方式：</strong> 150ms</p>
<p>将注册信息写入数据库后，发送注册邮件，再发送注册短信，以上三个任务全部完成后才返回给客户端。 这有一个问题是，邮件，短信并不是必须的，它只是一个通知，而这种做法让客户端等待没有必要等待的东西。</p>
<p>(2) <strong>并行方式：</strong> 100ms</p>
<p>将注册信息写入数据库后，发送邮件的同时，发送短信，以上三个任务完成后，返回给客户端，并行的方式能提高处理的时间。</p>
<p>(3) 消息队列：55ms
引入消息队列后，把发送邮件，短信不是必须的业务逻辑异步处理</p>
<p>![[Pasted image 20251118152112.png]]</p>
<h5 id="3_6">3. 流量削峰</h5>
<p><strong>场景：</strong> 秒杀活动，一般会因为流量过大，导致应用挂掉，为了解决这个问题，一般在应用前端加入
消息队列。</p>
<p><strong>中间件模式：</strong>
消息被MQ保存起来了 ，然后系统就可以按照自己的消费能力来消费，比如每秒1000个数据，这样慢慢写入数据库，这样就不会卡死数据库了。</p>
<p><strong>流量削峰也叫做削峰填谷</strong>
![[Pasted image 20251118153111.png]]
使用了MQ之后，限制消费消息的速度为1000，但是这样一来，高峰期产生的数据势必会被积压在MQ中，高峰就被“削”掉了。但是因为消息积压，在高峰期过后的一段时间内，消费消息的速度还是会维持在 3消费完积压的消息，这就叫做“填谷”</p>
<h4 id="83-amqp-jms">8.3 AMQP 以及 JMS</h4>
<h5 id="1-amqp">1. AMQP</h5>
<p>AMQP是一种**高级消息队列协议（Advanced Message Queuing Protocol），更准确的说是一种binary wire-level protocol（链接协议）。这是其和JMS的本质差别，AMQP不从API层进行限定，而是直接定义网络交换的数据格式。</p>
<h5 id="2-jms">2. JMS</h5>
<p>JMS即<strong>Java消息服务（JavaMessage Service）</strong>应用程序接口，是一个Java平台中关于面向消息中间件（MOM）的API，用于在两个应用程序之间，或分布式系统中发送消息，进行异步通信。</p>
<h5 id="3-amqp-jms">3. AMQP 与 JMS 区别</h5>
<p>· JMS是定义了统一的接口，来对消息操作进行统一；AMQP是通过规定协议来统一数据交互的格式</p>
<p>· JMS限定了必须使用Java语言；AMQP只是协议，不规定实现方式，因此是跨语言的。</p>
<p>· JMS规定了两种消息模式；而AMQP的消息模式更加丰富</p>
<h4 id="84-docker">8.4 docker 镜像下载</h4>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">rabbitmq</span><span class="p">:</span><span class="mf">3.12</span><span class="o">-</span><span class="n">management</span>
</code></pre></div>
<p>创建启动容器
5672 ：标准端口号 15672（后台管理的端口号）
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">参数</span><span class="err">：</span><span class="n">后台运行</span><span class="w"> </span><span class="n">Docker</span><span class="w"> </span><span class="n">容器</span>
<span class="err">#</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">参数</span><span class="err">：</span><span class="n">设置容器名称</span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="n">参数</span><span class="err">：</span><span class="n">映射端口号</span><span class="err">，</span><span class="n">格式是</span><span class="err">“</span><span class="n">宿主机端口号</span><span class="p">:</span><span class="n">容器内端口号</span><span class="err">”。</span><span class="mi">5672</span><span class="n">供客户端程序访问</span><span class="err">，</span><span class="mi">15672</span><span class="n">供后台管理界面访问</span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">参数</span><span class="err">：</span><span class="n">卷映射目录</span>
<span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">参数</span><span class="err">：</span><span class="n">设置容器内的环境变量</span><span class="err">，</span><span class="n">这里我们设置了登录RabbitMQ管理后台的默认用户和密码</span>
<span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="err">\</span>
<span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">rabbitmq</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">5672</span><span class="p">:</span><span class="mi">5672</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">15672</span><span class="p">:</span><span class="mi">15672</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">v</span><span class="w"> </span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">plugin</span><span class="p">:</span><span class="o">/</span><span class="n">plugins</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">RABBITMQ_DEFAULT_USER</span><span class="o">=</span><span class="n">root</span><span class="w"> </span><span class="err">\</span>
<span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">RABBITMQ_DEFAULT_PASS</span><span class="o">=</span><span class="n">liuqiang</span><span class="w"> </span><span class="err">\</span>
<span class="nl">rabbitmq</span><span class="p">:</span><span class="mf">3.12</span><span class="o">-</span><span class="n">management</span>
</code></pre></div></p>
<h4 id="85-springboot-rabbitmq">8.5 springboot 集成 rabbitMQ</h4>
<ol>
<li>
<p>直接导入启动器即可
<div class="highlight"><pre><span></span><code><span class="o">&lt;</span><span class="n">dependencies</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">boot</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">amqp</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">boot</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">boot</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">test</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependencies</span><span class="o">&gt;</span>
</code></pre></div></p>
</li>
<li>
<p>去写yaml配置文件
<div class="highlight"><pre><span></span><code><span class="nl">spring</span><span class="p">:</span><span class="w"> </span>
<span class="w">  </span><span class="n">rabbitmq</span><span class="p">:</span><span class="w"> </span>
<span class="w">    </span><span class="n">host</span><span class="p">:</span><span class="w"> </span><span class="mf">192.168.47.100</span>
<span class="w">    </span><span class="n">port</span><span class="p">:</span><span class="w"> </span><span class="mi">5672</span><span class="w"> </span>
<span class="w">    </span><span class="n">username</span><span class="p">:</span><span class="w"> </span><span class="n">guest</span><span class="w"> </span>
<span class="w">    </span><span class="n">password</span><span class="p">:</span><span class="w"> </span><span class="mi">123456</span><span class="w"> </span>
<span class="w">    </span><span class="n">virtual</span><span class="o">-</span><span class="n">host</span><span class="p">:</span><span class="w"> </span><span class="o">/</span>
</code></pre></div></p>
</li>
</ol>
<h4 id="86">8.6 不同工作模式案例</h4>
<h6 id="1_10">1. 简单模式</h6>
<ol>
<li>
<p>生产者
    核心方法：rabbitTemplate.convertAndSend
<div class="highlight"><pre><span></span><code><span class="nd">@Autowired</span><span class="w">  </span>
<span class="kd">private</span><span class="w"> </span><span class="n">RabbitTemplate</span><span class="w"> </span><span class="n">rabbitTemplate</span><span class="p">;</span><span class="w">  </span>

<span class="nd">@Test</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testSend</span><span class="p">(){</span><span class="w">  </span>
<span class="w">    </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="s">&quot;queue_simple&quot;</span><span class="p">,</span><span class="s">&quot;hello world&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>消费者
<div class="highlight"><pre><span></span><code><span class="nd">@RabbitListener</span><span class="p">(</span><span class="n">queues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;queue_simple&quot;</span><span class="p">})</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testSimpleConsumer</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="p">){</span><span class="w">  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;消费者收到消息：&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<h6 id="2_12">2. 工人模式</h6>
<pre><code>就是一个生产者，多个消费者，同一时刻只发给一个消费者,因此，不同生产者属于竞争关系。
</code></pre>
<ol>
<li>
<p>消费者
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testWorkerSend</span><span class="p">(){</span><span class="w">  </span>
<span class="w">    </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="s">&quot;queue_worker1&quot;</span><span class="p">,</span><span class="s">&quot;hello world1&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="s">&quot;queue_worker2&quot;</span><span class="p">,</span><span class="s">&quot;hello world2&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>生产者
<div class="highlight"><pre><span></span><code><span class="nd">@RabbitListener</span><span class="p">(</span><span class="n">queues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;queue_worker1&quot;</span><span class="p">})</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testWorkerConsumer1</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="p">){</span><span class="w">  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;消费者1收到消息：&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>

<span class="nd">@RabbitListener</span><span class="p">(</span><span class="n">queues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;queue_worker2&quot;</span><span class="p">})</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testWorkerConsumer2</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="p">){</span><span class="w">  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;消费者2收到消息：&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<h6 id="3-">3. 发布-订阅模式(广播模式)</h6>
<pre><code>一个生产者，多个消费者，并且有多个队列，路由会把消息发送给所有队列。也就是一个生产者生产的数据供所有消费者使用
注：记得传构建一个广播路由以及两个队列，然后把该路由和这两个队列绑定起来，路由键设置为 "" 即可。
</code></pre>
<ol>
<li>
<p>生产者 
<code>java
@Test  
public void testPublishAndSubscribeSend(){  
    rabbitTemplate.convertAndSend("exchange_ps","","hello world");  
}</code></p>
</li>
<li>
<p>消费者
<div class="highlight"><pre><span></span><code><span class="nd">@RabbitListener</span><span class="p">(</span><span class="n">queues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;queue_ps1&quot;</span><span class="p">})</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testPsConsumer1</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="p">){</span><span class="w">  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;消费者1收到消息：&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>

<span class="nd">@RabbitListener</span><span class="p">(</span><span class="n">queues</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;queue_ps2&quot;</span><span class="p">})</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testPsConsumer2</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">msg</span><span class="p">){</span><span class="w">  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;消费者2收到消息：&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">msg</span><span class="p">);</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<h6 id="4-_1">4. 发布-订阅模式（转发模式）</h6>
<pre><code>该模式允许消费者订阅一组消息，比如消费者1订阅的消息的路由键为 a,b,c，而消费者2订阅的路由键为a，那么当转发类型的路由接收到路由键为a的消息时，这两个消费者都会收到该消息，但如果是b，则只有消费者1会收到该消息，而2不会收到该消息

代码略，也就是在路由与消息队列绑定时指定该绑定的路由键即可。
</code></pre>
<p>![[Pasted image 20251118174035.png]]</p>
<h6 id="5_4">5. 主题模式</h6>
<pre><code>主题模式实际还是发布-订阅模式，只不过此时的路由键匹配可以写统配符了。
</code></pre>
<p>![[Pasted image 20251118174018.png]]</p>
<h4 id="87-rabbitlistener">8.7 @RabbitListener</h4>
<div class="highlight"><pre><span></span><code><span class="nd">@RabbitListener</span><span class="p">(</span><span class="n">bindings</span><span class="w"> </span><span class="o">=</span><span class="w">  </span>
<span class="w">        </span><span class="nd">@QueueBinding</span><span class="p">(</span><span class="w">  </span>
<span class="w">                </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@Queue</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;queue01&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">durable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">autoDelete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">exclusive</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">),</span><span class="w">  </span>
<span class="w">                </span><span class="n">exchange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@Exchange</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;exchange01&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;direct&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">durable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">autoDelete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">internal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">),</span><span class="w">  </span>
<span class="w">                </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;key01&quot;</span><span class="p">}))</span>
</code></pre></div>
<h4 id="88">8.8 消息的可靠性投递</h4>
<p>1）生产者发送消息的可靠 开启确认+回退 --&gt; 实现接口
2）消息中间件存储消息的可靠 --&gt; 默认就是可持久化的
3）消费者处理消息的可靠  开始手动确认模式(也就是业务成功，我才给消息队列返回 ack，之后消息队列才会删除该消息)</p>
<ol>
<li>确认＋回退机制
    producer—&gt;rabbitmq broker—&gt;exchange—&gt;queue—&gt;consumer<pre><code>当交换机收到了消息时，就会向生产者发送一个确认报文，生产者可以通过监听方法来收到这个确认报文
</code></pre>
</li>
</ol>
<p>实现方式
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">先去配置文件中开始确认</span><span class="err">、</span><span class="n">回退功能</span>
<span class="n">publisher</span><span class="o">-</span><span class="n">confirm</span><span class="o">-</span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="n">CORRELATED</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">交换机的确认</span><span class="w">  </span>
<span class="n">publisher</span><span class="o">-</span><span class="n">returns</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">队列的确认</span>

<span class="mf">2.</span><span class="w"> </span><span class="n">去增强</span><span class="w"> </span><span class="n">RabbitTemplate</span><span class="err">，</span><span class="n">也就是实现</span><span class="w"> </span><span class="n">ConfirmCallback</span><span class="w"> </span><span class="n">and</span><span class="w"> </span><span class="n">ReturnsCallback</span><span class="err">，</span><span class="n">然后设置给</span><span class="w"> </span><span class="n">RabbitTemplate</span>

<span class="mf">3.</span><span class="w"> </span><span class="n">然后</span><span class="err">，</span><span class="n">就成功的开启了确认</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">回退机制</span>
</code></pre></div></p>
<div class="highlight"><pre><span></span><code><span class="cm">/**</span>
<span class="cm"> * A callback for publisher confirmations.</span>
<span class="cm"> */</span>
<span class="nd">@FunctionalInterface</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ConfirmCallback</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Confirmation callback.</span>
<span class="cm">     * @param correlationData correlation data for the callback.</span>
<span class="cm">     * @param ack true for ack, false for nack</span>
<span class="cm">     * @param cause An optional cause, for nack, when available, otherwise null.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">confirm</span><span class="p">(</span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">CorrelationData</span><span class="w"> </span><span class="n">correlationData</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ack</span><span class="p">,</span><span class="w"> </span><span class="nd">@Nullable</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">cause</span><span class="p">);</span>

<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm">* A callback for returned messages.</span>
<span class="cm">* @since 2.3</span>
<span class="cm">*/</span>
<span class="nd">@FunctionalInterface</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">ReturnsCallback</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * Returned message callback.</span>
<span class="cm">     * @param returned the returned message and metadata.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">returnedMessage</span><span class="p">(</span><span class="n">ReturnedMessage</span><span class="w"> </span><span class="n">returned</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nd">@Component</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MQProducerAckConfig</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">RabbitTemplate</span><span class="p">.</span><span class="na">ConfirmCallback</span><span class="p">,</span><span class="w"> </span><span class="n">RabbitTemplate</span><span class="p">.</span><span class="na">ReturnsCallback</span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">RabbitTemplate</span><span class="w"> </span><span class="n">rabbitTemplate</span><span class="p">;</span>

<span class="w">    </span><span class="nd">@PostConstruct</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">init</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">setConfirmCallback</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">        </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">setReturnsCallback</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">confirm</span><span class="p">(</span><span class="n">CorrelationData</span><span class="w"> </span><span class="n">correlationData</span><span class="p">,</span><span class="w"> </span><span class="kt">boolean</span><span class="w"> </span><span class="n">ack</span><span class="p">,</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">cause</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ack</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;消息发送到交换机成功！数据：&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">correlationData</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;消息发送到交换机失败！数据：&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">correlationData</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot; 原因：&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">cause</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">returnedMessage</span><span class="p">(</span><span class="n">ReturnedMessage</span><span class="w"> </span><span class="n">returned</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;消息主体: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="p">(</span><span class="n">returned</span><span class="p">.</span><span class="na">getMessage</span><span class="p">().</span><span class="na">getBody</span><span class="p">()));</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;应答码: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">returned</span><span class="p">.</span><span class="na">getReplyCode</span><span class="p">());</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;描述：&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">returned</span><span class="p">.</span><span class="na">getReplyText</span><span class="p">());</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;消息使用的交换器 exchange : &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">returned</span><span class="p">.</span><span class="na">getExchange</span><span class="p">());</span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;消息使用的路由键 routing : &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">returned</span><span class="p">.</span><span class="na">getRoutingKey</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li>消息队列以及路由持久化<pre><code>我们其实不必专门创建持久化的交换机和队列，因为它们默认就是持久化的。接下来我们只需要确认一下：存放到队列中，尚未被消费端取走的消息，是否会随着RabbitMQ服务器重启而丢失？
</code></pre>
</li>
</ol>
<p>在后台管理界面创建交换机和队列时，默认就是持久化的模式。此时消息也是持久化的，不需要额外设置。</p>
<ol>
<li>消费端消息确认</li>
</ol>
<p>默认情况下，消费端取回消息后，默认会自动返回ACK确认消息，所以在前面的测试中消息被消费端消费之后，RabbitMQ得到ACK确认信息就会删除消息</p>
<p>但实际开发中，消费端根据消息队列投递的消息执行对应的业务，未必都能执行成功，如果希望能够多次重试，那么默认设定就不满足要求了</p>
<p>所以还是要修改成手动确认</p>
<div class="highlight"><pre><span></span><code><span class="nt">spring</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rabbitmq</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">virtual-host</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">    </span><span class="nt">listener</span><span class="p">:</span>
<span class="w">      </span><span class="nt">simple</span><span class="p">:</span>
<span class="w">        </span><span class="nt">acknowledge-mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span><span class="w"> </span><span class="c1"># 把消息确认模式改为手动确认</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code>basicAck()方法:给Broker返回ACK确认信息，表示消息已经在消费端成功消费，这样Broker就可以把消息删除了

basicNack()方法:给Broker返回NACK信息，表示消息在消费端消费失败，此时Broker的后续操作取决于参数requeue的值



basicReject()方法
</code></pre></div>
<table>
<thead>
<tr>
<th>参数名称</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>long deliveryTag</td>
<td>Broker给每一条进入队列的消息都设定一个唯一标识</td>
</tr>
<tr>
<td>boolean multiple</td>
<td>取值为true：为小于、等于deliveryTag的消息批量返回ACK信息 取值为false：仅为指定的deliveryTag返回ACK信息</td>
</tr>
<tr>
<td>boolean requeue</td>
<td>取值为true：Broker将消息重新放回队列，接下来会重新投递给消费端 取值为false：Broker将消息标记为已消费，不会放回队列</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td><div class="highlight"><pre><span></span><code><span class="nd">@Component</span>
<span class="nd">@Slf4j</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">MyMessageListener</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">EXCHANGE_DIRECT</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;exchange.direct.order&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">ROUTING_KEY</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;order&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kd">final</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">QUEUE_NAME</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;queue.order&quot;</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 修饰监听方法</span>
<span class="w">    </span><span class="nd">@RabbitListener</span><span class="p">(</span>
<span class="w">            </span><span class="c1">// 设置绑定关系</span>
<span class="w">            </span><span class="n">bindings</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@QueueBinding</span><span class="p">(</span>

<span class="w">                </span><span class="c1">// 配置队列信息：durable 为 true 表示队列持久化；autoDelete 为 false 表示关闭自动删除</span>
<span class="w">                </span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@Queue</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QUEUE_NAME</span><span class="p">,</span><span class="w"> </span><span class="n">durable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">autoDelete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">),</span>

<span class="w">                </span><span class="c1">// 配置交换机信息：durable 为 true 表示队列持久化；autoDelete 为 false 表示关闭自动删除</span>
<span class="w">                </span><span class="n">exchange</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nd">@Exchange</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EXCHANGE_DIRECT</span><span class="p">,</span><span class="w"> </span><span class="n">durable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">autoDelete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;false&quot;</span><span class="p">),</span>

<span class="w">                </span><span class="c1">// 配置路由键信息</span>
<span class="w">                </span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">ROUTING_KEY</span><span class="p">}</span>
<span class="w">    </span><span class="p">))</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">dataString</span><span class="p">,</span><span class="w"> </span><span class="n">Message</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">Channel</span><span class="w"> </span><span class="n">channel</span><span class="p">)</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="c1">// 1、获取当前消息的 deliveryTag 值备用</span>
<span class="w">        </span><span class="kt">long</span><span class="w"> </span><span class="n">deliveryTag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getMessageProperties</span><span class="p">().</span><span class="na">getDeliveryTag</span><span class="p">();</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 2、正常业务操作</span>
<span class="w">            </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;消费端接收到消息内容：&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">dataString</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// System.out.println(10 / 0);</span>

<span class="w">            </span><span class="c1">// 3、给 RabbitMQ 服务器返回 ACK 确认信息</span>
<span class="w">            </span><span class="n">channel</span><span class="p">.</span><span class="na">basicAck</span><span class="p">(</span><span class="n">deliveryTag</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">Exception</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">            </span><span class="c1">// 4、获取信息，看当前消息是否曾经被投递过</span>
<span class="w">            </span><span class="n">Boolean</span><span class="w"> </span><span class="n">redelivered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message</span><span class="p">.</span><span class="na">getMessageProperties</span><span class="p">().</span><span class="na">getRedelivered</span><span class="p">();</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">redelivered</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 5、如果没有被投递过，那就重新放回队列，重新投递，再试一次</span>
<span class="w">                </span><span class="n">channel</span><span class="p">.</span><span class="na">basicNack</span><span class="p">(</span><span class="n">deliveryTag</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="kc">true</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 6、如果已经被投递过，且这一次仍然进入了 catch 块，那么返回拒绝且不再放回队列</span>
<span class="w">                </span><span class="n">channel</span><span class="p">.</span><span class="na">basicReject</span><span class="p">(</span><span class="n">deliveryTag</span><span class="p">,</span><span class="w"> </span><span class="kc">false</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p>要点1：把消息确认模式改为手动确认</p>
</li>
<li>
<p>要点2：调用Channel对象的方法返回信息</p>
<ul>
<li>
<p>ACK：Acknowledgement，表示消息处理成功</p>
</li>
<li>
<p>NACK：Negative Acknowledgement，表示消息处理失败</p>
</li>
<li>
<p>Reject：拒绝，同样表示消息处理失败</p>
</li>
</ul>
</li>
<li>
<p>要点3：后续操作</p>
<ul>
<li>
<p>requeue为true：重新放回队列，重新投递，再次尝试</p>
</li>
<li>
<p>requeue为false：不放回队列，不重新投递</p>
</li>
</ul>
</li>
<li>
<p>要点4：deliveryTag 消息的唯一标识，查找具体某一条消息的依据</p>
</li>
</ul>
<h4 id="89">8.9 消息幂等性</h4>
<pre><code>只要涉及到生产者重发消息，就会导致消息队列有相同的消息，而这时候要满足消息幂等性：消费多条相同的消息与消费一条结果是相同的。
</code></pre>
<p>实现方式：乐观锁机制</p>
<pre><code>也就是给数据加一个版本号，同时消息也加一个版本号，只要消息成功的更新了数据库的数据，就给数据的版本号＋1，之后的更新就会因为版本号不同而无法进行，这就实现了相同的消息只有一条能更新数据库。
</code></pre>
<h4 id="810">8.10 消费端限流（存在默认限流）</h4>
<p>![[Pasted image 20251120105406.png]]</p>
<ul>
<li>生产者发送10000个消息</li>
<li>消费端并发能力上限：同时处理1000个请求</li>
<li>设定：每次最多从队列取回1000个请求</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="nt">spring</span><span class="p">:</span>
<span class="w">  </span><span class="nt">rabbitmq</span><span class="p">:</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">...</span>
<span class="w">    </span><span class="l l-Scalar l-Scalar-Plain">virtual-host</span><span class="p p-Indicator">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/</span>
<span class="w">    </span><span class="nt">listener</span><span class="p">:</span>
<span class="w">      </span><span class="nt">simple</span><span class="p">:</span>
<span class="w">        </span><span class="nt">acknowledge-mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">manual</span>
<span class="w">        </span><span class="nt">prefetch</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1000</span><span class="w">  </span><span class="c1"># 设置每次最多从消息队列服务器取回多少消息</span>
</code></pre></div>
<h4 id="811">8.11 消息超时</h4>
<pre><code>我们可以设置消息的超时时间，可以通过设置队列的总体时间或者给消息单独设置超时时间，从进入队列开始计时，如果在超时时间之前没被消费者取走，就会消失。
</code></pre>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">sendMessage</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">message</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="n">rabbitTemplate</span><span class="p">.</span><span class="na">convertAndSend</span><span class="p">(</span><span class="s">&quot;exchange01&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;key00&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="na">getMessageProperties</span><span class="p">().</span><span class="na">setExpiration</span><span class="p">(</span><span class="s">&quot;5000&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">msg</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="p">});</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div>
<h4 id="812">8.12 死信队列</h4>
<p>![[Pasted image 20251120113236.png]]</p>
<h6 id="1_11">1. 消息成为死信的三种情况</h6>
<ul>
<li>
<p>拒绝：消费者拒接消息，basicNack()/basicReject()，并且不把消息重新放入原目标队列，requeue=false</p>
</li>
<li>
<p>溢出：队列中消息数量到达限制。比如队列最大只能存储10条消息，且现在已经存储了10条，此时如果再发送一条消息进来，根据先进先出原则，队列中最早的消息会变成死信</p>
</li>
<li>
<p>超时：消息到达超时时间未被消费</p>
</li>
</ul>
<h6 id="2_13">2. 死信处理的方式</h6>
<ol>
<li>丢弃</li>
<li>记录到数据库</li>
<li>通过死信队列去处理</li>
</ol>
<h6 id="3_7">3. 实现方式</h6>
<pre><code>创建一个死信路由以及死信队列，然后给正常路由绑定死信路由以及路由键，从而让服务器自动的将死信发送给死信队列
</code></pre>
<h4 id="813">8.13 延迟队列</h4>
<ul>
<li>
<p>延迟队列存储的对象肯定是对应的延时消息，所谓”延时消息”是指当消息被发送以后，并不想让消费者立即拿到消息，而是等待指定时间后，消费者才拿到这个消息进行消费。</p>
</li>
<li>
<p>场景：在订单系统中，一个用户下单之后通常 有30分钟的时间进行支付，如果30分钟之内没有支付成功，那么这个订单将进行取消处理。这时就可以使用延时队列将订单信息发送到延时队列。</p>
</li>
</ul>
<h6 id="1_12">1. 实现方式</h6>
<p>1）超时+死信</p>
<p>![[Pasted image 20251120114100.png]]</p>
<p>2）插件</p>
<ul>
<li>官网地址：<a href="https://github.com/rabbitmq/rabbitmq-delayed-message-exchange">https://github.com/rabbitmq/rabbitmq-delayed-message-exchange</a></li>
<li>延迟极限：最多两天</li>
<li>导致回退回调函数被执行。因为，交换机会延迟转发给队列。</li>
</ul>
<h6 id="2_14">2. 安装方式</h6>
<ol>
<li>
<p>先去官网下载延迟队列插件
<div class="highlight"><pre><span></span><code>wget<span class="w"> </span>https://github.com/rabbitmq/rabbitmq-delayed-message-exchange/releases/download/v3.12.0/rabbitmq_delayed_message_exchange-3.12.0.ez
mv<span class="w"> </span>rabbitmq_delayed_message_exchange-3.12.0.ez<span class="w"> </span>/var/lib/docker/volumes/rabbitmq-plugin/_data
</code></pre></div></p>
</li>
<li>
<p>然后启用插件
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">登录进入容器内部</span>
<span class="n">docker</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="n">rabbitmq</span><span class="w"> </span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">bash</span>

<span class="err">#</span><span class="w"> </span><span class="n">rabbitmq</span><span class="o">-</span><span class="n">plugins命令所在目录已经配置到$PATH环境变量中了</span><span class="err">，</span><span class="n">可以直接调用</span>
<span class="n">rabbitmq</span><span class="o">-</span><span class="n">plugins</span><span class="w"> </span><span class="n">enable</span><span class="w"> </span><span class="n">rabbitmq_delayed_message_exchange</span>

<span class="err">#</span><span class="w"> </span><span class="n">退出Docker容器</span>
<span class="n">exit</span>

<span class="err">#</span><span class="w"> </span><span class="n">重启Docker容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">rabbitmq</span>
</code></pre></div></p>
</li>
</ol>
<h6 id="3_8">3. 使用方式</h6>
<pre><code>设置一个头就可以了。当然，延迟交换机必须通过参数指定路由器工作方式，同时，该交换机也可以通过注解的方式创建。
</code></pre>
<p><code>java
@Test
public void testSendDelayMessage() {
    rabbitTemplate.convertAndSend(
            EXCHANGE_DELAY,
            ROUTING_KEY_DELAY,
            "测试基于插件的延迟消息 [" + new SimpleDateFormat("hh:mm:ss").format(new Date()) + "]",
            messageProcessor -&gt; {

                // 设置延迟时间：以毫秒为单位
                messageProcessor.getMessageProperties().setHeader("x-delay", "10000");

                return messageProcessor;
            });
}</code></p>
<h2 id="springcloud-2022">九 SpringCloud 2022年版本</h2>
<h4 id="1_13">1. 什么是微服务</h4>
<p>![[Pasted image 20251120160005.png]]</p>
<pre><code>In short（简言之）, the microservice architectural style 【架构风格】[1] is an approach to developing a single application as a suite of small services【独立应用变成一套小服务】, each running in its own process and communicating with lightweight(轻量级沟通) mechanisms(每一个都运行在自己的进程内（容器）), often an HTTP resource API(用HTTP，将功能写成能接受请求). These services are built around business capabilities （独立业务能力）and independently deployable by fully automated deployment machinery（应该自动化独立部署）. There is a bare minimum of centralized management of these services（应该有一个能管理这些服务的中心）, which may be written in different programming languages (独立开发语言)and use different data storage technologies（独立的数据存储）.
</code></pre>
<p><strong>核心特性：</strong>
1. <strong>分解与独立性：</strong> 将应用分解成多个较小的独立部分，每个部分有各自的职责领域，可以<strong>独立开发、部署和维护</strong>。
2. <strong>通信：</strong> 各个服务通过<strong>轻量级 API</strong>（如 REST、消息队列）进行通信，而不是共享内存或数据库。
3. <strong>技术多样性：</strong> 允许团队为每个服务选择<strong>最合适的技术栈</strong>、编程语言和数据库。
4. <strong>数据自主性：</strong> 每个微服务通常拥有自己的<strong>数据库和数据管理模型</strong>。
5. <strong>云原生：</strong> 它是一种<strong>云原生软件构建方式</strong>，通常与<strong>容器化技术</strong>（如 Docker、Kubernetes）和 <strong>DevOps/持续交付</strong>流程结合使用。</p>
<p><strong>相比单体架构的优势：</strong>
- <strong>可扩展性更高：</strong> 各个微服务可根据自身需求独立弹性扩展。
- <strong>敏捷性更强：</strong> 加快开发和部署速度，缩短新功能上市时间。
- <strong>弹性增强：</strong> 某个服务故障时，不会影响整个应用的可用</p>
<h4 id="2_15">2. 概念汇总</h4>
<ol>
<li>微服务：一种架构风格，将单一应用分解为一组<strong>松耦合、可独立部署</strong>的小型服务，每个服务围绕特定业务功能构建，拥有自己的数据和技术栈。</li>
<li>分布式：在不同的服务器上部署不同的应用程序</li>
<li>集群：在不同的服务器上部署相同的服务</li>
<li>负载均衡：将请求尽量均衡的分发到不同的集群节点</li>
<li>网关：拦截所有服务调用请求，可以对服务进行统一的功能拓展（类似 Interceptor_</li>
<li>降级：调用服务失败了，返回一个兜底的结果</li>
<li>熔断：多次降级后，开始熔断器，之后的服务调用不再执行，而是直接返回降级结果。</li>
</ol>
<h4 id="3-springcloud">3. SpringCloud 的介绍</h4>
<p>针对微服务系统架构所存在的问题，肯定是需要有具体的技术来解决，而所使用到的技术就是Spring Clouad Alibaba。那么想要了解Spring Clouad Alibaba，那么就需要先了解一下Spring Cloud</p>
<p>下面是一些常用的组件：</p>
<ol>
<li>
<p><strong>注册中心（Nacos/Eureka）：</strong> 实现<strong>服务发现与注册</strong>。所有微服务启动时向中心注册，消费者通过中心获取服务地址。</p>
</li>
<li>
<p><strong>配置中心（Nacos）：</strong> 集中管理所有微服务的<strong>配置信息</strong>，支持配置的动态推送和更新。</p>
</li>
<li>
<p><strong>负载均衡（LoadBalancer/Ribbon）：</strong> 在集群服务器共同承担请求压力时，决定将请求分发给<strong>哪个实例</strong>（如：轮询机制、随机）。</p>
</li>
<li>
<p><strong>网关（Gateway/Zuul）：</strong> 系统的<strong>统一入口</strong>，处理所有微服务共性问题（如路由、鉴权、限流、监控等）。</p>
</li>
<li>
<p><strong>远程调用（OpenFeign/Feign）：</strong> 简化服务之间的 <strong>HTTP 调用</strong>，通过声明式接口实现远程服务访问。q</p>
</li>
<li>
<p><strong>服务降级/熔断（Sentinel/Hystrix）：</strong></p>
<ul>
<li><strong>降级：</strong> 牺牲非核心功能，确保核心功能在系统压力大时依然可用。</li>
<li><strong>熔断：</strong> 保护服务，当依赖服务故障时，快速失败，避免服务雪崩。</li>
</ul>
</li>
</ol>
<h4 id="4_3">4.  远程调用</h4>
<pre><code>远程调用直接通过 Springboot 提供的 RestTemplate就可以实现，但这是底层的，后面用其他组件。
注：该组件没有自动注册，需要手动注册
</code></pre>
<div class="highlight"><pre><span></span><code><span class="c1">// 1. 注册组件到ioc容器</span>
<span class="nd">@Configuration</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RestTemplateConfiguration</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@Bean</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">restTemplate</span><span class="p">(){</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">();</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>

<span class="c1">// 2. 通过 RestTemplate 调用远程服务</span>
<span class="n">restTemplate</span><span class="p">.</span><span class="na">getForEntity</span><span class="p">(</span><span class="s">&quot;http://localhost:10010/api/user/2&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</code></pre></div>
<p>上述的调用方式存在问题：</p>
<pre><code>1、维护性差：服务提供方的ip地址发生了改变，那么此时服务的消费方就需要更改代码
2、缺少负载均衡机制：负载均衡就是负载【请求】通过多台服务器进行处理
</code></pre>
<h4 id="5-nacos">5. Nacos</h4>
<pre><code>要想解决上述远程调用所存在的问题，就需要使用到Spring Cloud Alibaba中的Nacos注册中心。
通过注册中心可以对服务提供方和服务消费方进行解耦。具体的工作模式如下图所示：
</code></pre>
<p>![[Pasted image 20251120172658.png]]</p>
<p>工作流程说明：</p>
<pre><code>1、服务提供方在启动的时候，会向注册中心注册自己服务的详情信息(ip、端口号等)。在注册中心中会维护一张服务清单，保存这些注册信息，注册中心需要以心跳的方式去监测清单中的服务是否可用，如果不可用，需要在服务清单中剔除不可用的服务。

2、服务消费方向服务注册中心咨询服务，并获取所有服务的实例清单，然后按照指定的负载均衡算法从服务清单中选择一个服务实例进行访问。
</code></pre>
<h5 id="1-nacos">1. Nacos的介绍</h5>
<pre><code>Nacos是 Dynamic Naming and Configuration Service的首字母简称，一个更易于构建云原生应用的动态服务发现、配置管理和服务管理平台。
Nacos 致力于帮助您发现、配置和管理微服务。Nacos 提供了一组简单易用的特性集，帮助您快速实现动态服务发现、服务配置、服务元数据及流量管理。
</code></pre>
<p>![[Pasted image 20251120183525.png]]</p>
<pre><code>Nacos Server：服务注册中心，它是服务，其实例及元数据的数据库。服务实例在启动时注册到服务注册表，并在关闭时注销。服务注册中心可能会调用服务实例的健康检查 API 来验证它是否能够处理请求。Nacos Server需要独立的部署。

Nacos Client: Nacos Client负责和Nacos Server进行通讯完成服务的注册和服务的发现。

Nacos Console：是Nacos的控制模块，Nacos提供了可视化的后台管理系统，可以很容易的实现服务管理操作。
</code></pre>
<h5 id="2-nacos-docker">2. Nacos 的安装与启动（docker）</h5>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">拉取镜像</span>
<span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">nacos</span><span class="o">/</span><span class="n">nacos</span><span class="o">-</span><span class="n">server</span><span class="p">:</span><span class="n">v2</span><span class="mf">.1.1</span>

<span class="err">#</span><span class="w"> </span><span class="n">创建容器</span>
<span class="n">docker</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="o">--</span><span class="n">name</span><span class="w"> </span><span class="n">nacos</span><span class="w"> </span><span class="o">-</span><span class="n">e</span><span class="w"> </span><span class="n">MODE</span><span class="o">=</span><span class="n">standalone</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">8848</span><span class="p">:</span><span class="mi">8848</span><span class="w"> </span><span class="o">-</span><span class="n">p</span><span class="w"> </span><span class="mi">9848</span><span class="p">:</span><span class="mi">9848</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">nacos</span><span class="o">/</span><span class="n">nacos</span><span class="o">-</span><span class="n">server</span><span class="p">:</span><span class="n">v2</span><span class="mf">.1.1</span>

<span class="err">#</span><span class="w"> </span><span class="n">nacos2</span><span class="p">.</span><span class="na">x的版本新增了一个客户端与服务端的gRpc的通讯端口号9848</span>
</code></pre></div>
<p>打开浏览器访问nacos的所提供的后端管理界面：<a href="http://115.190.231.171:8848/nacos/">Nacos</a>
用户名和密码：nacos/nacos</p>
<h5 id="3-nacos">3. 微服务集成 nacos</h5>
<ol>
<li>
<p>导入依赖
<div class="highlight"><pre><span></span><code>&lt;!-- nacos作为注册中心的依赖 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre></div></p>
</li>
<li>
<p>进行配置
<div class="highlight"><pre><span></span><code>spring:
  # 配置nacos注册中心的地址
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848
  application:
    name: spzx-cloud-user   # 每一个服务注册到nacos注册中心都需要提供一个服务名称,order微服务注册的时候需要更改微服务名称
</code></pre></div></p>
</li>
<li>
<p>之后调用用服务名字代替ip地址即可</p>
</li>
</ol>
<h5 id="4-discoveryclient">4. DiscoveryClient</h5>
<pre><code>可以通过discoveryClient来获取服务的服务列表。
</code></pre>
<h5 id="5_5">5. 高级特性</h5>
<h6 id="51_1">5.1 就近机房访问</h6>
<p>![[Pasted image 20251121094939.png]]</p>
<p>实现方法：
1. 先给集群设置一个名字,然后，nacos就可以根据集群名字把节点划分为不同集群。</p>
<div class="highlight"><pre><span></span><code><span class="nt">spring</span><span class="p">:</span>
<span class="w">    </span><span class="nt">cloud</span><span class="p">:</span>
<span class="w">        </span><span class="nt">nacos</span><span class="p">:</span>
<span class="w">            </span><span class="nt">discovery</span><span class="p">:</span>
<span class="w">                </span><span class="l l-Scalar l-Scalar-Plain">cluster-name = xxx</span>
</code></pre></div>
<ol>
<li>负载均衡器的设置（负载均衡器的配置在调用者配）
<div class="highlight"><pre><span></span><code># loadbalancer要启用nacos组件提供的负载均衡算法：就近机房随机访问
spring:
    cloud:
        loadbalancer:
            nacos:
                enabled:true
</code></pre></div></li>
</ol>
<h6 id="52_1">5.2 权重配置</h6>
<pre><code>可以配置权重来设置服务实例承担服务的可能性。
</code></pre>
<p>在服务提供者端配置：
<div class="highlight"><pre><span></span><code>spring:
    cloud:
        nacos:
            discovery:weight:0 -  100
</code></pre></div></p>
<h6 id="53_1">5.3  环境隔离</h6>
<p>在实际的开发过程中，可能会存在很多个软件环境：开发环境、测试环境、生产环境。nacos 也是支持多环境隔离配置的，在 nacos 是通过 namespace 来实现多环境的隔离。</p>
<p>完整的服务注册数据存储结构如下所示：
![[Pasted image 20251121100513.png]]</p>
<p>下面是如何让服务注册到指定的命名空间：
<div class="highlight"><pre><span></span><code>spring:
    cloud:
        nacos:
            discovery:
                server-addr: nacos地址
                namespace: 对应命名空间的id
</code></pre></div></p>
<p>即使在同一个命名空间，也可以通过不同的组名划分。这个时候即使服务名字相同，也不属于一个集群</p>
<div class="highlight"><pre><span></span><code>spring:
    cloud:
        nacos:
            discovery:
                server-addr: nacos地址
                namespace: 对应命名空间的id
                group: 组名
</code></pre></div>
<h6 id="54_1">5.4 临时实例与永久实例</h6>
<pre><code>todo
</code></pre>
<h4 id="6-loadbalancer">6. LoadBalancer</h4>
<p>Spring Cloud LoadBalancer是Spring Cloud中负责客户端负载均衡的模块，其主要原理是通过选择合适的服务实例来实现负载均衡。</p>
<h5 id="1_14">1. 使用方式</h5>
<ol>
<li>在order微服务中添加依赖</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="o">&lt;!--</span><span class="w"> </span><span class="n">spring</span><span class="w"> </span><span class="n">cloud</span><span class="w"> </span><span class="n">所提供的负载均衡器</span><span class="w"> </span><span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">cloud</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">loadbalancer</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</code></pre></div>
<ol>
<li>在声明RestTemplate的方法上添加@LoadBalanced注解</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="nd">@Bean</span>
<span class="nd">@LoadBalanced</span><span class="w">       </span><span class="c1">// 让RestTemplate具有负载均衡的能力</span>
<span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">restTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li>更改远程调用代码
<div class="highlight"><pre><span></span><code><span class="c1">// 服务提供方的服务ip地址和端口号可以使用服务提供方的服务名称进行替换</span>
<span class="n">restTemplate</span><span class="p">.</span><span class="na">getForObject</span><span class="p">(</span><span class="s">&quot;http://spzx-cloud-user/api/user/findUserByUserId/&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">order</span><span class="p">.</span><span class="na">getUserId</span><span class="p">(),</span><span class="w"> </span><span class="n">User</span><span class="p">.</span><span class="na">class</span><span class="p">);</span>
</code></pre></div></li>
</ol>
<h5 id="2-loadbalancer">2. LoadBalancer 的原理</h5>
<p>Spring Cloud LoadBalancer的底层采用了一个拦截器 LoadBalancerInterceptor，拦截了RestTemplate发出的请求，对地址做了修改。用一幅图来总结一下：</p>
<p>![[Pasted image 20251121102631.png]]</p>
<p>执行流程说明：</p>
<p>1、通过LoadBalancerInterceptor请求拦截器拦截我们的RestTemplate请求：<a href="http://spzx-cloud-user/api/user/findUserByUserId/1">http://spzx-cloud-user/api/user/findUserByUserId/1</a></p>
<p>2、获取请求的url，然后从请求的url中获取服务提供方的主机名称</p>
<p>3、然后调用LoadBalancerClient中的execute方法，将服务提供方的名称传递过去</p>
<p>4、在LoadBalancerClient的choose方法中通过ReactiveLoadBalancer.Factory从Nacos注册中心中获取服务列表以及负载均衡算法实例对象</p>
<p>5、通过ReactiveLoadBalancer从服务列表中选择一个服务实例地址，然后发起远程调用</p>
<h5 id="3_9">3.  更改负载均衡算法</h5>
<p>LoadBalancer默认的负载均衡算法是RoundRobinLoadBalancer，如果想更改默认的负载均衡算法，那么此时需要向Spring容器中注册一个Bean，并且配置负载均衡的使用者。</p>
<ol>
<li>
<p>在 Spring 容器中注册一个 Bean
<div class="highlight"><pre><span></span><code><span class="nd">@Configuration</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">CustomLoadBalancerConfiguration</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cm">/**</span>
<span class="cm">     * @param environment: 用于获取环境属性配置，其中LoadBalancerClientFactory.PROPERTY_NAME表示该负载均衡器要应用的服务名称。</span>
<span class="cm">     * @param loadBalancerClientFactory: 是Spring Cloud中用于创建负载均衡器的工厂类，通过getLazyProvider方法获取ServiceInstanceListSupplier对象，以提供可用的服务列表。</span>
<span class="cm">     * ServiceInstanceListSupplier：用于提供ServiceInstance列表的接口，可以从DiscoveryClient或者其他注册中心中获取可用的服务实例列表。</span>
<span class="cm">     * @return</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="nd">@Bean</span>
<span class="w">    </span><span class="n">ReactorLoadBalancer</span><span class="o">&lt;</span><span class="n">ServiceInstance</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">randomLoadBalancer</span><span class="p">(</span><span class="n">Environment</span><span class="w"> </span><span class="n">environment</span><span class="p">,</span><span class="w"> </span><span class="n">LoadBalancerClientFactory</span><span class="w"> </span><span class="n">loadBalancerClientFactory</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">environment</span><span class="p">.</span><span class="na">getProperty</span><span class="p">(</span><span class="n">LoadBalancerClientFactory</span><span class="p">.</span><span class="na">PROPERTY_NAME</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RandomLoadBalancer</span><span class="p">(</span><span class="n">loadBalancerClientFactory</span><span class="p">.</span><span class="na">getLazyProvider</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">ServiceInstanceListSupplier</span><span class="p">.</span><span class="na">class</span><span class="p">),</span><span class="w"> </span><span class="n">name</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>配置负载均衡算法的使用者
<div class="highlight"><pre><span></span><code><span class="nd">@Configuration</span>
<span class="nd">@LoadBalancerClients</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nd">@LoadBalancerClient</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;spzx-cloud-user&quot;</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CustomLoadBalancerConfiguration</span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w">      </span><span class="c1">// 将负载均衡算法应用到指定的服务提供方中</span>
<span class="p">})</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RestTemplateConfiguration</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Bean</span>
<span class="w">    </span><span class="nd">@LoadBalanced</span><span class="w">       </span><span class="c1">// 让RestTemplate具有负载均衡的能力</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">RestTemplate</span><span class="w"> </span><span class="nf">restTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestTemplate</span><span class="p">()</span><span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<h4 id="7-openfeign">7. OpenFeign</h4>
<p>feign是一个声明式的http客户端，官方地址：<a href="https://github.com/OpenFeign/feign">https://github.com/OpenFeign/feign</a>其作用就是帮助我们优雅的实现http请求的发送。</p>
<h5 id="1_15">1. 使用方法</h5>
<ol>
<li>导入依赖
<div class="highlight"><pre><span></span><code><span class="o">&lt;!--</span><span class="w"> </span><span class="n">加入OpenFeign的依赖</span><span class="w"> </span><span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">org</span><span class="p">.</span><span class="na">springframework</span><span class="p">.</span><span class="na">cloud</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">openfeign</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</code></pre></div></li>
<li>
<p>开启功能</p>
<p>在启动类上添加@EnableFeignClients**开启OpenFeign的功能支持</p>
</li>
<li>
<p>编写 OpenFeign 的客户端
<div class="highlight"><pre><span></span><code><span class="nd">@FeignClient</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;spzx-cloud-user&quot;</span><span class="p">)</span><span class="w">     </span><span class="c1">// 声明当前接口是一个访问user-service的feign的客户端</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">UserFeignClient</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@GetMapping</span><span class="p">(</span><span class="s">&quot;/api/user/findUserByUserId/{userId}&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kd">abstract</span><span class="w"> </span><span class="n">User</span><span class="w"> </span><span class="nf">queryById</span><span class="p">(</span><span class="nd">@PathVariable</span><span class="p">(</span><span class="s">&quot;userId&quot;</span><span class="p">)</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">userId</span><span class="p">)</span><span class="w"> </span><span class="p">;</span><span class="w">   </span><span class="c1">// 根据userId查询用户信息的接口方法</span>

<span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<h5 id="2-openfeign">2. OpenFeign 的自定义配置</h5>
<p>OpenFeign可以支持很多的自定义配置，如下表所示：   </p>
<table>
<thead>
<tr>
<th>类型</th>
<th>作用</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>feign.Logger.Level</strong></td>
<td>修改日志级别</td>
<td>包含四种不同的级别：NONE、BASIC、HEADERS、FULL</td>
</tr>
<tr>
<td>feign.codec.Decoder</td>
<td>响应结果的解析器</td>
<td>http远程调用的结果做解析，例如解析json字符串为java对象</td>
</tr>
<tr>
<td>feign.codec.Encoder</td>
<td>请求参数编码</td>
<td>将请求参数编码，便于通过http请求发送</td>
</tr>
<tr>
<td>feign.Contract</td>
<td>支持的注解格式</td>
<td>默认是SpringMVC的注解</td>
</tr>
<tr>
<td>feign.Retryer</td>
<td>失败重试机制</td>
<td>请求失败的重试机制，默认是没有，不过会使用Ribbon的重试</td>
</tr>
</tbody>
</table>
<p>一般情况下，默认值就能满足我们使用，如果要自定义时，只需要创建自定义的@Bean覆盖默认Bean即可。</p>
<h6 id="21_1">2.1 日志配置</h6>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">将feign包下产生的日志的级别设置为debug</span>
<span class="nl">logging</span><span class="p">:</span>
<span class="w">  </span><span class="n">level</span><span class="p">:</span>
<span class="w">    </span><span class="n">com</span><span class="p">.</span><span class="na">atguigu</span><span class="p">.</span><span class="na">spzx</span><span class="p">.</span><span class="na">cloud</span><span class="p">.</span><span class="na">order</span><span class="p">.</span><span class="na">feign</span><span class="p">:</span><span class="w"> </span><span class="n">debug</span>

<span class="err">#</span><span class="w"> </span><span class="n">openfeign日志级别配置</span>
<span class="nl">spring</span><span class="p">:</span>
<span class="w">  </span><span class="n">cloud</span><span class="p">:</span>
<span class="w">    </span><span class="n">openfeign</span><span class="p">:</span>
<span class="w">      </span><span class="n">client</span><span class="p">:</span>
<span class="w">        </span><span class="n">config</span><span class="p">:</span><span class="w"> </span>
<span class="w">          </span><span class="k">default</span><span class="p">:</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">这里用default就是全局配置</span><span class="err">，</span><span class="n">如果是写服务名称</span><span class="err">，</span><span class="n">则是针对某个微服务的配置</span>
<span class="w">            </span><span class="n">loggerLevel</span><span class="p">:</span><span class="w"> </span><span class="n">full</span>
</code></pre></div>
<p>也可以基于Java代码来修改日志级别，先声明一个类，然后声明一个Logger.Level的对象：</p>
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">DefaultFeignConfiguration</span><span class="w">  </span><span class="p">{</span><span class="w">  </span>
<span class="w">     </span><span class="nd">@Bean</span><span class="w">  </span>
<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="n">Logger</span><span class="p">.</span><span class="na">Level</span><span class="w"> </span><span class="nf">feignLogLevel</span><span class="p">(){</span><span class="w">  </span>
<span class="w">         </span><span class="k">return</span><span class="w"> </span><span class="n">Logger</span><span class="p">.</span><span class="na">Level</span><span class="p">.</span><span class="na">BASIC</span><span class="p">;</span><span class="w"> </span><span class="c1">// 日志级别为BASIC  </span>
<span class="w">     </span><span class="p">}</span><span class="w">  </span>
<span class="w"> </span><span class="p">}</span>
</code></pre></div>
<p>如果要<strong>全局生效</strong>，将其放到启动类的@EnableFeignClients这个注解中：
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="nd">@EnableFeignClients</span><span class="p">(</span><span class="n">defaultConfiguration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DefaultFeignConfiguration</span><span class="w"> </span><span class="p">.</span><span class="na">class</span><span class="p">)</span><span class="w"> </span>
</code></pre></div>
如果是<strong>局部生效</strong>，则把它放到对应的@FeignClient这个注解中：
<div class="highlight"><pre><span></span><code><span class="w"> </span><span class="nd">@FeignClient</span><span class="p">(</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;spzx-cloud-user&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">configuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DefaultFeignConfiguration</span><span class="w"> </span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
</code></pre></div></p>
<h6 id="22_1">2.2 超时配置</h6>
<p>默认连接超时：10s，响应超时：60s</p>
<p><strong>超时机制概述</strong>：Feign 的超时机制是指在使用 Feign 进行服务间的 HTTP 调用时，设置请求的超时时间。当请求超过设定的超时时间后，Feign 将会中断该请求并抛出相应的异常。</p>
<p><strong>超时机制的意义</strong>：</p>
<p>1、防止长时间等待：通过设置适当的超时时间，可以避免客户端在请求服务时长时间等待响应而导致的性能问题。如果没有超时机制，客户端可能会一直等待，从而影响整个系统的吞吐量和响应时间。</p>
<p>2、避免资源浪费：超时机制可以帮助及时释放占用的资源，例如连接、线程等。如果请求一直处于等待状态而不超时，将导致资源的浪费和系统的负载增加。</p>
<p>3、优化用户体验：超时机制可以防止用户长时间等待无响应的情况发生，提供更好的用户体验。当请求超时时，可以及时给出错误提示或进行相应的处理，以提醒用户或采取其他措施。</p>
<p>配置如下：
<div class="highlight"><pre><span></span><code><span class="nl">spring</span><span class="p">:</span>
<span class="w">  </span><span class="n">cloud</span><span class="p">:</span>
<span class="w">    </span><span class="n">openfeign</span><span class="p">:</span>
<span class="w">      </span><span class="n">client</span><span class="p">:</span>
<span class="w">        </span><span class="n">config</span><span class="p">:</span>
<span class="w">          </span><span class="k">default</span><span class="p">:</span>
<span class="w">            </span><span class="n">loggerLevel</span><span class="p">:</span><span class="w"> </span><span class="n">full</span><span class="w">   </span>
<span class="w">            </span><span class="n">read</span><span class="o">-</span><span class="n">timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">2000</span><span class="w">          </span><span class="err">#</span><span class="w"> </span><span class="n">读取数据的超时时间设置为2s</span>
<span class="w">            </span><span class="n">connect</span><span class="o">-</span><span class="n">timeout</span><span class="p">:</span><span class="w"> </span><span class="mi">2000</span><span class="w">       </span><span class="err">#</span><span class="w"> </span><span class="n">建立连接的超时时间设置为2s</span>
</code></pre></div></p>
<h5 id="23_1">2.3 重试配置</h5>
<p>feign一旦请求超时了，那么此时就会直接抛出<strong>SocketTimeoutException</strong>: Read timed out的异常。请求超时的原因有很多种，如网络抖动、服务不可用等。如果由于网络暂时不可用导致触发了超时机制，那么此时直接返回异常信息就并不是特别的合理，尤其针对查询请求，肯定希望得到一个结果。合理的做法：<strong>触发超时以后，让feign进行重试</strong>。</p>
<ol>
<li>
<p>自定义重试器 实现 Retryer 接口
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">FeignClientRetryer</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">Retryer</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="c1">// 定义两个成员变量来决定重试次数</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="w"> </span><span class="p">;</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">continueOrPropagate</span><span class="p">(</span><span class="n">RetryableException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">     </span><span class="c1">// 是否需要进行重试取决于该方法是否抛出异常，如果抛出异常重试结束</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">start</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">end</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RuntimeException</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">start</span><span class="o">++</span><span class="w"> </span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nd">@Override</span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Retryer</span><span class="w"> </span><span class="nf">clone</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">    </span><span class="c1">// 框架底层调用该方法得到一个重试器</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">FeignClientRetryer</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>配置重试器
<div class="highlight"><pre><span></span><code>spring:  
  cloud:  
    openfeign:  
      client:   
        config:  
          default: # 配置哪个服务，如果写default就是全局配置  
            logger-level:  full  
            connect-timeout: 3000  
            read-timeout: 3000  
            retryer: &quot;person.ltb.openfeign.MyRetryer&quot;
</code></pre></div></p>
</li>
</ol>
<h4 id="8-nacos">8. Nacos 配置中心</h4>
<p>现在，不同的微服务都得单独去写 yaml 配置文件，这样在修改配置文件时非常不方便，尤其是运行在容器环境中，这时候，nacos 提供了配置中心，就像对不同服务的集中管理一样。</p>
<p>配置命名规则：服务名称-profile.yaml</p>
<h5 id="1_16">1. 使用方法</h5>
<ol>
<li>
<p>导入配置中心的依赖
<div class="highlight"><pre><span></span><code><span class="o">&lt;!--</span><span class="w"> </span><span class="n">nacos作为配置中心时所对应的依赖</span><span class="w"> </span><span class="o">--&gt;</span>
<span class="o">&lt;</span><span class="n">dependency</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">groupId</span><span class="o">&gt;</span><span class="n">com</span><span class="p">.</span><span class="na">alibaba</span><span class="p">.</span><span class="na">cloud</span><span class="o">&lt;/</span><span class="n">groupId</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">artifactId</span><span class="o">&gt;</span><span class="n">spring</span><span class="o">-</span><span class="n">cloud</span><span class="o">-</span><span class="n">starter</span><span class="o">-</span><span class="n">alibaba</span><span class="o">-</span><span class="n">nacos</span><span class="o">-</span><span class="n">config</span><span class="o">&lt;/</span><span class="n">artifactId</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">dependency</span><span class="o">&gt;</span>
</code></pre></div></p>
</li>
<li>
<p>在yaml中配置当前配置中心
<div class="highlight"><pre><span></span><code>spring:
  cloud:
    nacos:
      config:
        server-addr: xxx:8848
  config:
    import:
      - nacos:xxx.yml
</code></pre></div></p>
</li>
<li>
<p>之后，就可以通过 @Value 或者 @ConfigurationProperties 来拿到配置值了。</p>
</li>
</ol>
<p>注：想要开始热更新，还得使用 @ RefreshScope 注解</p>
<h4 id="9-gateway">9. Gateway</h4>
<h5 id="1-gateway">1. Gateway简介</h5>
<ul>
<li>
<p>Gateway是在spring生态系统之上构建的API网关服务，基于Spring5，SpringBoot2和Project Reactor等技术。Gateway旨在提供一种简单而有效的方式来对API进行路由，以及提供一些强大的过滤器功能，例如：熔断、限流、重试等</p>
</li>
<li>
<p>SpringCloud Gateway是SpringCloud的一个全新项目，基于Spring5.X+SpringBoot2.X和Project Reactor等技术开发的网关，它旨在为微服务架构提供一种简单有效的统一的API路由管理方式。</p>
</li>
<li>
<p>为了提升网关的性能，SpringCloud Gatway是基于WebFlux框架实现的，而WebFlux框架底层则使用了高性能的Reactor模式通讯框架Netty。</p>
</li>
<li>
<p>SpringCloud Gateway的目标提供统一的路由方式且基于Filter链的方式提供了网关基本的功能，例如：安全、监控/指标、和限流。</p>
</li>
</ul>
<p>![[Pasted image 20251121171843.png]]</p>
<h5 id="2_16">2. 核心概念</h5>
<ol>
<li>Route：路由是构建网关的基本模块，它由ID，目标URI，一系列的断言和过滤器组成，如果断言为true则匹配该路由</li>
<li>Predicate：参考的是java8的java.util.function.Predicate开发人员可以匹配HTTP请求中的所有内容（例如请求头或请求参数），如果请求与断言相匹配则进行路由</li>
<li>Fliter：指的是Spring框架中GatewayFilter的实例，使用过滤器，可以在请求被路由前或者之后对请求进行修改。</li>
</ol>
<h5 id="3-gateway">3. Gateway 使用方法</h5>
<pre><code>网关是一个专门的服务
</code></pre>
<ol>
<li>导入依赖
<code>&lt;!--网关--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!--nacos服务发现依赖--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;
&lt;/dependency&gt;

&lt;!-- 负载均衡组件 --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-loadbalancer&lt;/artifactId&gt;
&lt;/dependency&gt;</code></li>
<li>去配置路由
<code>server:
  port: 8222
spring:
  application:
    name: spzx-cloud-gateway
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
      routes:
        - id: spzx-cloud-user  # 路由id，可以自定义，只要唯一即可
          uri: lb://spzx-cloud-user  # 路由的目标地址 lb就是负载均衡，后面跟服务名称
          predicates:
            - Path=/*/user/** # 路径匹配
        - id: spzx-cloud-order
          uri: lb://spzx-cloud-order
          predicates:
            - Path=/*/order/** # 路径匹配
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848</code></li>
</ol>
<p>重点配置：路由的配置以及开始网关的注册服务
<div class="highlight"><pre><span></span><code>cloud:
    gateway:
      discovery:
        locator:
          enabled: true
      routes:
        - id: spzx-cloud-user  # 路由id，可以自定义，只要唯一即可
          uri: lb://spzx-cloud-user  # 路由的目标地址 lb就是负载均衡，后面跟服务名称
          predicates:
            - Path=/*/user/** # 路径匹配
        - id: spzx-cloud-order
          uri: lb://spzx-cloud-order
          predicates:
            - Path=/*/order/** # 路径匹配
</code></pre></div></p>
<ol>
<li>启动服务即可</li>
</ol>
<h5 id="4-predicate">4. Predicate 的使用</h5>
<pre><code>springcloud 提供了 10+ 断言类型，我们可以根据自己的业务要求来添加
</code></pre>
<p>eg:
<code>java
spring:
    cloud:
        gateway:
            routers:
                - id: 
                  url: 
                  predicates:
                    - Path=xxx
                    - Header=xxx</code></p>
<p><a href="https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway-server-webflux/request-predicates-factories.html">Predicate 官方文档</a></p>
<h5 id="5-fliter">5. Fliter 的使用</h5>
<pre><code>在gateway中要实现其他的功能：权限控制、流量监控、统一日志处理等。就需要使用到gateway中所提供的过滤器了。过滤器，可以对进入网关的请求和微服务返回的响应做处理：
</code></pre>
<p>spring gateway 提供了31种不同的过滤器，这些过滤器既可以做路由过滤器，也可以去做默认过滤器
<a href="https://docs.spring.io/spring-cloud-gateway/reference/spring-cloud-gateway-server-webflux/gatewayfilter-factories.html">GatewayFilter 官方文档</a></p>
<p>1) 路由过滤器的使用
<div class="highlight"><pre><span></span><code><span class="nl">spring</span><span class="p">:</span>
<span class="w">    </span><span class="n">cloud</span><span class="p">:</span>
<span class="w">        </span><span class="n">gateway</span><span class="p">:</span>
<span class="w">            </span><span class="n">routers</span><span class="p">:</span>
<span class="w">                </span><span class="o">-</span><span class="w"> </span><span class="n">id</span><span class="p">:</span><span class="w"> </span>
<span class="w">                  </span><span class="n">url</span><span class="p">:</span><span class="w"> </span>
<span class="w">                  </span><span class="n">fliters</span><span class="p">:</span>
<span class="w">                   </span><span class="o">-</span><span class="w"> </span><span class="n">AddRequestHeader</span><span class="o">=</span><span class="n">Truth</span><span class="p">,</span><span class="w"> </span><span class="n">atguigu</span>
</code></pre></div></p>
<p>2) 默认过滤器的使用
<div class="highlight"><pre><span></span><code><span class="nl">spring</span><span class="p">:</span>
<span class="w">    </span><span class="n">cloud</span><span class="p">:</span>
<span class="w">        </span><span class="n">gateway</span><span class="p">:</span>
<span class="w">            </span><span class="n">routers</span><span class="p">:</span>
<span class="w">                </span><span class="o">-</span><span class="w"> </span><span class="n">id</span><span class="p">:</span><span class="w"> </span>
<span class="w">                  </span><span class="n">url</span><span class="p">:</span><span class="w"> </span>
<span class="w">            </span><span class="k">default</span><span class="o">-</span><span class="n">filters</span><span class="p">:</span>
<span class="w">                </span><span class="o">-</span><span class="w"> </span><span class="n">AddRequestHeader</span><span class="o">=</span><span class="n">Truth</span><span class="p">,</span><span class="w"> </span><span class="n">atguigu</span><span class="w"> </span><span class="n">is</span><span class="w"> </span><span class="n">good</span>
</code></pre></div></p>
<p>3) 全局过滤器的使用
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AuthFilter</span><span class="w"> </span><span class="kd">implements</span><span class="w"> </span><span class="n">GlobalFilter</span><span class="p">,</span><span class="w"> </span><span class="n">Ordered</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">ServerWebExchange</span><span class="w"> </span><span class="n">exchange</span><span class="p">,</span><span class="w"> </span><span class="n">GatewayFilterChain</span><span class="w"> </span><span class="n">chain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="c1">// 1. 如果请求没带请求头username，我们就拦截，反正放行  </span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exchange</span><span class="p">.</span><span class="na">getRequest</span><span class="p">().</span><span class="na">getQueryParams</span><span class="p">().</span><span class="na">getFirst</span><span class="p">(</span><span class="s">&quot;username&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">username</span><span class="w"> </span><span class="o">==</span><span class="w">  </span><span class="kc">null</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">username</span><span class="p">.</span><span class="na">length</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">){</span><span class="w">  </span>
<span class="w">            </span><span class="c1">// 拦截  </span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">exchange</span><span class="p">.</span><span class="na">getResponse</span><span class="p">().</span><span class="na">setComplete</span><span class="p">();</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>

<span class="w">        </span><span class="c1">// 之前的叫做pre  </span>
<span class="w">        </span><span class="n">Mono</span><span class="o">&lt;</span><span class="n">Void</span><span class="o">&gt;</span><span class="w"> </span><span class="n">filter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">chain</span><span class="p">.</span><span class="na">filter</span><span class="p">(</span><span class="n">exchange</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="c1">// 后面的叫做post  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">filter</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="nf">getOrder</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div></p>
<h5 id="x">x. 过滤器执行顺序</h5>
<p>![[Pasted image 20251121171606.png]]</p>
<h4 id="10-sentinel">10. Sentinel</h4>
<h5 id="1_17">1. 雪崩效应</h5>
<p>概述：在微服务系统架构中，服务间调用关系错综复杂，一个微服务往往依赖于多个其它微服务。一个服务的不可用导致整个系统的不可用的现象就被称之为雪崩效应。</p>
<p>![[Pasted image 20251122150659.png]]</p>
<h5 id="2_17">2. 解决方案</h5>
<h6 id="21_2">2.1 超时处理</h6>
<p>超时处理：设定超时时间，请求超过一定时间没有响应就返回错误信息，不会无休止等待
![[Pasted image 20251122150936.png]]</p>
<h6 id="22_2">2.2 隔离处理</h6>
<p>隔离处理：将错误隔离在可控的范围之内，不要让其影响到其他的程序的运行。
这种设计思想，来源于船舱的设计，如下图所示：
![[Pasted image 20251122151011.png]]
船舱都会被隔板分离为多个独立空间，当船体破损时，只会导致部分空间进入，将故障控制在一定范围内，避免整个船体都被淹没。于此类似，我们业务系统也可以使用这种思想来防止出现雪崩效应，常见的隔离方式：线程隔离
![[Pasted image 20251122151024.png]]</p>
<h6 id="23_2">2.3 熔断处理</h6>
<p>由<strong>断路器</strong>统计业务执行的异常比例，如果超出阈值则会<strong>熔断</strong>该业务，拦截访问该业务的一切请求。
![[Pasted image 20251122151049.png]]
请求了三次，两次出现异常，一次成功。当发现访问服务D的请求异常比例过高时，认为服务D有导致雪崩的风险，会拦截访问服务D的一切请求，形成熔断：
![[Pasted image 20251122151108.png]]
触发熔断了以后，当在访问服务A的时候，就不会在通过服务A去访问服务D了，立马给用户进行返回，返回的是一种默认值，这种返回就是一种兜底方案。这种兜底方案也将其称之为降级逻辑。</p>
<h6 id="24">2.4 流量控制</h6>
<p>流量控制：限制业务访问的QPS(每秒的请求数)，避免服务因流量的突增而故障。
![[Pasted image 20251122151151.png]]
限流是一种<strong>预防</strong>措施，避免因瞬间高并发流量而导致服务故障，进而避免雪崩。其他的处理方式是一种<strong>补救</strong>措施，在部分服务故障时，将故障控制在一定范围，避免雪崩。</p>
<h5 id="3-sentinel">3. Sentinel 的安装与整合</h5>
<h6 id="31_3">3.1 安装</h6>
<p>sentenel 后端是一个springboot项目，下载下来直接用java-jar运行即可</p>
<div class="highlight"><pre><span></span><code><span class="n">java</span><span class="w"> </span><span class="o">-</span><span class="n">jar</span><span class="w"> </span><span class="n">sentinel</span><span class="o">-</span><span class="n">dashboard</span><span class="o">-</span><span class="mf">2.0.0</span><span class="o">-</span><span class="n">alpha</span><span class="o">-</span><span class="n">preview</span><span class="p">.</span><span class="na">jar</span>
</code></pre></div>
<table>
<thead>
<tr>
<th><strong>配置项</strong></th>
<th><strong>默认值</strong></th>
<th><strong>说明</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>server.port</td>
<td>8080</td>
<td>服务端口</td>
</tr>
<tr>
<td>sentinel.dashboard.auth.username</td>
<td>sentinel</td>
<td>默认用户名</td>
</tr>
<tr>
<td>sentinel.dashboard.auth.password</td>
<td>sentinel</td>
<td>默认密码</td>
</tr>
</tbody>
</table>
<p>eg:
<div class="highlight"><pre><span></span><code><span class="n">java</span><span class="w"> </span><span class="o">-</span><span class="n">Dserver</span><span class="p">.</span><span class="na">port</span><span class="o">=</span><span class="mi">8090</span><span class="w"> </span><span class="o">-</span><span class="n">jar</span><span class="w"> </span><span class="n">sentinel</span><span class="o">-</span><span class="n">dashboard</span><span class="o">-</span><span class="mf">2.0.0</span><span class="o">-</span><span class="n">alpha</span><span class="o">-</span><span class="n">preview</span><span class="p">.</span><span class="na">jar</span>
</code></pre></div></p>
<h6 id="32-sentinel">3.2 整合 sentinel</h6>
<p>一般要集成在服务的调用者上</p>
<ol>
<li>
<p>导入依赖
<div class="highlight"><pre><span></span><code>&lt;!--sentinel--&gt;
&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt; 
    &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre></div></p>
</li>
<li>
<p>写入配置
<div class="highlight"><pre><span></span><code>spring:
  cloud:
    sentinel:
      transport:
        dashboard: localhost:8080  # 配置sentinel控制台地址
</code></pre></div></p>
</li>
</ol>
<h5 id="4_4">4. 流量控制</h5>
<h6 id="41">4.1 相关概念</h6>
<p><strong>簇点链路</strong>：当请求进入微服务时，首先会访问DispatcherServlet，然后进入Controller、Service、Mapper，这样的一个调用链就叫做簇点链路。</p>
<p><strong>资源</strong>：簇点链路中被监控的每一个接口就是一个资源，流控、熔断等都是针对簇点链路中的资源来设置的。</p>
<p>默认情况下sentinel会监控spring mvc的每一个端点（Endpoint，也就是controller中的方法），因此spring mvc的每一个端点就是调用链路中的一个资源。</p>
<p>例如，我们刚才访问的spzx-cloud-user中的UserController中的端点：/api/user/findUserByUserId/{userId}</p>
<p>######  4.2 流控模式</p>
<p>在添加限流规则时，点击高级选项，可以选择三种<strong>流控模式</strong>：</p>
<pre><code>1、直接：统计当前资源的请求，触发阈值时对当前资源直接限流，也是默认的模式
2、关联：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流
3、链路：统计从指定链路访问到本资源的请求，触发阈值时，对指定链路限流
</code></pre>
<p>如下所示：</p>
<p>![[Pasted image 20251122155157.png]]</p>
<ol>
<li>关联模式</li>
</ol>
<p>语法说明：对/api/user/updateUserById资源的请求进行统计，当访问流量超过阈值时，就对/api/user/findUserByUserId/{userId}进行限流，避免影响/api/user/updateUserById资源。</p>
<p>使用场景：比如用户支付时需要修改订单状态，同时用户要查询订单。查询和修改操作会争抢数据库锁，产生竞争。业务需求是优先支付和更新订单的业务，因此当修改订单业务触发阈值时，需要对查询订单业务限流。</p>
<p>![[Pasted image 20251122155255.png]]</p>
<ol>
<li>链路模式</li>
</ol>
<p>只针对从指定链路访问到本资源的请求做统计，判断是否超过阈值，如果超过阈值对从该链路请求进行限流。</p>
<p>默认情况下，sentinel只监控controller方法，因此，通过 @SentinelResource **标记 UserService 中的 queryUsers 方法为一个sentinel监控的资源</p>
<p>链路模式中，是对不同来源的两个链路做监控。但是sentinel默认会给进入spring mvc的所有请求设置同一个root资源，会导致链路模式失效。因此需要关闭这种资源整合。
<div class="highlight"><pre><span></span><code><span class="nt">spring</span><span class="p">:</span>
<span class="w">  </span><span class="nt">cloud</span><span class="p">:</span>
<span class="w">    </span><span class="nt">sentinel</span><span class="p">:</span>
<span class="w">      </span><span class="nt">web-context-unify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"> </span><span class="c1"># 关闭context整合</span>
</code></pre></div></p>
<p>配置方式：</p>
<pre><code>1、/api/user/save --&gt; users
2、/api/user/query --&gt; users
</code></pre>
<p>如果只希望统计从/api/user/query进入到users的请求，并进行限流操作，则可以这样配置：
![[Pasted image 20251122155445.png]]</p>
<h6 id="43">4.3 流控效果</h6>
<p>流控效果是指请求达到流控阈值时应该采取的措施，包括三种：</p>
<p>1、快速失败：达到阈值后，新的请求会被立即拒绝并抛出FlowException异常，是默认的处理方式</p>
<p>2、warm up：预热模式，对超出阈值的请求同样是拒绝并抛出异常，但这种模式阈值会动态变化，从一个较小值(qps的1/3）逐渐增加到最大阈值</p>
<p><strong>工作特点</strong>：请求阈值初始值是 maxThreshold / coldFactor, 持续指定时长(预热时间)后，逐渐提高到maxThreshold值，而coldFactor的默认值是3。</p>
<p>3、排队等待：让所有的请求按照先后次序进入到一个队列中进行排队，当某一个请求最大的预期等待时间超过了所设定的超时时间时同样是拒绝并抛出异常</p>
<h6 id="44">4.4 热点资源限流</h6>
<p>之前的限流是统计访问某个资源的所有请求，判断是否超过QPS阈值。而热点参数限流是<strong>分别统计参数值相同的请求</strong>，判断是否超过QPS阈值。</p>
<h2 id="langchain4j">十 LangChain4j</h2>
<div class="highlight"><pre><span></span><code>
</code></pre></div>
<h3 id="x-pinecone">x. Pinecone 的集成</h3>
<ol>
<li>
<p>导入依赖
<div class="highlight"><pre><span></span><code>
</code></pre></div></p>
</li>
<li>
<p>去创建一个向量数据库</p>
</li>
<li>存储向量</li>
<li>检索向量</li>
</ol>
<h2 id="11-elasticsearch">11 ElasticSearch</h2>
<p><a href="https://www.elastic.co/">官网</a>
<a href="https://www.elastic.co/docs/reference">Reference | Elastic Docs</a></p>
<h4 id="1_18">1. 概述</h4>
<h5 id="11">1.1 简介</h5>
<p>ElasticSearch是一个基于<strong>Lucene（Apache开源全文检索工具包）</strong>的搜索服务器。它提供了一个<strong>分布式多用户能力</strong>的全文搜索引擎，基于RESTful web接口。ElasticSearch是用Java开发的，并作为Apache许可条款下的开放源码发布，是当前流行的企业级搜索引擎。 </p>
<p><a href="https://so.csdn.net/so/search?q=Elastic&amp;spm=1001.2101.3001.7020">Elastic</a>官方宣布ElasticSearch 进入Version 8，在速度、扩展、高相关性和简单性方面开启了一个全新的时代。</p>
<p>说明：ElasticSearch 8最低jdk版本要求jdk17，当前我们选择ElasticSearch版本：ElasticSearch8.5.0</p>
<h5 id="12">1.2 特性</h5>
<p><strong>近实时</strong> 理论上数据从写入ElasticSearch到数据可以被搜索只需要1秒左右的时间，实现准实时的数据索引和查询。</p>
<p><strong>分布式、可扩展</strong> 天生的分布式的设计，数据分片对于应用层透明，扩展性良好，可以轻易的进行节点扩容，支持上百甚至上千的服务器节点，支持PB级别的数据存储和搜索。</p>
<p><strong>稳定可靠</strong> ElasticSearch的分布式、数据冗余特性提供更加可靠的运行机制，且经过大型互联网公司众多项目使用，可靠性得到验证。</p>
<p><strong>高可用</strong> 数据多副本、多节点存储，单节点的故障不影响集群的使用。</p>
<p><strong>Rest API</strong> ElasticSearch提供标准的Rest API，这使得所有支持Rest API的语言都能够轻易的使用ElasticSearch，具备多语言通用的支持特性，易于使用。ElasticSearch Version 8以后，去除了以前Transport API、High-Level API、Low-Level API，统一标准的Rest API，这将使得ElasticSearch更加容易使用，原来被诟病的API混乱问题终于得到完美解决。</p>
<p><strong>高性能</strong> ElasticSearch底层构建基于Lucene，具备强大的搜索能力，即便是PB级别的数据依然能够实现秒级的搜索。</p>
<p><strong>多客户端支持</strong> 支持Java、Python、Go、PHP、Ruby等多语言客户端，还支持JDBC、ODBC等客户端。</p>
<p><strong>安全支持</strong> 提供单点登录SSO、加密通信、集群角色、属性的访问控制，支持审计等功能，在安全层面上还支持集成第三方的安全组件，在Version 8以后，默认开启了HTTPS，大大简化了安全上的配置。</p>
<p><strong>直接支持NLP</strong> ElasticSearch支持NLP，可以实现情感分析、文本分类等功能，在Version 8之前，需要额外的外部组件，而在Version 8，可以直接在ElasticSearch中使用这些功能，无需额外的组件。</p>
<p><strong>原生矢量搜索支持</strong> Elastic 8.0 版引入了一整套原生矢量搜索功能，增加了对近似最近邻 (ANN) 搜索的原生支持，可以快速且大规模地比较基于矢量的查询与基于矢量的文档语料库。</p>
<h5 id="13">1.3 应用场景</h5>
<p><strong>搭建日志系统</strong> 
<strong>ELK套件</strong>日志系统应该是ElasticSearch使用最广泛的场景之一了，ElasticSearch支持海量数据的存储和查询，特别适合日志搜索场景。广泛使用的ELK套件(ElasticSearch、Logstash、Kibana)是日志系统最经典的案例，使用Logstash和Beats组件进行日志收集，ElasticSearch存储和查询应用日志，Kibana提供日志的可视化搜索界面。</p>
<p>![[Pasted image 20260123095430.png]]</p>
<p><strong>搭建数据分析系统</strong> 
Elasitcsearch支持数据分析，例如强大的数据聚合功能，通过搭配Kibana，提供诸如直方图、统计分组、范围聚合等方便使用的功能，能够快速实现一些数据报表等功能。 在数字化转型的大行其道的当下，需要从海量数据中发现数据的规律，从而做出一定的决策，ElasticSearch一定是最适合的解决方案之一。</p>
<p><strong>搭建搜索系统</strong> 
ElasticSearch为搜索而生，用于搭建全文搜索系统是自然而然的事情，它能够提供快速的索引和搜索功能，还有相关的评分功能、分词插件等，支持丰富的搜索特性，可以用于搭建大型的搜索引擎，更加常用语实现站内搜索，例如银行App、购物App等站内商品、服务搜索。</p>
<h5 id="14">1.4 全文搜索引擎</h5>
<p>Google，百度类的网站搜索，它们都是根据网页中的<strong>关键字</strong>生成索引，我们在搜索的时候输入关键字，它们会将该关键字即索引匹配到的所有网页返回；还有常见的项目中应用日志的搜索等等。对于这些非结构化的数据文本，关系型数据库搜索不是能很好的支持。</p>
<p>一般<strong>传统数据库</strong>，全文检索都实现的很鸡肋，因为一般也没人用数据库存文本字段。进行全文检索需要<strong>扫描整个表</strong>，如果数据量大的话即使对SQL的语法<strong>优化</strong>，也收效甚微。建立了索引，但是维护起来也很麻烦，对于 insert 和 update 操作都会重新构建索引。</p>
<p>这里说到的<strong>全文搜索引擎</strong>指的是目前广泛应用的主流<strong>搜索引擎</strong>。它的工作原理是计算机索引程序通过扫描文章中的每一个词，<strong>对每一个词建立一个索引，指明该词在文章中出现的次数和位置</strong>，当用户查询时，检索程序就根据事先建立的索引进行查找，并将查找的结果反馈给用户的检索方式。这个过程类似于通过字典中的检索字表查字的过程。</p>
<h5 id="15-lucene">1.5 lucene 介绍</h5>
<h5 id="16">1.6 倒排索引</h5>
<p>![[Pasted image 20260123095447.png]]</p>
<p><strong>倒排索引步骤：</strong>
第一步：数据根据<strong>词条</strong>进行分词，同时记录文档（Document-数据）索引位置
第二步：分完词后可能有重复，我们要进行去重
第三步：按照序号排序，从而为后续检索提高效率</p>
<p><strong>查询步骤：</strong>
第一步：根据搜索词语进行分词
第二步：分此后在倒排索引列表查询，快速找到文档id
第三步：根据文档 id 就可能路由，然后找到这个文档的位置</p>
<h5 id="17-es-solr">1.7 Es 和 Solr 的对比</h5>
<p>solr对于索引的构建是实时的，所以有些时候会产生io阻塞，从而导致查询速度忽快忽慢，而es非常文档，并且随着数据的增多，es检索性能不会下降，但是slor的检索效率会出现明显变化。</p>
<ul>
<li>es基本是开箱即用，非常简单。Solr安装略微复杂。</li>
<li>Solr 利用 Zookeeper 进行分布式管理，而 ElasticSearch 自身带有分布式协调管理功能。</li>
<li>Solr 支持更多格式的数据，比如JSON、XML、CSV，而 ElasticSearch 仅支持json文件格式。</li>
<li>Solr 是传统搜索应用的有力解决方案，但 ElasticSearch 更适用于新兴的实时搜索应用。
现在很多互联网应用都是要求实时搜索的，所以我们选择了ElasticSearch。</li>
</ul>
<h4 id="2-elk-docker">2. ELK 的安装（docker）</h4>
<h5 id="21-elasticsearch">2.1 ElasticSearch 的安装</h5>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.5/docker.html">Install doc</a></p>
<ol>
<li>
<p>拉取镜像
<div class="highlight"><pre><span></span><code>docker pull elasticsearch:8.5.0
</code></pre></div></p>
</li>
<li>
<p>在宿主机建立要被挂载的目录
<div class="highlight"><pre><span></span><code>rm -rf /opt/elasticsearch
mkdir -p /opt/elasticsearch/{config,plugins,data}
</code></pre></div></p>
</li>
<li>
<p>去 github 下载中文分词器，然后拷贝到plugins目录重启 es</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">下载elasticsearch</span><span class="o">-</span><span class="n">analysis</span><span class="o">-</span><span class="n">ik</span><span class="o">-</span><span class="mf">8.5.0</span><span class="p">.</span><span class="na">zip</span>
<span class="mf">2.</span><span class="w"> </span><span class="n">上传到</span><span class="o">/</span><span class="n">mydata</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">/</span><span class="n">plugins</span><span class="w"> </span><span class="n">目录后</span><span class="err">，</span><span class="n">解压</span><span class="err">：</span><span class="n">unzip</span><span class="w"> </span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">analysis</span><span class="o">-</span><span class="n">ik</span><span class="o">-</span><span class="mf">8.5.0</span><span class="p">.</span><span class="na">zip</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">ik</span><span class="o">-</span><span class="n">analyzer</span><span class="w"> </span><span class="n">必须删除原来的压缩包elasticsearch</span><span class="o">-</span><span class="n">analysis</span><span class="o">-</span><span class="n">ik</span><span class="o">-</span><span class="mf">8.5.0</span><span class="p">.</span><span class="na">zip</span><span class="o">**</span>
<span class="mf">3.</span><span class="w"> </span><span class="n">重启es</span><span class="err">：</span><span class="n">docker</span><span class="w"> </span><span class="n">restart</span><span class="w"> </span><span class="n">a24eb9941759</span>

<span class="n">yum</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="o">-</span><span class="n">y</span><span class="w"> </span><span class="n">unzip</span>
<span class="n">unzip</span><span class="w"> </span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">analysis</span><span class="o">-</span><span class="n">ik</span><span class="o">-</span><span class="mf">8.5.0</span><span class="p">.</span><span class="na">zip</span><span class="w"> </span><span class="o">-</span><span class="n">d</span><span class="w"> </span><span class="n">ik</span><span class="o">-</span><span class="n">analyzer</span>
<span class="n">rm</span><span class="w"> </span><span class="o">-</span><span class="n">rf</span><span class="w"> </span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">analysis</span><span class="o">-</span><span class="n">ik</span><span class="o">-</span><span class="mf">8.5.0</span><span class="p">.</span><span class="na">zip</span><span class="w"> </span>
</code></pre></div>
<ol>
<li>
<p>制作配置文件
<div class="highlight"><pre><span></span><code>cat &lt;&lt;EOF&gt; /opt/elasticsearch/config/elasticsearch.yml
xpack.security.enabled: true # true为开始密码验证
xpack.license.self_generated.type: basic
xpack.security.transport.ssl.enabled: false  # 不配报错
xpack.security.enrollment.enabled: true
http.host: 0.0.0.0
EOF
</code></pre></div></p>
</li>
<li>
<p>给当前el目录设置权限
<div class="highlight"><pre><span></span><code>chmod -R 777 /opt/elasticsearch
</code></pre></div></p>
</li>
<li>
<p>启动 el
<div class="highlight"><pre><span></span><code>docker run --name elasticsearch -p 9200:9200 -p 9300:9300 \
--net elastic \
--restart=always \
-e &quot;discovery.type=single-node&quot; \
-e ES_JAVA_OPTS=&quot;-Xms512m -Xmx512m&quot; \
-v /opt/elasticsearch/config/elasticsearch.yml:/usr/share/elasticsearch/config/elasticsearch.yml \
-v /opt/elasticsearch/data:/usr/share/elasticsearch/data \
-v /opt/elasticsearch/plugins:/usr/share/elasticsearch/plugins \
-d elasticsearch:8.5.0
</code></pre></div></p>
</li>
</ol>
<p>如果运行时提示elastic 未找到 执行这个命令 ： docker network create elastic</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">重置下面两个密码</span><span class="err">，</span><span class="n">注意</span><span class="err">：</span><span class="n">需等待es启动</span>
<span class="n">docker</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="n">elasticsearch</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">reset</span><span class="o">-</span><span class="n">password</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">elastic</span><span class="w">  </span><span class="o">-</span><span class="n">i</span><span class="w">   </span><span class="err">#</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w"> </span><span class="n">表示自定义密码</span><span class="w"> </span><span class="n">给java客户端用的</span>
<span class="n">docker</span><span class="w"> </span><span class="n">exec</span><span class="w"> </span><span class="o">-</span><span class="n">it</span><span class="w"> </span><span class="n">elasticsearch</span><span class="w"> </span><span class="n">bin</span><span class="o">/</span><span class="n">elasticsearch</span><span class="o">-</span><span class="n">reset</span><span class="o">-</span><span class="n">password</span><span class="w"> </span><span class="o">-</span><span class="n">u</span><span class="w"> </span><span class="n">kibana_system</span><span class="w"> </span><span class="o">-</span><span class="n">i</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">给</span><span class="w"> </span><span class="n">kibana</span><span class="w"> </span><span class="n">用的</span>

<span class="nl">用户名</span><span class="p">:</span><span class="w"> </span><span class="n">elastic</span><span class="w"> </span><span class="n">密码可以使用</span><span class="p">:</span><span class="w"> </span><span class="n">liuqiang</span>
</code></pre></div>
<h5 id="22-logstach">2.2 LogStach 的安装</h5>
<ol>
<li>
<p>拉取镜像
<div class="highlight"><pre><span></span><code><span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">logstach</span><span class="p">:</span><span class="mf">8.5.0</span>
<span class="n">docker</span><span class="w"> </span><span class="n">pull</span><span class="w"> </span><span class="n">swr</span><span class="p">.</span><span class="na">cn</span><span class="o">-</span><span class="n">north</span><span class="o">-</span><span class="mf">4.</span><span class="n">myhuaweicloud</span><span class="p">.</span><span class="na">com</span><span class="o">/</span><span class="n">ddn</span><span class="o">-</span><span class="n">k8s</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="na">elastic</span><span class="p">.</span><span class="na">co</span><span class="o">/</span><span class="n">logstash</span><span class="o">/</span><span class="n">logstash</span><span class="p">:</span><span class="mf">8.5.0</span>


<span class="n">docker</span><span class="w"> </span><span class="n">tag</span><span class="w"> </span><span class="n">swr</span><span class="p">.</span><span class="na">cn</span><span class="o">-</span><span class="n">north</span><span class="o">-</span><span class="mf">4.</span><span class="n">myhuaweicloud</span><span class="p">.</span><span class="na">com</span><span class="o">/</span><span class="n">ddn</span><span class="o">-</span><span class="n">k8s</span><span class="o">/</span><span class="n">docker</span><span class="p">.</span><span class="na">elastic</span><span class="p">.</span><span class="na">co</span><span class="o">/</span><span class="n">logstash</span><span class="o">/</span><span class="n">logstash</span><span class="p">:</span><span class="mf">8.5.0</span><span class="w"> </span><span class="n">logstash</span><span class="p">:</span><span class="mf">8.5.0</span>
</code></pre></div></p>
</li>
<li>
<p>编写配置文件
<div class="highlight"><pre><span></span><code>vim /mydata/logstash/logstash.conf
input {
  tcp {
          mode =&gt; &quot;server&quot;
          host =&gt; &quot;0.0.0.0&quot;
          port =&gt; 5044
          codec =&gt; json_lines
      }
}
filter{

}
output {
  elasticsearch {
      hosts =&gt; &quot;152.136.97.27:9200&quot;
      index =&gt; &quot;tingshu-%{+YYYY.MM}&quot;
      user =&gt; &quot;elastic&quot;
      password =&gt; &quot;liuqiang&quot;
  }
}
</code></pre></div></p>
</li>
<li>
<p>创建容器
<div class="highlight"><pre><span></span><code>docker run --name logstash -p 5044:5044 \
--net elastic \
--restart=always \
--link elasticsearch:es \
-v /mydata/logstash/logstash.conf:/usr/share/logstash/pipeline/logstash.conf \
-d logstash:8.5.0
</code></pre></div></p>
</li>
</ol>
<h5 id="23-kibana">2.3 kibana的安装</h5>
<ol>
<li>
<p>拉取镜像
<div class="highlight"><pre><span></span><code>docker pull kibana:8.5.0
</code></pre></div></p>
</li>
<li>
<p>提前创建挂载目录
<div class="highlight"><pre><span></span><code>rm -rf /opt/kibana
mkdir -p /opt/kibana/{config,data}
</code></pre></div></p>
</li>
<li>
<p>制作配置文件
<div class="highlight"><pre><span></span><code>cat &lt;&lt;EOF&gt; /opt/kibana/config/kibana.yml
server.host: &quot;0.0.0.0&quot;  # 不配报错
server.shutdownTimeout: &quot;5s&quot;
elasticsearch.hosts: [ &quot;http://elasticsearch:9200&quot; ]
elasticsearch.username: &quot;kibana_system&quot;  # 不能用 elastic 
elasticsearch.password: &quot;liuqiang&quot;
i18n.locale: &quot;zh-CN&quot;
EOF
</code></pre></div></p>
</li>
<li>
<p>启动
<div class="highlight"><pre><span></span><code>sudo docker run --name kibana \
--net elastic \
-v /opt/kibana/config/kibana.yml:/usr/share/kibana/config/kibana.yml \
-p 5601:5601 -d kibana:8.5.0
</code></pre></div></p>
</li>
</ol>
<p>登录kibana ，注意需要使用elastic 用户登录不能使用 kibana_system 这个用户登录。</p>
<p>测试是否安装成功
<div class="highlight"><pre><span></span><code>GET  /_analyze
{
  &quot;analyzer&quot;: &quot;ik_smart&quot;, 
  &quot;text&quot;:     &quot;我是中国人&quot;
}
</code></pre></div></p>
<h4 id="3-es">3. es 核心概念</h4>
<h5 id="31-es">3.1 es 与 关系型数据库的对比</h5>
<p>![[imgs/image-3.png]]</p>
<p>mysql 的数据模型是 DDL 来描述的
而 es 的 document 有哪些 field 是通过 mapping 来说明的</p>
<h5 id="32-index">3.2 index</h5>
<p>一个索引就是一个拥有几分相似特征的文档的集合。比如说，你可以有一个客户数据的索引，另一个产品目录的索引，还有一个订单数据的索引。一个索引由一个名字来标识（必须全部是小写字母），并且当我们要对这个索引中的文档进行索引、搜索、更新和删除的时候，都要使用到这个名字。在一个集群中，可以定义任意多的索引。</p>
<p>能搜索的数据必须索引，这样的好处是可以提高查询速度，比如：新华字典前面的目录就是索引的意思，目录可以提高查询速度。</p>
<h5 id="33-type">3.3 type</h5>
<p>在一个索引中，你可以定义一种或多种类型。</p>
<p>一个类型是你的索引的一个逻辑上的分类/分区，其语义完全由你来定。通常，会为具有一组共同字段的文档定义一个类型。不同的版本，类型发生了不同的变化</p>
<table>
<thead>
<tr>
<th>版本</th>
<th>Type</th>
</tr>
</thead>
<tbody>
<tr>
<td>5.x</td>
<td>支持多种type</td>
</tr>
<tr>
<td>6.x</td>
<td>只能有一种type</td>
</tr>
<tr>
<td>7.x</td>
<td>默认不再支持自定义索引类型（默认类型为：_doc）</td>
</tr>
<tr>
<td>8.x</td>
<td>默认类型为：_doc</td>
</tr>
<tr>
<td>##### 3.4 document</td>
<td></td>
</tr>
</tbody>
</table>
<p>一个文档是一个可被索引的基础信息单元，也就是一条数据</p>
<p>比如：你可以拥有某一个客户的文档，某一个产品的一个文档，当然，也可以拥有某个订单的一个文档。文档以<strong>JSON（Javascript Object Notation）格式</strong>来表示，而JSON是一个到处存在的互联网数据交互格式。</p>
<p>在一个index/type里面，你可以存储任意多的文档。</p>
<h5 id="35-field">3.5 field</h5>
<p>相当于是数据表的字段，对文档数据根据不同属性进行的分类标识。</p>
<h5 id="37-mapping">3.7 mapping</h5>
<p>mapping是处理数据的方式和规则方面做一些限制，如：某个字段的数据类型、默认值、分析器、是否被索引等等。这些都是映射里面可以设置的，其它就是处理ES里面数据的一些使用规则设置也叫做映射，按着最优规则处理数据对性能提高很大，因此才需要建立映射，并且需要思考如何建立映射才能对性能更好。</p>
<h4 id="4-es">4. Es 的基础功能</h4>
<h5 id="41_1">4.1 分词器</h5>
<p>官方提供的分词器有这么几种: Standard、Letter、Lowercase、Whitespace、UAX URL Email、Classic、Thai等，中文分词器可以使用第三方的比如IK分词器。前面我们已经安装过了。</p>
<p>ik_smart：智能切分，粒度较粗。
ik_max_word：最细粒度切分，尽可能多地切出词语，包括所有可能的组合。
<div class="highlight"><pre><span></span><code>post _analyze
{
  &quot;analyzer&quot;:&quot;ik_smart&quot;,
  &quot;text&quot;: &quot;我是中国人&quot;
}
</code></pre></div></p>
<h5 id="42">4.2 索引操作</h5>
<p>ES 软件的索引可以类比为 MySQL 中表的概念，创建一个索引，类似于创建一个表
详细操作可看：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.5/indices.html">索引官方文档</a></p>
<ol>
<li>
<p>创建索引
<div class="highlight"><pre><span></span><code><span class="n">PUT</span><span class="w"> </span><span class="o">/</span><span class="n">my</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mo">000001</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;settings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;index&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;number_of_shards&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w">  </span>
<span class="w">      </span><span class="s">&quot;number_of_replicas&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>

<span class="n">其他配置</span><span class="err">：</span><span class="n">mappings</span><span class="p">:</span>
<span class="n">PUT</span><span class="w"> </span><span class="o">/</span><span class="n">test</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;settings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;number_of_shards&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s">&quot;mappings&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;properties&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;field1&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;text&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>删除索引
<div class="highlight"><pre><span></span><code>DELETE /my-index-000001
</code></pre></div></p>
</li>
<li>
<p>查看索引
<div class="highlight"><pre><span></span><code>GET /_cat/indices?v
GET /{索引名称}
</code></pre></div></p>
</li>
</ol>
<h5 id="43_1">4.3 <a href="https://www.elastic.co/guide/en/elasticsearch/reference/8.5/docs.html">文档操作</a></h5>
<p>文档是 ES 软件搜索数据的最小单位, 不依赖预先定义的模式，所以可以将文档类比为表的一行JSON类型的数据。我们知道关系型数据库中，要提前定义字段才能使用，在ElasticSearch中，对于字段是非常灵活的，有时候我们可以忽略该字段，或者动态的添加一个新的字段。</p>
<ol>
<li>
<p>新增文档
<div class="highlight"><pre><span></span><code><span class="n">put</span><span class="w"> </span><span class="o">/</span><span class="n">索引名</span><span class="o">/</span><span class="n">类型</span><span class="o">/</span><span class="p">{</span><span class="n">id</span><span class="p">}</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;小米手机&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;brand&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;小米&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;images&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://www.gulixueyuan.com/xm.jpg&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;price&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3999</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>查看文档
<div class="highlight"><pre><span></span><code><span class="n">get</span><span class="w"> </span><span class="o">/</span><span class="n">索引</span><span class="o">/</span><span class="n">类型</span><span class="o">/</span><span class="n">id</span>
</code></pre></div></p>
</li>
<li>
<p>查看所有文档
<div class="highlight"><pre><span></span><code>get/索引/_search
</code></pre></div></p>
</li>
<li>
<p>修改文档
<div class="highlight"><pre><span></span><code><span class="c1">// 全局修改，实际上就是覆盖了以前的，可以理解为新增</span>
<span class="n">put</span><span class="w"> </span><span class="o">/</span><span class="n">index</span><span class="o">/</span><span class="n">_doc</span><span class="o">/</span><span class="n">id</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">jsonBody</span>
<span class="p">}</span>

<span class="c1">// 局部修改</span>
<span class="n">post</span><span class="w"> </span><span class="o">/</span><span class="n">index</span><span class="o">/</span><span class="n">_update</span><span class="o">/</span><span class="n">id</span>
<span class="p">{</span>
<span class="w">    </span><span class="s">&quot;doc&quot;</span><span class="p">:{</span>
<span class="w">        </span><span class="s">&quot;属性&quot;</span><span class="p">:</span><span class="s">&quot;值&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="nl">eg</span><span class="p">:</span>
<span class="n">post</span><span class="w"> </span><span class="o">/</span><span class="n">myindex</span><span class="o">/</span><span class="n">_update</span><span class="o">/</span><span class="mi">1</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;doc&quot;</span><span class="p">:</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;title&quot;</span><span class="p">:</span><span class="s">&quot;大米&quot;</span>
<span class="w">  </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>删除文档
<div class="highlight"><pre><span></span><code><span class="nl">语法</span><span class="p">:</span><span class="w"> </span><span class="n">DELETE</span><span class="w"> </span><span class="o">/</span><span class="p">{</span><span class="n">索引名称</span><span class="p">}</span><span class="o">/</span><span class="p">{</span><span class="n">类型</span><span class="p">}</span><span class="o">/</span><span class="p">{</span><span class="n">id</span><span class="p">}</span>
<span class="n">DELETE</span><span class="w"> </span><span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_doc</span><span class="o">/</span><span class="mi">1</span>
</code></pre></div></p>
</li>
</ol>
<h4 id="44_1">4.4 映射</h4>
<p>创建数据库表需要设置字段名称，类型，长度，约束等；索引库也一样，需要知道这个类型下有哪些字段，每个字段有哪些约束信息，这就叫做<strong>映射(mapping)</strong>。</p>
<ol>
<li>查看映射
<div class="highlight"><pre><span></span><code>get /index/_mapping
</code></pre></div></li>
</ol>
<h5 id="441">4.4.1 动态映射</h5>
<p>在关系数据库中，需要事先创建数据库，然后在该数据库下创建数据表，并创建 表字段、类型、长度、主键等，最后才能基于表插入数据。而ElasticSearch中不 需要定义Mapping映射（即关系型数据库的表、字段等），在文档写入 ElasticSearch时，会根据文档字段<strong>自动识别类型</strong>，这种机制称之为<strong>动态映射</strong>。</p>
<table>
<thead>
<tr>
<th>数据</th>
<th>对应的类型</th>
</tr>
</thead>
<tbody>
<tr>
<td>null</td>
<td>字段不添加</td>
</tr>
<tr>
<td>true|flase</td>
<td>boolean</td>
</tr>
<tr>
<td>字符串</td>
<td><strong>text</strong>/<strong>keyword</strong></td>
</tr>
<tr>
<td>数值</td>
<td>long</td>
</tr>
<tr>
<td>小数</td>
<td>float</td>
</tr>
<tr>
<td>日期</td>
<td>date</td>
</tr>
<tr>
<td>特殊类型：字符串</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>
<p><strong>text</strong>:用于长文本，对本文内容进行分词（产生倒排索引文档列表），支持多关键字<strong>全文查询</strong>。例如：电商项目中商品名称，或者博客项目文章标题，正文设置为text 缺点：不能进行聚合（分组），不支持排序。</p>
</li>
<li>
<p><strong>keyword</strong>：用于词条精确查询，支持等值查询，不需要进行分词字符串（分词后无意义）。例如：用户昵称、用户手机号、身份证号、图片地址。场景：根据品牌名称等值查询。支持聚合（分组）、排序 不支持全文查询查询</p>
</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>是否分词</strong></td>
<td>✅ 是（使用 analyzer 分词）</td>
<td>❌ 否（整体作为一个 term）</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>全文搜索（如文章内容、商品描述）</td>
<td>精确匹配（如品牌、状态、ID、标签）</td>
</tr>
<tr>
<td><strong>支持全文检索</strong></td>
<td>✅（<code>match</code>, <code>multi_match</code> 等）</td>
<td>❌（但可用 <code>term</code> 精确查）</td>
</tr>
<tr>
<td><strong>支持聚合（Aggregation）</strong></td>
<td>❌（默认不行，除非开启 <code>fielddata</code>）</td>
<td>✅（天然支持）</td>
</tr>
<tr>
<td><strong>支持排序（Sort）</strong></td>
<td>❌（同上，需 <code>fielddata</code>）</td>
<td>✅</td>
</tr>
<tr>
<td><strong>存储方式</strong></td>
<td>倒排索引（terms → docs）</td>
<td>正排索引（doc → term）</td>
</tr>
<tr>
<td><strong>大小写敏感</strong></td>
<td>取决于 analyzer（如 <code>standard</code> 会转小写）</td>
<td>完全保留原始值（区分大小写）</td>
</tr>
</tbody>
</table>
<h5 id="442">4.4.2 静态映射</h5>
<div class="highlight"><pre><span></span><code>PUT /my_index
{
  &quot;mappings&quot;: {
    &quot;properties&quot;: {
      &quot;title&quot;: {
        &quot;type&quot;: &quot;text&quot;,
        &quot;index&quot;: true,
        &quot;store&quot;: true,
        &quot;analyzer&quot;: &quot;ik_max_word&quot;,
        &quot;search_analyzer&quot;: &quot;ik_smart&quot;
      },
      &quot;brand&quot;: { 
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;index&quot;: true,
        &quot;store&quot;: true
      },
      &quot;images&quot;: {
        &quot;type&quot;: &quot;keyword&quot;,
        &quot;index&quot;: false,
        &quot;store&quot;: true
      },
      &quot;price&quot;: {
        &quot;type&quot;: &quot;integer&quot;,
        &quot;index&quot;: true,
        &quot;store&quot;: true
      }
    }
  }
}
</code></pre></div>
<h4 id="45-nested">4.5 nested</h4>
<p>nested 类型是一种特殊的对象object数据类型(specialised version of the object datatype )，允许对象数组彼此独立地进行索引和查询。</p>
<p>对于数组形式的数据，默认存储类型是：Object，故我们的文档内部存储为：
<div class="highlight"><pre><span></span><code><span class="p">{</span><span class="w"> </span>
<span class="s">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">狂人日记</span><span class="o">]</span><span class="p">,</span><span class="w"> </span>
<span class="s">&quot;body&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="err">《</span><span class="n">狂人日记</span><span class="err">》</span><span class="n">是一篇象征性和寓意很强的小说</span><span class="err">，</span><span class="n">当时</span><span class="p">...</span><span class="w"> </span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;comments.name&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">张三</span><span class="p">,</span><span class="w"> </span><span class="n">李四</span><span class="p">,</span><span class="w"> </span><span class="n">王五</span><span class="w"> </span><span class="o">]</span><span class="p">,</span><span class="w"> </span>
<span class="s">&quot;comments.comment&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="n">非常棒的文章</span><span class="p">,</span><span class="n">文章非常好</span><span class="p">,</span><span class="n">王五</span><span class="p">,...</span><span class="w"> </span><span class="o">]</span><span class="p">,</span><span class="w"> </span>
<span class="s">&quot;comments.age&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="mi">33</span><span class="p">,</span><span class="w"> </span><span class="mi">34</span><span class="p">,</span><span class="w"> </span><span class="mi">38</span><span class="w"> </span><span class="o">]</span><span class="p">,</span><span class="w"> </span>
<span class="s">&quot;comments.rating&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="w"> </span><span class="o">]</span><span class="w"> </span>
<span class="p">}</span>
</code></pre></div>
我们可以清楚地看到，comments.name和comments.age之间的关系已丢失。这就是为什么我们的文档匹配李四和34的查询。</p>
<p>也就是，如果集合用默认数据类型，那么根据集合里对象的字段去查询是不独立的，也就是每次查询都是看所有对象的某个字段。</p>
<p>比如我们要通过精确匹配去查询当前集合中有：年龄为 35 以及姓名为张三的 docment，但如果是默认数据类型，它的意思就变成了：所有对象中有年龄为35的，以及所有对象中姓名为张三的。
本质实际上是：集合的默认存储会使对象的结构信息丢失。</p>
<h4 id="5-dsl">5. DSL 高级查询功能</h4>
<p>Query DSL概述: <strong>Domain Specific Language</strong>(领域专用语言)，ElasticSearch提供了基于JSON的DSL来定义查询。
![[imgs/image-4.png]]</p>
<h5 id="51_2">5.1 模糊查询</h5>
<p>语法：
<div class="highlight"><pre><span></span><code><span class="n">get</span><span class="w"> </span><span class="o">/</span><span class="n">index_name</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">    </span><span class="s">&quot;query&quot;</span><span class="p">:{</span>
<span class="w">        </span><span class="s">&quot;match | match_all | multi_match | prefix&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>全部查询</p>
<div class="highlight"><pre><span></span><code><span class="n">get</span><span class="w"> </span><span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:{</span>
<span class="w">    </span><span class="s">&quot;match_all&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>模糊查询 get | post 
 在模糊查询中，查询内容分词后默认是 or 关系<br />
 ``` java
// 单条件查询 默认是 or 关系
get /my_index/_search
{
    "query": {
        "match":{
            "title" : "笔记本华为"
        }
    }
}</p>
<p>// 改为 and 关系
get /my_index/_search
{
  "query": {
    "match":{
      "title":{
        "query": "华为笔记本电脑",
        "operator": "and"
      }
    }
  }
}
 ```</p>
<p>多字段查询： multi_match
<div class="highlight"><pre><span></span><code><span class="n">get</span><span class="w"> </span><span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;multi_match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;汽车&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;fields&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s">&quot;title&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;brand&quot;</span><span class="o">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>前缀匹配：prefix
<div class="highlight"><pre><span></span><code><span class="n">get</span><span class="w"> </span><span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;prefix&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;value&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;华为&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<h5 id="52_2">5.2 精确查询</h5>
<p>精确匹配：用来查询数值或者字符串为 keyword 类型的</p>
<ol>
<li>
<p>单 keyword 精确匹配
<div class="highlight"><pre><span></span><code><span class="n">get</span><span class="w"> </span><span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:{</span>
<span class="w">    </span><span class="s">&quot;term&quot;</span><span class="p">:{</span>
<span class="w">      </span><span class="s">&quot;brand&quot;</span><span class="p">:</span><span class="s">&quot;华为&quot;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>多 keyWord 精确匹配
<div class="highlight"><pre><span></span><code><span class="n">post</span><span class="w"> </span><span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:{</span>
<span class="w">    </span><span class="s">&quot;terms&quot;</span><span class="p">:{</span>
<span class="w">      </span><span class="s">&quot;brand&quot;</span><span class="p">:</span><span class="o">[</span><span class="s">&quot;华为&quot;</span><span class="p">,</span><span class="s">&quot;apple&quot;</span><span class="o">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>数值类型的范围查询
<div class="highlight"><pre><span></span><code><span class="n">post</span><span class="w"> </span><span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:{</span>
<span class="w">    </span><span class="s">&quot;range&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;price&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;gte&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;lte&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">5000</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>返回指定字段
<div class="highlight"><pre><span></span><code>&quot;_source&quot;: [&quot;title&quot;,&quot;brand&quot;]
</code></pre></div></p>
</li>
</ol>
<h5 id="53_2">5.3 多条件查询</h5>
<ul>
<li>must: 各个条件都必须满足，所有条件是and的关系</li>
<li>should: 各个条件有一个满足即可，即各条件是or的关系</li>
<li>must_not: 不满足所有条件，即各条件是not的关系</li>
<li>filter: 与must效果等同，但是它不计算得分，<strong>效率更高点</strong>。</li>
</ul>
<p>bool 节点
<div class="highlight"><pre><span></span><code>post /my_index/_search
{
  &quot;query&quot;:{
    &quot;bool&quot;: {
        &quot;must&quot;:[
            {
                &quot;match&quot;:{
                    &quot;title&quot;:&quot;xxx&quot;
                },
                ...
            }
        ],
        &quot;should&quot;:[],
        &quot;must_not&quot;:[],
        ...
    }
  },
  &quot;_source&quot;:[]
}
</code></pre></div></p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">标题有华为并且价格区间在3000</span><span class="o">-</span><span class="mi">80000</span>
<span class="n">post</span><span class="w"> </span><span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:{</span>
<span class="w">    </span><span class="s">&quot;bool&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;must&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="s">&quot;match&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;华为&quot;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="s">&quot;range&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s">&quot;price&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="s">&quot;gte&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">3000</span><span class="p">,</span>
<span class="w">              </span><span class="s">&quot;lte&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">80000</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="o">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h5 id="54_2">5.4 聚合查询</h5>
<p>聚合允许使用者对es文档进行统计分析，类似与关系型数据库中的group by，当然还有很多其他的聚合，例如取最大值、平均值等等。</p>
<p><strong>聚合三要素：聚合名称（给不同聚合业务其名称-用于解析结果）、聚合字段（对哪个字段进行分组）、聚合类型（如何聚合-常见：字段值相同放在一组）</strong></p>
<div class="highlight"><pre><span></span><code><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;match_all&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s">&quot;size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="s">&quot;aggs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;max_price&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;max&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;field&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;price&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>eg:直接对全部数据聚合
<div class="highlight"><pre><span></span><code><span class="n">post</span><span class="w"> </span><span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:{</span>
<span class="w">    </span><span class="s">&quot;match_all&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="p">},</span>

<span class="w">  </span><span class="s">&quot;aggs&quot;</span><span class="p">:{</span>
<span class="w">    </span><span class="c1">// 聚合名称</span>
<span class="w">    </span><span class="s">&quot;agg_max_price&quot;</span><span class="p">:{</span>
<span class="w">      </span><span class="c1">// 聚合类型</span>
<span class="w">      </span><span class="s">&quot;max&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 聚合字段 </span>
<span class="w">        </span><span class="s">&quot;field&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;price&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>eg:先分组，在聚合
<div class="highlight"><pre><span></span><code><span class="n">post</span><span class="w"> </span><span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;match_all&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s">&quot;aggs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;agg_by_brand&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;terms&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;field&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;brand&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span>
<span class="w">      </span><span class="p">},</span>
<span class="w">      </span><span class="s">&quot;aggs&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;max_price&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="s">&quot;max&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s">&quot;field&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;price&quot;</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<p>常见聚合类型：</p>
<table>
<thead>
<tr>
<th>聚合大类</th>
<th>聚合类型（Aggregation Type）</th>
<th>用途说明</th>
<th>示例字段</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>指标聚合（Metric Aggregations）</strong></td>
<td><code>min</code></td>
<td>计算某字段的最小值</td>
<td><code>"field": "price"</code></td>
</tr>
<tr>
<td></td>
<td><code>max</code></td>
<td>计算某字段的最大值</td>
<td><code>"field": "price"</code></td>
</tr>
<tr>
<td></td>
<td><code>avg</code></td>
<td>计算某字段的平均值</td>
<td><code>"field": "price"</code></td>
</tr>
<tr>
<td></td>
<td><code>sum</code></td>
<td>计算某字段的总和</td>
<td><code>"field": "quantity"</code></td>
</tr>
<tr>
<td></td>
<td><code>value_count</code></td>
<td>统计某字段非空值的数量</td>
<td><code>"field": "user_id"</code></td>
</tr>
<tr>
<td></td>
<td><code>stats</code></td>
<td>同时返回 min/max/avg/sum/count 等统计信息</td>
<td><code>"field": "price"</code></td>
</tr>
<tr>
<td></td>
<td><code>extended_stats</code></td>
<td>在 stats 基础上增加方差、标准差等</td>
<td><code>"field": "price"</code></td>
</tr>
<tr>
<td></td>
<td><code>cardinality</code></td>
<td>估算字段唯一值（去重）数量（近似值）</td>
<td><code>"field": "user_id"</code></td>
</tr>
<tr>
<td><strong>桶聚合（Bucket Aggregations）</strong></td>
<td><code>terms</code></td>
<td>按字段值分组（类似 SQL 的 GROUP BY）</td>
<td><code>"field": "category"</code></td>
</tr>
<tr>
<td></td>
<td><code>date_histogram</code></td>
<td>按时间间隔对日期字段分组（如按天、月）</td>
<td><code>"field": "timestamp", "calendar_interval": "1d"</code></td>
</tr>
<tr>
<td></td>
<td><code>range</code></td>
<td>按数值范围分组（自定义区间）</td>
<td><code>"field": "price", "ranges": [{"from":0,"to":100}]</code></td>
</tr>
<tr>
<td></td>
<td><code>date_range</code></td>
<td>按日期范围分组</td>
<td><code>"field": "order_date", "ranges": [...]</code></td>
</tr>
<tr>
<td></td>
<td><code>histogram</code></td>
<td>按固定数值间隔分桶（如每10元一档）</td>
<td><code>"field": "price", "interval": 10</code></td>
</tr>
<tr>
<td></td>
<td><code>filter</code> / <code>filters</code></td>
<td>根据查询条件创建一个或多个桶</td>
<td><code>"term": {"status": "completed"}</code></td>
</tr>
<tr>
<td></td>
<td><code>missing</code></td>
<td>将缺失某字段的文档归为一组</td>
<td><code>"field": "description"</code></td>
</tr>
<tr>
<td><strong>管道聚合（Pipeline Aggregations）</strong></td>
<td><code>derivative</code></td>
<td>计算相邻桶之间的差值（常用于时间序列）</td>
<td>作用于 histogram 或 date_histogram 结果</td>
</tr>
<tr>
<td></td>
<td><code>cumulative_sum</code></td>
<td>计算累计和</td>
<td>作用于 sum 或 count 等指标</td>
</tr>
<tr>
<td></td>
<td><code>avg_bucket</code>, <code>min_bucket</code>, <code>max_bucket</code>, <code>sum_bucket</code></td>
<td>对其他聚合结果的桶进行二次聚合</td>
<td>例如对每日销售额求平均</td>
</tr>
<tr>
<td></td>
<td><code>bucket_script</code></td>
<td>使用脚本对多个桶的聚合结果进行计算</td>
<td>支持自定义公式</td>
</tr>
</tbody>
</table>
<h5 id="55_1">5.5 分页查询</h5>
<p>和 query 同级，分别是 "from", "size"</p>
<div class="highlight"><pre><span></span><code><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 查询条件，例如 match_all、term、bool 等</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s">&quot;from&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w">     </span><span class="c1">// 起始位置（第0条 = 第一页第一条）</span>
<span class="w">  </span><span class="s">&quot;size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="w">     </span><span class="c1">// 每页返回10条</span>
<span class="p">}</span>
</code></pre></div>
<table>
<thead>
<tr>
<th>项目</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>默认最大窗口</strong></td>
<td><code>from + size &lt;= 10000</code>（可调大，但不推荐）</td>
</tr>
<tr>
<td><strong>性能问题</strong></td>
<td>深度分页（如 <code>from=999990</code>）会导致每个分片加载并排序大量数据，消耗 CPU/内存</td>
</tr>
<tr>
<td><strong>适用场景</strong></td>
<td>仅适用于<strong>浅分页</strong>（如前几十页）</td>
</tr>
<tr>
<td><strong>替代方案</strong></td>
<td>深度分页请使用 <code>search_after</code> 或 <code>scroll</code></td>
</tr>
<tr>
<td>##### 5.6 排序</td>
<td></td>
</tr>
<tr>
<td>排序由排序字段 + order:"desc</td>
<td>asc" 构成， sort 节点下可以有多个排序规则。</td>
</tr>
<tr>
<td>默认按照相关性从大到小排序</td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">your_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 查询条件</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s">&quot;sort&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;字段名&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="s">&quot;order&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;asc&quot;</span><span class="w"> </span><span class="n">或</span><span class="w"> </span><span class="s">&quot;desc&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="o">]</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;from&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">  </span><span class="s">&quot;size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span>
<span class="p">}</span>
</code></pre></div>
<p>🔹 <code>sort</code> 是一个<strong>数组</strong>，可以包含多个排序规则（按顺序优先级应用）<br />
🔹 与 <code>query</code>、<code>aggs</code>、<code>from</code>、<code>size</code> 等同级</p>
<p>多关键字排序：
<div class="highlight"><pre><span></span><code><span class="n">post</span><span class="w"> </span><span class="o">/</span><span class="n">my_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:{</span>
<span class="w">    </span><span class="s">&quot;match_all&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s">&quot;sort&quot;</span><span class="p">:</span><span class="o">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;price&quot;</span><span class="p">:{</span>
<span class="w">        </span><span class="s">&quot;order&quot;</span><span class="p">:</span><span class="s">&quot;desc&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;_score&quot;</span><span class="p">:{</span>
<span class="w">        </span><span class="s">&quot;order&quot;</span><span class="p">:</span><span class="s">&quot;desc&quot;</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="o">]</span>
<span class="p">}</span>
</code></pre></div></p>
<p>相关性排序：
<div class="highlight"><pre><span></span><code><span class="s">&quot;sort&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span>
<span class="w">  </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;_score&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;order&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;desc&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="p">}</span>
<span class="o">]</span>
</code></pre></div></p>
<ol>
<li><strong>字段必须可排序</strong>：<ul>
<li>数值、日期、<code>keyword</code> 类型天然支持</li>
<li><code>text</code> 类型需使用 <code>.keyword</code>（如 <code>"title.keyword"</code>）</li>
</ul>
</li>
<li><strong>性能影响</strong>：<ul>
<li>排序会消耗内存和 CPU，尤其是非 <code>_doc</code> 或 <code>_score</code> 的字段</li>
<li>建议对高频排序字段开启 <code>doc_values: true</code>（默认已开启）</li>
</ul>
</li>
<li><strong>分页 + 排序一致性</strong>：<ul>
<li>使用 <code>from/size</code> 分页时，确保排序字段<strong>具有唯一性</strong>（如加上 <code>_id</code>），避免分页结果跳变</li>
</ul>
</li>
</ol>
<h5 id="57">5.7 高亮显示</h5>
<div class="highlight"><pre><span></span><code><span class="n">POST</span><span class="w"> </span><span class="o">/</span><span class="n">your_index</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;query&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 查询条件（如 match、multi_match 等）</span>
<span class="w">  </span><span class="p">},</span>
<span class="w">  </span><span class="s">&quot;highlight&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;fields&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="s">&quot;字段名1&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span>
<span class="w">      </span><span class="s">&quot;字段名2&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li>自定义高亮
<div class="highlight"><pre><span></span><code><span class="w">      </span><span class="s">&quot;pre_tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;post_tags&quot;</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;number_of_fragments&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;fragment_size&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">150</span>
</code></pre></div></li>
</ol>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>pre_tags</code> / <code>post_tags</code></td>
<td>自定义高亮前/后标签，默认是 <code>["&lt;em&gt;"]</code> / <code>["&lt;/em&gt;"]</code></td>
</tr>
<tr>
<td><code>number_of_fragments</code></td>
<td>返回多少个高亮片段（默认 3）。设为 <code>0</code> 表示返回<strong>整个字段内容</strong>并高亮</td>
</tr>
<tr>
<td><code>fragment_size</code></td>
<td>每个片段的字符长度（默认 100）</td>
</tr>
<tr>
<td><code>require_field_match</code></td>
<td>是否只高亮被查询命中的字段（默认 <code>true</code>）</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td>##### 5.8 选择查询字段</td>
<td></td>
</tr>
<tr>
<td><div class="highlight"><pre><span></span><code><span class="s">&quot;_source&quot;</span><span class="p">:</span><span class="w"> </span><span class="o">[</span><span class="s">&quot;f1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;f2&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">...</span><span class="o">]</span>
<span class="s">&quot;_source&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="s">&quot;includes&quot;</span><span class="p">:</span><span class="o">[</span><span class="s">&quot;f1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;f2&quot;</span><span class="o">]</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;excludes&quot;</span><span class="p">:</span><span class="o">[</span><span class="s">&quot;f1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;f2&quot;</span><span class="o">]</span>
<span class="p">}</span>
</code></pre></div></td>
<td></td>
</tr>
<tr>
<td>#### 6. Java Api 操作Es</td>
<td></td>
</tr>
</tbody>
</table>
<h5 id="61-elasticsearch-java-api-client">6.1 <a href="https://www.elastic.co/docs/reference/elasticsearch-clients">ElasticSearch Java API Client</a></h5>
<p>Elasticsearch provides official clients for popular programming languages. These client libraries make it easier to use your preferred language to work with your Elasticsearch deployment.</p>
<p><a href="https://www.elastic.co/guide/en/elasticsearch/client/java-api-client/8.5/installation.html">8.5 java client 文档</a></p>
<ol>
<li>导入依赖
<div class="highlight"><pre><span></span><code>&lt;project&gt;
  &lt;dependencies&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;co.elastic.clients&lt;/groupId&gt;
      &lt;artifactId&gt;elasticsearch-java&lt;/artifactId&gt;
      &lt;version&gt;8.5.3&lt;/version&gt;
    &lt;/dependency&gt;

    &lt;dependency&gt;
      &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;
      &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;
      &lt;version&gt;2.12.3&lt;/version&gt;
    &lt;/dependency&gt;

  &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre></div></li>
</ol>
<p>如果报错，导入下面的依赖：</p>
<div class="highlight"><pre><span></span><code>&lt;project&gt;
  &lt;dependencies&gt;
    ...
    &lt;dependency&gt;
      &lt;groupId&gt;jakarta.json&lt;/groupId&gt;
      &lt;artifactId&gt;jakarta.json-api&lt;/artifactId&gt;
      &lt;version&gt;2.0.1&lt;/version&gt;
    &lt;/dependency&gt;

  &lt;/dependencies&gt;
&lt;/project&gt;
</code></pre></div>
<ol>
<li>
<p>创建一个 c 端（带账号以及密码）
<div class="highlight"><pre><span></span><code><span class="n">BasicCredentialsProvider</span><span class="w"> </span><span class="n">credsProv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">BasicCredentialsProvider</span><span class="p">();</span><span class="w">  </span>
<span class="n">credsProv</span><span class="p">.</span><span class="na">setCredentials</span><span class="p">(</span><span class="w">  </span>
<span class="w">        </span><span class="n">AuthScope</span><span class="p">.</span><span class="na">ANY</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UsernamePasswordCredentials</span><span class="p">(</span><span class="s">&quot;elastic&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;liuqiang&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="p">);</span><span class="w">  </span>

<span class="n">RestClient</span><span class="w"> </span><span class="n">restClient</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RestClient</span><span class="w">  </span>
<span class="w">        </span><span class="p">.</span><span class="na">builder</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">HttpHost</span><span class="p">(</span><span class="s">&quot;152.136.97.27&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">9200</span><span class="p">))</span><span class="w">  </span>
<span class="w">        </span><span class="p">.</span><span class="na">setHttpClientConfigCallback</span><span class="p">(</span><span class="n">hc</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">hc</span><span class="w">  </span>
<span class="w">                </span><span class="p">.</span><span class="na">setDefaultCredentialsProvider</span><span class="p">(</span><span class="n">credsProv</span><span class="p">)</span><span class="w">  </span>
<span class="w">        </span><span class="p">)</span><span class="w">  </span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">  </span>

<span class="c1">// Create the transport and the API client  </span>
<span class="n">ElasticsearchTransport</span><span class="w"> </span><span class="n">transport</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">RestClientTransport</span><span class="p">(</span><span class="n">restClient</span><span class="p">,</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">JacksonJsonpMapper</span><span class="p">());</span><span class="w">  </span>
<span class="n">client</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">ElasticsearchClient</span><span class="p">(</span><span class="n">transport</span><span class="p">);</span>
</code></pre></div></p>
</li>
<li>
<p>之后就可以调用原生 api 了</p>
</li>
</ol>
<p>新增文档
<div class="highlight"><pre><span></span><code><span class="c1">// 1. lambda 写法  </span>
<span class="n">Goods</span><span class="w"> </span><span class="n">goods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Goods</span><span class="p">();</span><span class="w">  </span>
<span class="n">goods</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="s">&quot;2&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="n">goods</span><span class="p">.</span><span class="na">setBrand</span><span class="p">(</span><span class="s">&quot;大米&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="n">goods</span><span class="p">.</span><span class="na">setImages</span><span class="p">(</span><span class="s">&quot;https://www.baidu.com&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="n">goods</span><span class="p">.</span><span class="na">setPrice</span><span class="p">(</span><span class="mi">6666</span><span class="p">);</span><span class="w">  </span>
<span class="n">goods</span><span class="p">.</span><span class="na">setTitle</span><span class="p">(</span><span class="s">&quot;大米手机&quot;</span><span class="p">);</span><span class="w">  </span>

<span class="c1">// client.index(t -&gt; t.index(INDEX_NAME).id(goods.getId()).document(goods));  </span>


<span class="c1">// 2. 原生写法  </span>
<span class="n">IndexRequest</span><span class="p">.</span><span class="na">Builder</span><span class="o">&lt;</span><span class="n">Goods</span><span class="o">&gt;</span><span class="w"> </span><span class="n">goodsBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IndexRequest</span><span class="p">.</span><span class="na">Builder</span><span class="o">&lt;&gt;</span><span class="p">();</span><span class="w">  </span>
<span class="n">IndexRequest</span><span class="o">&lt;</span><span class="n">Goods</span><span class="o">&gt;</span><span class="w"> </span><span class="n">req</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">goodsBuilder</span><span class="p">.</span><span class="na">index</span><span class="p">(</span><span class="n">INDEX_NAME</span><span class="p">)</span><span class="w">  </span>
<span class="w">        </span><span class="p">.</span><span class="na">id</span><span class="p">(</span><span class="n">goods</span><span class="p">.</span><span class="na">getId</span><span class="p">())</span><span class="w">  </span>
<span class="w">        </span><span class="p">.</span><span class="na">document</span><span class="p">(</span><span class="n">goods</span><span class="p">)</span><span class="w">  </span>
<span class="w">        </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">  </span>
<span class="n">client</span><span class="p">.</span><span class="na">index</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
</code></pre></div></p>
<p>其他操作一致，其实就是在拼 restful 的url，然后去发http请求</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">test02</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="n">GetResponse</span><span class="o">&lt;</span><span class="n">Goods</span><span class="o">&gt;</span><span class="w"> </span><span class="n">goodsGetResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="na">index</span><span class="p">(</span><span class="n">INDEX_NAME</span><span class="p">).</span><span class="na">id</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">},</span><span class="w"> </span><span class="n">Goods</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">goodsGetResponse</span><span class="p">.</span><span class="na">source</span><span class="p">());</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>

<span class="nd">@Test</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">test03</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="n">client</span><span class="p">.</span><span class="na">delete</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="na">index</span><span class="p">(</span><span class="n">INDEX_NAME</span><span class="p">).</span><span class="na">id</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">))</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div>
<h5 id="62-spring-data-elasticsearch">6.2 <a href="https://spring.io/projects/spring-data-elasticsearch">Spring Data Elasticsearch</a></h5>
<p>Spring Data是一个用于简化数据库、非关系型数据库、索引库访问，并支持云服务的开源框架。其主要目标是使得对数据的访问变得方便快捷。 Spring Data可以极大的简化JPA（ElasticSearch…）的写法，可以在几乎不用写实现的情况下，实现对数据的访问和操作。除了CRUD外，还包括如分页、排序等一些常用的功能。</p>
<p>Spring Data ElasticSearch 基于 spring data API 简化 ElasticSearch操作，将原始操作ElasticSearch的客户端API 进行封装 。Spring Data为ElasticSearch项目提供集成搜索引擎。Spring Data ElasticSearch POJO的关键功能区域为中心的模型与Elastichsearch交互文档和轻松地编写一个存储索引库数据访问层。</p>
<h6 id="_6">使用方法</h6>
<ol>
<li>
<p>导入依赖
<div class="highlight"><pre><span></span><code>&lt;dependency&gt;  
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;  
    &lt;artifactId&gt;spring-boot-starter-data-elasticsearch&lt;/artifactId&gt;  
&lt;/dependency&gt;
</code></pre></div></p>
</li>
<li>
<p>去做 client 的配置
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">官方的写法</span>
<span class="nd">@Configuration</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">EsClientConf</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ElasticsearchConfiguration</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@Override</span><span class="w">  </span>
<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="n">ClientConfiguration</span><span class="w"> </span><span class="nf">clientConfiguration</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ClientConfiguration</span><span class="p">.</span><span class="na">builder</span><span class="p">()</span><span class="w">  </span>
<span class="w">                </span><span class="p">.</span><span class="na">connectedTo</span><span class="p">(</span><span class="s">&quot;152.136.97.27:9200&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="w">                </span><span class="p">.</span><span class="na">withBasicAuth</span><span class="p">(</span><span class="s">&quot;elastic&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;liuqiang&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="w">                </span><span class="p">.</span><span class="na">build</span><span class="p">();</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="mf">2.</span><span class="w"> </span><span class="n">写配置文件</span>
<span class="nl">spring</span><span class="p">:</span><span class="w">  </span>
<span class="w">  </span><span class="n">elasticsearch</span><span class="p">:</span><span class="w">  </span>
<span class="w">    </span><span class="n">uris</span><span class="p">:</span><span class="w"> </span><span class="n">http</span><span class="p">:</span><span class="c1">//152.136.97.27:9200  </span>
<span class="w">    </span><span class="n">username</span><span class="p">:</span><span class="w"> </span><span class="n">elastic</span><span class="w">  </span>
<span class="w">    </span><span class="n">password</span><span class="p">:</span><span class="w"> </span><span class="n">liuqiang</span>
</code></pre></div>
<ol>
<li>之后就可以注入原生 es-client 或者 低级client了</li>
</ol>
<div class="highlight"><pre><span></span><code><span class="c1">// restClient 演示</span>
<span class="nd">@Test</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">test02</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="c1">// 1. 构造 GET /myindex/_doc/1    Request request = new Request(&quot;GET&quot;, &quot;/myindex/_doc/1&quot;);  </span>

<span class="w">    </span><span class="c1">// 2. 发送请求  </span>
<span class="w">    </span><span class="n">Response</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">restClient</span><span class="p">.</span><span class="na">performRequest</span><span class="p">(</span><span class="n">request</span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 3. 读取响应体为字符串  </span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">responseBody</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EntityUtils</span><span class="p">.</span><span class="na">toString</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="na">getEntity</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;UTF-8&quot;</span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 4. 使用 ObjectMapper 解析整个响应  </span>
<span class="w">    </span><span class="n">JsonNode</span><span class="w"> </span><span class="n">root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objectMapper</span><span class="p">.</span><span class="na">readTree</span><span class="p">(</span><span class="n">responseBody</span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 5. 检查文档是否存在  </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">root</span><span class="p">.</span><span class="na">path</span><span class="p">(</span><span class="s">&quot;found&quot;</span><span class="p">).</span><span class="na">asBoolean</span><span class="p">(</span><span class="kc">true</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Document not found!&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 6. 提取 _source 节点  </span>
<span class="w">    </span><span class="n">JsonNode</span><span class="w"> </span><span class="n">sourceNode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">root</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;_source&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">sourceNode</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">null</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="k">throw</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Missing &#39;_source&#39; in Elasticsearch response&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 7. 将 _source 反序列化为 Goods 对象  </span>
<span class="w">    </span><span class="n">Goods</span><span class="w"> </span><span class="n">goods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">objectMapper</span><span class="p">.</span><span class="na">treeToValue</span><span class="p">(</span><span class="n">sourceNode</span><span class="p">,</span><span class="w"> </span><span class="n">Goods</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 8. 输出结果  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;Retrieved goods: &quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">goods</span><span class="p">);</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><span class="nd">@Autowired</span><span class="w">  </span>
<span class="kd">private</span><span class="w"> </span><span class="n">ElasticsearchClient</span><span class="w"> </span><span class="n">elasticsearchClient</span><span class="p">;</span><span class="w">  </span>

<span class="nd">@Test</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">get</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="n">GetResponse</span><span class="o">&lt;</span><span class="n">Goods</span><span class="o">&gt;</span><span class="w"> </span><span class="n">myindex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elasticsearchClient</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">t</span><span class="w"> </span><span class="o">-&gt;</span><span class="w">  </span>
<span class="w">                    </span><span class="n">t</span><span class="p">.</span><span class="na">index</span><span class="p">(</span><span class="s">&quot;myindex&quot;</span><span class="p">).</span><span class="na">id</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="w">            </span><span class="p">,</span><span class="w"> </span><span class="n">Goods</span><span class="p">.</span><span class="na">class</span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">myindex</span><span class="p">.</span><span class="na">source</span><span class="p">());</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div>
<ol>
<li>当然，我们一版不用原生client，而是spring封装好的 esTemplate
<div class="highlight"><pre><span></span><code><span class="nd">@Autowired</span><span class="w">  </span>
<span class="kd">private</span><span class="w"> </span><span class="n">ElasticsearchTemplate</span><span class="w"> </span><span class="n">elasticsearchTemplate</span><span class="p">;</span><span class="w">  </span>
<span class="nd">@Test</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">test03</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>

<span class="w">    </span><span class="n">Goods</span><span class="w"> </span><span class="n">goods</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elasticsearchTemplate</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">Goods</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="n">IndexCoordinates</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;myindex&quot;</span><span class="p">));</span><span class="w">  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">goods</span><span class="p">);</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>

<span class="nd">@Test</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">test04</span><span class="p">()</span><span class="w"> </span><span class="kd">throws</span><span class="w"> </span><span class="n">IOException</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>

<span class="w">    </span><span class="n">Goods</span><span class="w"> </span><span class="n">good</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Goods</span><span class="p">();</span><span class="w">  </span>
<span class="w">    </span><span class="n">good</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="s">&quot;3&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">good</span><span class="p">.</span><span class="na">setTitle</span><span class="p">(</span><span class="s">&quot;apple手机&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">good</span><span class="p">.</span><span class="na">setBrand</span><span class="p">(</span><span class="s">&quot;apple&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">good</span><span class="p">.</span><span class="na">setImages</span><span class="p">(</span><span class="s">&quot;https://www.baidu.com&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">good</span><span class="p">.</span><span class="na">setPrice</span><span class="p">(</span><span class="mi">9999</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">elasticsearchTemplate</span><span class="p">.</span><span class="na">save</span><span class="p">(</span><span class="n">good</span><span class="p">,</span><span class="w"> </span><span class="n">IndexCoordinates</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="s">&quot;myindex&quot;</span><span class="p">));</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div></li>
</ol>
<h6 id="es">映射以及通过实现接口来使用es</h6>
<p>Spring Data通过注解来声明字段的映射属性，有下面的三个注解：
@Document 作用在类，标记实体类为文档对象， indexName：对应索引库名称
@Id 作用在成员变量，标记一个字段作为id主键
@Field 作用在成员变量，标记为文档的字段，并指定字段映射属性：
type：字段类型，取值是枚举：FieldType index：是否索引，布尔类型，默认是true store：是否存储，布尔类型，默认是false analyzer：分词器名称：ik_max_word
其次，我们还可以在持久层来实现接口，从而实现对es的操作</p>
<div class="highlight"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">写实体类的映射</span>
<span class="nd">@Data</span><span class="w">  </span>
<span class="nd">@Document</span><span class="p">(</span><span class="n">indexName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;index2&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">Goods</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@Id</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="nd">@Field</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FieldType</span><span class="p">.</span><span class="na">Text</span><span class="p">)</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">title</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="nd">@Field</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FieldType</span><span class="p">.</span><span class="na">Keyword</span><span class="p">)</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">images</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="nd">@Field</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FieldType</span><span class="p">.</span><span class="na">Keyword</span><span class="p">)</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">brand</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="nd">@Field</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FieldType</span><span class="p">.</span><span class="na">Integer</span><span class="p">)</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">price</span><span class="p">;</span><span class="w">  </span>
<span class="p">}</span>


<span class="mf">2.</span><span class="w"> </span><span class="n">写一个接口</span><span class="err">，</span><span class="n">去继承ElasticsearchRepository</span>
<span class="cm">/**  </span>
<span class="cm"> * SpringData会自动扫描继承自*Repository接口产生代理对象  </span>
<span class="cm"> */</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">GoodsRepository</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">ElasticsearchRepository</span><span class="o">&lt;</span><span class="n">Goods</span><span class="p">,</span><span class="w"> </span><span class="n">Integer</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="p">}</span>


<span class="mf">3.</span><span class="w"> </span><span class="n">之后就可以注入这个接口</span><span class="err">，</span><span class="n">然后直接操作bean对于的索引库了</span><span class="err">。</span>
</code></pre></div>
<h4 id="7_1">7. 提示词的实现</h4>
<h5 id="71">7.1 基础语法</h5>
<ol>
<li>
<p>创建索引的时候就要指定提示词
<div class="highlight"><pre><span></span><code>PUT test
{
  &quot;mappings&quot;: {
    &quot;properties&quot;: {
      &quot;name&quot;: {
        &quot;type&quot;: &quot;keyword&quot;
      },
      &quot;suggestKeyword&quot;: {
        &quot;type&quot;: &quot;completion&quot;
      },
      &quot;suggestPinyin&quot;: {
        &quot;type&quot;: &quot;completion&quot;
      },
      &quot;suggestLetter&quot;: {
        &quot;type&quot;: &quot;completion&quot;
      }
    }
  }
}
</code></pre></div></p>
</li>
<li>
<p>之后，就可以通过输入去匹配提示词了</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>#模拟用户录入部分关键字内容后，完成自动补全

#单独查询 拼音建议词
GET /test/_search
{
  &quot;suggest&quot;: {
    &quot;mySuggestPinyin&quot;: {
      &quot;prefix&quot;: &quot;8fen&quot;,
      &quot;completion&quot;: {
        &quot;field&quot;: &quot;suggestPinyin&quot;
      }
    }
  }
}

#单独查询 拼音字母建议词
GET /test/_search
{
  &quot;suggest&quot;: {
    &quot;mySuggestLetter&quot;: {
      &quot;prefix&quot;: &quot;8fz&quot;,
      &quot;completion&quot;: {
        &quot;field&quot;: &quot;suggestLetter&quot;
      }
    }
  }
}

#单独查询 汉字建议词
GET /test/_search
{
  &quot;suggest&quot;: {
    &quot;mySuggestKeyword&quot;: {
      &quot;prefix&quot;: &quot;经典&quot;,
      &quot;completion&quot;: {
        &quot;field&quot;: &quot;suggestKeyword&quot;
      }
    }
  }
}

#一个建议中包含多个自定义建议参数，分别查询多个自动补全字段
GET /test/_search
{
  &quot;suggest&quot;: {
    &quot;mySuggestKeyword&quot;: {
      &quot;prefix&quot;: &quot;8f&quot;,
      &quot;completion&quot;: {
        &quot;field&quot;: &quot;suggestKeyword&quot;,
        &quot;size&quot;: 10,
        &quot;skip_duplicates&quot;: true
      }
    },
    &quot;mySuggestPinyin&quot;: {
      &quot;prefix&quot;: &quot;8f&quot;,
      &quot;completion&quot;: {
        &quot;field&quot;: &quot;suggestPinyin&quot;,
         &quot;skip_duplicates&quot;: true
      }
    },
    &quot;mySuggestLetter&quot;: {
      &quot;prefix&quot;: &quot;8f&quot;,
      &quot;completion&quot;: {
        &quot;field&quot;: &quot;suggestLetter&quot;,
         &quot;skip_duplicates&quot;: true
      }
    }
  }
}
</code></pre></div>
<h5 id="72">7.2 实现方式</h5>
<p>首先，先去创建一个提示词索引库，静态映射如下：
<div class="highlight"><pre><span></span><code><span class="nd">@Data</span><span class="w">  </span>
<span class="nd">@Document</span><span class="p">(</span><span class="n">indexName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;suggestinfo&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="nd">@JsonIgnoreProperties</span><span class="p">(</span><span class="n">ignoreUnknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="c1">//目的：防止json字符串转成实体对象时因未识别字段报错  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">SuggestIndex</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>

<span class="w">    </span><span class="cm">/**  </span>
<span class="cm">     * 提示词文档 id，和专辑文档id统一  </span>
<span class="cm">     */</span><span class="w">  </span>
<span class="w">    </span><span class="nd">@Id</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">  </span>

<span class="w">    </span><span class="cm">/**  </span>
<span class="cm">     * 提示词名称,也就是文档的标题  </span>
<span class="cm">     */</span><span class="w">  </span>
<span class="w">    </span><span class="nd">@Field</span><span class="p">(</span><span class="n">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FieldType</span><span class="p">.</span><span class="na">Text</span><span class="p">,</span><span class="w"> </span><span class="n">analyzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;standard&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">title</span><span class="p">;</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@CompletionField</span><span class="p">(</span><span class="n">analyzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;standard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">searchAnalyzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;standard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">maxInputLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Completion</span><span class="w"> </span><span class="n">keyword</span><span class="p">;</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@CompletionField</span><span class="p">(</span><span class="n">analyzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;standard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">searchAnalyzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;standard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">maxInputLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Completion</span><span class="w"> </span><span class="n">keywordPinyin</span><span class="p">;</span><span class="w">  </span>

<span class="w">    </span><span class="nd">@CompletionField</span><span class="p">(</span><span class="n">analyzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;standard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">searchAnalyzer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;standard&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">maxInputLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Completion</span><span class="w"> </span><span class="n">keywordSequence</span><span class="p">;</span><span class="w">  </span>

<span class="p">}</span>
</code></pre></div></p>
<p>然后，去写 DSL 即可</p>
<div class="highlight"><pre><span></span><code><span class="n">post</span><span class="w"> </span><span class="o">/</span><span class="n">suggestinfo</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
<span class="w">  </span><span class="s">&quot;suggest&quot;</span><span class="p">:{</span>
<span class="w">    </span><span class="s">&quot;KeyWordPingYingSuggst&quot;</span><span class="p">:{</span>
<span class="w">      </span><span class="s">&quot;prefix&quot;</span><span class="p">:</span><span class="s">&quot;dao&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;completion&quot;</span><span class="p">:{</span>
<span class="w">        </span><span class="s">&quot;field&quot;</span><span class="p">:</span><span class="s">&quot;keywordPinyin&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;skip_duplicates&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s">&quot;KeyWordSuggst&quot;</span><span class="p">:{</span>
<span class="w">      </span><span class="s">&quot;prefix&quot;</span><span class="p">:</span><span class="s">&quot;dao&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;completion&quot;</span><span class="p">:{</span>
<span class="w">        </span><span class="s">&quot;field&quot;</span><span class="p">:</span><span class="s">&quot;keyword&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;skip_duplicates&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="s">&quot;KeyWordLettersSuggst&quot;</span><span class="p">:{</span>
<span class="w">      </span><span class="s">&quot;prefix&quot;</span><span class="p">:</span><span class="s">&quot;dao&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="s">&quot;completion&quot;</span><span class="p">:{</span>
<span class="w">        </span><span class="s">&quot;field&quot;</span><span class="p">:</span><span class="s">&quot;keywordSequence&quot;</span><span class="p">,</span>
<span class="w">        </span><span class="s">&quot;skip_duplicates&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="8-elk">8. ELK 日志解决方法</h4>
<p>![[Springboot/imgs/image 1.png]]</p>
<h5 id="81-elk">8.1 ELK的安装</h5>
<p>[[#11 ElasticSearch#2. ELK 的安装（docker）]]</p>
<h5 id="82-elk">8.2 ELK的使用</h5>
<ol>
<li>
<p>导入依赖
<div class="highlight"><pre><span></span><code>&lt;dependency&gt;
    &lt;groupId&gt;net.logstash.logback&lt;/groupId&gt;
    &lt;artifactId&gt;logstash-logback-encoder&lt;/artifactId&gt;
    &lt;version&gt;5.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre></div></p>
</li>
<li>
<p>日志配置文件<code>logback-spring.xml</code>增加，日志Logstash策略
<div class="highlight"><pre><span></span><code>&lt;!-- logstash日志 --&gt;
&lt;appender name=&quot;LOGSTASH&quot; class=&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;&gt;
    &lt;!-- logstash ip和暴露的端口，logback就是通过这个地址把日志发送给logstash --&gt;
    &lt;destination&gt;152.136.97.27:5044&lt;/destination&gt;
    &lt;encoder charset=&quot;UTF-8&quot; class=&quot;net.logstash.logback.encoder.LogstashEncoder&quot; /&gt;
&lt;/appender&gt;

&lt;!-- 开发环境 --&gt;
&lt;springProfile name=&quot;dev&quot;&gt;
    &lt;!-- com.atguigu日志记录器：业务程序INFO级别  --&gt;
    &lt;logger name=&quot;com.atguigu&quot; level=&quot;INFO&quot; /&gt;
    &lt;!--&lt;logger name=&quot;com.alibaba&quot; level=&quot;WARN&quot; /&gt;--&gt;
    &lt;!-- 根日志记录器：INFO级别  --&gt;
    &lt;root level=&quot;INFO&quot;&gt;
        &lt;appender-ref ref=&quot;CONSOLE&quot; /&gt;
        &lt;appender-ref ref=&quot;LOGSTASH&quot; /&gt;
    &lt;/root&gt;
&lt;/springProfile&gt;
</code></pre></div></p>
</li>
<li>
<p>启动项目测试Java进程启动会将日志发送到Logstash，Logstash会自动将数据存入ES</p>
</li>
</ol>
<p>注：别忘了配置 ELK（es的配置、logstach的配置、Kibana的配置）</p>
<h2 id="12-mongodb">12 MongoDB</h2>
<p>官方文档：<a href="https://www.mongodb.com/zh-cn/docs/v7.0/">什么是 MongoDB？- 数据库手册 v7.0 - MongoDB Docs</a></p>
<h3 id="1_19">1. 基础概念</h3>
<h4 id="11_1">1.1 介绍</h4>
<p>MongoDB 是在2007年由DoubleClick公司的几位核心成员开发出的一款<strong>分布式文档（数据）</strong>数据库，由C++语言编写。</p>
<p>在MongoDB中数据主要的组织结构就是<code>数据库、集合和文档</code>，文档存储在集合当中，集合存储在数据库中。</p>
<p>MongoDB中每一条数据记录就是一个文档，<code>数据结构由键值(key=&gt;value)对组成</code>。</p>
<p>文档类似于 JSON 对象，它的数据结构被叫做<code>BSON</code>（Binary JSON）。</p>
<p>![[Springboot/imgs/image-3 1.png]]</p>
<table>
<thead>
<tr>
<th>RDBMS（MySQL）</th>
<th>MongoDB</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据库</td>
<td>数据库（database）</td>
</tr>
<tr>
<td>表</td>
<td>集合（Collection）</td>
</tr>
<tr>
<td>行</td>
<td>文档（Document）</td>
</tr>
<tr>
<td>列</td>
<td>字段（Field）</td>
</tr>
<tr>
<td>表联合</td>
<td>嵌入文档</td>
</tr>
<tr>
<td>主键</td>
<td>_id</td>
</tr>
</tbody>
</table>
<h4 id="12_1">1.2 适用场景</h4>
<pre><code>MongoDB不需要去明确指定一个文档的具体结构，对字段的管理非常灵活，有很强的可扩展性。
支持高并发、高可用、高可扩展性，自带数据压缩功能，支持海量数据的高效存储和访问（磁盘内存映射技术）。
支持基本的CRUD、数据聚合、文本搜索和地理空间查询功能。
</code></pre>
<ul>
<li>网站数据：Mongo非常适合实时的插入，更新与查询，并具备网站实时数据存储所需的复制及高度伸缩性。</li>
<li>高伸缩性的场景：Mongo非常适合由数十或数百台服务器组成的数据库。</li>
<li>大尺寸，低价值的数据：使用传统的关系型数据库存储一些数据时可能会比较昂贵，在此之前，很多时候程序员往往会选择传统的文件进行存储。</li>
<li>缓存：由于性能很高，Mongo也适合作为信息基础设施的缓存层。在系统重启之后，由Mongo搭建的持久化缓存层可以避免下层的数据源过载。</li>
</ul>
<h4 id="13-mdb">1.3 Mdb 的安装</h4>
<h5 id="docker">docker 版本</h5>
<ol>
<li>
<p>直接拉取镜像
<div class="highlight"><pre><span></span><code>docker pull mongo:7.0.0
</code></pre></div></p>
</li>
<li>
<p>创建宿主机上的挂载目录
<div class="highlight"><pre><span></span><code>rm -rf /opt/mongo
mkdir -p /opt/mongo/data/db
</code></pre></div></p>
</li>
<li>
<p>创建并启动容器
<div class="highlight"><pre><span></span><code>docker run -d --restart=always -p 27017:27017 --name mongo -v /opt/mongo/data/db:/data/db mongo:7.0.0
</code></pre></div></p>
</li>
<li>
<p>连接mongosh
<div class="highlight"><pre><span></span><code>docker exec -it mongo mongosh
</code></pre></div></p>
</li>
<li>
<p>断开连接（在linux中）
<div class="highlight"><pre><span></span><code>exit 
</code></pre></div></p>
</li>
</ol>
<h5 id="windows">windows 版本</h5>
<h3 id="2-mongodb">2. MongoDB 用法</h3>
<h4 id="21_3">2.1 基本命令</h4>
<div class="highlight"><pre><span></span><code>show dbs
db.version() #当前db版本
db.getMongo() #查看当前db的连接机器地址
db.help() #帮助
quit() #退出命令行
</code></pre></div>
<h4 id="22_3">2.2 数据库操作</h4>
<ol>
<li>创建数据库</li>
</ol>
<div class="highlight"><pre><span></span><code>use userdb // 如果数据库不存在，则创建数据库，否则切换到指定数据库。
</code></pre></div>
<ol>
<li>
<p>查看当前数据库
<div class="highlight"><pre><span></span><code>db.getName()
</code></pre></div></p>
</li>
<li>
<p>显示当前数据库状态
<div class="highlight"><pre><span></span><code>db.stats()
</code></pre></div></p>
</li>
<li>
<p>删除当前数据库
<div class="highlight"><pre><span></span><code>db.dropDatabase()
</code></pre></div></p>
</li>
</ol>
<h4 id="23_3">2.3 集合的操作</h4>
<ol>
<li>
<p>创建集合
<div class="highlight"><pre><span></span><code>db.createCollection(&quot;集合名&quot;)
</code></pre></div></p>
</li>
<li>
<p>删除集合
<div class="highlight"><pre><span></span><code>db.集合名.drop()
</code></pre></div></p>
</li>
</ol>
<h4 id="24_1">2.4 <a href="https://www.runoob.com/mongodb/mongodb-tutorial.html">文档的操作</a></h4>
<h5 id="1_20">1. 文档的增删改查</h5>
<p>ObjectId 是一个12字节 BSON 类型数据，有以下格式：</p>
<ul>
<li>前4个字节表示时间戳</li>
<li>接下来的3个字节是机器标识码</li>
<li>紧接的2个字节由进程id组成（PID）</li>
<li>最后3个字节是随机数。</li>
</ul>
<p>MongoDB中存储的文档必须有一个"_id"键。这个键的值可以是任何类型的，默认是个ObjectId对象。
在一个集合里面，每个文档都有唯一的"_id"值，来确保集合里面每个文档都能被唯一标识。</p>
<p><strong>注意：</strong>
 - MongoDB区分类型和大小写。
 - MongoDB的文档不能有重复的键。
 - 在 7.0.0版本中，文档的增删改：insert,remove,update 都被替换为了 xxxOne,xxxMany ... </p>
<ol>
<li>
<p>插入文档
<div class="highlight"><pre><span></span><code>db.集合名称.insertOne()
db.集合名称.insertMany()
</code></pre></div></p>
</li>
<li>
<p>查找文档
<div class="highlight"><pre><span></span><code>db.user.find({_id:&quot;123&quot;}) // 等值查询
db.user.find() // 查所有
db.user.find(field:{$lt:50})
</code></pre></div>
![[Springboot/imgs/image-4 1.png]]</p>
</li>
<li>
<p>修改文档
    <code>只更新匹配到的第一条记录 $set修改器不会将已有字段删除</code>
<div class="highlight"><pre><span></span><code>db.user.update({name:&quot;liutianba&quot;}, {$set:{age:&quot;999&quot;}}) // 只更新匹配到的第一条
db.user.update({age:21}, {$set:{age:99}}, {multi: true})
</code></pre></div></p>
</li>
<li>
<p>删除文档
<div class="highlight"><pre><span></span><code>db.user.remove() // 删除所有
db.user.remove({field:xxx}) // 条件删除
</code></pre></div></p>
</li>
</ol>
<h5 id="2_18">2. 文档的索引操作</h5>
<p>海量数据实现条件高效率查询，全集合扫描性能相对较低，针对于查询字段创建索引（单列索引，复合索引）</p>
<p>在md中的等级：
- <code>IDHACK</code>：直接通过 <code>_id</code> 主键查询。
- <code>IXSCAN</code>：使用索引查找匹配的索引条目。
- <code>FETCH</code>：<strong>从集合中取出完整文档</strong>。
- <code>COLLSCAN</code>：<strong>没有可用索引</strong>，遍历整个集合的每一条文档。
- <code>PROJECTION_SIMPLE</code> / <code>PROJECTION_COVERED</code>：只返回索引中已包含的字段（<strong>覆盖查询</strong>）。
- <code>SORT</code> / <code>LIMIT</code> / <code>SKIP</code>：这些是<strong>附加操作阶段</strong>，通常出现在主 stage 之后。</p>
<ol>
<li>查看执行计划
<div class="highlight"><pre><span></span><code>db.集合名称.find({条件}).explain()
</code></pre></div></li>
</ol>
<p>![[Springboot/imgs/image-5.png]]</p>
<ol>
<li>对频繁查询的字段创建索引
<div class="highlight"><pre><span></span><code>db.user.createIndex({字段:1})  #1 为指定按升序创建索引，如果你想按降序来创建索引指定为 -1

eg：db.user.createIndex({name:1})
</code></pre></div></li>
</ol>
<p>![[Springboot/imgs/image-6.png]]</p>
<h4 id="3-spring-data-mongodb">3. <a href="https://spring.io/projects/spring-data-mongodb">Spring Data MongoDB</a></h4>
<p>spring-data-mongodb提供了<code>MongoTemplate</code>与<code>MongoRepository</code>两种方式访问mongodb，MongoRepository操作简单，MongoTemplate操作灵活，我们在项目中可以灵活使用这两种方式操作mongodb。</p>
<p>特性：
- <a href="https://docs.spring.io/spring-data/mongodb/reference/mongodb/template-api.html">MongoTemplate</a>: Helper class that increases productivity for common tasks.MongoTemplate：辅助类，可提高常见任务的生产效率。
- <a href="https://docs.spring.io/spring-data/mongodb/reference/mongodb/mapping/mapping.html">Object Mapping</a>: Feature rich, annotation driven object mapper.对象映射：功能丰富、基于注解的对象映射器。
- <a href="https://docs.spring.io/spring-data/mongodb/reference/mongodb/lifecycle-events.html">Lifecycle Events</a>: Before and after save, update, delete hooks and events.生命周期事件：保存、更新、删除前后的钩子和事件。
- <a href="https://docs.spring.io/spring-data/mongodb/reference/mongodb/repositories/repositories.html">Data Repositories</a>: Repository interfaces including support for custom queries &amp; aggregations.数据存储库：包括对自定义查询和聚合支持的存储库接口。
- <a href="https://docs.spring.io/spring-data/mongodb/reference/mongodb/client-session-transactions.html">Multi Document Transactions</a>: Managed transaction support for multi document modifications.多文档事务：支持对多文档修改的托管事务。
- <a href="https://docs.spring.io/spring-data/mongodb/reference/mongodb/mongo-encryption.html">Encryption</a>: Automatic and explicit client side field level encryption.加密：自动且明确的客户端字段级加密。
- <a href="https://docs.spring.io/spring-data/mongodb/reference/mongodb/template-gridfs.html">GridFS</a>: Large file storage.GridFS：大文件存储。
- <a href="https://docs.spring.io/spring-data/mongodb/reference/repositories/core-extensions.html#core.extensions.querydsl">Querydsl</a>: Type-safe query integration.Querydsl：类型安全的查询集成。
- <a href="https://docs.spring.io/spring-data/mongodb/reference/kotlin.html">Kotlin</a>: Extensions to enrich developer experience.Kotlin：扩展功能以丰富开发者体验。</p>
<h5 id="31_4">3.1 版本需求</h5>
<p>![[java/java八股/imgs/image-7.png]]</p>
<h5 id="32-mongodb">3.2  连接到 mongoDb</h5>
<ol>
<li>直接注入一个配置类
<div class="highlight"><pre><span></span><code><span class="nd">@Configuration</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AppConfig</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="cm">/*</span>
<span class="cm">   * Use the standard Mongo driver API to create a com.mongodb.client.MongoClient instance.</span>
<span class="cm">   */</span>
<span class="w">   </span><span class="kd">public</span><span class="w"> </span><span class="nd">@Bean</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">mongodb</span><span class="p">.</span><span class="na">client</span><span class="p">.</span><span class="na">MongoClient</span><span class="w"> </span><span class="nf">mongoClient</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">com</span><span class="p">.</span><span class="na">mongodb</span><span class="p">.</span><span class="na">client</span><span class="p">.</span><span class="na">MongoClients</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">&quot;mongodb://localhost:27017&quot;</span><span class="p">);</span>
<span class="w">   </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></li>
</ol>
<p>与直接实例化  <code>MongoClient</code>  实例相比， <code>FactoryBean</code>  还具有额外的优势，即为容器提供一个  <code>ExceptionTranslator</code>  实现，该实现将 MongoDB 异常转换为 Spring 可移植的  <code>DataAccessException</code>  层次结构中的异常，该层次结构适用于使用  <code>@Repository</code>  注解的数据访问类。 此层次结构以及  <code>@Repository</code>  的使用在 Spring 的 DAO 支持特性中有详细描述。</p>
<div class="highlight"><pre><span></span><code><span class="nd">@Configuration</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">AppConfig</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Factory bean that creates the com.mongodb.client.MongoClient instance</span>
<span class="cm">     */</span>
<span class="w">     </span><span class="kd">public</span><span class="w"> </span><span class="nd">@Bean</span><span class="w"> </span><span class="n">MongoClientFactoryBean</span><span class="w"> </span><span class="nf">mongo</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="n">MongoClientFactoryBean</span><span class="w"> </span><span class="n">mongo</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MongoClientFactoryBean</span><span class="p">();</span>
<span class="w">          </span><span class="n">mongo</span><span class="p">.</span><span class="na">setHost</span><span class="p">(</span><span class="s">&quot;localhost&quot;</span><span class="p">);</span>
<span class="w">          </span><span class="k">return</span><span class="w"> </span><span class="n">mongo</span><span class="p">;</span>
<span class="w">     </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>若要在其他  <code>@Configuration</code>  类或您自己的类中访问由  <code>FactoryBean</code>  创建的  <code>MongoClient</code>  对象，请使用  <code>private @Autowired MongoClient mongoClient;</code>  字段。</p>
<h5 id="33-mongotemplate">3.3 mongoTemplate 的配置</h5>
<ol>
<li>
<p>根据注册好的 mongoClient 去注册 mongoTemplate
<div class="highlight"><pre><span></span><code><span class="nd">@Configuration</span>
<span class="kd">class</span> <span class="nc">ApplicationConfiguration</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="nd">@Bean</span>
<span class="w">  </span><span class="n">MongoClient</span><span class="w"> </span><span class="nf">mongoClient</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">MongoClients</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="s">&quot;mongodb://localhost:27017&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nd">@Bean</span>
<span class="w">  </span><span class="n">MongoOperations</span><span class="w"> </span><span class="nf">mongoTemplate</span><span class="p">(</span><span class="n">MongoClient</span><span class="w"> </span><span class="n">mongoClient</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">MongoTemplate</span><span class="p">(</span><span class="n">mongoClient</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;geospatial&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>或者直接写配置文件即可
<div class="highlight"><pre><span></span><code>spring:
  data:
    mongodb:
      database: user
      host: 192.168.200.6
      port: 27017
</code></pre></div></p>
</li>
</ol>
<h5 id="34">3.4 使用方法</h5>
<ol>
<li>
<p>导入依赖
<div class="highlight"><pre><span></span><code>&lt;dependency&gt;  
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;  
    &lt;artifactId&gt;spring-boot-starter-data-mongodb&lt;/artifactId&gt;  
&lt;/dependency&gt;
</code></pre></div></p>
</li>
<li>
<p>之后就可以按照 3.5 | 3.6 这两种方法去使用了</p>
</li>
</ol>
<h5 id="35">3.5 持久层接口代码演示</h5>
<ol>
<li>
<p>创建一个实体类来和数据库的集合做映射
<div class="highlight"><pre><span></span><code><span class="nd">@Document</span><span class="p">(</span><span class="n">collection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="nd">@Data</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">UserDoc</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="nd">@Id</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Long</span><span class="w"> </span><span class="n">id</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">String</span><span class="w"> </span><span class="n">name</span><span class="p">;</span><span class="w">  </span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">Integer</span><span class="w"> </span><span class="n">age</span><span class="p">;</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>去写持久层接口，要继承 spring 提供的接口
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kd">interface</span> <span class="nc">UserRepository</span><span class="w"> </span><span class="kd">extends</span><span class="w"> </span><span class="n">MongoRepository</span><span class="o">&lt;</span><span class="n">UserDoc</span><span class="p">,</span><span class="n">Long</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>之后就可以注入该接口去使用了
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testFind</span><span class="p">(){</span><span class="w">  </span>
<span class="w">    </span><span class="c1">// 通过id查询  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;通过id查询&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">UserDoc</span><span class="o">&gt;</span><span class="w"> </span><span class="n">user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">findById</span><span class="p">(</span><span class="mi">3L</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">user</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 条件查询  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;条件查询&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">UserDoc</span><span class="w"> </span><span class="n">example</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserDoc</span><span class="p">();</span><span class="w">  </span>
<span class="w">    </span><span class="n">example</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="s">&quot;ltb&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">example</span><span class="p">.</span><span class="na">setAge</span><span class="p">(</span><span class="mi">19</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">Optional</span><span class="o">&lt;</span><span class="n">UserDoc</span><span class="o">&gt;</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">Example</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">example</span><span class="p">));</span><span class="w">  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">one</span><span class="p">.</span><span class="na">get</span><span class="p">());</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 分页查询  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;分页查询&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">Page</span><span class="o">&lt;</span><span class="n">UserDoc</span><span class="o">&gt;</span><span class="w"> </span><span class="n">all</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">findAll</span><span class="p">(</span><span class="n">PageRequest</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">));</span><span class="w">  </span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">UserDoc</span><span class="w"> </span><span class="n">userDoc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">all</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">userDoc</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 排序  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;排序&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">List</span><span class="o">&lt;</span><span class="n">UserDoc</span><span class="o">&gt;</span><span class="w"> </span><span class="n">age</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">userRepository</span><span class="p">.</span><span class="na">findAll</span><span class="p">(</span><span class="n">Sort</span><span class="p">.</span><span class="na">by</span><span class="p">(</span><span class="n">Sort</span><span class="p">.</span><span class="na">Direction</span><span class="p">.</span><span class="na">DESC</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;age&quot;</span><span class="p">));</span><span class="w">  </span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">UserDoc</span><span class="w"> </span><span class="n">userDoc</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">age</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">userDoc</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<h5 id="36">3.6 模板类代码演示</h5>
<ol>
<li>要么去配置文件中写：spring.data.mongodb 节点下的配置，要么就去按照上面的手动注册的配置说明来配置</li>
<li>配置完以后，就可以注入 mongoTemplate, 然后使用了</li>
</ol>
<p>注：mongoTemplate 可以动态的指定要操作的集合名称，所以比持久层接口灵活的多，因为持久层接口只能操作其实体类映射的集合。
mongoTemplate 默认操作的集合：如果操作是新增，删除，修改，那么默认的集合就是改实体类对应的集合，如果该实体类没有用 @Document 指定集合，那么这个集合的名称就是改实体类的名称。
如果是查询，则也会根据传入的查询的类对象去找当前集合名称。
<div class="highlight"><pre><span></span><code>mongoTemplate.find(new Query().addCriteria(Criteria.where(&quot;id&quot;).is(1L)), PersonDoc.class)
</code></pre></div></p>
<div class="highlight"><pre><span></span><code><span class="nd">@Test</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testTemplate</span><span class="p">(){</span><span class="w">  </span>
<span class="w">    </span><span class="c1">// 通过id查询  </span>
<span class="w">    </span><span class="n">Query</span><span class="w"> </span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">Query</span><span class="p">();</span><span class="w">  </span>
<span class="w">    </span><span class="n">UserDoc</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mongoTemplate</span><span class="p">.</span><span class="na">findOne</span><span class="p">(</span><span class="n">query</span><span class="p">.</span><span class="na">addCriteria</span><span class="p">(</span><span class="n">Criteria</span><span class="p">.</span><span class="na">where</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">).</span><span class="na">is</span><span class="p">(</span><span class="mi">3L</span><span class="p">)),</span><span class="w"> </span><span class="n">UserDoc</span><span class="p">.</span><span class="na">class</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;user&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">id</span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 新增  </span>
<span class="w">    </span><span class="n">UserDoc</span><span class="w"> </span><span class="n">userDoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UserDoc</span><span class="p">();</span><span class="w">  </span>
<span class="w">    </span><span class="n">userDoc</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="mi">5L</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">userDoc</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="s">&quot;张三&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">userDoc</span><span class="p">.</span><span class="na">setAge</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">mongoTemplate</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">userDoc</span><span class="p">);</span><span class="w">  </span>
<span class="p">}</span><span class="w">  </span>

<span class="nd">@Test</span><span class="w">  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">testTemplateUpdate</span><span class="p">(){</span><span class="w">  </span>
<span class="w">    </span><span class="n">PersonDoc</span><span class="w"> </span><span class="n">personDoc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">PersonDoc</span><span class="p">();</span><span class="w">  </span>
<span class="w">    </span><span class="n">personDoc</span><span class="p">.</span><span class="na">setId</span><span class="p">(</span><span class="mi">1L</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">personDoc</span><span class="p">.</span><span class="na">setName</span><span class="p">(</span><span class="s">&quot;张三&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="n">personDoc</span><span class="p">.</span><span class="na">setAge</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="n">mongoTemplate</span><span class="p">.</span><span class="na">insert</span><span class="p">(</span><span class="n">personDoc</span><span class="p">);</span><span class="w">  </span>
<span class="p">}</span>
</code></pre></div>
<h2 id="13-zipkin">13 zipkin</h2>
<h4 id="1_21">1. 为什么要有链路追踪</h4>
<pre><code>一个看起来很简单的应用，背后可能需要数十或数百个服务来支撑，一个请求就要多次服务调用。当请求变慢、或者不能使用时，我们是不知道是哪个后台服务引起的。这时，我们使用 Zipkin 就能解决这个问题。由于业务访问量的增大，业务复杂度增加，以及微服务架构和容器技术的兴起，要对系统进行各种拆分。微服务系统拆分后，我们可以使用 Zipkin 链路，来快速定位追踪有故障的服务点。
</code></pre>
<h4 id="2-zipkin">2. zipkin 主要功能</h4>
<p><strong>Zipkin</strong> 其主要功能是聚集来自各个异构系统的实时监控数据，在微服务架构下，十分方便地用于服务响应延迟等问题的定位。</p>
<p><strong>Zipkin</strong> 每一个调用链路通过一个 trace id 来串联起来，只要你有一个 trace id ，就能够直接定位到这次调用链路，并且可以根据服务名、标签、响应时间等进行查询，过滤那些耗时比较长的链路节点。</p>
<p><strong>Zipkin 分布式跟踪系统</strong>就能非常好地解决该问题，<strong>主要解决以下3点问题：</strong>
- 1. 动态展示服务的链路；  <br />
- 2. 分析服务链路的瓶颈并对其进行调优；
- 3. 快速进行服务链路的故障发现;</p>
<h4 id="3_10">3. 使用方式</h4>
<ol>
<li>
<p>导入依赖
<div class="highlight"><pre><span></span><code>&lt;dependency&gt;
    &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
    &lt;artifactId&gt;micrometer-tracing-bridge-brave&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.zipkin.reporter2&lt;/groupId&gt;
    &lt;artifactId&gt;zipkin-reporter-brave&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.micrometer&lt;/groupId&gt;
    &lt;artifactId&gt;micrometer-observation&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;
    &lt;artifactId&gt;spring-cloud-starter-zipkin&lt;/artifactId&gt;
    &lt;version&gt;2.2.8.RELEASE&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;io.github.openfeign&lt;/groupId&gt;
    &lt;artifactId&gt;feign-micrometer&lt;/artifactId&gt;
    &lt;version&gt;12.5&lt;/version&gt;
&lt;/dependency&gt;
</code></pre></div></p>
</li>
<li>
<p>写配置</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>management:
  zipkin:
    tracing:
      endpoint: http://host:9411/api/v2/spans
  tracing:
    sampling:
      probability: 1.0 # 记录速率100%
</code></pre></div>
<h4 id="4-openfeign-zipkin">4. 解决异步 openfeign 无法被 zipkin 完整追踪的问题</h4>
<p>问题原因：由于整合专辑详情接口是通过4个子线程来完成远程接口的调用的，默认是无法将主线程的链路id传到子线程，所以就将这些调用分开追踪了。</p>
<p>解决方案：用 spring 的线程池，然后从父线程拿到链路id</p>
<div class="highlight"><pre><span></span><code>//设置解决zipkin链路追踪不完整装饰器对象
taskExecutor.setTaskDecorator(new ZipkinTaskDecorator(zipkinHelper));
</code></pre></div>
<h1 id="14-redisson">14 <a href="https://redisson.pro/docs/overview/">Redisson</a></h1>
<h4 id="1_22">1. 介绍</h4>
<p><strong>Redisson是一个在Redis的基础上实现的Java驻内存数据网格</strong>（In-Memory Data Grid）。它不仅提供了一系列的分布式的Java常用对象，还提供了许多分布式服务。其中包括(BitSet, Set, Multimap, SortedSet, Map, List, Queue, BlockingQueue, Deque, BlockingDeque, Semaphore, Lock, AtomicLong, CountDownLatch, Publish / Subscribe, Bloom filter, Remote service, Spring cache, Executor service, Live Object service, Scheduler service) Redisson提供了使用Redis的最简单和最便捷的方法。Redisson的<strong>宗旨是促进使用者对Redis的关注分离</strong>（Separation of Concern），从而让使用者能够将精力更集中地放在处理业务逻辑上。</p>
<p>set nx 实现的分布式锁存在以下问题：
1. 代码实现不方便</p>
<ol>
<li>
<p>不可重入性（Reentrancy Issue）：同一个线程在已经持有锁的情况下，再次尝试获取该锁会失败（导致死锁或逻辑阻塞）。</p>
</li>
<li>
<p>锁超时释放导致并发安全失效：线程 A 获取锁后发生 GC 停顿（STW）或耗时操作，导致锁在 Redis 端到期自动释放。</p>
</li>
<li>
<p><strong>缺乏等待阻塞机制（自旋压力）</strong>：如果业务需要等待锁，开发者通常要写 <code>while(true)</code> 循环不断重试（自旋），这会给 Redis 服务器带来巨大的 QPS 压力，且浪费 CPU 资源。</p>
</li>
</ol>
<h4 id="1-redission">1. <a href="https://redisson.pro/docs/getting-started/">redission 的使用</a></h4>
<p>本质还是注册一个 c 端
1. 导入依赖
<div class="highlight"><pre><span></span><code>&lt;dependency&gt;
   &lt;groupId&gt;org.redisson&lt;/groupId&gt;
   &lt;artifactId&gt;redisson-spring-boot-starter&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre></div></p>
<ol>
<li>配置一个 redission 的配置类,并且手动注册一个 RedissonClient
<div class="highlight"><pre><span></span><code>/**
 * redisson配置信息
 */
@Data
@Configuration
@ConfigurationProperties(&quot;spring.data.redis&quot;)
public class RedissonConfig {

    private String host;

    private String password;

    private String port;

    private int timeout = 3000;
    private static String ADDRESS_PREFIX = &quot;redis://&quot;;

    /**
     * 自动装配
     */
    @Bean
    RedissonClient redissonSingle() {
        Config config = new Config();

        if (StringUtils.isBlank(host)) {
            throw new RuntimeException(&quot;host is  empty&quot;);
        }
        SingleServerConfig serverConfig = config.useSingleServer()
                .setAddress(ADDRESS_PREFIX + this.host + &quot;:&quot; + port)
                .setTimeout(this.timeout);
        if (StringUtils.isNotBlank(this.password)) {
            serverConfig.setPassword(this.password);
        }
        return Redisson.create(config);
    }
}
</code></pre></div></li>
</ol>
<h4 id="2_19">2. 分布式锁的使用：缓存击穿</h4>
<table>
<thead>
<tr>
<th><strong>解决点</strong></th>
<th><strong>Redisson 的实现方式</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>代码实现不方便</strong></td>
<td>封装了复杂的 Lua 脚本，API 极其简洁（类似 <code>ReentrantLock</code>）。</td>
</tr>
<tr>
<td><strong>不可重入</strong></td>
<td><strong>Hash 结构存储</strong>：Key 是锁名，Field 是 <code>UUID:ThreadID</code>，Value 是重入次数（Counter）。</td>
</tr>
<tr>
<td><strong>锁超时释放</strong></td>
<td><strong>看门狗 (Watch Dog)</strong>：只要业务没执行完（未主动调用 unlock），后台线程每 10 秒会自动延长过期时间。</td>
</tr>
<tr>
<td><strong>阻塞重试</strong></td>
<td><strong>发布/订阅 (Pub/Sub)</strong>：获取锁失败后，线程会订阅该锁的释放消息，而不是一直死循环自旋，节省 CPU。</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="nd">@Service</span>
<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">RankingService</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="nd">@Autowired</span>
<span class="w">    </span><span class="kd">private</span><span class="w"> </span><span class="n">RedissonClient</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">;</span>

<span class="w">    </span><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">processDataWithLock</span><span class="p">(</span><span class="n">String</span><span class="w"> </span><span class="n">categoryId</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. 获取锁对象（此时并未加锁）</span>
<span class="w">        </span><span class="c1">// 这里的 key 可以根据业务维度进行拆分，实现细粒度锁</span>
<span class="w">        </span><span class="n">String</span><span class="w"> </span><span class="n">lockKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;lock:ranking:&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">categoryId</span><span class="p">;</span>
<span class="w">        </span><span class="n">RLock</span><span class="w"> </span><span class="n">lock</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getLock</span><span class="p">(</span><span class="n">lockKey</span><span class="p">);</span>

<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="cm">/**</span>
<span class="cm">             * 2. 尝试加锁 (参数说明):</span>
<span class="cm">             * waitTime:  等待获取锁的最长时间（期间会不断重试）</span>
<span class="cm">             * leaseTime: 锁自动释放的时间（建议设为 -1，启用看门狗机制）</span>
<span class="cm">             * unit:      时间单位</span>
<span class="cm">             */</span>
<span class="w">            </span><span class="kt">boolean</span><span class="w"> </span><span class="n">isLocked</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">lock</span><span class="p">.</span><span class="na">tryLock</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">TimeUnit</span><span class="p">.</span><span class="na">SECONDS</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">isLocked</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 3. 执行业务逻辑</span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;成功获取锁，开始处理业务...&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="n">Thread</span><span class="p">.</span><span class="na">sleep</span><span class="p">(</span><span class="mi">5000</span><span class="p">);</span><span class="w"> </span><span class="c1">// 模拟耗时操作</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;获取锁失败，当前有其他线程正在处理&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="n">InterruptedException</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Thread</span><span class="p">.</span><span class="na">currentThread</span><span class="p">().</span><span class="na">interrupt</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">finally</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 4. 释放锁 (核心：必须判断锁是否存在，且是否由当前线程持有)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">lock</span><span class="p">.</span><span class="na">isHeldByCurrentThread</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">lock</span><span class="p">.</span><span class="na">unlock</span><span class="p">();</span>
<span class="w">                </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="s">&quot;锁已释放&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<h4 id="3_11">3. 获取锁的不同方式</h4>
<p>leaseTime: 经过 leaseTime 后强制释放
waitTime: 最多等待 waitTime 秒</p>
<table>
<thead>
<tr>
<th><strong>方法</strong></th>
<th><strong>阻塞等待</strong></th>
<th><strong>返回值</strong></th>
<th><strong>自动续期(看门狗)</strong></th>
<th><strong>强制释放时间</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><code>lock()</code></td>
<td><strong>是</strong>（死等）</td>
<td><code>void</code></td>
<td><strong>开启</strong> ✅</td>
<td>无（直到手动 unlock）</td>
</tr>
<tr>
<td><code>lock(5, SECONDS)</code></td>
<td><strong>是</strong>（死等）</td>
<td><code>void</code></td>
<td><strong>关闭</strong> ❌</td>
<td>5秒后强制释放</td>
</tr>
<tr>
<td><code>tryLock(5, 10, SECONDS)</code></td>
<td><strong>是</strong>（限时重试）</td>
<td><code>boolean</code></td>
<td><strong>关闭</strong> ❌</td>
<td>10秒后强制释放</td>
</tr>
<tr>
<td><code>tryLock(5, -1, SECONDS)</code></td>
<td><strong>是</strong>（限时重试）</td>
<td><code>boolean</code></td>
<td><strong>开启</strong> ✅</td>
<td>无（直到手动 unlock）</td>
</tr>
</tbody>
</table>
<h4 id="4-day10">4. 源码分析 day10</h4>
<h5 id="1_23">1. 加锁</h5>
<h5 id="2_20">2. 看门狗机制</h5>
<p>只有设置的锁的过期时间 leaseTime 小于0才会开启该功能。固定频率是 leasetime / 3，默认是 10 s,因为锁的默认过期时间为30s</p>
<h5 id="3_12">3. 解锁</h5>
<h4 id="5_6">5. <a href="https://redisson.pro/docs/data-and-services/objects/#bloom-filter">布隆过滤器</a></h4>
<p>布隆过滤器（Bloom Filter），是1970年，由一个叫布隆的小伙子提出的，距今已经五十年了。它实际上是一个很长的<a href="https://baike.baidu.com/item/%E4%BA%8C%E8%BF%9B%E5%88%B6/361457" title="二进制">二进制</a>向量和<strong>一系列随机映射函数</strong>。布隆过滤器可以用于<a href="https://baike.baidu.com/item/%E6%A3%80%E7%B4%A2/11003896" title="检索">检索</a>一个元素是否在一个<a href="https://baike.baidu.com/item/%E9%9B%86%E5%90%88/2908117" title="集合">集合</a>中。它的优点是空间效率和查询时间都比一般的算法要好的多，缺点是有一定的误识别率和删除困难。二进制大家应该都清楚，存储的数据不是0就是1，默认是0。</p>
<p>主要用于判断一个元素是否在一个集合中，0代表不存在某个数据，1代表存在某个数据。</p>
<p>总结： <strong>判断一个元素一定不存在 或者 可能存在！</strong> 存在一定的误判率{通过代码调节}</p>
<h5 id="51_3">5.1 原理</h5>
<p><strong>记录数据</strong>
1. 通过<strong>K个哈希函数</strong>计算该数据，返回<strong>K个</strong>计算出的<strong>hash值</strong>
2. 这些K个hash值映射到对应的K个二进制的数组下标
3. 将K个下标对应的二进制数据改成1。</p>
<p><strong>查询数据是否在集合中</strong>
1. 通过相同的 K 个哈希函数去计算该数据，得到 K 个 Hash 值。
2. 去查询这以这 K 个 hash 值 为下标的二进制数据
3. 如果都为1，则该元素可能存在，如果存在0，则该元素一定不存在。</p>
<p>时间复杂度$O(k)$ ，空间复杂度 $O(m)$
$k$ : 哈希函数的个数
$m$ : 二进制为的个数</p>
<h5 id="52_3">5.2 优缺点</h5>
<p><strong>优点</strong>
1. 时间复杂度$O(k)$ ，空间复杂度 $O(m)$
2. 保密性好：不存原始数据，只用二进制位来表示元素是否存在</p>
<p><strong>缺点</strong>
 1. 由于底层是哈希函数，所以可能出现哈希冲突，因此，对于元素是否存在的判断，是一个可能性 
 2. 不支持删除元素：因为不同数据的多个hash值可能存在相同，如果删除了a元素，很可能会导致其他元素也存在0，从而影响其他元素的判断。</p>
<h5 id="53_3">5.3 使用方式</h5>
<p>Must be initialized with capacity size by <code>tryInit(expectedInsertions, falseProbability)</code> method before usage.</p>
<div class="highlight"><pre><span></span><code><span class="n">code</span><span class="w"> </span><span class="n">example</span><span class="err">：</span>
<span class="n">RBloomFilter</span><span class="o">&lt;</span><span class="n">SomeObject</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bloomFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisson</span><span class="p">.</span><span class="na">getBloomFilter</span><span class="p">(</span><span class="s">&quot;sample&quot;</span><span class="p">);</span>
<span class="n">bloomFilter</span><span class="p">.</span><span class="na">tryInit</span><span class="p">(</span><span class="mi">55000000L</span><span class="p">,</span><span class="w"> </span><span class="mf">0.03</span><span class="p">);</span>

<span class="n">bloomFilter</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SomeObject</span><span class="p">(</span><span class="s">&quot;field1Value&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;field2Value&quot;</span><span class="p">));</span>
<span class="kt">boolean</span><span class="w"> </span><span class="n">contains</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bloomFilter</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SomeObject</span><span class="p">(</span><span class="s">&quot;field1Value&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;field8Value&quot;</span><span class="p">));</span>
<span class="kt">long</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bloomFilter</span><span class="p">.</span><span class="na">count</span><span class="p">();</span>
</code></pre></div>
<p>添加数据、判断数据是否存在</p>
<div class="highlight"><pre><span></span><code><span class="n">RClusteredBloomFilter</span><span class="o">&lt;</span><span class="n">SomeObject</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bloomFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redisson</span><span class="p">.</span><span class="na">getClusteredBloomFilter</span><span class="p">(</span><span class="s">&quot;sample&quot;</span><span class="p">);</span>
<span class="c1">// initialize bloom filter with </span>
<span class="c1">// expectedInsertions = 255000000  </span>
<span class="c1">// falseProbability = 0.03</span>
<span class="n">bloomFilter</span><span class="p">.</span><span class="na">tryInit</span><span class="p">(</span><span class="mi">255000000L</span><span class="p">,</span><span class="w"> </span><span class="mf">0.03</span><span class="p">);</span>
<span class="n">bloomFilter</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SomeObject</span><span class="p">(</span><span class="s">&quot;fi  eld1Value&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;field2Value&quot;</span><span class="p">));</span>
<span class="n">bloomFilter</span><span class="p">.</span><span class="na">add</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SomeObject</span><span class="p">(</span><span class="s">&quot;field5Value&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;field8Value&quot;</span><span class="p">));</span>
<span class="n">bloomFilter</span><span class="p">.</span><span class="na">contains</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="n">SomeObject</span><span class="p">(</span><span class="s">&quot;field1Value&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;field8Value&quot;</span><span class="p">));</span>
</code></pre></div>
<p>在初始化后，会在redis中产生一个 hash，用来记录当前布隆过滤器的一些配置信息。
![[Springboot/imgs/image 2.png]]</p>
<p>之后，我们便可以根据布隆过滤器的名称去获得布隆过滤器，注意，只有在第一次添加数据时才会产生真正的位图。</p>
<h5 id="54_3">5.4 布隆过滤器的重建与扩容</h5>
<div class="highlight"><pre><span></span><code><span class="nd">@Scheduled</span><span class="p">(</span><span class="n">cron</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;0 0 2 1 * ?&quot;</span><span class="p">)</span><span class="w">  </span>
<span class="c1">// @Scheduled(cron = &quot;0/59 * * * * ?&quot;)  </span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">rebuildBloomFilter</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w">  </span>
<span class="w">    </span><span class="c1">// 1. 拿到当前布隆过滤器的预估值  </span>
<span class="w">    </span><span class="n">RBloomFilter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">old_bloomFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBloomFilter</span><span class="p">(</span><span class="n">RedisConstant</span><span class="p">.</span><span class="na">ALBUM_BLOOM_FILTER</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_bloomFilter</span><span class="p">.</span><span class="na">count</span><span class="p">();</span><span class="w"> </span><span class="c1">// 预估插入数量  </span>
<span class="w">    </span><span class="kt">long</span><span class="w"> </span><span class="n">exceptedInsertions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_bloomFilter</span><span class="p">.</span><span class="na">getExpectedInsertions</span><span class="p">();</span><span class="w"> </span><span class="c1">// 期望大小  </span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">falseProbability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_bloomFilter</span><span class="p">.</span><span class="na">getFalseProbability</span><span class="p">();</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// all: 新建布隆过滤器  </span>
<span class="w">    </span><span class="n">RBloomFilter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="w"> </span><span class="n">new_bloomFilter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">redissonClient</span><span class="p">.</span><span class="na">getBloomFilter</span><span class="p">(</span><span class="s">&quot;temp&quot;</span><span class="p">);</span><span class="w">  </span>

<span class="w">    </span><span class="c1">// 2. 如果预估值大于当前布隆过滤器的 exceptedInsertions，则扩容  </span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">exceptedInsertions</span><span class="p">){</span><span class="w">  </span>
<span class="w">        </span><span class="c1">// 2.1 扩容规则 exceptedInsertions * 1.5        exceptedInsertions = (long) (exceptedInsertions * 1.5);  </span>

<span class="w">        </span><span class="c1">// 2.2 初始化  </span>
<span class="w">        </span><span class="n">new_bloomFilter</span><span class="p">.</span><span class="na">tryInit</span><span class="p">(</span><span class="n">exceptedInsertions</span><span class="p">,</span><span class="w"> </span><span class="n">falseProbability</span><span class="p">);</span><span class="w">  </span>

<span class="w">        </span><span class="c1">// 2.3 删除旧的布隆过滤器  </span>
<span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">delete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_bloomFilter</span><span class="p">.</span><span class="na">delete</span><span class="p">();</span><span class="w">  </span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">delete</span><span class="p">){</span><span class="w">  </span>
<span class="w">            </span><span class="c1">// 2.5 删除成功，则将新的布隆过滤器重命名为旧的布隆过滤器  </span>
<span class="w">            </span><span class="n">new_bloomFilter</span><span class="p">.</span><span class="na">rename</span><span class="p">(</span><span class="n">RedisConstant</span><span class="p">.</span><span class="na">ALBUM_BLOOM_FILTER</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>

<span class="w">        </span><span class="c1">// 2.4 添加专辑 id 到布隆过滤器中  </span>
<span class="w">        </span><span class="n">albumInfoService</span><span class="p">.</span><span class="na">batchUpperToBloom</span><span class="p">();</span><span class="w">  </span>
<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;扩容专辑 id 的布隆过滤器成功！&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="k">else</span><span class="p">{</span><span class="w">  </span>
<span class="w">        </span><span class="c1">// 3. 反之只需要重建即可（因为可能有很多专辑都下架了，但是布隆过滤器无法删除元素）  </span>
<span class="w">        </span><span class="c1">// 3.1 初始化  </span>
<span class="w">        </span><span class="n">new_bloomFilter</span><span class="p">.</span><span class="na">tryInit</span><span class="p">(</span><span class="n">exceptedInsertions</span><span class="p">,</span><span class="w"> </span><span class="n">falseProbability</span><span class="p">);</span><span class="w">  </span>

<span class="w">        </span><span class="c1">// 3.2 删除旧的布隆过滤器  </span>
<span class="w">        </span><span class="kt">boolean</span><span class="w"> </span><span class="n">delete</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_bloomFilter</span><span class="p">.</span><span class="na">delete</span><span class="p">();</span><span class="w">  </span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">delete</span><span class="p">){</span><span class="w">  </span>
<span class="w">            </span><span class="c1">// 3.3 删除成功，则将新的布隆过滤器重命名为旧的布隆过滤器  </span>
<span class="w">            </span><span class="n">new_bloomFilter</span><span class="p">.</span><span class="na">rename</span><span class="p">(</span><span class="n">RedisConstant</span><span class="p">.</span><span class="na">ALBUM_BLOOM_FILTER</span><span class="p">);</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w">  </span>

<span class="w">        </span><span class="c1">// 3.4 添加专辑 id 到布隆过滤器中  </span>
<span class="w">        </span><span class="n">albumInfoService</span><span class="p">.</span><span class="na">batchUpperToBloom</span><span class="p">();</span><span class="w">  </span>

<span class="w">        </span><span class="n">log</span><span class="p">.</span><span class="na">info</span><span class="p">(</span><span class="s">&quot;重建专辑 id 的布隆过滤器成功！&quot;</span><span class="p">);</span><span class="w">  </span>
<span class="w">    </span><span class="p">}</span><span class="w">  </span>

<span class="p">}</span>
</code></pre></div>
<h4 id="6_1">6. 缓存数据一致性</h4>
<p>只能做到最终一致</p>
<h5 id="61">6.1 双写策略</h5>
<p>![[Springboot/imgs/image 3.png]]</p>
<p>并发场景下，这样的情况是很容易出现的，每个线程的操作先后顺序不同，这样就导致请求B的缓存值被请求A给覆盖了，<strong>数据库中是线程B的新值，缓存中是线程A的旧值</strong>，并且会一直这么脏下去直到缓存失效（设置了过期时间）</p>
<p>![[Springboot/imgs/image-1 1.png]]</p>
<p>和前面一种情况相反，<strong>缓存中是线程B的新值，而数据库中是线程A的旧值。</strong></p>
<h5 id="62">6.2 先删除缓存再更新数据库</h5>
<p>可以解决双写出现的不一致问题，但是再并发读写的情况下，可能出现：写线程刚把旧缓存删了，还没来得及写数据库，读线程就去数据库读到了还没更新的数据，并且导致这个刚被删除的旧数据又被缓存到了 redis 中，之后写线程更新完数据库，就会导致数据库与缓存的不一致。
也就是导致了数据库为新值，但缓存为旧值。 </p>
<h5 id="63_1">6.3 延迟双删</h5>
<ol>
<li>先去删除缓存</li>
<li>再去更新数据库</li>
<li>睡眠一段时间（500ms）</li>
<li>再去删除缓存（此删除是为了避免数据库还没更新或者是没同步完成，其他进程读到了旧数据从而导致又缓存了旧数据） </li>
</ol>
<p>问题：这个延时时间不太好设置！设置长了性能差，设置短了会导致数据不一致</p>
<h5 id="64">6.4 分布式读写锁</h5>
<p>读读允许并发
读写、写写不允许并发
问题：效率低</p>
<h5 id="65-binlog">6.5 Binlog 方案</h5>
<p>「<strong>先更新数据库，再删缓存</strong>」的策略的第一步是更新数据库，那么更新数据库成功，就会产生一条变更日志，记录在 binlog 里。</p>
<p>于是我们就可以通过订阅 binlog 日志，拿到具体要操作的数据，然后再执行缓存删除，阿里巴巴开源的 <strong>Canal</strong> 中间件就是基于这个实现的。</p>
<p>Canal 模拟 MySQL 主从复制的交互协议，把自己伪装成一个 MySQL 的从节点，向 MySQL 主节点发送 dump 请求，MySQL 收到请求后，就会开始推送 Binlog 给 Canal，Canal 解析 Binlog 字节流之后，转换为便于读取的结构化数据，供下游程序订阅使用。</p>
<p>![[Springboot/imgs/image 4.png]]</p>
<p>具体解决方案如下图：
canel 伪装成一个 mysql 主节点的从节点。然后发起 dump 去接受主节点的 binlog 日志，之后，就会像这些数据发送到消息队列中，而我们要写代码去获取数据，然后决定如何处理这些数据，为了解决数据一致性问题，每当我们监听到了数据库的写操作，就去把对于的缓存数据删掉即可。</p>
<p>![[Springboot/imgs/image 5.png]]</p>
<h6 id="canal">Canal 服务端</h6>
<ol>
<li>
<p>查看是否开启了 bin_log 日志
<div class="highlight"><pre><span></span><code>show variables like &#39;%log_bin%&#39;;
</code></pre></div></p>
</li>
<li>
<p>在<strong>MySQL</strong>新增用户用于监听Binlog日志，在Canal容器中要使用该用户
<div class="highlight"><pre><span></span><code><span class="o">#</span><span class="err">创建用户</span>
<span class="k">CREATE</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="n">canal</span><span class="w"> </span><span class="n">IDENTIFIED</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;liuqiang&#39;</span><span class="p">;</span><span class="w">  </span>
<span class="o">#</span><span class="err">给用户授权</span><span class="o">-</span><span class="err">所有库所有表主从同步权限</span>
<span class="k">GRANT</span><span class="w"> </span><span class="k">SELECT</span><span class="p">,</span><span class="w"> </span><span class="n">REPLICATION</span><span class="w"> </span><span class="n">SLAVE</span><span class="p">,</span><span class="w"> </span><span class="n">REPLICATION</span><span class="w"> </span><span class="n">CLIENT</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="o">*</span><span class="p">.</span><span class="o">*</span><span class="w"> </span><span class="k">TO</span><span class="w"> </span><span class="s1">&#39;canal&#39;</span><span class="o">@</span><span class="s1">&#39;%&#39;</span><span class="p">;</span>

<span class="o">#</span><span class="err">如果是</span><span class="n">MySQL8</span><span class="p">.</span><span class="n">X以上需要对加密方式进行设置</span>
<span class="k">ALTER</span><span class="w"> </span><span class="k">USER</span><span class="w"> </span><span class="s1">&#39;canal&#39;</span><span class="o">@</span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="n">IDENTIFIED</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="n">mysql_native_password</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="s1">&#39;liuqiang&#39;</span><span class="p">;</span>
<span class="o">#</span><span class="err">刷新生效</span>
<span class="n">FLUSH</span><span class="w"> </span><span class="k">PRIVILEGES</span><span class="p">;</span>
</code></pre></div></p>
</li>
<li>
<p>查询MySQL主节点状态；完成重置
<div class="highlight"><pre><span></span><code>SHOW MASTER STATUS; 
reset master;
</code></pre></div></p>
</li>
<li>
<p>采用Docker方式创建Canal服务端。以下为创建Canal容器命令，要修改要监听主MySQL数据库IP跟端口用户名以及密码确保正确(不需要执行)</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>docker<span class="w"> </span>run<span class="w"> </span>-p<span class="w"> </span><span class="m">11111</span>:11111<span class="w"> </span>--name<span class="w"> </span>canal<span class="w"> </span><span class="se">\</span>
-e<span class="w"> </span>canal.destinations<span class="o">=</span>tingshuTopic<span class="w"> </span><span class="se">\</span>
-e<span class="w"> </span>canal.instance.master.address<span class="o">=</span>j36b695c.natappfree.cc:5272<span class="w">  </span><span class="se">\</span>
-e<span class="w"> </span>canal.instance.dbUsername<span class="o">=</span>canal<span class="w">  </span><span class="se">\</span>
-e<span class="w"> </span>canal.instance.dbPassword<span class="o">=</span>liuqiang<span class="w">  </span><span class="se">\</span>
-e<span class="w"> </span>canal.instance.connectionCharset<span class="o">=</span>UTF-8<span class="w"> </span><span class="se">\</span>
-e<span class="w"> </span>canal.instance.tsdb.enable<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
-e<span class="w"> </span>canal.instance.gtidon<span class="o">=</span><span class="nb">false</span><span class="w">  </span><span class="se">\</span>
-d<span class="w"> </span>canal/canal-server:v1.1.8



//<span class="w"> </span>
docker<span class="w"> </span>stop<span class="w"> </span>canal<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>docker<span class="w"> </span>rm<span class="w"> </span>canal

docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>--name<span class="w"> </span>canal<span class="w"> </span><span class="se">\</span>
-p<span class="w"> </span><span class="m">11111</span>:11111<span class="w"> </span><span class="se">\</span>
-e<span class="w"> </span>canal.destinations<span class="o">=</span>tingshuTopic<span class="w"> </span><span class="se">\</span>
-e<span class="w"> </span>canal.instance.master.address<span class="o">=</span>j36b695c.natappfree.cc:5272<span class="w"> </span><span class="se">\</span>
-e<span class="w"> </span>canal.instance.dbUsername<span class="o">=</span>canal<span class="w"> </span><span class="se">\</span>
-e<span class="w"> </span>canal.instance.dbPassword<span class="o">=</span>liuqiang<span class="w"> </span><span class="se">\</span>
-e<span class="w"> </span>canal.instance.connectionCharset<span class="o">=</span>UTF-8<span class="w"> </span><span class="se">\</span>
-e<span class="w"> </span>canal.instance.tsdb.enable<span class="o">=</span><span class="nb">true</span><span class="w"> </span><span class="se">\</span>
-e<span class="w"> </span><span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;-Xms512m -Xmx512m&quot;</span><span class="w"> </span><span class="se">\</span>
canal/canal-server:v1.1.8


//<span class="w"> </span><span class="m">3</span>.
mkdir<span class="w"> </span>-p<span class="w"> </span>/opt/canal<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>vi<span class="w"> </span>/opt/canal/instance.properties

docker<span class="w"> </span>run<span class="w"> </span>-d<span class="w"> </span>--name<span class="w"> </span>canal<span class="w"> </span>-p<span class="w"> </span><span class="m">11111</span>:11111<span class="w"> </span>-e<span class="w"> </span>canal.destinations<span class="o">=</span>tingshuTopic<span class="w"> </span>-e<span class="w"> </span><span class="nv">JAVA_OPTS</span><span class="o">=</span><span class="s2">&quot;-Xms256m -Xmx512m -XX:MaxDirectMemorySize=256m&quot;</span><span class="w">  </span>-v<span class="w"> </span>/opt/canal/instance.properties:/home/admin/canal-server/conf/tingshuTopic/instance.properties<span class="w"> </span>canal/canal-server:v1.1.8
</code></pre></div>
<ol>
<li>
<p>Canal 日志在容器
<div class="highlight"><pre><span></span><code>/home/admin/canal-server/logs/tingshuTopic 日志路径
</code></pre></div></p>
</li>
<li>
<p>查看是否成功同步我们的主节点
<div class="highlight"><pre><span></span><code>// canel 是否启动成功
docker logs -f canal

# 进入容器查看 instance 日志
docker exec -it canal sh -c &quot;tail -f /home/admin/canal-server/logs/tingshuTopic/tingshuTopic.log&quot;
// 
</code></pre></div></p>
</li>
</ol>
<h6 id="canal_1">Canal 客户端</h6>
<ol>
<li>
<p>创建一个新的模块，并引入依赖
<div class="highlight"><pre><span></span><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;project xmlns=&quot;http://maven.apache.org/POM/4.0.0&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;&gt;
    &lt;parent&gt;
        &lt;artifactId&gt;service&lt;/artifactId&gt;
        &lt;groupId&gt;com.atguigu.tingshu&lt;/groupId&gt;
        &lt;version&gt;1.0&lt;/version&gt;
    &lt;/parent&gt;
    &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt;

    &lt;artifactId&gt;service-cdc&lt;/artifactId&gt;

    &lt;properties&gt;
        &lt;maven.compiler.source&gt;17&lt;/maven.compiler.source&gt;
        &lt;maven.compiler.target&gt;17&lt;/maven.compiler.target&gt;
        &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt;
    &lt;/properties&gt;


    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;io.github.xizixuejie&lt;/groupId&gt;
            &lt;artifactId&gt;canal-spring-boot-starter&lt;/artifactId&gt;
            &lt;version&gt;0.0.17&lt;/version&gt;
        &lt;/dependency&gt;
    &lt;/dependencies&gt;

&lt;/project&gt;
</code></pre></div></p>
</li>
<li>
<p>提供启动类
<div class="highlight"><pre><span></span><code>package com.atguigu.tingshu;

import io.xzxj.canal.spring.annotation.EnableCanalListener;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.jdbc.DataSourceAutoConfiguration;

@EnableCanalListener
@SpringBootApplication(exclude = DataSourceAutoConfiguration.class)
public class CDCApplicaiton {

    public static void main(String[] args) {
        SpringApplication.run(CDCApplicaiton.class, args);
    }
}
</code></pre></div></p>
</li>
<li>
<p>在nacos写配置文件</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>server:
  port: 8601
canal:
  server: canal 地址
  destination: tingshuTopic
</code></pre></div>
<ol>
<li>在本地创建 bootStrap.yaml</li>
</ol>
<div class="highlight"><pre><span></span><code>spring.application.name=service-canal
spring.profiles.active=dev
spring.main.allow-bean-definiton-overriding=true
spring.cloud.nacos.discovery.server-addr=192.168.200.6:8848
spring.cloud.nacos.config.server-addr=192.168.200.6:8848
spring.cloud.nacos.config.prefix=${spring.application.name}
spring.cloud.nacos.config.file-extension=yaml
spring.cloud.nacos.config.shared-configs[0].data-id=common.yaml
</code></pre></div>
<ol>
<li>监听到变更业务处理类-用户信息
<div class="highlight"><pre><span></span><code>@Slf4j
@CanalListener(destination = &quot;tingshuTopic&quot;, schemaName = &quot;tingshu_user&quot;, tableName = &quot;user_info&quot;)
public class UserListener implements EntryListener&lt;UserInfo&gt; {

    @Autowired
    private RedisTemplate redisTemplate;

    /**
     * 监听用户表更新回调方法
     * @param before
     * @param after
     * @param fields
     */
    @Override
    public void update(UserInfo before, UserInfo after, Set&lt;String&gt; fields) {
        log.info(&quot;[cdc]监听到变更数据&quot;);
        String redisKey = &quot;user:info:&quot;+after.getId();
        redisTemplate.delete(redisKey);
    }
}
</code></pre></div></li>
</ol>
<p>注意：由于我的数据库在本机，canal在云服务器上，所以，需要把本机上的 mysql:3306 通过内网穿透暴露到公网上</p>
<h5 id="66_1">6.6 内网穿透</h5>
<p>选择 <a href="https://natapp.cn/">natapp</a> 实现内网穿透
账号：18604849909 密码...</p>
<p>购买完隧道后按照<a href="https://natapp.cn/article/natapp_newbie">NATAPP1分钟快速新手图文教程 - NATAPP-内网穿透 基于ngrok的国内高速内网映射工具</a>即可使用</p>
<p>内网穿透配置完毕后，之后使用命令：
<div class="highlight"><pre><span></span><code>telnet<span class="w"> </span>tcp://j36b695c.natappfree.cc:5272<span class="o">(</span>内网穿透后的ip地址<span class="o">)</span>
curl<span class="w"> </span>j36b695c.natappfree.cc:5272
</code></pre></div></p>
<h1 id="15-seata">15. seata</h1>
<h4 id="1-cap">1. CAP</h4>
<p>在一个<code>分布式系统中</code>，当涉及读写操作时，只能保证一致性（Consistence）、可用性（Availability）、分区容错性（Partition Tolerance）三者中的两个，另外一个必须被牺牲。</p>
<ul>
<li>C 一致性（Consistency）：对某个指定的客户端来说，读操作保证能够返回最新的写操作结果</li>
<li>A 可用性（Availability）：非故障的节点在合理的时间内返回合理的响应<code>（不是错误和超时的响应）</code></li>
<li>P 分区容忍性（Partition Tolerance）：当出现网络分区后<code>（可能是丢包，也可能是连接中断，还可能是拥塞）</code>，系统能够继续“履行职责”-必须满足</li>
</ul>
<h4 id="2-base">2. Base 定理</h4>
<p>BASE理论是对CAP的一种解决思路，包含三个思想：
- <strong>Basically Available</strong> <strong>（基本可用）</strong>：分布式系统在出现故障时，允许损失部分可用性，即保证核心可用。
- <strong>Soft State（软状态）：</strong>在一定时间内，允许出现中间状态，比如<strong>临时</strong>的不一致状态。
- <strong>Eventually Consistent（最终一致性）</strong>：虽然无法保证强一致性，但是在软状态结束后，最终达到数据一致。</p>
<h4 id="3_13">3. 分布式事务的解决方案</h4>
<p>![[Springboot/imgs/image 6.png]]</p>
<ul>
<li>
<p>AP模式：各子事务分别执行和提交，允许出现结果不一致，然后采用弥补措施恢复数据即可，实现最终一致（柔性事务）。</p>
</li>
<li>
<p>CP模式：各个子事务执行后互相等待，同时提交，同时回滚，达成强一致。但事务等待过程中，处于弱可用状态（刚性事务）。</p>
</li>
</ul>
<p>这里的子系统事务，称为<strong>分支事务</strong>；有关联的各个分支事务在一起称为<strong>全局事务</strong>。</p>
<h4 id="4-seata">4. <a href="https://seata.io/zh-cn/">Seata</a>简介</h4>
<p>Seata 的设计目标是对业务无侵入，它把一个分布式事务理解成一个包含了若干分支事务的全局事务。<strong>全局事务</strong>的职责是<strong>协调其下管辖的分支事务达成一致</strong>，要么一起成功提交，要么一起失败回滚。此外，通常分支事务本身就是一个关系型数据库的本地事务。</p>
<h5 id="41_2">4.1 架构</h5>
<ul>
<li>
<p><strong>TC (Transaction Coordinator) -</strong> <strong>事务协调者（Seata服务）：</strong>维护全局和分支事务的状态，协调全局事务提交或回滚。</p>
</li>
<li>
<p><strong>TM (Transaction Manager) -</strong> <strong>事务管理器：</strong>定义全局事务的范围、开始全局事务、提交或回滚全局事务。</p>
</li>
<li>
<p><strong>RM (Resource Manager) -</strong> <strong>资源管理器：</strong>管理分支事务处理的资源，与TC通信以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</p>
</li>
</ul>
<p>![[Springboot/imgs/image-1 2.png]]</p>
<h5 id="42-xa-cp">4.2 XA 模式 CP</h5>
<p>XA 模式就是牺牲了数据的可用性，从而去实现强一致性，也就是不会输先数据不一致的情况，具体实现方式就是分支事务执行完sql后并不直接提交，而是向tc上报状态并等待其他事务的执行，最后，如果都没发生异常，就同时提交，否就，就全部回滚。Seate 在 XA 模式下无业务入侵，但是效率比较低。
![[Springboot/imgs/image-2 1.png]]</p>
<p>总结：
1. 各个服务需要集成 seata 并将自己注册到 seata，成为一个 seata 眼里的 RM
2. 当需要开启全局事务时，TM 要与 TC 通信，从而让 tc 协调本次全局事务的提交，回滚。（获得全局事务id，然后传递给rm，从而实现分支事务与全局事务的绑定）
3. 之后，每个 RM 就可以执行自己的 sql，在 XA 模式下，执行完不提交，而是向 TC 上报状态，由 TC 协调 TM 统一的管理这些分支事务的提交与回滚。</p>
<h5 id="43-at-ap">4.3 AT 模式 AP</h5>
<p><a href="https://seata.apache.org/zh-cn/docs/dev/mode/at-mode">Seata AT 模式 | Apache Seata</a></p>
<h6 id="1_24">1. 概述</h6>
<ul>
<li>一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。</li>
<li>二阶段：<ul>
<li>提交异步化，非常快速地完成。</li>
<li>回滚通过一阶段的回滚日志进行反向补偿。</li>
</ul>
</li>
</ul>
<p><strong>写隔离</strong>
- 一阶段本地事务提交前，需要确保先拿到 <strong>全局锁</strong> 。
- 拿不到 <strong>全局锁</strong> ，不能提交本地事务。
- 拿 <strong>全局锁</strong> 的尝试被限制在一定范围内，超出范围将放弃，并回滚本地事务，释放本地锁。</p>
<p><strong>读隔离</strong>
在数据库本地事务隔离级别 <strong>读已提交（Read Committed）</strong> 或以上的基础上，Seata（AT 模式）的默认全局隔离级别是 <strong>读未提交（Read Uncommitted）</strong> 。</p>
<h6 id="2_21">2. 具体过程</h6>
<p><strong>一阶段：</strong>
1. 解析 SQL：得到 SQL 的类型（UPDATE），表（product），条件（where name = 'TXC'）等相关的信息。
2.  查询前镜像：根据解析得到的条件信息，生成查询语句，定位数据。
3. 执行业务 SQL：更新这条记录的 name 为 'GTS'。
4. 查询后镜像：根据前镜像的结果，通过 <strong>主键</strong> 定位数据。
5. 插入回滚日志：把前后镜像数据以及业务 SQL 相关的信息组成一条回滚日志记录，插入到 <code>UNDO_LOG</code> 表中。
6. 提交前，向 TC 注册分支：申请 <code>product</code> 表中，主键值等于 1 的记录的 <strong>全局锁</strong> 。
7. 本地事务提交：业务数据的更新和前面步骤中生成的 UNDO LOG 一并提交。
8. 将本地事务提交的结果上报给 TC。</p>
<p>二阶段回滚：
1. 收到 TC 的分支回滚请求，开启一个本地事务，执行如下操作。
2. 通过 XID 和 Branch ID 查找到相应的 UNDO LOG 记录。
3. 数据校验：拿 UNDO LOG 中的后镜与当前数据进行比较，如果有不同，说明数据被当前全局事务之外的动作做了修改。这种情况，需要根据配置策略来做处理，详细的说明在另外的文档中介绍。
4. 根据 UNDO LOG 中的前镜像和业务 SQL 的相关信息生成并执行回滚的语句：</p>
<p>二阶段提交：
1. 收到 TC 的分支提交请求，把请求放入一个异步任务的队列中，马上返回提交成功的结果给 TC。
2. 异步任务阶段的分支提交请求将异步和批量地删除相应 UNDO LOG 记录。</p>
<h6 id="3_14">3. 优缺点</h6>
<p>1）一阶段直接提交事务，然后释放资源，性能比 XA 模式好
2）利用全局锁实现了读写隔离，避免了脏写问题
3）没有代码入侵，框架自动完成回滚和提交</p>
<p>1）两阶段之间属于软状态，也就是分布式事务的一致性是最终才实现的, 存在短暂的数据不一致性.
2）框架的快照会影响性能，但比 XA 模式要好.</p>
<h5 id="44-seata-docker">4.4 Seata 部署（docker)</h5>
<ol>
<li>
<p>初始化 Seata 数据库
<div class="highlight"><pre><span></span><code>-- 1. 执行语句创建名为 seata 的数据库
CREATE DATABASE seata DEFAULT CHARACTER SET utf8mb4 DEFAULT COLLATE utf8mb4_general_ci;

-- 2.执行脚本完成 Seata 表结构的创建
use seata;

-- the table to store GlobalSession data
CREATE TABLE IF NOT EXISTS `global_table`
(
    `xid`                       VARCHAR(128) NOT NULL,
    `transaction_id`            BIGINT,
    `status`                    TINYINT      NOT NULL,
    `application_id`            VARCHAR(32),
    `transaction_service_group` VARCHAR(32),
    `transaction_name`          VARCHAR(128),
    `timeout`                   INT,
    `begin_time`                BIGINT,
    `application_data`          VARCHAR(2000),
    `gmt_create`                DATETIME,
    `gmt_modified`              DATETIME,
    PRIMARY KEY (`xid`),
    KEY `idx_status_gmt_modified` (`status` , `gmt_modified`),
    KEY `idx_transaction_id` (`transaction_id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4;

-- the table to store BranchSession data
CREATE TABLE IF NOT EXISTS `branch_table`
(
    `branch_id`         BIGINT       NOT NULL,
    `xid`               VARCHAR(128) NOT NULL,
    `transaction_id`    BIGINT,
    `resource_group_id` VARCHAR(32),
    `resource_id`       VARCHAR(256),
    `branch_type`       VARCHAR(8),
    `status`            TINYINT,
    `client_id`         VARCHAR(64),
    `application_data`  VARCHAR(2000),
    `gmt_create`        DATETIME(6),
    `gmt_modified`      DATETIME(6),
    PRIMARY KEY (`branch_id`),
    KEY `idx_xid` (`xid`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4;

-- the table to store lock data
CREATE TABLE IF NOT EXISTS `lock_table`
(
    `row_key`        VARCHAR(128) NOT NULL,
    `xid`            VARCHAR(128),
    `transaction_id` BIGINT,
    `branch_id`      BIGINT       NOT NULL,
    `resource_id`    VARCHAR(256),
    `table_name`     VARCHAR(32),
    `pk`             VARCHAR(36),
    `status`         TINYINT      NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;0:locked ,1:rollbacking&#39;,
    `gmt_create`     DATETIME,
    `gmt_modified`   DATETIME,
    PRIMARY KEY (`row_key`),
    KEY `idx_status` (`status`),
    KEY `idx_branch_id` (`branch_id`),
    KEY `idx_xid_and_branch_id` (`xid` , `branch_id`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4;

CREATE TABLE IF NOT EXISTS `distributed_lock`
(
    `lock_key`       CHAR(20) NOT NULL,
    `lock_value`     VARCHAR(20) NOT NULL,
    `expire`         BIGINT,
    primary key (`lock_key`)
) ENGINE = InnoDB
  DEFAULT CHARSET = utf8mb4;

INSERT INTO `distributed_lock` (lock_key, lock_value, expire) VALUES (&#39;AsyncCommitting&#39;, &#39; &#39;, 0);
INSERT INTO `distributed_lock` (lock_key, lock_value, expire) VALUES (&#39;RetryCommitting&#39;, &#39; &#39;, 0);
INSERT INTO `distributed_lock` (lock_key, lock_value, expire) VALUES (&#39;RetryRollbacking&#39;, &#39; &#39;, 0);
INSERT INTO `distributed_lock` (lock_key, lock_value, expire) VALUES (&#39;TxTimeoutCheck&#39;, &#39; &#39;, 0);
</code></pre></div></p>
</li>
<li>
<p>在 Nacos 默认的 <strong>public</strong> 命名空间下 ，新建配置 Data ID 为 <strong>seata-server.properties</strong> ，Group 为 DEFAULT_GROUP 的配置，获取Seata 配置在线地址：<a href="https://github.com/seata/seata/blob/1.5.2/script/config-center/config.txt">官方配置</a> 仅需修存储模式为db以及对应的db连接配置</p>
</li>
</ol>
<div class="highlight"><pre><span></span><code>#For details about configuration items, see https://seata.io/zh-cn/docs/user/configurations.html
#Transport configuration, for client and server
transport.type=TCP
transport.server=NIO
transport.heartbeat=true
transport.enableTmClientBatchSendRequest=false
transport.enableRmClientBatchSendRequest=true
transport.enableTcServerBatchSendResponse=false
transport.rpcRmRequestTimeout=30000
transport.rpcTmRequestTimeout=30000
transport.rpcTcRequestTimeout=30000
transport.threadFactory.bossThreadPrefix=NettyBoss
transport.threadFactory.workerThreadPrefix=NettyServerNIOWorker
transport.threadFactory.serverExecutorThreadPrefix=NettyServerBizHandler
transport.threadFactory.shareBossWorker=false
transport.threadFactory.clientSelectorThreadPrefix=NettyClientSelector
transport.threadFactory.clientSelectorThreadSize=1
transport.threadFactory.clientWorkerThreadPrefix=NettyClientWorkerThread
transport.threadFactory.bossThreadSize=1
transport.threadFactory.workerThreadSize=default
transport.shutdown.wait=3
transport.serialization=seata
transport.compressor=none

#Transaction routing rules configuration, only for the client
service.vgroupMapping.default_tx_group=default
#If you use a registry, you can ignore it
service.default.grouplist=127.0.0.1:8091
service.enableDegrade=false
service.disableGlobalTransaction=false

#Transaction rule configuration, only for the client
client.rm.asyncCommitBufferLimit=10000
client.rm.lock.retryInterval=10
client.rm.lock.retryTimes=30
client.rm.lock.retryPolicyBranchRollbackOnConflict=true
client.rm.reportRetryCount=5
client.rm.tableMetaCheckEnable=true
client.rm.tableMetaCheckerInterval=60000
client.rm.sqlParserType=druid
client.rm.reportSuccessEnable=false
client.rm.sagaBranchRegisterEnable=false
client.rm.sagaJsonParser=fastjson
client.rm.tccActionInterceptorOrder=-2147482648
client.tm.commitRetryCount=5
client.tm.rollbackRetryCount=5
client.tm.defaultGlobalTransactionTimeout=60000
client.tm.degradeCheck=false
client.tm.degradeCheckAllowTimes=10
client.tm.degradeCheckPeriod=2000
client.tm.interceptorOrder=-2147482648
client.undo.dataValidation=true
client.undo.logSerialization=jackson
client.undo.onlyCareUpdateColumns=true
server.undo.logSaveDays=7
server.undo.logDeletePeriod=86400000
client.undo.logTable=undo_log
client.undo.compress.enable=true
client.undo.compress.type=zip
client.undo.compress.threshold=64k
#For TCC transaction mode
tcc.fence.logTableName=tcc_fence_log
tcc.fence.cleanPeriod=1h

#Log rule configuration, for client and server
log.exceptionRate=100

#Transaction storage configuration, only for the server. The file, DB, and redis configuration values are optional.
store.mode=db
store.lock.mode=db
store.session.mode=db
#Used for password encryption
store.publicKey=

#If `store.mode,store.lock.mode,store.session.mode` are not equal to `file`, you can remove the configuration block.
store.file.dir=file_store/data
store.file.maxBranchSessionSize=16384
store.file.maxGlobalSessionSize=512
store.file.fileWriteBufferCacheSize=16384
store.file.flushDiskMode=async
store.file.sessionReloadReadSize=100

#These configurations are required if the `store mode` is `db`. If `store.mode,store.lock.mode,store.session.mode` are not equal to `db`, you can remove the configuration block.
store.db.datasource=druid
store.db.dbType=mysql
store.db.driverClassName=com.mysql.jdbc.Driver
store.db.url=jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true&amp;rewriteBatchedStatements=true
store.db.user=root
store.db.password=liuqiang
store.db.minConn=5
store.db.maxConn=30
store.db.globalTable=global_table
store.db.branchTable=branch_table
store.db.distributedLockTable=distributed_lock
store.db.queryLimit=100
store.db.lockTable=lock_table
store.db.maxWait=5000

#These configurations are required if the `store mode` is `redis`. If `store.mode,store.lock.mode,store.session.mode` are not equal to `redis`, you can remove the configuration block.
store.redis.mode=single
store.redis.single.host=127.0.0.1
store.redis.single.port=6379
store.redis.sentinel.masterName=
store.redis.sentinel.sentinelHosts=
store.redis.maxConn=10
store.redis.minConn=1
store.redis.maxTotal=100
store.redis.database=0
store.redis.password=
store.redis.queryLimit=100

#Transaction rule configuration, only for the server
server.recovery.committingRetryPeriod=1000
server.recovery.asynCommittingRetryPeriod=1000
server.recovery.rollbackingRetryPeriod=1000
server.recovery.timeoutRetryPeriod=1000
server.maxCommitRetryTimeout=-1
server.maxRollbackRetryTimeout=-1
server.rollbackRetryTimeoutUnlockEnable=false
server.distributedLockExpireTime=10000
server.xaerNotaRetryTimeout=60000
server.session.branchAsyncQueueSize=5000
server.session.enableBranchAsyncRemove=false
server.enableParallelRequestHandle=false

#Metrics configuration, only for the server
metrics.enabled=false
metrics.registryType=compact
metrics.exporterList=prometheus
metrics.exporterPrometheusPort=9898
</code></pre></div>
<ul>
<li><strong>store.mode=db</strong> 存储模式选择为数据库</li>
<li><strong>192.168.200.6</strong> MySQL主机地址</li>
<li><strong>store.db.user=root</strong> 数据库用户名</li>
<li>
<p><strong>store.db.password=root</strong> 数据库密码</p>
</li>
<li>
<p>获取 seata 配置
<div class="highlight"><pre><span></span><code>// 1. 创建临时容器
docker run -d --name seata-server -p 8091:8091 -p 7091:7091 seataio/seata-server:1.7.0

// 2. 创建文件夹为容器挂载目录
mkdir -p /mydata/seata/config


// 3. 赋值容器配日志到宿主机
docker cp seata-server:/seata-server/resources/ /mydata/seata/config

// 4.删除临时容器
// docker rm -f seata-server
</code></pre></div></p>
</li>
<li>
<p>修改配置</p>
</li>
</ul>
<p>在获取到 seata-server 的应用配置之后，因为这里采用 Nacos 作为 seata 的配置中心和注册中心，所以需要修改 application.yml 里的配置中心和注册中心地址，详细配置我们可以从 application.example.yml 拿到。</p>
<div class="highlight"><pre><span></span><code>server:
  port: 7091
seata:
  config:
    type: nacos
    nacos:
      server-addr: 192.168.200.6:8848
      namespace:
      group: DEFAULT_GROUP
      data-id: seata-server.properties
  security:
    secretKey: SeataSecretKey0c382ef121d778043159209298fd40bf3850a017
    tokenValidityInMilliseconds: 1800000
  registry:
    type: nacos
    nacos:
      application: seata-server  
      server-addr: 192.168.200.6:8848
      namespace:
      group: DEFAULT_GROUP
      cluster: default
console:
  user:
    username: seata
    password: seata
logging:
  config: classpath:logback-spring.xml
  file:
    path: /mydata/seata/logs
</code></pre></div>
<ul>
<li><strong>namespace</strong> nacos命名空间id，不填默认是public命名空间</li>
<li><strong>data-id: seataServer.properties</strong> Seata外置文件所处Naocs的Data ID，参考上小节的 <strong>导入配置至 Nacos</strong></li>
<li><strong>group: SEATA_GROUP</strong> 指定注册至nacos注册中心的分组名</li>
<li>
<p><strong>cluster: default</strong> 指定注册至nacos注册中心的集群名</p>
</li>
<li>
<p>启动
<div class="highlight"><pre><span></span><code>docker run -d --name seata-server --restart=always  -p 8091:8091 -p 7091:7091 -e SEATA_IP=192.168.200.6 -v /mydata/seata/config/resources:/seata-server/resources seataio/seata-server:1.7.0
</code></pre></div></p>
</li>
</ul>
<h5 id="45-seata-windows">4.5 <a href="https://blog.csdn.net/u013737132/article/details/133295970">Seata 部署</a>（windows)</h5>
<div class="highlight"><pre><span></span><code>在本地部署 seata 时，注意：默认向nacos注册时上传的是一个临时的公网ip地址，之后微服务从nacos下拉seata实例时候就会通过这个错误的 ip 去访问seata，从而导致访问不到，因此，我们要手动指定 seata 注册到 nacos 的 ip 地址（环回地址）
seata-server.bat -Dseata.service.host-address=127.0.0.1
</code></pre></div>
<h5 id="46-seata">4.6 集成 Seata</h5>
<ol>
<li>如果是 TA 模式，需要在集成 seata 的服务的数据源创建一个 undo_log 表
<div class="highlight"><pre><span></span><code>/*
 Navicat Premium Data Transfer

 Source Server         : local
 Source Server Type    : MySQL
 Source Server Version : 50622
 Source Host           : localhost:3306
 Source Schema         : seata_demo

 Target Server Type    : MySQL
 Target Server Version : 50622
 File Encoding         : 65001

 Date: 20/06/2021 12:39:03
*/

SET NAMES utf8mb4;
SET FOREIGN_KEY_CHECKS = 0;

-- ----------------------------
-- Table structure for undo_log
-- ----------------------------
DROP TABLE IF EXISTS `undo_log`;
-- 注意此处0.3.0+ 增加唯一索引 ux_undo_log
CREATE TABLE `undo_log` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT,
  `branch_id` bigint(20) NOT NULL,
  `xid` varchar(100) NOT NULL,
  `context` varchar(128) NOT NULL,
  `rollback_info` longblob NOT NULL,
  `log_status` int(11) NOT NULL,
  `log_created` datetime NOT NULL,
  `log_modified` datetime NOT NULL,
  `ext` varchar(100) DEFAULT NULL,
  PRIMARY KEY (`id`),
  UNIQUE KEY `ux_undo_log` (`xid`,`branch_id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;

-- ----------------------------
-- Records of undo_log
-- ----------------------------


SET FOREIGN_KEY_CHECKS = 1;
</code></pre></div></li>
<li>导入依赖
<div class="highlight"><pre><span></span><code>    &lt;!--seata--&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;
        &lt;artifactId&gt;spring-cloud-starter-alibaba-seata&lt;/artifactId&gt;
        &lt;!-- 默认seata客户端版本比较低，排除后重新引入指定版本--&gt;
        &lt;exclusions&gt;
            &lt;exclusion&gt;
                &lt;groupId&gt;io.seata&lt;/groupId&gt;
                &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;
            &lt;/exclusion&gt;
        &lt;/exclusions&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
        &lt;groupId&gt;io.seata&lt;/groupId&gt;
        &lt;artifactId&gt;seata-spring-boot-starter&lt;/artifactId&gt;
    &lt;/dependency&gt;
</code></pre></div></li>
<li>然后去写配置文件即可
nacos 作为注册中心
<div class="highlight"><pre><span></span><code><span class="nl">seata</span><span class="p">:</span>
<span class="w">  </span><span class="n">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="n">tx</span><span class="o">-</span><span class="n">service</span><span class="o">-</span><span class="n">group</span><span class="p">:</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">spring</span><span class="p">.</span><span class="na">application</span><span class="p">.</span><span class="na">name</span><span class="p">}</span><span class="o">-</span><span class="n">group</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">事务组名称</span>
<span class="w">  </span><span class="n">service</span><span class="p">:</span>
<span class="w">    </span><span class="n">vgroup</span><span class="o">-</span><span class="n">mapping</span><span class="p">:</span>
<span class="w">      </span><span class="err">#</span><span class="n">指定事务分组至集群映射关系</span><span class="err">，</span><span class="n">集群名default需要与seata</span><span class="o">-</span><span class="n">server注册到Nacos的cluster保持一致</span>
<span class="w">      </span><span class="n">order</span><span class="o">-</span><span class="n">service</span><span class="o">-</span><span class="n">group</span><span class="p">:</span><span class="w"> </span><span class="k">default</span>
<span class="w">  </span><span class="n">registry</span><span class="p">:</span>
<span class="w">    </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="n">nacos</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">使用nacos作为注册中心</span>
<span class="w">    </span><span class="n">nacos</span><span class="p">:</span>
<span class="w">      </span><span class="n">server</span><span class="o">-</span><span class="n">addr</span><span class="p">:</span><span class="w"> </span><span class="mf">192.168.200.6</span><span class="p">:</span><span class="mi">8848</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">nacos服务地址</span>
<span class="w">      </span><span class="n">group</span><span class="p">:</span><span class="w"> </span><span class="n">DEFAULT_GROUP</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">默认服务分组</span>
<span class="w">      </span><span class="n">namespace</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">默认命名空间</span>
<span class="w">      </span><span class="n">cluster</span><span class="p">:</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">默认TC集群名称</span>
</code></pre></div></li>
</ol>
<p>直接访问 seata
<div class="highlight"><pre><span></span><code><span class="nl">seata</span><span class="p">:</span><span class="w"> </span>
<span class="w">  </span><span class="n">enabled</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span>
<span class="w">  </span><span class="n">application</span><span class="o">-</span><span class="n">id</span><span class="p">:</span><span class="w"> </span><span class="n">$</span><span class="p">{</span><span class="n">spring</span><span class="p">.</span><span class="na">application</span><span class="p">.</span><span class="na">name</span><span class="p">}</span>
<span class="w">  </span><span class="n">tx</span><span class="o">-</span><span class="n">service</span><span class="o">-</span><span class="n">group</span><span class="p">:</span><span class="w"> </span><span class="n">default_tx_group</span><span class="w"> </span><span class="err">#</span><span class="w"> </span><span class="n">务必与</span><span class="w"> </span><span class="n">properties</span><span class="w"> </span><span class="n">中的分组名对应</span>

<span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="mf">1.</span><span class="w"> </span><span class="n">关键</span><span class="err">：</span><span class="n">将注册中心改为</span><span class="w"> </span><span class="n">file</span><span class="err">，</span><span class="n">这样它就不会去</span><span class="w"> </span><span class="n">Nacos</span><span class="w"> </span><span class="n">找</span><span class="w"> </span><span class="n">Seata</span><span class="w"> </span><span class="n">地址了</span>
<span class="w">  </span><span class="n">registry</span><span class="p">:</span>
<span class="w">    </span><span class="n">type</span><span class="p">:</span><span class="w"> </span><span class="n">file</span>

<span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="n">关键</span><span class="err">：</span><span class="n">直接硬编码</span><span class="w"> </span><span class="n">Seata</span><span class="w"> </span><span class="n">Server</span><span class="w"> </span><span class="n">的地址</span>
<span class="w">  </span><span class="n">service</span><span class="p">:</span>
<span class="w">    </span><span class="n">vgroup</span><span class="o">-</span><span class="n">mapping</span><span class="p">:</span>
<span class="w">      </span><span class="n">default_tx_group</span><span class="p">:</span><span class="w"> </span><span class="k">default</span>
<span class="w">    </span><span class="n">grouplist</span><span class="p">:</span>
<span class="w">      </span><span class="k">default</span><span class="p">:</span><span class="w"> </span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">8091</span><span class="w">  </span><span class="err">#</span><span class="w"> </span><span class="n">这里直接指向你本地启动的</span><span class="w"> </span><span class="n">Seata</span><span class="w"> </span><span class="n">端口</span>
</code></pre></div></p>
<h5 id="47">4.7 总结</h5>
<p>使用 seata 实际很简单
1、首先先部署一个 seata，可以是 windows，也可以是 docker
2、去写 seata 的配置，主要是储存模式，数据库的连接url以及账户和密码
2、如果是 TA 模式（默认模式），则创建一个 undo_log 表在当前服务的数据库下
3、导入依赖
4、去写配置，从而让当前微服务连接到seata。
5、最后，在分布式事务的入口加上注解：@GloableTransactional 即可。</p>
<h4 id="5_7">5. 全局锁</h4>
<p>如果没有全局锁,会存在脏写问题.</p>
<p>![[Springboot/imgs/image-3 2.png]]</p>
<p>Seata解决思路就是引入了全局锁的概念。在释放DB锁之前（提交本地事务前），先拿到全局锁。避免同一时刻有另外一个事务来操作当前数据。
全局锁的持有时间是一直到二阶段结束, 需要注意:当我们的事务 A 需要回滚时, 必须要拿到本地锁,但此时本地锁被事务2占有,但由于事务2拿不到全局锁,所以在尝试一定次数后,就会释放本地锁,然后回滚.</p>
<p>![[Springboot/imgs/image-4 2.png]]</p>
<h4 id="6_2">6. 全局事务的边界选择</h4>
<p>我们可以选择在一个全局事务下,当出现异常时,哪些分支事务需要回滚,哪些不需要回滚,因为在某些场景下不需要一股脑全部都回滚.</p>
<p>解决方式: 将需要一起回滚的分支事务通过seata的 @GlobleTransactional 来管理,注意,如果是在其他方法内部,则需要把这个全局事务抽成一个单独的类下面的方法,这样才能产生代理对象.</p>
<p>![[Springboot/imgs/image-5 1.png]]</p>
<p>如果此时我们不希望扣减余额失败就去回滚我们的保存订单业务,那么就可以将在 submitOrder 方法下的 远程调用<code>扣减余额</code>以及<code>发放商品权益</code> 这两段代码逻辑抽取到一个新的类下的新的方法,然后,去在这个方法下通过注解 @GlobleTransactional.... 来控制扣减余额以及方法权益的分布式事务 </p>
<h4 id="7_2">7. 本地事务失效的常见场景</h4>
<ol>
<li>
<p>@Transactional 标注了一个 private| static| final... 修饰的方法：因为事务能生效的本质是产生了个代理对象，然后通过代理对象去调用这个目标地方，但是现在目标方法私有，所以代理对象没法重写这个方法，所以就失效了。
<div class="highlight"><pre><span></span><code><span class="nd">@Transactional</span><span class="p">()</span>
<span class="kd">private</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">a</span><span class="p">(){</span>
<span class="w">    </span><span class="c1">// a表操作</span>
<span class="w">    </span><span class="c1">// b表操作</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
<li>
<p>异常仅仅只是被你自己捕获并打印，没有抛出去</p>
</li>
<li>
<p>没有直接通过代理对象去调用方法，而是通过目标对象直接调用方法，也会导致事务失效
    <code>下面这种情况可以生效，因为存在事务的传播</code>
<div class="highlight"><pre><span></span><code><span class="nd">@Transactional</span><span class="p">(</span><span class="n">rollback</span><span class="o">=</span><span class="n">Exception</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">a</span><span class="p">(){</span>
<span class="w">    </span><span class="c1">// a表操作</span>
<span class="w">    </span><span class="c1">// b表操作 通过this调用了本类下的其他方法</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">b</span><span class="p">()</span>
<span class="p">}</span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">b</span><span class="p">(){</span>
<span class="w">    </span><span class="c1">// b表操作</span>
<span class="p">}</span>
</code></pre></div></p>
</li>
</ol>
<p><code>这样不行，传播也救不了，因为都没调代理对象</code>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">a</span><span class="p">(){</span>
<span class="w">    </span><span class="c1">// a表操作</span>
<span class="w">    </span><span class="c1">// b表操作 通过this调用了本类下的其他方法</span>
<span class="w">    </span><span class="k">this</span><span class="p">.</span><span class="na">b</span><span class="p">()</span>
<span class="p">}</span>
<span class="nd">@Transactional</span><span class="p">(</span><span class="n">rollback</span><span class="o">=</span><span class="n">Exception</span><span class="p">.</span><span class="na">class</span><span class="p">)</span>
<span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">b</span><span class="p">(){</span>
<span class="w">    </span><span class="c1">// b表操作</span>
<span class="p">}</span>
</code></pre></div></p>
<ol>
<li>
<p>选择的数据库引擎不支持事务：MyIsam...</p>
</li>
<li>
<p>默认回滚类型：RuntimeException 和 Error 不匹配</p>
</li>
</ol>
<h4 id="8">8.  分布式事务失效问题</h4>
<p>如果在远处调用之后没手动判断业务码，就可能导致分布式事务的失效，因为我们的远程调用做了降级处理，即使业务失败，也不会抛出异常，而是直接返回降级返回，如果我们没有手动的去判断业务状态码是否为200，就会出现远程调用失败了，但是我们的TC根本不知道有一个分支事务出现了异常，从而导致了数据的不一致性.</p>
<p>解决方法:oa
1. 每次都判断远程调用的结果是否成功,失败手动抛出异常
2. 利用 AOP 的异常通知,对Service层发放进行增强,如果检查出有异常并且是我们当前全局事务的一个分支事务,就手动的去调用全局事务的回滚.</p>
<h1 id="16-xxj-job">16. <a href="https://www.xuxueli.com/xxl-job/">Xxj-Job</a></h1>
<h4 id="1_25">1. 概述</h4>
<p>XXL-JOB是一个分布式任务调度平台，其核心设计目标是开发迅速、学习简单、轻量级、易扩展。现已开放源代码并接入多家公司线上产品线，开箱即用。</p>
<h4 id="2_22">2. 使用</h4>
<p>官方文档：<a href="https://www.xuxueli.com/xxl-job/">Xxj-Job</a>
当调度中心部署完成后，可以访问<a href="http://localhost:8080/xxl-job-admin">web管理页面</a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  回到页面顶部
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2026 LiuTianBa7 

    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../..", "features": ["navigation.tabs", "navigation.tracking", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>